;/*FB_PKG_DELIM*/

__d("ACTSanitizerApiTypes",["$InternalEnum"],(function(t,n,r,o,a,i){"use strict";var e=n("$InternalEnum")({Valid:0,UrlFailure:1,MessageTextFailure:2,CtaFailure:3});i.ACTSanitizerValidationResult=e}),66);
__d("ACTSanitizerApiWasm",["ACTSanitizerApiTypes","FBLogger","WAArmadilloXMA.pb","WAResolvable","WATagsLogger","WAWasmModuleCache","actsanitizer_api_v2","asyncToGeneratorRuntime","bx","encodeProtobuf","getErrorSafe"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_=r("bx").getURL(r("bx")("30948")),f=o("WATagsLogger").TAGS(["ACTSanitizerWasm"]);function g(){return h.apply(this,arguments)}function h(){return h=n("asyncToGeneratorRuntime").asyncToGenerator(function*(){var t=new(o("WAResolvable")).Resolvable,n=r("actsanitizer_api_v2")({instantiateWasm:function(a,i){return o("WAWasmModuleCache").loadWasmModule(_).then(function(e){return WebAssembly.instantiate(e,a)}).then(function(n){f.LOG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["instantiateWasm succeeded"]))),i(n),t.resolve()}).catch(function(e){f.ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["WebAssembly.instantiate failed with error: ",""])),r("getErrorSafe")(e).toString()),t.reject(e)}),{}}}).catch(function(e){throw f.ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["initWasm failed with error: ",""])),r("getErrorSafe")(e).toString()),t.reject(e),e}),a=yield t.promise.then(function(){return n});return{getWasmMemorySize:function(){var e;return(e=a.wasmMemory)==null?void 0:e.buffer.byteLength},isMessageTextValid:function(t){try{var e=new TextEncoder,n=e.encode(t),i=a._malloc(n.byteLength);a.HEAPU8.set(n,i);var l=a._ACTSanitizer_isMessageTextValid(i,n.byteLength);a._free(i);var s=o("ACTSanitizerApiTypes").ACTSanitizerValidationResult.cast(l);if(s==null)throw r("FBLogger")("messenger_web").mustfixThrow("ACT Sanitizer WASM module returned invalid validation result");return s}catch(e){throw f.ERROR(c||(c=babelHelpers.taggedTemplateLiteralLoose(["isMessageTextValid runtime error: ",""])),r("getErrorSafe")(e).toString()),e}},isXMAValid:function(t){var e,n;try{n=o("encodeProtobuf").encodeProtobuf(o("WAArmadilloXMA.pb").ExtendedContentMessageSpec,t).readByteArrayView(),e=a._malloc(n.byteLength),a.HEAPU8.set(n,e);var i=a._ACTSanitizer_isXMAValid(e,n.byteLength),l=o("ACTSanitizerApiTypes").ACTSanitizerValidationResult.cast(i);if(l==null)throw f.ERROR(d||(d=babelHelpers.taggedTemplateLiteralLoose(["module returned invalid validation result: ",""])),l),r("FBLogger")("messenger_web").mustfixThrow("ACTSanitizerWasm module returned invalid validation result");return f.LOG(m||(m=babelHelpers.taggedTemplateLiteralLoose(["isXMAValid succeeded with result: ",""])),l),l}catch(e){var s,u,c,_;throw f.ERROR(p||(p=babelHelpers.taggedTemplateLiteralLoose(["isXMAValid runtime error: ",". Final memory allocation: ",". input page size: ",". xma target type: ",""])),r("getErrorSafe")(e).toString(),(s=y((u=a.wasmMemory)==null?void 0:u.buffer.byteLength))!=null?s:"unknown",(c=y((_=n)==null?void 0:_.byteLength))!=null?c:"unknown",t.targetType),e}finally{e!=null&&a._free(e)}}}}),h.apply(this,arguments)}function y(e){return e==null?null:Math.ceil(e/65536)}l.ACTSanitizerWasm=g}),98);
__d("ACTSanitizerApiLazyLoader",["ACTSanitizerApiWasm"],(function(t,n,r,o,a,i,l){"use strict";var e=null,s=1024*1024;function u(){e==null&&(e=o("ACTSanitizerApiWasm").ACTSanitizerWasm());var t=e;return t.then(function(t){var n=t.getWasmMemorySize();n!=null&&n>=s&&(e=o("ACTSanitizerApiWasm").ACTSanitizerWasm())}),t}l.loadACTSanitizerApi=u}),98);
__d("Cache",["TimeSlice"],(function(t,n,r,o,a,i,l){"use strict";var e=6e4,s=(function(){function t(){this.$1=new Map}var n=t.prototype;return n.has=function(t){return this.$1.has(t)},n.get=function(t,n){var e=this.__getRaw(t);return e?e.$2:n},n.getAll=function(t,n){var e=this,r=new Map;return t.forEach(function(t){return r.set(t,e.get(t,n))}),r},n.delete=function(t){var e=this.__getRaw(t);return e&&e.$3&&clearTimeout(e.$3),this.$1.delete(t)},n.clear=function(){this.$1.forEach(function(e){e&&e.$3&&clearTimeout(e.$3)}),this.$1.clear()},n.set=function(n,o,a,i){if(!this.shouldUpdate(n,a))return!1;var t=this.__getRaw(n);return t||(t=this.__getNewRawObject()),delete t.$2,delete t.$4,t.$3&&clearTimeout(t.$3),delete t.$3,t.$2=o,a!=null&&(t.$4=a),i!=null&&i>=0&&(t.$3=setTimeout(r("TimeSlice").guard(this.delete.bind(this,n),"Cache expiration timeout"),i*e)),this.__setRaw(n,t),!0},n.shouldUpdate=function(t,n){var e=this.__getRaw(t);return e==null||e.$4==null||n==null||n>e.$4},n.size=function(){return this.$1.size},n.__getRaw=function(t){return this.$1.get(t)},n.__setRaw=function(t,n){this.$1.set(t,n)},n.__getNewRawObject=function(){return{$2:null,$3:null,$4:null,$5:null,$6:null}},n.__keys=function(){return this.$1.keys()},t})();l.default=s}),98);
__d("EBAPIConvertNativeToLS",["I64","LSDict","LSShape","LSVec"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(t){return{decrypted_protobuf:t.decryptedProtobuf,protobuf_timestamp_ms:(e||(e=o("I64"))).of_float(t.protobufTimestampMs)}}function u(e,t){var n=r("LSVec").ofArray(e.map(function(e){return e.value}).filter(Boolean)),o=r("LSVec").ofArray(t.map(function(e){return c(e)}).filter(Boolean));return{echo:n,protobuf:o}}function c(e){var t=e.topLevelProtobuf,n=e.supplementalProtobufs,a=e.otid;if(a!=null){var i=new Map;n.forEach(function(e,t){var n=o("LSShape").ofRecord(s(e));i.set(t,n)});var l={otid:a,supplemental_protobufs:new(r("LSDict"))(i),tags:e.messageTags.map(function(e){return e}),toplevel_protobuf:o("LSShape").ofRecord(s(t))};return o("LSShape").ofRecord(l)}}l.convertNativeProtobufToLSType=s,l.convertNativeDecryptionResponseToDecryptedMessageType=u,l.convertDecryptedProtobufMessageToLSNativeType=c}),98);
__d("MEBEncryptionVersion",[],(function(t,n,r,o,a,i){var e=Object.freeze({UNKNOWN:0,ENCRYPTION_KDF_WITH_VERSION:2,ENCRYPTION_KDF_WITH_NULL_SALT:3,ENCRYPTION_KDF_WITH_NULL_SALT_DF_CANARY:4,TEST_VERSION:99});i.default=e}),66);
__d("EBCryptoUtils",["Base64Utils","EncryptedBackupsSymmetricEncryptionUtils","HChaCha20","MEBEncryptionVersion","SymmetricEncryptionCreateEncryptedData","SymmetricEncryptionPaddingUtils","XPlatReactCrypto","asyncToGeneratorRuntime","err"],(function(t,n,r,o,a,i,l){"use strict";var e=32,s=2147483647,u="message_key_in_epoch",c="_",d="cipher_version",m="thread",p="message_thread",_="supplemental_enc_aad",f="kdf_info:mailbox_root_key_v2>supplemental_enc_key";function g(t,n,o,a,i){var l=o>=r("MEBEncryptionVersion").ENCRYPTION_KDF_WITH_NULL_SALT?null:h(a),s=y(t,o,a);if(s==null)throw i.endFailWithError("failed_to_derive_message_symmetric_key"),r("err")("Error in derive message symmetric key. info is null");return b(s,l,n,[e],i)}function h(e){try{return new TextEncoder().encode(e).buffer}catch(e){throw r("err")("Error in get blob from string with exception: ",e)}}function y(e,t,n){var r=C(e,t,n);return h(r)}function C(e,t,n){return t>=r("MEBEncryptionVersion").ENCRYPTION_KDF_WITH_NULL_SALT_DF_CANARY||t>=r("MEBEncryptionVersion").ENCRYPTION_KDF_WITH_NULL_SALT?[u,new TextDecoder().decode(e),d,t,m,n].join(c):t>=r("MEBEncryptionVersion").ENCRYPTION_KDF_WITH_VERSION?[u,new TextDecoder().decode(e),d,t].join(c):[u,new TextDecoder().decode(e)].join(c)}function b(e,t,n,a,i){if(a.length<1||a.some(function(e){return e>s}))throw i==null||i.endFailWithError("invalid_key_lengths_for_derive_keys"),r("err")("Invalid key lengths for derive keys");var l=a.reduce(function(e,t){return e+t},0)*8;return o("XPlatReactCrypto").subtleImportKey("raw",n,"HKDF",!1,["deriveBits"]).then(function(n){return o("XPlatReactCrypto").subtleDeriveBits({hash:"SHA-256",info:e,name:"HKDF",salt:t!=null?t:new Uint8Array(10).buffer},n,l)}).then(function(e){for(var t=new Uint8Array(e),n=[],r=0,o=0,i=a.length;o<i;++o){var l=r+a[o];n.push(t.slice(r,l).buffer),r=l}return n}).catch(function(e){throw i==null||i.endFailWithError("exception_in_create_derived_keys",e),r("err")("Exception in create derived keys",e)})}function v(e,t,n,a,i){var l=o("Base64Utils").toArrayBuffer(n);return S(e,t,l).then(function(e){if(e==null)throw a==null||a.endFailWithError("symmetric_string_decryption_with_null_result"),r("err")("symmetric string decryption with null result");return e}).catch(function(e){throw a==null||a.endFailWithError("symmetric_string_decryption_failed_with_error",e),r("err")("symmetric string decryption failed with encryption version: "+(i!=null?i:"null")+" and error",e)})}function S(e,t,n){if(n.byteLength<o("EncryptedBackupsSymmetricEncryptionUtils").hChaCha20SubKeyNonceLengthInBytes+o("EncryptedBackupsSymmetricEncryptionUtils").aesGcmTagLengthInBytes)throw r("err")("cipher text is invalid");var a=new Uint8Array(n),i=a.slice(0,o("EncryptedBackupsSymmetricEncryptionUtils").totalNonceLengthInBytes),l=new(o("HChaCha20")).HChaCha20,s=a.slice(o("EncryptedBackupsSymmetricEncryptionUtils").totalNonceLengthInBytes).buffer,u=l.hChaCha20Bytes(i.slice(0,o("EncryptedBackupsSymmetricEncryptionUtils").hChaCha20SubKeyNonceLengthInBytes).buffer,e);return o("XPlatReactCrypto").subtleImportKey("raw",u,"AES-GCM",!1,["decrypt"]).then(function(e){return o("XPlatReactCrypto").subtleDecrypt({additionalData:t,iv:new Uint8Array(i.slice(o("EncryptedBackupsSymmetricEncryptionUtils").hChaCha20SubKeyNonceLengthInBytes).buffer),name:"AES-GCM",tagLength:o("EncryptedBackupsSymmetricEncryptionUtils").aesGcmTagLength},e,s)}).then(function(e){var t=o("SymmetricEncryptionPaddingUtils").stripPadding(e);if(t==null)throw r("err")("Failed to strip padding for symmetric decryption");return t}).catch(function(e){throw r("err")("symmetric data decryption failed with error",e)})}function R(e,t,n){return L.apply(this,arguments)}function L(){return L=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t,n){var a=yield r("SymmetricEncryptionCreateEncryptedData")(t,new TextEncoder().encode([p,n].join(c)).buffer,e),i=a[0];return i!=null?o("Base64Utils").fromArrayBuffer(i):null}),L.apply(this,arguments)}l.KEY_LEN=e,l.MAX_INT_32=s,l.STRING_JOIN_SEPARATOR=c,l.MESSAGE_ENCYPTION_AAD=p,l.SUPPLEMENTAL_ENC_AAD=_,l.SUPPLEMENTAL_ENC_KEY_INFO=f,l.deriveMessageSymmetricKey=g,l.getBlobFromString=h,l.getInfoByEncryptionVersion=C,l.createDerivedKeys=b,l.symmetricEncryptionCreateDecryptedString=v,l.encryptThenBase64EncodeBlob=R}),98);
__d("EBDecryptQplFlow",["QPLUserFlow","Random","gkx","qpl"],(function(t,n,r,o,a,i,l){"use strict";function e(e){var t=e.annotations,n=e.decryptionType,a=e.entryPoint,i=e.isMinos,l=e.source,u=e.threadId,c=r("qpl")._(521485751,"1118"),d=o("Random").uint32();return r("QPLUserFlow").start(c,{annotations:babelHelpers.extends({},t,{bool:babelHelpers.extends({},t==null?void 0:t.bool,{is_wasm_serializer_on:r("gkx")("18428"),isMinos:i,minos_rollout_enabled:r("gkx")("20911"),occam_only_mailbox_users:r("gkx")("16674")}),int:babelHelpers.extends({},t==null?void 0:t.int,{instanceKey:d,retryCount:0}),string:babelHelpers.extends({},t==null?void 0:t.string,{decryptionType:n,queryType:a,source:l!=null?l:"unknown",threadId:u})}),instanceKey:d}),s(c,d)}function s(e,t){return{addAnnotations:function(o){r("QPLUserFlow").addAnnotations(e,o,{instanceKey:t})},addPoint:function(o,a){a&&r("QPLUserFlow").addAnnotations(e,a,{instanceKey:t}),r("QPLUserFlow").addPoint(e,o,{instanceKey:t})},endFailWithError:function(o,a,i){var n=babelHelpers.extends({},i,{string:babelHelpers.extends({},i==null?void 0:i.string,{failReason:a})});r("QPLUserFlow").endFailure(e,o,{annotations:n,instanceKey:t})},endSuccess:function(o){r("QPLUserFlow").endSuccess(e,{annotations:o,instanceKey:t})},getInstanceKey:function(){return t}}}l.startDecryptQplFlow=e}),98);
__d("EBEchoMessageDecryptor",["EBCryptoUtils","EBDecryptQplFlow","I64","LSAuthorityLevel","LSIntEnum","MEBEncryptionVersion","Promise","ReQL","WACryptoUtils","WALogger","asyncToGeneratorRuntime","err"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_;function f(e,t,n){return g.apply(this,arguments)}function g(){return g=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t,n){if(t==null)throw o("WALogger").ERROR(c||(c=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] No backup id provided"]))),r("err")("no-backup-id-provided");var a=yield o("ReQL").toArrayAsync(o("ReQL").fromTableAscending(e.tables.secure_encrypted_backups_epochs));if(a.length===0)throw o("WALogger").ERROR(d||(d=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] SecureEncryptedBackupsEpoch table is empty"]))),r("err")("secure-epochs-table-empty");return a.filter(function(e){return(p||(p=o("I64"))).equal(e.authorityLevel,(_||(_=o("LSIntEnum"))).ofNumber(r("LSAuthorityLevel").AUTHORITATIVE))&&(p||(p=o("I64"))).equal(e.backupId,(p||(p=o("I64"))).of_string(t))&&n.equals(e[n.key])})}),g.apply(this,arguments)}function h(e,t){var n=t.epoch_id;return n!=null?f(e,t.backup_id,{equals:function(t){return t instanceof ArrayBuffer?!1:(p||(p=o("I64"))).equal(n,t)},key:"epochId",value:n}):f(e,t.backup_id,{equals:function(n){return n instanceof ArrayBuffer?o("WACryptoUtils").arrayBuffersEqual(t.epoch_anon_id,n):!1},key:"epochAnonIdBlob",value:t.epoch_anon_id})}var y=(function(){function t(){}var a=t.prototype;return a.decrypt=function(a,i,l,c,d){var t=l.map((function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var n,l,m=o("EBDecryptQplFlow").startDecryptQplFlow({decryptionType:"echo_message_decryptor",entryPoint:d,isMinos:!1,source:c,threadId:i});if(t.value==null)return o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Empty echo message string - cannot decrypt"]))),m.endFailWithError("empty_echo_message_string"),{otid:t.otid,value:void 0};var p=t.value;m.addPoint("get_epoch_keys_by_id_start");var _=yield h(a,t);if(_.length===0)return o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] No epoch keys found for message"]))),m.endFailWithError("no_epoch_keys_found_for_message"),{otid:t.otid,value:void 0};m.addPoint("get_epoch_keys_by_id_end"),m.addPoint("derive_message_symmetric_key_start");var f=yield o("EBCryptoUtils").deriveMessageSymmetricKey(_[0].epochAnonIdBlob,_[0].epochRootKeyBlob,(n=t.encryption_version)!=null?n:r("MEBEncryptionVersion").UNKNOWN,i,m);if(f==null||f.length===0)return o("WALogger").ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Failed to derive symmetric key for message"]))),m.endFailWithError("failed_to_derive_symmetric_key"),{otid:t.otid,value:void 0};m.addPoint("derive_message_symmetric_key_end"),m.addPoint("symmetric_encryption_create_decrypted_string_start");var g=yield o("EBCryptoUtils").symmetricEncryptionCreateDecryptedString(f[0],new TextEncoder().encode([o("EBCryptoUtils").MESSAGE_ENCYPTION_AAD,i].join(o("EBCryptoUtils").STRING_JOIN_SEPARATOR)).buffer,p,m,(l=t.encryption_version)!=null?l:r("MEBEncryptionVersion").UNKNOWN);return m.addPoint("symmetric_encryption_create_decrypted_string_end"),m.endSuccess(),{otid:t.otid,value:g!=null?new TextDecoder().decode(g):void 0}});return function(e){return t.apply(this,arguments)}})());return(m||(m=n("Promise"))).all(t)},t})();l.getEpochKeysByID=h,l.EchoMessageDecryptor=y}),98);
__d("EBTypes",[],(function(t,n,r,o,a,i){"use strict";function e(e){return e}i.unsafeCastToDecryptedLabyrinthMessage=e}),66);
__d("EBProtobufMessageDecryptor",["Base64Utils","EBCryptoUtils","EBDecryptQplFlow","EBEchoMessageDecryptor","EBTypes","MEBEncryptionVersion","MpsTypes","Promise","WALogger","WALongInt","WATimeUtils","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_,f,g,h=(function(){function t(){}var a=t.prototype;return a.$1=(function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t,n,a,i,l){var m,p,_=o("EBDecryptQplFlow").startDecryptQplFlow({decryptionType:"protobuf_message_decryptor",entryPoint:l,isMinos:!1,source:i,threadId:n});_.addAnnotations({string:{message_id:a.otid}}),_.addPoint("get_epoch_keys_by_id_start");var f=yield o("EBEchoMessageDecryptor").getEpochKeysByID(t,a);if(f.length===0){o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] No epoch keys found for message"]))),_.endFailWithError("no_epoch_keys_found_for_message");return}_.addPoint("get_epoch_keys_by_id_end");var g=f[0];_.addPoint("derive_message_symmetric_key_start");var h=yield o("EBCryptoUtils").deriveMessageSymmetricKey(g.epochAnonIdBlob,g.epochRootKeyBlob,(m=a.encryption_version)!=null?m:r("MEBEncryptionVersion").UNKNOWN,n,_);if(h==null||h.length===0){o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Failed to derive symmetric key for message"]))),_.endFailWithError("failed_to_derive_symmetric_key");return}if(_.addPoint("derive_message_symmetric_key_end"),_.addPoint("symmetric_encryption_create_decrypted_string_start"),a.encryptedProtobufContent==null){o("WALogger").ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] encrypted protobuf content is null"]))),_.endFailWithError("encrypted_protobuf_content_is_null");return}var y=a.encryptedProtobufContent,C=yield o("EBCryptoUtils").symmetricEncryptionCreateDecryptedString(h[0],new TextEncoder().encode([o("EBCryptoUtils").MESSAGE_ENCYPTION_AAD,n].join(o("EBCryptoUtils").STRING_JOIN_SEPARATOR)).buffer,y,_,(p=a.encryption_version)!=null?p:r("MEBEncryptionVersion").UNKNOWN),b;if(a.skCipherText!=null){var v,S,R=a.skCipherText,L=yield(S=o("EBCryptoUtils")).createDerivedKeys(new TextEncoder().encode(S.SUPPLEMENTAL_ENC_KEY_INFO).buffer,void 0,g.epochRootKeyBlob,[S.KEY_LEN],_);b=yield S.symmetricEncryptionCreateDecryptedString(L[0],new TextEncoder().encode(S.SUPPLEMENTAL_ENC_AAD).buffer,R,_,(v=a.encryption_version)!=null?v:r("MEBEncryptionVersion").UNKNOWN)}if(C==null){_.endFailWithError("failed_to_decrypt_protobuf"),o("WALogger").ERROR(c||(c=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Failed to decrypt protobuf"])));return}_.addPoint("symmetric_encryption_create_decrypted_string_end"),_.addPoint("decrypt_supplemental_key_start");var E=b!=null?o("MpsTypes").toSupplementalKey(new TextDecoder().decode(b)):void 0;if(_.addPoint("decrypt_supplemental_key_end"),a.protobufTimestampMs==null){_.endFailWithError("protobuf_timestamp_is_null"),o("WALogger").ERROR(d||(d=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] protobuf timestamp is null"])));return}var k=o("WATimeUtils").castLongIntToMillisTime(o("WALongInt").decimalStringToLongInt(a.protobufTimestampMs));return _.endSuccess(),{decryptedProtobuf:o("EBTypes").unsafeCastToDecryptedLabyrinthMessage(C),decryptedSupplementalKey:E,protobufTimestampMs:k}});function a(e,n,r,o,a){return t.apply(this,arguments)}return a})(),a.$2=function(t){var e=t.topLevelProtobuf.encryptedProtobufContent,n=t.topLevelProtobuf.protobufTimestampMs,r=t.topLevelProtobuf.otid;if(!(e==null||n==null||r==null))return{messageTags:t.messageTags,otid:o("MpsTypes").toMessageId(r),supplementalProtobufs:new Map,topLevelProtobuf:{decryptedProtobuf:o("EBTypes").unsafeCastToDecryptedLabyrinthMessage(o("Base64Utils").toArrayBuffer(e)),decryptedSupplementalKey:void 0,protobufTimestampMs:o("WATimeUtils").castLongIntToMillisTime(o("WALongInt").decimalStringToLongInt(n))}}},a.$3=(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t,r,a,i){var l=this,s=r.topLevelProtobuf,u=r.supplementalProtobufs,c=yield this.$1(e,t,s,a,i);if(c==null){o("WALogger").ERROR(m||(m=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Failed to decrypt top level protobuf"])));return}var d=new Map;return yield(g||(g=n("Promise"))).all(u.map((function(){var r=n("asyncToGeneratorRuntime").asyncToGenerator(function*(n){var r=yield l.$1(e,t,n,a,i);if(r==null){o("WALogger").ERROR(p||(p=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Failed to decrypt supplemental protobuf"])));return}var s=r.decryptedSupplementalKey;if(s==null){o("WALogger").ERROR(_||(_=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] decrypted supplemental key is null"])));return}d.set(s,r)});return function(e){return r.apply(this,arguments)}})())),{messageTags:r.messageTags,otid:r.topLevelProtobuf.otid!=null?o("MpsTypes").toMessageId(r.topLevelProtobuf.otid):void 0,supplementalProtobufs:d,topLevelProtobuf:c}});function t(t,n,r,o,a){return e.apply(this,arguments)}return t})(),a.decrypt=(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t,r,a,i){var l=this,s=[];return yield(g||(g=n("Promise"))).all(r.map((function(){var r=n("asyncToGeneratorRuntime").asyncToGenerator(function*(n){if(n.isUnencrypted===!0){var r=l.$2(n);r!=null&&s.push(r);return}var u=yield l.$3(e,t,n,a,i);if(u==null){o("WALogger").ERROR(f||(f=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Failed to decrypt protobuf message for message with otid ",""])),n.topLevelProtobuf.otid);return}s.push(u)});return function(e){return r.apply(this,arguments)}})())),s});function t(t,n,r,o,a){return e.apply(this,arguments)}return t})(),t})();l.ProtobufMessageDecryptor=h}),98);
__d("EBAPIDecryptionModule",["EBEchoMessageDecryptor","EBProtobufMessageDecryptor","WALogger","WAResultOrError","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e,s;function u(e,t,n,r,o,a){return c.apply(this,arguments)}function c(){return c=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t,n,r,a,i,l){o("WALogger").DEV(e||(e=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Running native decryption"])));var u=new(o("EBEchoMessageDecryptor")).EchoMessageDecryptor,c=new(o("EBProtobufMessageDecryptor")).ProtobufMessageDecryptor;try{var d=a.length>0?yield u.decrypt(t,n,a,i,l):[],m=r.length>0?yield c.decrypt(t,n,r,i,l):[];return o("WAResultOrError").makeResult({decryptedEchoMessages:d,decryptedProtobufs:m})}catch(e){return o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Error thrown when running native decryption: ",""])),e),o("WAResultOrError").makeError(e)}}),c.apply(this,arguments)}l.decryptUsingNativeJS=u}),98);
__d("EBAPISharedTypes",[],(function(t,n,r,o,a,i){"use strict";var e=["ebls-not-initialized","no-client-state","runtime-error","invalid-client-state","invalid-graphql-response","empty-decryption-response","delete-mailbox","unsupported-context","eb-not-enabled","echo-to-protobuf-conversion-error","called-from-main-thread","missing-message-range-info","server-side-exception","thread-not-found-in-mi-act-mapping-table","thread-not-found-on-server","echo-decryption-failure","protobuf-decryption-failure","decryption-error","null-chat-jid","native-decryption-error","invalid-parameters","secure-epochs-table-empty","no-backup-id-provided"],l=new Set(e);i.EBAPIRestoreErrorValues=e,i.errorSet=l}),66);
__d("EBBase64Decode",["Base64Utils"],(function(t,n,r,o,a,i,l){"use strict";function e(e){var t=e.replace(/-/g,"+").replace(/_/g,"/").replace(/\./g,"=").replace("/,/","="),n=4-t.length%4;if(n<4)for(var r=0;r<n;r++)t+="=";return t}function s(t){return o("Base64Utils").toArrayBuffer(e(t))}l.default=s}),98);
__d("EBConvertMinosProtobufShape",["EBTypes"],(function(t,n,r,o,a,i,l){"use strict";function e(e){var t;return{messageTags:e.messageTags,otid:(t=e.otid)!=null?t:void 0,supplementalProtobufs:s(e.supplementalProtobufs),topLevelProtobuf:{decryptedProtobuf:o("EBTypes").unsafeCastToDecryptedLabyrinthMessage(e.topLevelProtobuf.decryptedProtobuf),decryptedSupplementalKey:e.topLevelProtobuf.decryptedSupplementalKey,protobufTimestampMs:e.topLevelProtobuf.protobufTimestampMs}}}function s(e){var t=new Map;return e.forEach(function(e,n){var r={decryptedProtobuf:o("EBTypes").unsafeCastToDecryptedLabyrinthMessage(e.decryptedProtobuf),decryptedSupplementalKey:n,protobufTimestampMs:e.protobufTimestampMs};t.set(n,r)}),t}l.convertMinosProtobufShape=e}),98);
__d("EBDBConsistencyApi",["$InternalEnum","EBDB","FBLogger","I64","QPLUserFlow","ReQL","asyncToGeneratorRuntime","getErrorSafe","justknobx","qpl"],(function(t,n,r,o,a,i,l){"use strict";var e,s=["encrypted_backups_virtual_devices","secure_encrypted_backups_recovery_code_status","device_metadata","secure_encrypted_backups_epochs","secure_encrypted_backups_client_state","encrypted_backups","experiences_shared_state","auto_restore_opt_out"],u=null;function c(){return u}function d(e,t){return m.apply(this,arguments)}function m(){return m=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t,n){try{var a=yield o("EBDB").getEBDB(),l=BigInt((e||(e=o("I64"))).to_string(n));yield a.runInTransaction(["device_state"],"readwrite",function(e){return e.stores.device_state.bulkPut([{deviceId:l,env:t}])},"EBDB - AddDevice",i.id+":54"),u=l}catch(e){r("FBLogger")("wmi_eb").catching(r("getErrorSafe")(e)).mustfix("Error on EBDB - AddDevice")}}),m.apply(this,arguments)}function p(e){return o("ReQL").firstAsync(o("ReQL").fromTableAscending(e.tables.secure_encrypted_backups_client_state)).then(function(e){return e==null?void 0:e.deviceId})}function _(e,t,n){return f.apply(this,arguments)}function f(){return f=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t,n){if(n!=null)return d(t,n);try{var o=yield p(e);return o==null?void 0:d(t,o)}catch(e){r("FBLogger")("wmi_eb").catching(r("getErrorSafe")(e)).mustfix("Error on fetching secure_encrypted_backups_client_state")}}),f.apply(this,arguments)}function g(e,t){return h.apply(this,arguments)}function h(){return h=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t){r("QPLUserFlow").addPoint(t,"track_overprompting_start");try{var a=yield o("EBDB").getEBDB(),l=!1;yield a.runInTransaction(["device_state"],"readwrite",(function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var n=yield t.stores.device_state.get(e);(n==null?void 0:n.deviceId)!=null&&(l=!0)});return function(e){return t.apply(this,arguments)}})(),"EBDB - AddDevice",i.id+":107"),r("QPLUserFlow").addAnnotations(t,{bool:{overprompting:l}}),r("QPLUserFlow").addPoint(t,"track_overprompting_end")}catch(e){r("QPLUserFlow").addPoint(t,"track_overprompting_fail"),r("FBLogger")("wmi_eb").catching(r("getErrorSafe")(e)).mustfix("Error on track overpropting")}}),h.apply(this,arguments)}var y=n("$InternalEnum")({Disabled:0,EbsmInconsistent:1,EbdbInconsistent:2,Enabled:3,Inconsistent:4});function C(e){return b.apply(this,arguments)}function b(){return b=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var n=yield p(t),r=n!=null?BigInt((e||(e=o("I64"))).to_string(n)):null;return r==null&&u==null?y.Disabled:r==null&&u!=null?y.EbsmInconsistent:r!=null&&u==null?y.EbdbInconsistent:r===u?y.Enabled:y.Inconsistent}),b.apply(this,arguments)}function v(e,t,n,r){return S.apply(this,arguments)}function S(){return S=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t,n,o){var a=1/r("justknobx")._("3914");if(!(Math.random()>=a)){var i=r("qpl")._(521471316,"2831");try{r("QPLUserFlow").start(i);var l=yield C(e);o!=null&&r("QPLUserFlow").addAnnotations(i,o()),r("QPLUserFlow").endSuccess(i,{annotations:{int:{consistency:l,env:t,operation:n}}})}catch(e){r("QPLUserFlow").endFailure(i,"error"),r("FBLogger")("wmi_eb").catching(r("getErrorSafe")(e)).mustfix("Error on trackConsistency in %s",t)}}}),S.apply(this,arguments)}function R(){return L.apply(this,arguments)}function L(){return L=n("asyncToGeneratorRuntime").asyncToGenerator(function*(){yield o("EBDB").clearDeviceState(),u=null}),L.apply(this,arguments)}var E;function k(e,t){return I.apply(this,arguments)}function I(){return I=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t,n){E!=null&&E(),yield o("ReQL").firstAsync(o("ReQL").fromTableAscending(t.tables.encrypted_backups)).then(function(e){e!=null&&((e==null?void 0:e.backupId)==null||(e==null?void 0:e.isUserOptedOut)===!0)&&R()}).catch(function(e){r("FBLogger")("wmi_eb").catching(e).mustfix("EBDBApi: EBLS error on fetching data from encrypted_backups")}),E=t.tables.encrypted_backups.subscribe(function(e,t){t.operation!=="delete"&&(t.value.backupId==null||t.value.isUserOptedOut===!0)&&R()});var a=yield o("EBDB").getEBDB(),l=yield a.runInTransaction(["device_state"],"readonly",function(e){return e.stores.device_state.get(n)},"EBDB - readDeviceState",i.id+":250").catch(function(e){r("FBLogger")("wmi_eb").catching(e).mustfix("EBDB error: fetching device_state")});if(u=T(l==null?void 0:l.deviceId),u==null){var s=yield p(t);if(s==null)return;var c=BigInt((e||(e=o("I64"))).to_string(s));u=c,yield a.runInTransaction(["device_state"],"readwrite",function(e){return e.stores.device_state.bulkPut([{deviceId:c,env:n}])},"EBDB - writeDeviceState",i.id+":272").catch(function(e){r("FBLogger")("wmi_eb").catching(e).mustfix("EBDB error: write device_state")})}}),I.apply(this,arguments)}function T(t){if(t!=null){if(typeof t=="bigint")return t;if(typeof t=="number")return BigInt(t);if(typeof t=="string")try{return BigInt(t)}catch(e){r("FBLogger")("wmi_eb").catching(r("getErrorSafe")(e)).mustfix("EBDBApi: Parsing string as BigInt"),R();return}if(Array.isArray(t))try{return BigInt((e||(e=o("I64"))).to_string(t))}catch(e){r("FBLogger")("wmi_eb").catching(r("getErrorSafe")(e)).mustfix("EBDBApi: Parsing I64 as BigInt"),R();return}r("FBLogger")("wmi_eb").mustfix("EBDBApi: Parsing unknown as BigInt %s",String(t)),R()}}l.EB_STORES=s,l.getDeviceId=c,l.addNewDevice=_,l.trackOverprompting=g,l.EBConsistencyResult=y,l.checkRegistrationConsistency=C,l.trackConsistency=v,l.clearDeviceState=R,l.startListeningDeviceRegistrations=k}),98);
__d("EBDedupeEncryptedLabyrinthMessages",["MpsTypes"],(function(t,n,r,o,a,i,l){"use strict";var e=["supplemental_protobufs","supplemental_protobufs_v2","top_level_protobuf","top_level_protobuf_unencrypted","top_level_protobuf_v2"];function s(t,n,r){return t.map(function(t){var a,i,l=t.protobuf_stanzas,s=t.otid;if(!l||s==null)return t;var u=l.supplemental_protobufs,c=l.supplemental_protobufs_v2,d=l.top_level_protobuf,m=l.top_level_protobuf_unencrypted,p=l.top_level_protobuf_v2,_=babelHelpers.objectWithoutPropertiesLoose(l,e),f=o("MpsTypes").toMessageId(s),g=n.get(f);if(g==null)return t;var h=(a=u==null?void 0:u.length)!=null?a:0,y=(i=c==null?void 0:c.length)!=null?i:0,C=!0;if(h>0||y>0){var b=u==null?void 0:u.map(function(e){return e.supplemental_otid}).filter(function(e){return e!=null}),v=new Map;if(c)for(var S of c)S.supplemental_otid!=null&&S.supplemental_key!=null&&v.set(S.supplemental_otid,S.supplemental_key);for(var R of b){var L=v.get(R);if(L==null){C=!1;break}var E=g.supplementalProtobufs.get(o("MpsTypes").toSupplementalKey(L));if(g.supplementalProtobufs.size>0&&E==null){C=!1;break}}}if(C){var k=d==null;return r.addAnnotations({bool:{missing_message_minos_restore:k}}),babelHelpers.extends({},t,{protobuf_stanzas:babelHelpers.extends({},_,{supplemental_protobufs:[],supplemental_protobufs_v2:c,top_level_protobuf:null,top_level_protobuf_unencrypted:null,top_level_protobuf_v2:p})})}return t})}l.dedupeEncryptedLabyrinthMessages=s}),98);
__d("EBDedupeLabyrinthMessages",["EBConvertMinosProtobufShape","MpsTypes"],(function(t,n,r,o,a,i,l){"use strict";function e(e){var t=new Map;return e.forEach(function(e,n){var r=o("EBConvertMinosProtobufShape").convertMinosProtobufShape(e);t.set(n,r)}),t}function s(t,n){if(n==null)return t;var r=e(n),a=[];t.forEach(function(e){if(e.otid!=null){var t=o("MpsTypes").toMessageId(e.otid),n=r.get(t);if(n!=null){var i=u(e.supplementalProtobufs,n.supplementalProtobufs);n.supplementalProtobufs=i,a.push(n),r.delete(t)}else a.push(e)}});for(var i of r.values())a.push(i);return a}function u(e,t){var n=new Map;return e.forEach(function(e,r){var o=t.get(r);o!=null?(n.set(r,o),t.delete(r)):n.set(r,e)}),t.forEach(function(e,t){n.set(t,e)}),n}l.dedupeLabyrinthMessages=s}),98);
__d("PublicKeyEncryptionUtils",["Promise","UInt8Array","XPlatReactCrypto"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(e,t){}function u(e){return e!=null?e:new Uint8Array(0).buffer}function c(e,t,n,r,a){return o("UInt8Array").concatBytes([e,t,n,r,a]).buffer}function d(e,t,n,r){return o("XPlatReactCrypto").subtleImportKey("raw",e.buffer,"HKDF",!1,["deriveKey"]).then(function(e){return o("XPlatReactCrypto").subtleDeriveKey({hash:"SHA-256",info:n,name:"HKDF",salt:t},e,{length:256,name:"AES-GCM"},!1,[r])})}var m="key length is not 32";function p(e,t){if(e.length!==32)return t(m)}function _(t){return new(e||(e=n("Promise")))(function(e,n){return p(t,n),e()})}var f=32;l.assertValidCurvePoint=s,l.getSalt=u,l.concatAad=c,l.getAesKey=d,l.testKeyLength=p,l.assertKeyLength=_,l.keyLength=f}),98);
__d("PublicEncryptionCreateDecryptedData",["CryptoLogger","Promise","PublicKeyEncryptionUtils","RetUtil","XPlatReactCrypto","requireDeferred"],(function(t,n,r,o,a,i,l){"use strict";var e,s=r("requireDeferred")("PublicKeyCrypto").__setRef("PublicEncryptionCreateDecryptedData"),u=r("requireDeferred")("X25519").__setRef("PublicEncryptionCreateDecryptedData");function c(e,t){var n=1+o("PublicKeyEncryptionUtils").keyLength+16,r=e.length;r<1+o("PublicKeyEncryptionUtils").keyLength+16&&t("CipherText length is "+r+", < "+n)}function d(e,t,n){var r=t[0];if(r!==e)return n("Unexpected version "+r)}function m(t){return new(e||(e=n("Promise")))(function(e,n){return d(1,t,n),c(t,n),e()})}function p(t,r){return new(e||(e=n("Promise")))(function(e,n){return o("PublicKeyEncryptionUtils").assertValidCurvePoint(t,n),o("PublicKeyEncryptionUtils").assertValidCurvePoint(r,n),e()})}function _(t,r,a,i,l,c){var d,_=new Uint8Array(l),f=new Uint8Array([1]),g=(d=o("PublicKeyEncryptionUtils")).getSalt(i),h=new Uint8Array(t),y=new Uint8Array(a),C=new Uint8Array(r),b=new Uint8Array(c);return(e||(e=n("Promise"))).all([o("PublicKeyEncryptionUtils").assertKeyLength(h),o("PublicKeyEncryptionUtils").assertKeyLength(C),o("PublicKeyEncryptionUtils").assertKeyLength(y)]).then(function(){return m(b)}).then(function(){return u.load()}).then(function(t){var r=b.slice(1,o("PublicKeyEncryptionUtils").keyLength+1),a=t.publicKeyFromBytes(r,t.KeyPurpose.Encryption);return p(a,y).then(function(){var i=o("PublicKeyEncryptionUtils").concatAad(f,y,h,r,_),l=function(o,i,l){var r=t.publicKeyFromBytes(o,t.KeyPurpose.Encryption),s=t.publicKeyFromBytes(i,t.KeyPurpose.Encryption),u=t.secretKeyFromBytes(l,t.KeyPurpose.Encryption);return r==null||s==null||u==null||a==null?(e||(e=n("Promise"))).resolve():(e||(e=n("Promise"))).resolve([r,s,u,a])};return l(h,y,C).then(function(e){if(e!=null)return{ephemeralPub:e[3],innerAad:i,receiverPriv:e[2],receiverPub:e[0],senderPub:e[1]}})})}).then(function(e){if(e!=null){var t=e.ephemeralPub,n=e.receiverPriv,r=e.senderPub,a=e.innerAad;return s.load().then(function(e){return e.receiverDeriveSharedSecret(n,t,r)}).then(function(e){return e==null?null:o("PublicKeyEncryptionUtils").getAesKey(e,g,a,"decrypt")}).then(function(e){if(e!=null){var t=new Uint8Array(12).buffer,n=b.slice(o("PublicKeyEncryptionUtils").keyLength+1).buffer;return o("XPlatReactCrypto").subtleDecrypt({additionalData:a,iv:new Uint8Array(t),name:"AES-GCM",tagLength:128},e,n)}})}}).then(function(t){return(e||(e=n("Promise"))).resolve(o("RetUtil").getNullableRetResult(t))}).catch(function(t){var r=o("CryptoLogger").CryptoLogger("public_encryption_create_decrypted_data");return o("CryptoLogger").captureError(r,t).mustfix("Creation of decrypted data for public encryption failed"),(e||(e=n("Promise"))).resolve(o("RetUtil").getNullableRetResult(void 0))})}l.default=_}),98);
__d("PublicEncryptionCreateEncryptedData",["CryptoLogger","Promise","PublicKeyEncryptionUtils","RetUtil","UInt8Array","XPlatReactCrypto","requireDeferred"],(function(t,n,r,o,a,i,l){"use strict";var e,s=r("requireDeferred")("PublicKeyCrypto").__setRef("PublicEncryptionCreateEncryptedData"),u=r("requireDeferred")("X25519").__setRef("PublicEncryptionCreateEncryptedData");function c(e,t){if(e.byteLength>32)return t("PSK is too long")}function d(t,r){return new(e||(e=n("Promise")))(function(e,n){return o("PublicKeyEncryptionUtils").assertValidCurvePoint(r,n),c(t,n),e()})}function m(t,r,a,i,l,c){var m,p=new Uint8Array([1]),_=new Uint8Array(l),f=(m=o("PublicKeyEncryptionUtils")).getSalt(i),g=new Uint8Array(t),h=new Uint8Array(r),y=new Uint8Array(a);return(e||(e=n("Promise"))).all([o("PublicKeyEncryptionUtils").assertKeyLength(g),o("PublicKeyEncryptionUtils").assertKeyLength(h),o("PublicKeyEncryptionUtils").assertKeyLength(y)]).then(function(){return d(f,g)}).then(function(){return u.load()}).then(function(t){var r=t.generateKeys(t.KeyPurpose.Encryption),a=r.pk,i=o("PublicKeyEncryptionUtils").concatAad(p,h,g,a,_),l=function(o,a,i){var r=t.publicKeyFromBytes(o,t.KeyPurpose.Encryption),l=t.publicKeyFromBytes(a,t.KeyPurpose.Encryption),s=t.secretKeyFromBytes(i,t.KeyPurpose.Encryption);return r==null||l==null||s==null?(e||(e=n("Promise"))).resolve():(e||(e=n("Promise"))).resolve([r,l,s])};return l(g,h,y).then(function(e){return e==null?null:{ephemeralPriv:r.sk,ephemeralPubBytes:r.pk,innerAad:i,receiverPub:e[0],senderPriv:e[2],senderPub:e[1]}})}).then(function(e){if(e!=null){var t=e.ephemeralPubBytes,n=e.ephemeralPriv,r=e.senderPriv,a=e.receiverPub,i=e.innerAad;return s.load().then(function(e){return e.senderDeriveSharedSecret(r,n,a)}).then(function(e){if(e!=null)return o("PublicKeyEncryptionUtils").getAesKey(e,f,i,"encrypt")}).then(function(e){if(e!=null){var t=new Uint8Array(12).buffer;return o("XPlatReactCrypto").subtleEncrypt({additionalData:i,iv:new Uint8Array(t),name:"AES-GCM",tagLength:128},e,c)}}).then(function(e){if(e!=null){var n=new Uint8Array(e);return o("UInt8Array").concatBytes([p,t,n]).buffer}})}}).then(function(t){return(e||(e=n("Promise"))).resolve(o("RetUtil").getNullableRetResult(t))}).catch(function(t){var r=o("CryptoLogger").CryptoLogger("public_encryption_create_encrypted_data");return o("CryptoLogger").captureError(r,t).mustfix("Creation of encrypted data for public encryption failed"),(e||(e=n("Promise"))).resolve(o("RetUtil").getNullableRetResult(void 0))})}l.default=m}),98);
__d("EBEpochUtils",["Base64Utils","EBCryptoUtils","FBLogger","I64","Promise","PublicEncryptionCreateDecryptedData","PublicEncryptionCreateEncryptedData","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u="epoch_chaining",c="epoch_root_key",d="epoch_data_storage",m="epoch_data_metadata",p=18;function _(e){var t=new TextEncoder().encode("0").buffer;if(e==null||e.byteLength===0)return t;var n=new TextDecoder,o=n.decode(e),a=Number.parseInt(o,10);if(Number.isNaN(a))throw r("FBLogger")("messenger_web").mustfixThrow("currentEpochInt is NaN");var i=a+1;return new TextEncoder().encode(i.toString()).buffer}function f(e,t,n){return g.apply(this,arguments)}function g(){return g=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t,n){var a,i=[(a=o("EBCryptoUtils")).KEY_LEN,a.KEY_LEN],l=a.getBlobFromString([u,e,(s||(s=o("I64"))).to_string(t)].join(o("EBCryptoUtils").STRING_JOIN_SEPARATOR));if(l==null)throw r("FBLogger")("messenger_web").mustfixThrow("infoForEpochChaining is empty");var c=yield o("EBCryptoUtils").createDerivedKeys(l,null,n,i);return{epoch_chaining_key:c[0],epoch_distribution_pre_shared_key:c[1]}}),g.apply(this,arguments)}function h(e,t,n,r,o,a){return y.apply(this,arguments)}function y(){return y=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t,n,o,a,i){var l=yield r("PublicEncryptionCreateDecryptedData")(e,t,n,o,v(a),i);return l[0]}),y.apply(this,arguments)}function C(e,t,n,r,o,a){return b.apply(this,arguments)}function b(){return b=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t,n,o,a,i){var l=yield r("PublicEncryptionCreateEncryptedData")(e,t,n,o,v(a),i);return l[0]}),b.apply(this,arguments)}function v(e){return new TextEncoder().encode(["epoch_",e].join(o("EBCryptoUtils").STRING_JOIN_SEPARATOR)).buffer}function S(e,t,n,r){return R.apply(this,arguments)}function R(){return R=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t,n,r){var a=yield o("EBCryptoUtils").createDerivedKeys(e,t,n,r);return a[0]}),R.apply(this,arguments)}function L(e,t){var n=o("EBCryptoUtils").getBlobFromString(c);if(n==null)throw r("FBLogger")("messenger_web").mustfixThrow("epochRootKey is empty");return S(n,e,t,[o("EBCryptoUtils").KEY_LEN])}function E(e,t){var n=new TextEncoder().encode("meb/debug/fingerprint/"+t).buffer;if(n==null)throw r("FBLogger")("messenger_web").mustfixThrow("blob type for which fingerprints are supported is empty");return S(n,null,e,[p])}function k(e,t,n){return I.apply(this,arguments)}function I(){return I=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t,r,a){var i=[o("EBCryptoUtils").KEY_LEN],l=o("Base64Utils").fromArrayBuffer(r),s=[t,l].join(o("EBCryptoUtils").STRING_JOIN_SEPARATOR),u=yield o("EBCryptoUtils").createDerivedKeys(new TextEncoder().encode(s).buffer,null,a,i);return u.length===0?(e||(e=n("Promise"))).resolve():u[0]}),I.apply(this,arguments)}function T(e){return k(d,e.epochAnonIdBlob,e.epochRootKeyBlob)}function D(e,t){return x.apply(this,arguments)}function x(){return x=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t){var n=yield $(t,e,m);if(n==null)throw r("FBLogger")("messenger_web").mustfixThrow("symmetricDecryptAndBase64Decode output is empty while decrypting backward edge");return o("Base64Utils").toArrayBuffer(n)}),x.apply(this,arguments)}function $(e,t,n){return P.apply(this,arguments)}function P(){return P=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t,n){var a=new TextEncoder().encode(n).buffer;if(a==null)throw r("FBLogger")("messenger_web").mustfixThrow("aadBuffer is empty");var i=yield o("EBCryptoUtils").symmetricEncryptionCreateDecryptedString(t,a,e);if(i==null)throw r("FBLogger")("messenger_web").mustfixThrow("decrypted_arraybuffer is empty");return new TextDecoder().decode(i)}),P.apply(this,arguments)}l.getNextEpochId=_,l.generateEpochChainingAndDistributionPreSharedKey=f,l.decryptEpochKey=h,l.generateEncryptedEpochKey=C,l.deriveKey=S,l.generateEpochRootKey=L,l.getFingerPrint=E,l.createDerivedKeysForEpoch=k,l.deriveBackwardEdgeKey=T,l.decryptBackwardEdge=D}),98);
__d("LSEpochStatus",[],(function(t,n,r,o,a,i){var e=Object.freeze({ES_OPEN:1,ES_CLOSE:2});i.default=e}),66);
__d("MEBEpochDerivationResult",[],(function(t,n,r,o,a,i){var e=Object.freeze({SUCCESS:0,UNKNOWN_ERROR:1,EDGE_NEITHER_FORWARD_NOR_BACKWARD:2,FORWARD_DECRYPTION_FAILED:3,FORWARD_SOURCE_EPOCH_NOT_FOUND_DEPRECATED:4,BACKWARD_SOURCE_EPOCH_NOT_FOUND_DEPRECATED:5,BACKWARD_DECRYPTION_FAILED:6,MISSING_CLIENT_STATE:7,DEVICE_ID_MISMATCH:8,SOURCE_FINGERPRINT_MISMATCH:9,DEST_FINGERPRINT_MISMATCH:10,STORAGE_KEY_MISMATH:11,PSK_FINGERPRINT_MISMATCH:12,SOURCE_EPOCH_NOT_FOUND:13,FORWARD_EDGE_NOT_CONSECUTIVE:14,BACKWARD_EDGE_NOT_CONSECUTIVE:15,DERIVATION_DEST_EXISTS:16,DERIVATION_DEST_ANON_ID_EXISTS:17});i.default=e}),66);
__d("EBDeriveAndStoreEpochs",["Base64Utils","EBBase64Decode","EBEpochUtils","I64","LSAuthorityLevel","LSEpochStatus","MEBEpochDerivationResult","ReQL","WACryptoUtils","WAResultOrError","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(e,t,n,r){return u.apply(this,arguments)}function u(){return u=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t,n,a,i){var l,s,u,c,d=yield o("EBEpochUtils").getNextEpochId(i.epochAnonIdBlob),m=a==null||(l=a.to_epoch)==null?void 0:l.epoch_anon_id;if(m==null)return o("WAResultOrError").makeError({errorMessage:"epoch forward edge target epoch anon id is null",resultCode:r("MEBEpochDerivationResult").FORWARD_EDGE_NOT_CONSECUTIVE});var p=r("EBBase64Decode")(m);if(new TextDecoder().decode(d)!==new TextDecoder().decode(p))return o("WAResultOrError").makeError({errorMessage:"epoch forward edge not consecutive",resultCode:r("MEBEpochDerivationResult").FORWARD_EDGE_NOT_CONSECUTIVE});var _=a==null||(s=a.from_epoch)==null?void 0:s.epoch_id,f=a==null||(u=a.from_epoch)==null?void 0:u.epoch_anon_id;if(_==null||f==null)return o("WAResultOrError").makeError({errorMessage:"fromEpochId or fromEpochAnonId is null",resultCode:r("MEBEpochDerivationResult").SOURCE_EPOCH_NOT_FOUND});var g=r("EBBase64Decode")(f),h=new TextDecoder().decode(g),y=yield o("EBEpochUtils").generateEpochChainingAndDistributionPreSharedKey(h,(e||(e=o("I64"))).of_string(_),i.epochRootKeyBlob),C=y.epoch_distribution_pre_shared_key,b=yield o("EBEpochUtils").getFingerPrint(C,"MEBCryptoPreSharedKey");if((n==null?void 0:n.psk_fingerprint)!==o("Base64Utils").fromArrayBuffer(b))return o("WAResultOrError").makeError({errorMessage:"epoch forward edge psk fingerprint mismatch",resultCode:r("MEBEpochDerivationResult").PSK_FINGERPRINT_MISMATCH});var v=n==null?void 0:n.epoch_storage_public_key;if(o("Base64Utils").fromArrayBuffer(t.epochStoragePublicKeyBlob)!==v)return o("WAResultOrError").makeError({errorMessage:"epoch forward edge storage key mismatch",resultCode:r("MEBEpochDerivationResult").STORAGE_KEY_MISMATH});var S=n==null?void 0:n.auth_public_key;if(S==null)return o("WAResultOrError").makeError({errorMessage:"epoch forward edge auth public key is null",resultCode:r("MEBEpochDerivationResult").FORWARD_SOURCE_EPOCH_NOT_FOUND_DEPRECATED});var R=a==null||(c=a.to_epoch)==null?void 0:c.epoch_anon_id;if(R==null)return o("WAResultOrError").makeError({errorMessage:"epoch forward edge target epoch anon id is null",resultCode:r("MEBEpochDerivationResult").FORWARD_SOURCE_EPOCH_NOT_FOUND_DEPRECATED});var L=n==null?void 0:n.encrypted_entropy;if(L==null)return o("WAResultOrError").makeError({errorMessage:"epoch forward edge encrypted entropy is null",resultCode:r("MEBEpochDerivationResult").FORWARD_SOURCE_EPOCH_NOT_FOUND_DEPRECATED});var E=r("EBBase64Decode")(S);if(E==null)return o("WAResultOrError").makeError({errorMessage:"epoch forward edge auth public key is null",resultCode:r("MEBEpochDerivationResult").FORWARD_SOURCE_EPOCH_NOT_FOUND_DEPRECATED});var k=r("EBBase64Decode")(L);if(k==null)return o("WAResultOrError").makeError({errorMessage:"epoch forward edge encrypted entropy is null",resultCode:r("MEBEpochDerivationResult").FORWARD_SOURCE_EPOCH_NOT_FOUND_DEPRECATED});var I=r("EBBase64Decode")(R),T=new TextDecoder().decode(I),D=yield o("EBEpochUtils").decryptEpochKey(t.epochStoragePublicKeyBlob,t.epochStoragePrivateKeyBlob,E,C,T,k);return D==null?o("WAResultOrError").makeError({errorMessage:"epoch forward edge entropy is null",resultCode:r("MEBEpochDerivationResult").FORWARD_DECRYPTION_FAILED}):o("WAResultOrError").makeResult(yield o("EBEpochUtils").generateEpochRootKey(y.epoch_chaining_key,D))}),u.apply(this,arguments)}function c(e,t,n){return d.apply(this,arguments)}function d(){return d=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t,n){var a,i=t==null||(a=t.to_epoch)==null?void 0:a.epoch_anon_id;if(i==null)return o("WAResultOrError").makeError({errorMessage:"toEpochId is null",resultCode:r("MEBEpochDerivationResult").BACKWARD_SOURCE_EPOCH_NOT_FOUND_DEPRECATED});var l=o("EBEpochUtils").getNextEpochId(r("EBBase64Decode")(i));if(!o("WACryptoUtils").arrayBuffersEqual(l,e.epochAnonIdBlob))return o("WAResultOrError").makeError({errorMessage:"epoch backward edge not consecutive",resultCode:r("MEBEpochDerivationResult").BACKWARD_EDGE_NOT_CONSECUTIVE});var s=yield o("EBEpochUtils").deriveBackwardEdgeKey(e);return s==null?o("WAResultOrError").makeError({errorMessage:"epoch backward edge storage key is null",resultCode:r("MEBEpochDerivationResult").STORAGE_KEY_MISMATH}):o("WAResultOrError").makeResult(yield o("EBEpochUtils").decryptBackwardEdge(s,n))}),d.apply(this,arguments)}function m(e,t){return p.apply(this,arguments)}function p(){return p=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t,n){var a,l,u,d,m=yield t.runInTransaction(function(e){return o("ReQL").firstAsync(o("ReQL").fromTableAscending(e.secure_encrypted_backups_client_state))},"readwrite",void 0,void 0,i.id+":224");if(m==null)return o("WAResultOrError").makeError({errorMessage:"client state is missing",resultCode:r("MEBEpochDerivationResult").MISSING_CLIENT_STATE});var p=n==null||(a=n.from_epoch)==null?void 0:a.epoch_id;if(p==null)return o("WAResultOrError").makeError({errorMessage:"fromEpochId is null",resultCode:r("MEBEpochDerivationResult").SOURCE_EPOCH_NOT_FOUND});var _=yield t.runInTransaction(function(t){return t.secure_encrypted_backups_epochs.get((e||(e=o("I64"))).of_string(p))},"readwrite",void 0,void 0,i.id+":242");if(_==null)return o("WAResultOrError").makeError({errorMessage:"source epoch is missing",resultCode:r("MEBEpochDerivationResult").SOURCE_EPOCH_NOT_FOUND});var f=n==null||(l=n.from_epoch)==null?void 0:l.epoch_anon_id;if(f==null)return o("WAResultOrError").makeError({errorMessage:"fromEpochId or fromEpochAnonId is null",resultCode:r("MEBEpochDerivationResult").SOURCE_EPOCH_NOT_FOUND});var g=r("EBBase64Decode")(f);if(new TextDecoder().decode(_.epochAnonIdBlob)!==new TextDecoder().decode(g))return o("WAResultOrError").makeError({errorMessage:"epoch derivation source epoch anon id mismatch",resultCode:r("MEBEpochDerivationResult").SOURCE_FINGERPRINT_MISMATCH});var h=n==null?void 0:n.from_epoch_fingerprint,y=yield o("EBEpochUtils").getFingerPrint(_.epochRootKeyBlob,"MEBEpochRootKey");if(o("Base64Utils").fromArrayBuffer(y)!==h)return o("WAResultOrError").makeError({errorMessage:"epoch derivation source epoch fingerprint mismatch",resultCode:r("MEBEpochDerivationResult").SOURCE_FINGERPRINT_MISMATCH});var C=n==null?void 0:n.forward_edge,b;if(C!=null)b=yield s(m,C,n,_);else{var v=n==null?void 0:n.backward_edge;if(v==null)return o("WAResultOrError").makeError({errorMessage:"backward edge is null",resultCode:r("MEBEpochDerivationResult").BACKWARD_SOURCE_EPOCH_NOT_FOUND_DEPRECATED});b=yield c(_,n,v)}var S=n==null?void 0:n.to_epoch_fingerprint,R=b.value,L=n==null||(u=n.to_epoch)==null?void 0:u.epoch_id,E=n==null||(d=n.to_epoch)==null?void 0:d.epoch_anon_id;if(L==null||E==null)return o("WAResultOrError").makeError({errorMessage:"target epoch id or anon id is null",resultCode:r("MEBEpochDerivationResult").FORWARD_SOURCE_EPOCH_NOT_FOUND_DEPRECATED});if(R==null)return b;var k=yield o("EBEpochUtils").getFingerPrint(R,"MEBEpochRootKey");if(S!==o("Base64Utils").fromArrayBuffer(k))return o("WAResultOrError").makeError({errorMessage:"epoch derivation target epoch fingerprint mismatch",resultCode:r("MEBEpochDerivationResult").DEST_FINGERPRINT_MISMATCH});var I=r("EBBase64Decode")(E);return yield t.runInTransaction(function(t){return t.secure_encrypted_backups_epochs.put({authorityLevel:(e||(e=o("I64"))).of_float(r("LSAuthorityLevel").AUTHORITATIVE),backupId:m.backupId,epochAnonIdBlob:I,epochId:e.of_string(L),epochRootKeyBlob:R,epochStatus:e.of_float(r("LSEpochStatus").ES_CLOSE)})},"readwrite",void 0,void 0,i.id+":331"),o("WAResultOrError").makeResult(R)}),p.apply(this,arguments)}function _(e,t){return f.apply(this,arguments)}function f(){return f=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t){if((t==null?void 0:t.epoch_edges)==null)return[];var n=[];for(var o of t.epoch_edges){var a,i,l,s,u,c=yield m(e,o),d={resultForEpochSync:{error_message:(a=c.error)==null?void 0:a.errorMessage,from:{epoch_anon_id:(i=o.from_epoch)==null?void 0:i.epoch_anon_id,epoch_id:o==null||(l=o.from_epoch)==null?void 0:l.epoch_id},has_backward_edge:(o==null?void 0:o.backward_edge)!=null,has_forward_edge:(o==null?void 0:o.forward_edge)!=null,result_code:c.success?r("MEBEpochDerivationResult").SUCCESS:c.error.resultCode,to:{epoch_anon_id:o==null||(s=o.to_epoch)==null?void 0:s.epoch_anon_id,epoch_id:o==null||(u=o.to_epoch)==null?void 0:u.epoch_id}}};n.push(d)}return n}),f.apply(this,arguments)}l.deriveAndStoreEpochsNonLS=_}),98);
__d("EBEpochChangeListener",["EBIsEbEnabled","EBIsEbEnabledSubscriber","Promise","ReQL","WAPubSub","asyncToGeneratorRuntime","err"],(function(t,n,r,o,a,i,l){"use strict";var e,s=(function(){function e(e){this.$1=o("WAPubSub").simplePubSub(),this.$3=e}var t=e.prototype;return t.initialize=(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(){var e=this;(yield o("EBIsEbEnabled").isEbEnabledLS(this.$3.tables))&&this.$4(this.$3),yield o("EBIsEbEnabledSubscriber").isEbEnabledSubscriber().then(function(t){t.subscribe(function(t){t?e.$4(e.$3):e.$2==null||e.$2()})})});function t(){return e.apply(this,arguments)}return t})(),t.$4=function(t){var e=this;return this.$2==null&&(this.$2=o("ReQL").fromTableAscending(t.tables.secure_encrypted_backups_epochs).subscribe(function(t,n){e.$1.publish(n)})),this.$2},t.subscribe=function(t){return this.$1.subscribe(t)},e})(),u;function c(e){return d.apply(this,arguments)}function d(){return d=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){if(u!=null)return(e||(e=n("Promise"))).resolve();u=new s(t),yield u.initialize()}),d.apply(this,arguments)}function m(e){if(u==null)throw r("err")("EBEpochChangeListener is not initialized");return u.subscribe(e)}l.initEBEpochChangeListener=c,l.subscribeToEpochChanges=m}),98);
__d("EBMinosEncryptedMekVersion",["$InternalEnum","gkx"],(function(t,n,r,o,a,i,l){"use strict";var e=n("$InternalEnum")({V1:1,V2:2}),s=e.V1,u=r("gkx")("19417")?e.V2:e.V1;l.MinosEncryptedMekVersion=e,l.INITIAL_VERSION=s,l.MINOS_ENCRYPTED_MEK_CURRENT_VERSION=u}),98);
__d("EBMinosClientConfig",["EBMinosEncryptedMekVersion","EBMinosMessageEncryptionVersion"],(function(t,n,r,o,a,i,l){"use strict";var e={preferredMekEncryptionVersion:o("EBMinosEncryptedMekVersion").MINOS_ENCRYPTED_MEK_CURRENT_VERSION,preferredMessageEncryptionVersion:o("EBMinosMessageEncryptionVersion").MINOS_MESSAGE_ENCRYPTION_CURRENT_VERSION};l.MINOS_CLIENT_CONFIG=e}),98);
__d("EBMinosWasmEncryptMekForDistribution",["EBMinosClientConfig","EBMinosEncryptedMekVersion","EBMinosLogger","EBMinosTypes","EBMinosWasm.pb","EBMinosWasmReactorSingleton","WALongInt","WAResultOrError","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(){function t(t){var n=t.ciphertext,r=t.version,a=o("WALongInt").maybeNumberOrThrowIfTooLarge(r);if(a==null)return o("WAResultOrError").makeError("missing-mek-encryption-version");var i=o("EBMinosEncryptedMekVersion").MinosEncryptedMekVersion.cast(a);return i==null?(o("EBMinosLogger").minosLogger.ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Failed to cast encrypted mek version: ",""])),a),o("WAResultOrError").makeError("invalid-mek-encryption-version")):o("WAResultOrError").makeResult({encryptedMek:o("EBMinosTypes").unsafeCastToEncryptedMek(n),mekEncryptionVersion:i})}return(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var n=e.fromKeypair,r=e.mek,a=e.senderEpochHead,i=e.toEpochHead,l=e.toMailboxPk;return yield o("EBMinosWasmReactorSingleton").DEPRECATED_minosCommand({InputSpec:o("EBMinosWasm.pb").MinosCommandSpec,ResultSpec:o("EBMinosWasm.pb").EncryptMekForDistributionResultSpec,validateResult:t},{encryptMekForDistribution:{conf:o("EBMinosClientConfig").MINOS_CLIENT_CONFIG,fromKeypair:n,mek:r,senderEpochHead:a,toEpochHead:i,toMailboxPk:l}})});function r(t){return e.apply(this,arguments)}return r})()}var u=s();l.encryptMekForDistribution=u}),98);
__d("EBMinosWasmEncryptMeksForDistributionFromTransportSender",["EBMinosClientConfig","EBMinosEncryptedMekVersion","EBMinosLogger","EBMinosTypes","EBMinosWasm.pb","EBMinosWasmReactorSingleton","WALongInt","WAResultOrError","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(){function t(t){var n=t.encryptedMeks,r=t.ephemeralEncryptionPk,a=t.signature,i=t.signingPk,l=t.version,s=o("WALongInt").maybeNumberOrThrowIfTooLarge(l);if(s==null)return o("WAResultOrError").makeError("missing-mek-encryption-version");var u=o("EBMinosEncryptedMekVersion").MinosEncryptedMekVersion.cast(s);return u==null?(o("EBMinosLogger").minosLogger.ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Failed to cast encrypted mek version: ",""])),s),o("WAResultOrError").makeError("invalid-mek-encryption-version")):o("WAResultOrError").makeResult({encryptedMeks:n.map(o("EBMinosTypes").unsafeCastToEncryptedMek),encryptedMekVersion:u,ephemeralEncryptionPk:o("EBMinosTypes").unsafeCastToTransportSenderEphemeralPK(r),signature:o("EBMinosTypes").unsafeCastToTransportSenderEphemeralKeySig(a),signingPk:o("EBMinosTypes").unsafeCastToTransportSigningPK(i)})}return(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var n=e.mek,r=e.recipientEpochHeads,a=e.recipientMailboxEncryptionPks,i=e.transportSigningKp;return yield o("EBMinosWasmReactorSingleton").DEPRECATED_minosCommand({InputSpec:o("EBMinosWasm.pb").MinosCommandSpec,ResultSpec:o("EBMinosWasm.pb").EncryptMeksForDistributionFromTransportSenderResultSpec,validateResult:t},{encryptMeksForDistributionFromTransportSender:{conf:o("EBMinosClientConfig").MINOS_CLIENT_CONFIG,mek:n,recipientEpochHeads:r,recipientMailboxEncryptionPks:a,transportSigningKp:i}})});function r(t){return e.apply(this,arguments)}return r})()}var u=s();l.createMinosWasmEncryptMeksForDistributionFromTransportSender=s,l.encryptMeksForDistributionFromTransportSender=u}),98);
__d("EBMinosWasmGenerateMek",["EBMinosTypes","EBMinosWasm.pb","EBMinosWasmReactorSingleton","WAResultOrError","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";function e(){function e(e){var t=e.mek;return o("WAResultOrError").makeResult({key:o("EBMinosTypes").unsafeCastMekKey(t.key),mekId:o("EBMinosTypes").unsafeCastToMekId(t.mekId),rosterHash:o("EBMinosTypes").unsafeCastMekRosterHash(t.rosterHash)})}return(function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var n=t.epochHeads;return yield o("EBMinosWasmReactorSingleton").DEPRECATED_minosCommand({InputSpec:o("EBMinosWasm.pb").MinosCommandSpec,ResultSpec:o("EBMinosWasm.pb").GenerateMekResultSpec,validateResult:e},{generateMek:{epochHeads:n}})});function r(e){return t.apply(this,arguments)}return r})()}var s=e();l.generateMek=s}),98);
__d("WAPromiseMap",["Promise"],(function(t,n,r,o,a,i){"use strict";var e;function l(t,r){return(e||(e=n("Promise"))).resolve(t).then(function(t){return(e||(e=n("Promise"))).all(t.map(function(e,t){return r(e,t)}))})}i.promiseMap=l}),66);
__d("EBGenerateAndUploadMek",["EBMinosEncryptedMekVersion","EBMinosWasmEncryptMekForDistribution","EBMinosWasmEncryptMeksForDistributionFromTransportSender","EBMinosWasmGenerateMek","WAErrorMessage","WAPromiseMap","WAResultOrError","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e=["mekEncryptionVersion","mekEnvelopes"],s,u,c,d,m,p,_,f,g,h,y,C,b;function v(e){return S.apply(this,arguments)}function S(){return S=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var n=t.actThreadId,r=t.io,a=t.logger,i=t.msgUploadQpl,l=t.participantMailboxes,f=t.sender;a.DEV(s||(s=babelHelpers.taggedTemplateLiteralLoose(["start generate and upload mek"]))),i.addPoint("generate_mek_start");var g=l.map(function(e){var t=e.epochHead;return t}),h=yield o("EBMinosWasmGenerateMek").generateMek({epochHeads:g});if(!h.success)return a.ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["mek generated error: ",""])),h.error),o("WAResultOrError").makeError("generate-mek-error");i.addPoint("generate_mek_end"),a.DEV(c||(c=babelHelpers.taggedTemplateLiteralLoose(["Sender type: ",". Epoch FBID: ",""])),f.senderType,f.senderEpochFbId),i.addPoint("get_minos_mailbox_key_end",{string:{senderType:f.senderType}}),a.DEV(d||(d=babelHelpers.taggedTemplateLiteralLoose(["start encrypy mek. senderType: ",""])),f.senderType),i.addPoint("encrypt_mek_envelopes_start");var y=h.value,C=yield f.senderType==="Minos"?R({fromKeypair:f.fromKeypair,logger:a,mek:y,participantMailboxes:l,senderEpochFbId:f.senderEpochFbId,senderEpochHead:f.senderEpochHead}):E({logger:a,mek:y,participantMailboxes:l,transportSigningKp:f.transportSigningKp});if(!C.success)return i.addPoint("encrypt_mek_envelopes_fail"),o("WAResultOrError").makeError("encrypt-mek-error");i.addPoint("encrypt_mek_envelopes_end");var b=C.value,v=b.mekEncryptionVersion,S=b.mekEnvelopes,L=babelHelpers.objectWithoutPropertiesLoose(b,e);i.addAnnotations({int:{mek_encryption_version:v}}),i.addPoint("register_mek_gql_start");var k=yield r.registerMinosMessageEncryptionKey({actThreadId:n,instanceKey:i.getInstanceKey(),mekEncryptionVersion:v,mekEnvelopes:S,mekId:y.mekId,mekRosterHash:y.rosterHash,sender:L}).catch(function(e){var t=o("WAErrorMessage").maybeGetMessageFromError(e);return a.ERROR(m||(m=babelHelpers.taggedTemplateLiteralLoose(["upload mek runtime-error: ",". ",""])),t,e),o("WAResultOrError").makeError({errorName:"runtime-error",failReason:t})});if(k.success!==!0){var I=k.error,T=I.errorName,D=I.failReason;return a.ERROR(p||(p=babelHelpers.taggedTemplateLiteralLoose(["upload mek error: ",". Reason: ",""])),T,D),i.addPoint("register_mek_gql_fail"),o("WAResultOrError").makeError("distribute-mek-error")}return i.addPoint("register_mek_gql_end"),a.DEV(_||(_=babelHelpers.taggedTemplateLiteralLoose(["register minos message encryption key success"]))),o("WAResultOrError").makeResult({mek:y,mekFbid:k.value.mekFbid})}),S.apply(this,arguments)}function R(e){return L.apply(this,arguments)}function L(){return L=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=e.fromKeypair,r=e.logger,a=e.mek,i=e.participantMailboxes,l=e.senderEpochFbId,s=e.senderEpochHead,u=o("EBMinosEncryptedMekVersion").INITIAL_VERSION,c=yield o("WAPromiseMap").promiseMap(i,(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var n=e.epochHead,i=e.mailboxKey,l=e.mailboxKeyFbid,c=e.participantId,d=yield o("EBMinosWasmEncryptMekForDistribution").encryptMekForDistribution({fromKeypair:t,mek:a,senderEpochHead:s,toEpochHead:n,toMailboxPk:i});if(!d.success)return r.ERROR(f||(f=babelHelpers.taggedTemplateLiteralLoose(["mek encryption error: ",""])),d.error),null;var m=d.value.mekEncryptionVersion;if(m!=null)u=m;else return r.ERROR(g||(g=babelHelpers.taggedTemplateLiteralLoose(["invalid encryptedMekVersion: ",""])),d.value.mekEncryptionVersion),null;return{encryptedMek:d.value.encryptedMek,mailboxKey:i,mailboxKeyFbid:l,participantId:c}});return function(t){return e.apply(this,arguments)}})()),d=c.filter(Boolean);return d.length===0?(r.ERROR(h||(h=babelHelpers.taggedTemplateLiteralLoose(["no successful mek encryption results"]))),o("WAResultOrError").makeError("encrypt-mek-error")):o("WAResultOrError").makeResult({epochFbId:l,mekEncryptionVersion:u,mekEnvelopes:d,senderType:"Minos"})}),L.apply(this,arguments)}function E(e){return k.apply(this,arguments)}function k(){return k=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=e.logger,n=e.mek,r=e.participantMailboxes,a=e.transportSigningKp,i=yield o("EBMinosWasmEncryptMeksForDistributionFromTransportSender").encryptMeksForDistributionFromTransportSender({mek:n,recipientEpochHeads:r.map(function(e){var t=e.epochHead;return t}),recipientMailboxEncryptionPks:r.map(function(e){var t=e.mailboxKey;return t}),transportSigningKp:a});if(!i.success)return t.ERROR(y||(y=babelHelpers.taggedTemplateLiteralLoose(["mek encryption error: ",""])),i.error),o("WAResultOrError").makeError("encrypt-mek-error");if(i.value.encryptedMeks.length!==r.length)return t.ERROR(C||(C=babelHelpers.taggedTemplateLiteralLoose(["number of encrypted meks does not match number of participants"]))),o("WAResultOrError").makeError("encrypt-mek-error");var l=o("EBMinosEncryptedMekVersion").INITIAL_VERSION,s=r.map(function(e,n){var r=i.value.encryptedMekVersion;if(r!=null)l=r;else return t.ERROR(b||(b=babelHelpers.taggedTemplateLiteralLoose(["invalid encryptedMekVersion: ",""])),i.value.encryptedMekVersion),null;return{encryptedMek:i.value.encryptedMeks[n],mailboxKey:e.mailboxKey,mailboxKeyFbid:e.mailboxKeyFbid,participantId:e.participantId}}),u=s.filter(Boolean);return o("WAResultOrError").makeResult({ephemeralEncryptionPk:i.value.ephemeralEncryptionPk,mekEncryptionVersion:l,mekEnvelopes:u,senderType:"Transport",signature:i.value.signature,signingPk:i.value.signingPk})}),k.apply(this,arguments)}l.generateAndUploadMek=v}),98);
__d("EBGenerateMessageTags",["EncryptedBackupsUploadEntity","MSGDataclassTypes.flow"],(function(t,n,r,o,a,i,l){"use strict";function e(e){switch(e){case o("EncryptedBackupsUploadEntity").AttachmentContextMediaType.IMAGE:return o("MSGDataclassTypes.flow").MpsMessageTag.Photo;case o("EncryptedBackupsUploadEntity").AttachmentContextMediaType.VIDEO:return o("MSGDataclassTypes.flow").MpsMessageTag.Video;case o("EncryptedBackupsUploadEntity").AttachmentContextMediaType.GIF:return o("MSGDataclassTypes.flow").MpsMessageTag.Gif;case o("EncryptedBackupsUploadEntity").AttachmentContextMediaType.PTT:return o("MSGDataclassTypes.flow").MpsMessageTag.Audio;case o("EncryptedBackupsUploadEntity").AttachmentContextMediaType.DOCUMENT:return o("MSGDataclassTypes.flow").MpsMessageTag.File;default:return null}}l.generateEBMessageTags=e}),98);
__d("EBGetClientState",["EBLogger","EBMinosInterfaceTypes","I64","LSAuthorityLevel","LSIntEnum","ReQL","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u;function c(e,t){return d.apply(this,arguments)}function d(){return d=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t,n){var a=n!=null?yield o("ReQL").firstAsync(o("ReQL").fromTableAscending(n.secure_encrypted_backups_client_state)):yield o("ReQL").firstAsync(o("ReQL").fromTableAscending(t.tables.secure_encrypted_backups_client_state)),i=n!=null?yield o("ReQL").toArrayAsync(o("ReQL").fromTableAscending(n.secure_encrypted_backups_epochs)):yield o("ReQL").toArrayAsync(o("ReQL").fromTableAscending(t.tables.secure_encrypted_backups_epochs)),l=i.filter(function(e){return(s||(s=o("I64"))).equal(e.authorityLevel,(u||(u=o("LSIntEnum"))).ofNumber(r("LSAuthorityLevel").AUTHORITATIVE))}).map(function(e){return(s||(s=o("I64"))).to_string(e.epochId)});if(a==null){o("EBLogger").EBLogger("wmi").MUSTFIX(e||(e=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth][web Client state is null - unable to proceed with GQL restore"])));return}var c=(a==null?void 0:a.deviceId)!=null?o("EBMinosInterfaceTypes").unsafeCastToDeviceId((s||(s=o("I64"))).to_string(a==null?void 0:a.deviceId)):null,d=a.mailboxRootKeyBlob,m=a.ocmfClientStateBlob,p=o("EBMinosInterfaceTypes").unsafeCastToBackupFbid((s||(s=o("I64"))).to_string(a.backupId)),_=a.encryptionVersion;return{backupId:p,deviceId:c,encryptionVersion:_,locally_available_epochs:l,mailboxRootKey:d,ocmfClientStateBlob:m}}),d.apply(this,arguments)}l.getClientState=c}),98);
__d("EBMinosWasmDeriveAttachmentAccessTokenSecret",["EBMinosTypes","EBMinosWasm.pb","EBMinosWasmReactorSingleton","WAResultOrError","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";function e(){function e(e){var t=e.attachmentAccessTokenSecret;return o("WAResultOrError").makeResult(o("EBMinosTypes").unsafeCastToAttachmentAccessTokenSecret(t))}return(function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var n=t.mediaKey;return yield o("EBMinosWasmReactorSingleton").DEPRECATED_minosCommand({InputSpec:o("EBMinosWasm.pb").MinosCommandSpec,ResultSpec:o("EBMinosWasm.pb").DeriveAttachmentAccessTokenSecretResultSpec,validateResult:e},{deriveAttachmentAccessTokenSecret:{mediaKey:n}})});function r(e){return t.apply(this,arguments)}return r})()}var s=e();l.deriveAttachmentAccessTokenSecret=s}),98);
__d("EBMinosWasmDeriveAttachmentPrimaryKeySecret",["EBMinosTypes","EBMinosWasm.pb","EBMinosWasmReactorSingleton","WAResultOrError","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";function e(){function e(e){var t=e.attachmentPrimaryKeySecret;return o("WAResultOrError").makeResult(o("EBMinosTypes").unsafeCastToAttachmentPrimaryKeySecret(t))}return(function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var n=t.mediaKey;return yield o("EBMinosWasmReactorSingleton").DEPRECATED_minosCommand({InputSpec:o("EBMinosWasm.pb").MinosCommandSpec,ResultSpec:o("EBMinosWasm.pb").DeriveAttachmentPrimaryKeySecretResultSpec,validateResult:e},{deriveAttachmentPrimaryKeySecret:{mediaKey:n}})});function r(e){return t.apply(this,arguments)}return r})()}var s=e();l.deriveAttachmentPrimaryKeySecret=s}),98);
__d("EBGetMinosAttachmentPayloadFromMpsMessage",["EBMinosTypes","EBMinosWasmDeriveAttachmentAccessTokenSecret","EBMinosWasmDeriveAttachmentPrimaryKeySecret","MpsMessageToBridgeWrapper","Promise","WAMediaUtils","WAResultOrError","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p;function _(e){var t,r,a=e.logger,i=e.message,l=e.qplFlow,s=o("MpsMessageToBridgeWrapper").MpsMessageToBridgeWrapper.fromTopLevel(i),u=s.deserialize(),c=(t=u.encryptedTransportMessage())==null?void 0:t.consumerMessage();if(c!=null)return f({consumerApplication:c,logger:a,qplFlow:l});var d=(r=u.encryptedTransportMessage())==null||(r=r.armadillo())==null?void 0:r.extendedContentMessage();return d!=null?h({extendedContentMessage:d,logger:a,qplFlow:l}):(p||(p=n("Promise"))).resolve([])}function f(e){return g.apply(this,arguments)}function g(){return g=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t,n,r,a,i,l,s=e.consumerApplication,u=e.logger,c=e.qplFlow,d=s.attachmentMessage();if(d==null||((t=d.payload.integral)==null?void 0:t.receiverFetchId)!=null)return[];var m=d.kind,p=d.payload.integral,_=(n=p==null||(r=p.transport)==null?void 0:r.integral)!=null?n:{},f=_.mediaKey,g=(a=p==null||(i=p.transport)==null?void 0:i.ancillary)!=null?a:{},h=g.objectId,y=yield C({logger:u,maybeMediaKey:f,maybeObjectId:h}),b=p==null||(l=p.transport)==null||(l=l.ancillary)==null||(l=l.thumbnail)==null?void 0:l.downloadableThumbnail,S=b==null?null:yield C({logger:u,maybeMediaKey:b.mediaKey,maybeObjectId:b.objectId}),R=c.getInstanceKey().toString();return[y.success===!0?babelHelpers.extends({},y.value,{attachmentTraceId:R,mediaType:v(m)}):null,(S==null?void 0:S.success)===!0?babelHelpers.extends({},S.value,{attachmentTraceId:R,mediaType:o("EBMinosTypes").MinosAttachmentMediaType.MESSENGER_PREVIEW}):null].filter(Boolean)}),g.apply(this,arguments)}function h(e){return y.apply(this,arguments)}function y(){return y=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var r=t.extendedContentMessage,a=t.logger,i=t.qplFlow,l=[r.favicon(),r.headerImage()].concat(r.previews()).filter(Boolean);if(l.length===0)return[];var u=yield(p||(p=n("Promise"))).all(l.map(function(e){var t,n;return C({logger:a,maybeMediaKey:(t=e.integral)==null||(t=t.transport)==null||(t=t.integral)==null?void 0:t.mediaKey,maybeObjectId:(n=e.integral)==null||(n=n.transport)==null||(n=n.ancillary)==null?void 0:n.objectId})})),c=u.filter(function(e){return e.success===!0}),d=u.filter(function(e){return e.success===!1});return d.forEach(function(t){a.ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Failed to parse an attachment in XMA message: ",""])),t.error)}),c.length===0&&a.ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Failed to parse all attachments in XMA message"]))),c.map(function(e){return babelHelpers.extends({},e.value,{attachmentTraceId:i.getInstanceKey().toString(),mediaType:o("EBMinosTypes").MinosAttachmentMediaType.XMA})})}),y.apply(this,arguments)}function C(e){return b.apply(this,arguments)}function b(){return b=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=e.logger,n=e.maybeMediaKey,r=e.maybeObjectId;if(n==null)return t.ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["Missing mediaKey in media message protobuf"]))),o("WAResultOrError").makeError("missing-media-key");if(r==null)return t.ERROR(c||(c=babelHelpers.taggedTemplateLiteralLoose(["Missing objectId in media message protobuf"]))),o("WAResultOrError").makeError("missing-object-id");var a=o("WAMediaUtils").castToMediaKey(n),i=yield o("EBMinosWasmDeriveAttachmentPrimaryKeySecret").deriveAttachmentPrimaryKeySecret({mediaKey:a});if(!i.success)return t.ERROR(d||(d=babelHelpers.taggedTemplateLiteralLoose(["Failed to derive attachment primary key secret"]))),o("WAResultOrError").makeError("derive-primary-key-secret-error");var l=yield o("EBMinosWasmDeriveAttachmentAccessTokenSecret").deriveAttachmentAccessTokenSecret({mediaKey:a});return l.success?o("WAResultOrError").makeResult({accessTokenSecret:l.value,primaryKeySecret:i.value,zippyObjectId:o("WAMediaUtils").stringToDeliveryObjectId(r)}):(t.ERROR(m||(m=babelHelpers.taggedTemplateLiteralLoose(["Failed to derive attachment access token secret"]))),o("WAResultOrError").makeError("derive-access-token-secret-error"))}),b.apply(this,arguments)}function v(e){return e==="audioTransport"?o("EBMinosTypes").MinosAttachmentMediaType.PTT:e==="imageTransport"?o("EBMinosTypes").MinosAttachmentMediaType.IMAGE:e==="videoTransport"?o("EBMinosTypes").MinosAttachmentMediaType.VIDEO:e==="stickerTransport"?o("EBMinosTypes").MinosAttachmentMediaType.STICKER:e==="documentTransport"?o("EBMinosTypes").MinosAttachmentMediaType.DOCUMENT:(function(){throw Error("Match: No case succesfully matched. Make exhaustive or add a wildcard case using '_'. Argument: "+e)})()}l.getMinosAttachmentPayloadFromMpsMessage=_}),98);
__d("EBGraphQLRestoreDefinition",[],(function(t,n,r,o,a,i){"use strict";function e(e){return e}i.toMpsMessageQueryForGraphQLQuery=e}),66);
__d("EBSMAPI",["EBDeps","Promise","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e,s;function u(){return s!=null||(s=o("EBDeps").getDeps().getEBSMAPI()),s}var c={addDeviceWithEBKeys:(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(){var e;return(e=yield u()).addDeviceWithEBKeys.apply(e,arguments)});function t(){return e.apply(this,arguments)}return t})(),addDeviceWithRecoveryCode:(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(){var e;return(e=yield u()).addDeviceWithRecoveryCode.apply(e,arguments)});function t(){return e.apply(this,arguments)}return t})(),addVirtualDevice:(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(){var e;return(e=yield u()).addVirtualDevice.apply(e,arguments)});function t(){return e.apply(this,arguments)}return t})(),deleteBackupsOnClient:(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(){var e;return(e=yield u()).deleteBackupsOnClient.apply(e,arguments)});function t(){return e.apply(this,arguments)}return t})(),deleteEncryptedBackup:(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(){var e;return(e=yield u()).deleteEncryptedBackup.apply(e,arguments)});function t(){return e.apply(this,arguments)}return t})(),ebOptOut:(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(){var e;return(e=yield u()).ebOptOut.apply(e,arguments)});function t(){return e.apply(this,arguments)}return t})(),fetchBackupIds:(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(){var e;return(e=yield u()).fetchBackupIds.apply(e,arguments)});function t(){return e.apply(this,arguments)}return t})(),generateRecoveryCode:(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(){var e;return(e=yield u()).generateRecoveryCode.apply(e,arguments)});function t(){return e.apply(this,arguments)}return t})(),getEBState:(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(){return(yield u()).getEBState()});function t(){return e.apply(this,arguments)}return t})(),getLSVirtualDevices:(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){return(yield u()).getLSVirtualDevices(e)});function t(t){return e.apply(this,arguments)}return t})(),initializeBackup:(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(){var e;return(e=yield u()).initializeBackup.apply(e,arguments)});function t(){return e.apply(this,arguments)}return t})(),isEbEnabled:(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(){var e;return(e=yield u()).isEbEnabled.apply(e,arguments)});function t(){return e.apply(this,arguments)}return t})(),optOutOfBackup:function(){return(e||(e=n("Promise"))).resolve()},otcAddDevice:(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(){var e;return(e=yield u()).otcAddDevice.apply(e,arguments)});function t(){return e.apply(this,arguments)}return t})(),repairEpochs:(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(){return(yield u()).repairEpochs()});function t(){return e.apply(this,arguments)}return t})(),revokeVirtualDevice:(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(){var e;return(e=yield u()).revokeVirtualDevice.apply(e,arguments)});function t(){return e.apply(this,arguments)}return t})(),syncEpochs:(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(){return(yield u()).syncEpochs()});function t(){return e.apply(this,arguments)}return t})()},d=c;l.default=d}),98);
__d("RecoveryCodeDB",["MAWCurrentUser","MAWIndexedDbMetadata","MAWODSProxy","MessengerWebInitData","QPLFlow","WAHex","WALogger","WAOdsEnums","WAResolvable","Worm","WormEAR","WormIDbDriver","asyncToGeneratorRuntime","qpl"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u={persisted_recovery_code:{indexes:{},primaryKey:"pk"}},c=1e4,d=new(o("WAResolvable")).Resolvable;function m(){return p.apply(this,arguments)}function p(){return p=n("asyncToGeneratorRuntime").asyncToGenerator(function*(){var t=o("MAWIndexedDbMetadata").ebRecoveryCodeDBName(o("MAWCurrentUser").getID()),n=o("WAHex").parseHex(r("MessengerWebInitData").accountKeyV2),a={log:function(t){return o("MAWODSProxy").odsBumpEntityKey({entity:o("WAOdsEnums").Entity.EB_RECOVERY_CODE_DB,key:t})}},i=r("qpl")._(1056840657,"2716"),l=o("QPLFlow").startQPLFlow(i,{annotations:{string:{dbType:"recovery_code_db",operationType:"initRecoveryCodeDB"}},timeoutInMs:c});try{var m="recovery_code_db",p=new(o("WormEAR")).WormEAR(u,m,n),_=new(o("Worm")).WormDatabase(new(o("WormIDbDriver")).WormIDbDriver(t,m,u,p,a,{onTransactionError:function(n){n instanceof o("WormEAR").DecryptionError&&o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Error decrypting RecoveryCodeDB"])))},safeToDeleteStores:new Set(["migration"])}),i);yield _.init({eventFlow:l}),l.endSuccess(),d.resolve(_)}catch(e){throw l.endFail("error"),o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Error initializing RecoveryCodeDB: ",""])),e),d.reject(e),e}}),p.apply(this,arguments)}function _(){return f.apply(this,arguments)}function f(){return f=n("asyncToGeneratorRuntime").asyncToGenerator(function*(){return d.resolveWasCalled()||(yield m()),d.promise}),f.apply(this,arguments)}l.schema=u,l.getOrCreateRecoveryCodeDB=_}),98);
__d("EBOnboardDeviceWithAutomaticEB",["EBIsEbEnabled","EBLogger","EBSMAPI","LSAuthorityLevel","MAWCurrentUser","MAWODSProxy","RecoveryCodeDB","WAOdsEnums","asyncToGeneratorRuntime","getErrorSafe"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d=o("EBLogger").EBLogger().tags(["EBOnboardDeviceWithAutomaticEB"]);function m(){return p.apply(this,arguments)}function p(){return p=n("asyncToGeneratorRuntime").asyncToGenerator(function*(){try{var t=yield o("EBIsEbEnabled").isEBEnabled();if(t){d.DEBUG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["EB is already enabled, skipping onboard with recovery code"])));return}d.DEBUG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["EB is not enabled, checking for recovery code in database"])));var a=yield o("RecoveryCodeDB").getOrCreateRecoveryCodeDB(),i=yield a.runInTransaction(["persisted_recovery_code"],"readonly",(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=yield e.stores.persisted_recovery_code.readAll(),n=t.find(function(e){return e.authorityLevel===r("LSAuthorityLevel").AUTHORITATIVE});return n==null?void 0:n.recoveryCode});return function(t){return e.apply(this,arguments)}})(),"RecoveryCodeDB - read recovery code for adding device");if(i==null){d.DEBUG(u||(u=babelHelpers.taggedTemplateLiteralLoose(["No recovery code found in database"])));return}d.DEBUG(c||(c=babelHelpers.taggedTemplateLiteralLoose(["Found recovery code in database, attempting to add device"]))),o("MAWODSProxy").odsBumpEntityKey({entity:o("WAOdsEnums").Entity.AUTOMATIC_EB,key:"onboard_device_with_recovery_code.attempt"});var l=yield r("EBSMAPI").addDeviceWithRecoveryCode({recoveryCode:i,userId:o("MAWCurrentUser").getID()});l.success?(d.info("Successfully added device with recovery code from database"),o("MAWODSProxy").odsBumpEntityKey({entity:o("WAOdsEnums").Entity.AUTOMATIC_EB,key:"onboard_device_with_recovery_code.success"})):(d.warn("Failed to add device with recovery code: "+l.error),o("MAWODSProxy").odsBumpEntityKey({entity:o("WAOdsEnums").Entity.AUTOMATIC_EB,key:"onboard_device_with_recovery_code.failure."+l.error}),o("MAWODSProxy").odsBumpEntityKey({entity:o("WAOdsEnums").Entity.AUTOMATIC_EB,key:"onboard_device_with_recovery_code.failure"}))}catch(e){d.catching(r("getErrorSafe")(e)).warn("Failed to onboard device with automatic EB after EBLS init")}}),p.apply(this,arguments)}l.onboardDeviceWithAutomaticEB=m}),98);
__d("EBResumeAutomaticEBInitialisation",["EBLogger","EBSMAPI","LSAuthorityLevel","LSIntEnum","RecoveryCodeDB","asyncToGeneratorRuntime","getErrorSafe"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(){return u.apply(this,arguments)}function u(){return u=n("asyncToGeneratorRuntime").asyncToGenerator(function*(){try{var t=yield o("RecoveryCodeDB").getOrCreateRecoveryCodeDB(),a=yield t.runInTransaction(["persisted_recovery_code"],"readonly",(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=yield e.stores.persisted_recovery_code.readAll(),n=t.find(function(e){return e.virtualDeviceType===16&&e.authorityLevel===r("LSAuthorityLevel").OPTIMISTIC});return n!=null});return function(t){return e.apply(this,arguments)}})(),"FetchOptimisticRecoveryCode");a&&(o("EBLogger").EBLogger().info("Found existing optimistic recovery code, resuming backup initialization"),yield r("EBSMAPI").initializeBackup({virtualDeviceId:null,virtualDeviceType:(e||(e=o("LSIntEnum"))).ofNumber(16)}))}catch(e){o("EBLogger").EBLogger().catching(r("getErrorSafe")(e)).warn("Failed to resume initialization from optimistic recovery code")}}),u.apply(this,arguments)}l.resumeAutomaticEBInitialisation=s}),98);
__d("EBSMProperties",[],(function(t,n,r,o,a,i){"use strict";var e=["encrypted_backups_virtual_devices","secure_encrypted_backups_recovery_code_status","device_metadata","secure_encrypted_backups_epochs","secure_encrypted_backups_client_state","encrypted_backups","experiences_shared_state","auto_restore_opt_out"],l=new Set(["secure_encrypted_backups_client_state","secure_encrypted_backups_epochs"]),s={dbVersion:5,mandatoryTables:l,persistedTables:new Set(e),persistedTablesArray:e},u=s;i.default=u}),66);
__d("MWEBODSEntityKey.enum",["$InternalEnum"],(function(t,n,r,o,a,i){"use strict";var e=n("$InternalEnum")({START:"start",SUCCESS:"success",FAIL:"fail",INCORRECT_PIN_CODE:"incorrect_pin_code",INCORRECT_RECOVERY_CODE:"incorrect_recovery_code",TIMEOUT:"timeout",CANCEL:"cancel"}),l=e;i.default=l}),66);
__d("MWEncryptedBackupsFirstRestoreUpsellTime",["EBAPIWorkerCheck","FBLogger","WebStorage","getErrorSafe","getMWEncryptedBackupsIsLocalStorageSupported"],(function(t,n,r,o,a,i,l){"use strict";var e,s="mw_encrypted_backups_restore_upsell_first_impression_time_key";function u(){var t=Date.now().toString();if(o("EBAPIWorkerCheck").runningInWorker())return d(t);if(!o("getMWEncryptedBackupsIsLocalStorageSupported").getMWEncryptedBackupsIsLocalStorageSupported())return t;try{var n,a=(n=(e||(e=r("WebStorage"))).getLocalStorage())==null?void 0:n.getItem(s);if(a==null){var i;return(i=(e||(e=r("WebStorage"))).getLocalStorage())==null||i.setItem(s,t),t}return a}catch(e){return r("FBLogger")("wmi_eb").warn("[labyrinth][web] Failed to set EB session identifier due to %s",r("getErrorSafe")(e).message),t}}var c=null;function d(e){return c==null&&(c=e),c}l.getFirstRestoreUpsellTime=u,l.getFirstRestoreUpsellTimeForEBLS=d}),98);
__d("QPLMemoryUtils",["MemoryUtils","QPLUserFlow"],(function(t,n,r,o,a,i,l){"use strict";function e(e){var t=o("MemoryUtils").getCurrentMemory(),n=t.usedJSHeapSize;r("QPLUserFlow").addAnnotations(e,{int:{usedJSHeapSizeStart:n}})}function s(e){var t=o("MemoryUtils").getCurrentMemory(),n=t.usedJSHeapSize;r("QPLUserFlow").addAnnotations(e,{int:{usedJSHeapSizeEnd:n}})}l.logMemoryForQPLStart=e,l.logMemoryForQPLEnd=s}),98);
__d("createReStoreEBSMTablesPersistence",["CurrentMessengerUser","EBLogger","MAWUnrecoverableDbErrors","MWEBODSCategory","MWEBODSEntityKey.enum","MWEBODSEntityName.enum","MWEBUseLocalStorage","MWEncryptedBackupsFirstRestoreUpsellTime","MWEncryptedBackupsLocalStorageEntryEnum","ODS","Promise","QPLMemoryUtils","QPLUserFlow","Random","ReStorePersistence","ReStoreTabNotifier","WebSession","asyncToGeneratorRuntime","getErrorSafe","promiseDone","qpl"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d=o("CurrentMessengerUser").getIDorEIMU(),m=r("ReStoreTabNotifier")==null?void 0:r("ReStoreTabNotifier")("mwChat-"+d),p=null,_=!1,f=!1,g=o("EBLogger").EBLogger().tags(["EBSM","Pesistence","MainThread"]);function h(e,t,n){var r=e.get(t);if(r!==void 0)return r;var o=n();return e.set(t,o),o}function y(t){var a=(c||(c=n("Promise"))).resolve(),i="flushChangesV2",l=new Map;function d(e){return h(l,e,function(){return new Map})}var y=o("MWEncryptedBackupsFirstRestoreUpsellTime").getFirstRestoreUpsellTime();r("QPLUserFlow").start(r("qpl")._(521481876,"1407"),{annotations:{string:{ebSessionIdentifier:y,sessionTabId:o("WebSession").getId()}}}),(u||(u=o("ODS"))).bumpEntityKey(r("MWEBODSCategory"),r("MWEBODSEntityName.enum").MW_EBSM_HYDRATION,r("MWEBODSEntityKey.enum").START),o("QPLMemoryUtils").logMemoryForQPLStart(r("qpl")._(521481876,"1407"));function C(){return b.apply(this,arguments)}function b(){return b=n("asyncToGeneratorRuntime").asyncToGenerator(function*(){try{yield t.rehydrateEBSMFromEBDB(d),o("QPLMemoryUtils").logMemoryForQPLEnd(r("qpl")._(521481876,"1407")),r("QPLUserFlow").endSuccess(r("qpl")._(521481876,"1407")),(u||(u=o("ODS"))).bumpEntityKey(r("MWEBODSCategory"),r("MWEBODSEntityName.enum").MW_EBSM_HYDRATION,r("MWEBODSEntityKey.enum").SUCCESS)}catch(t){r("QPLUserFlow").addPoint(r("qpl")._(521481876,"1407"),"EBSM_HYDRATION_FAILED");var e=r("getErrorSafe")(t);g.MUSTFIX(s||(s=babelHelpers.taggedTemplateLiteralLoose(["An error occured in EBSM hydration when loading EB data: ",""])),e.message),r("QPLUserFlow").endFailure(r("qpl")._(521481876,"1407"),"Hydration failed."),(u||(u=o("ODS"))).bumpEntityKey(r("MWEBODSCategory"),r("MWEBODSEntityName.enum").MW_EBSM_HYDRATION,r("MWEBODSEntityKey.enum").FAIL)}}),b.apply(this,arguments)}return p=C(),m==null||m.onEventReceive("flushChangesV2",function(n){var a=n.changeSet,l=new Map;if(a.forEach(function(e,t){l.set(t,{toAdd:[],toDelete:[]});var n=d(t);e.forEach(function(e,r){if(o("ReStorePersistence").isDeletedValue(e,o("ReStorePersistence").sentinelDeleted)){var a;(a=l.get(t))==null||a.toDelete.push(n.get(r))}else{var i;(i=l.get(t))==null||i.toAdd.push(e)}})}),t.updateEBSM==null){g.MUSTFIX(e||(e=babelHelpers.taggedTemplateLiteralLoose(["ebdbEbsmApi.updateEBSM is not defined"])));return}r("promiseDone")(t.updateEBSM(l,i))}),{flush:(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,n){var a,l;if(e.size!==0&&(e.size>0&&e.forEach(function(t,n){t.size===0&&e.delete(n)}),e.size!==0)){var s=((a=n.actionSource)==null?void 0:a.type)==="user_initiated"&&((l=n.actionSource)==null?void 0:l.source)===i;if(s){e.forEach(function(e,t){var n=d(t);e.forEach(function(e,t){o("ReStorePersistence").isDeletedValue(e,o("ReStorePersistence").sentinelDeleted)?n.delete(t):n.set(t,e)})});return}var u=new Map;e.forEach(function(e,t){u.set(t,{toAdd:[],toDelete:[]});var n=d(t);e.forEach(function(e,r){if(o("ReStorePersistence").isDeletedValue(e,o("ReStorePersistence").sentinelDeleted)){var a;(a=u.get(t))==null||a.toDelete.push(n.get(r)),n.delete(r)}else{var i;(i=u.get(t))==null||i.toAdd.push(e),n.set(r,e)}})}),m==null||m.postMessage("flushChangesV2",{changeSet:e,fromVersion:"",sentinelDeleted:o("ReStorePersistence").sentinelDeleted,version:""});var c=o("Random").uint32(),_=Array.from(e.keys());r("QPLUserFlow").start(r("qpl")._(521485383,"2200"),{annotations:{bool:{ebsmv2:!0},string_array:{tables:_}},instanceKey:c}),yield p,yield t.flushEBSMtoEBDB(u).catch(function(){})}});function a(t,n){return e.apply(this,arguments)}return a})(),get:function(t,r,o){var e=d(r);return _?e.get(o):p==null?(c||(c=n("Promise"))).reject("rehydration is not complete"):p.then(function(){return _=!0,e.get(o)})},logError:function(n,a,i,l){if((u||(u=o("ODS"))).bumpEntityKey(r("MWEBODSCategory"),r("MWEBODSEntityName.enum").MW_EBSM_RESTORE_PERSISTENCE_ERROR,n),i==="dbCorruption"){var e,s;(u||(u=o("ODS"))).bumpEntityKey(r("MWEBODSCategory"),r("MWEBODSEntityName.enum").MW_EBSM_CORRUPTION,n);var c="Got unexpected undefined in ebsm, mode: "+a+", table: "+n+", id: "+((e=l==null?void 0:l.id)!=null?e:"")+", deletedInThisTxn: "+((s=l==null?void 0:l.deletedInThisTxn)!=null?s:"")+". Deleting EBSM db";g.mustfix(c);var d=o("Random").uint32();o("MAWUnrecoverableDbErrors").setError(new(o("MAWUnrecoverableDbErrors")).EbsmHydrationError(c,!0,d,n),function(){r("promiseDone")(t.clearEbStores(),function(){(u||(u=o("ODS"))).bumpEntityKey(r("MWEBODSCategory"),r("MWEBODSEntityName.enum").MW_EBSM_CORRUPTION,"db_deleted.main_thread")})}),f||(f=!0,o("MWEBUseLocalStorage").mwEBCreateLocalStorageEntry(r("MWEncryptedBackupsLocalStorageEntryEnum").EBSM_CORRUPTION_WIPE,"full"))}},queueCommitWork:void 0,runExclusively:function(t){return new(c||(c=n("Promise")))(function(e,r){a=a.then(n("asyncToGeneratorRuntime").asyncToGenerator(function*(){var n=yield t(),o=n[0],a=n[1];try{e(yield o())}catch(e){r(e)}}))})},shouldApplySync:function(){return!1},shouldInline:function(t,n){return!1},shouldSync:function(t,n){return t!=="notifyInMemoryTable"},tabTablesNotifier:function(){return m},types:["ephemeral"],uniqueId:""}}l.default=y}),98);
__d("createReStoreTableNameAllowListPersistence",["Promise","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i){"use strict";var e;function l(t,r,o){var a;return{clearCache:function(){t.clearCache==null||t.clearCache(),r.clearCache==null||r.clearCache()},close:function(){t.close==null||t.close(),r.close==null||r.close()},flush:(function(){var a=n("asyncToGeneratorRuntime").asyncToGenerator(function*(a,i){var l=new Map,s=new Map;a.forEach(function(e,t){o.has(t)?s.set(t,e):l.set(t,e)}),yield(e||(e=n("Promise"))).all([t.flush(l,i),r.flush(s,i)])});function i(e,t){return a.apply(this,arguments)}return i})(),get:function(n,a,i,l){return o.has(a)?r.get(n,a,i,l):t.get(n,a,i,l)},isClosed:function(){return(t.isClosed==null?void 0:t.isClosed())||!1},isPersistenceSupported:t.isPersistenceSupported,logError:function(n,a,i,l){o.has(n)?r.logError==null||r.logError(n,a,i,l):t.logError==null||t.logError(n,a,i,l)},permitsSynchronousIO:function(n){if(o.has(n)){var e;return(e=r.permitsSynchronousIO==null?void 0:r.permitsSynchronousIO(n))!=null?e:!1}else{var a;return(a=t.permitsSynchronousIO==null?void 0:t.permitsSynchronousIO(n))!=null?a:!1}},runExclusively:function(a,i){return t.runExclusively(function(){return new(e||(e=n("Promise")))(function(t,o){var l=r.runExclusively(n("asyncToGeneratorRuntime").asyncToGenerator(function*(){var r=yield a(),o=r[0],i=r[1],s=new(e||(e=n("Promise")))(function(e){t([function(){return e(),l},i])});return[n("asyncToGeneratorRuntime").asyncToGenerator(function*(){return yield s,o()}),i]}),i);l.catch(o)})},i)},shouldApplySync:function(n,a){return o.has(a)?r.shouldApplySync(n,a):t.shouldApplySync(n,a)},shouldInline:function(n,a){return o.has(n)?r.shouldInline(n,a):t.shouldInline(n,a)},shouldSync:function(n,a){return o.has(a)?r.shouldSync(n,a):t.shouldSync(n,a)},tabTablesNotifier:(a=t.tabTablesNotifier)!=null?a:r.tabTablesNotifier,types:[].concat(t.types,r.types),uniqueId:r.uniqueId+t.uniqueId}}i.default=l}),66);
__d("LSJSEBInMemoryStorage",["EBSMProperties","createLSReStoreEphemeralPersistence","createReStoreEBSMTablesPersistence","createReStoreTableNameAllowListPersistence"],(function(t,n,r,o,a,i,l){"use strict";function e(e){var t=r("createReStoreTableNameAllowListPersistence")(o("createLSReStoreEphemeralPersistence").createLSReStoreEphemeralPersistence(),r("createReStoreEBSMTablesPersistence")(e),r("EBSMProperties").persistedTables);return t}l.makeReStorePersistence=e}),98);
__d("EBWorkerAddDeviceUtils",["EBDB","EBDBEbsmApi","EBSMProperties","I64","LSAuthorityLevel","LSIntEnum","LSJSEBInMemoryStorage","LSMetadata","LSReStoreWrapper","MAWLSVaultingHooks","Promise","ReQL","asyncToGeneratorRuntime","err"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u;function c(e,t){return d.apply(this,arguments)}function d(){return d=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t,a){var l=yield o("ReQL").firstAsync(o("ReQL").fromTableAscending(a.tables.secure_encrypted_backups_client_state));if(l!=null)return"dest_table_not_empty";var c={clearEbStores:o("EBDB").clearEbStores,flushEBSMtoEBDB:o("EBDBEbsmApi").flushEBSMtoEBDB,rehydrateEBSMFromEBDB:o("EBDBEbsmApi").rehydrateEBSMFromEBDB,updateEBSM:function(){return(u||(u=n("Promise"))).resolve()}},d=yield o("LSJSEBInMemoryStorage").makeReStorePersistence(c);if(d==null)throw r("err")("persistence is null");var m=o("LSReStoreWrapper").createLSReStore(d,o("LSMetadata").schema,[r("MAWLSVaultingHooks")],void 0),p=yield o("ReQL").toArrayAsync(o("ReQL").fromTableAscending(m.tables.secure_encrypted_backups_epochs));return p.filter(function(t){return(e||(e=o("I64"))).equal(t.authorityLevel,(s||(s=o("LSIntEnum"))).ofNumber(r("LSAuthorityLevel").AUTHORITATIVE))}).length===0?"source_epoch_not_authoritative":m.runInTransaction(function(e){return a.runInTransaction((function(){var r=n("asyncToGeneratorRuntime").asyncToGenerator(function*(r){var o=yield(u||(u=n("Promise"))).all(t.map((function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var n=e[t],o=n.entries(new WeakMap),a=yield o.next();if(a.done)return"source_table_empty";for(var i=r[t];!a.done;){var l=a.value,s=l[0],u=l[1];yield i.upsert(s,u),a=yield o.next()}return"success"});return function(e){return t.apply(this,arguments)}})())),a=new Set(o);return a.has("source_table_empty")?"source_table_empty":a.has("success")&&a.size===1?"success":"fail"});return function(e){return r.apply(this,arguments)}})(),"readwrite",void 0,void 0,i.id+":91")},"readonly",void 0,void 0,i.id+":89")}),d.apply(this,arguments)}function m(e){return p.apply(this,arguments)}function p(){return p=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){yield e.runInTransaction(function(e){return(u||(u=n("Promise"))).all(r("EBSMProperties").persistedTablesArray.map((function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){for(var n=e[t],r=n.entries(new WeakMap),o=yield r.next();!o.done;)yield n.delete.apply(n,o.value[0]),o=yield r.next()});return function(e){return t.apply(this,arguments)}})()))},"readwrite",void 0,void 0,i.id+":131")}),p.apply(this,arguments)}l.copyEBStateTablesFromMainthreadToWorker=c,l.clearLSEBSMTables=m}),98);
__d("LSDedicatedMqttChannel",["FBMqttChannel","cr:1232"],(function(t,n,r,o,a,i,l){"use strict";function e(){n("cr:1232")!=null&&n("cr:1232").shutdownAndClear()}function s(e,t,o,a,i,l){return function(s){return n("cr:1232")!=null?n("cr:1232").getInstance(s,e,t,o,a,i,l):r("FBMqttChannel")}}l.shutdownAndClear=e,l.getInstance=s}),98);
__d("MAWEBLSInWorkerSwitch",["MAWEBEnabledStateManager"],(function(t,n,r,o,a,i,l){"use strict";var e=new(o("MAWEBEnabledStateManager")).MAWEBEnabledStateManager,s=e;l.default=s}),98);
__d("LSFetchBackupIds",["LSIssueNewEbTaskAndGetTaskIDV2","LSLogMebClientEvent.nop"],(function(t,n,r,o,a,i){function e(){var e=arguments,t=e[e.length-1],r=[],o=[];return t.sequence([function(o){return t.sequence([function(o){return r[0]=t.i64.of_float(Date.now()),(function(e){t.logger(e).info(e)})("[EncryptedBackups][LSEncryptedBackupsFetchBackupIdsStoredProcedure] Beginning execution."),r[11]=t.i64.cast([0,0]),r[7]=r[11],r[8]=new t.Map,r[8].set("backup_tenancy",e[0]),r[8].set("trace_id",void 0),r[9]=t.toJSON(r[8]),t.storedProcedure(n("LSIssueNewEbTaskAndGetTaskIDV2"),"encrypted_backups_setup",t.i64.cast([0,50008]),r[9],t.i64.cast([0,0]),t.i64.cast([0,93]),t.i64.cast([0,0]),void 0,r[7]).then(function(e){var t;return t=e,r[10]=t[0],t})},function(e){return r[1]=t.i64.of_float(Date.now()),r[2]=t.i64.random(),r[4]="Finishing execution. Execution time: ",r[5]=t.i64.to_string(t.i64.sub(r[1],r[0])),r[6]=" ms",r[3]="",(function(e){t.logger(e).info(e)})(["[EncryptedBackups][LSEncryptedBackupsFetchBackupIdsStoredProcedure] ",r[3],r[4],r[3],r[5],r[3],r[6]].join("")),t.i64.eq(t.i64.mod_(r[2],t.i64.cast([0,1e3])),t.i64.cast([0,0]))?(r[7]=",",r[8]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"LSEncryptedBackupsFetchBackupIdsStoredProcedure",[r[4],r[7],r[5],r[7],r[6]].join(""),r[8],t.i64.cast([0,4]))):t.resolve()}])},function(e){return t.resolve(o)}])}e.__sproc_name__="LSEncryptedBackupsFetchBackupIdsStoredProcedure",e.__tables__=["encrypted_backups"],a.exports=e}),null);
__d("LSFetchBackupIdsStoredProcedure",["LSFetchBackupIds","LSSynchronousPromise","Promise","cr:8709"],(function(t,n,r,o,a,i,l){var e;function s(t,a){var i=t.storedProcedure(r("LSFetchBackupIds"),a.backupTenancy,a.traceId,a.isUiBlocking);return(e||(e=n("Promise"))).resolve(o("LSSynchronousPromise").maybeExtractValueIfSynchronousPromise(i))}l.default=s}),98);
__d("isInstamadilloEB",["qex"],(function(t,n,r,o,a,i,l){"use strict";function e(){return r("qex")._("670")===!0}l.default=e}),98);
__d("MWEncryptedBackupsListenForChangesToBackupStateInitPath",["EBSMAPI","I64","LSAuthorityLevel","LSEncryptedBackupsBackupTenancy","LSFactory","LSFetchBackupIdsStoredProcedure","LSIntEnum","MWChatEncryptedBackupsLogging","MWChatEncryptedBackupsQPLEvents","MWEncryptedBackupsFirstRestoreUpsellTime","QPLEvent","QPLUserFlow","ReQL","WebSession","isInstamadilloEB","promiseDone","qex"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c=r("qex")._("121")===!0;function d(t){function n(){r("promiseDone")(r("EBSMAPI").fetchBackupIds("MWEncryptedBackupsListenForChangesToBackupStateInitPath"),function(){return void 0})}function a(){var n=o("ReQL").fromTableAscending(t.tables.encrypted_backups),a=n.subscribe(function(t,n){n.operation==="delete"||!(e||(e=o("I64"))).equal(n.value.authorityLevel,(s||(s=o("LSIntEnum"))).ofNumber(r("LSAuthorityLevel").AUTHORITATIVE))||(a(),r("QPLUserFlow").getActiveFlowIDs().includes((u||(u=o("QPLEvent"))).getMarkerId(o("MWChatEncryptedBackupsQPLEvents").fetchBackupIdsQPLEvent))&&o("MWChatEncryptedBackupsLogging").endSuccess({event:o("MWChatEncryptedBackupsQPLEvents").fetchBackupIdsQPLEvent}))}),l=o("MWEncryptedBackupsFirstRestoreUpsellTime").getFirstRestoreUpsellTime();r("QPLUserFlow").getActiveFlowIDs().includes((u||(u=o("QPLEvent"))).getMarkerId(o("MWChatEncryptedBackupsQPLEvents").fetchBackupIdsQPLEvent))||r("QPLUserFlow").start(o("MWChatEncryptedBackupsQPLEvents").fetchBackupIdsQPLEvent,{annotations:{string:{ebSessionIdentifier:l,fetchBackupIdsVersion:"msys",sessionTabId:o("WebSession").getId()}}}),r("promiseDone")(t.runInTransaction(function(e){return r("LSFetchBackupIdsStoredProcedure")(r("LSFactory")(e),{backupTenancy:(s||(s=o("LSIntEnum"))).ofNumber(r("LSEncryptedBackupsBackupTenancy").PRODUCTION),isUiBlocking:!1})},"readwrite",void 0,void 0,i.id+":86"),function(){return void 0})}var l=n;(c||r("isInstamadilloEB")())&&(l=a,l());var d=o("ReQL").fromTableAscending(t.tables.encrypted_backups_status_trigger);return d.subscribe(l)}function m(e){}var p={listenForChangesToBackupState:d,preloadEBData:m};l.default=p}),98);
__d("EBLS",["EBDB","EBDBEbsmApi","EBEpochChangeListener","EBIsEbEnabled","EBIsEbEnabledSubscriber","EBLogger","EBOnboardDeviceWithAutomaticEB","EBReadyNotifier","EBReenrollmentTriggerListener","EBResumeAutomaticEBInitialisation","EBWorkerAddDeviceUtils","I64","LSAuthorityLevel","LSDataTraceFlushDeferred","LSDatascriptEvaluatorMaybeDeferred","LSDedicatedMqttChannel","LSDefaultSyncGroups","LSDeleteAllAndInsertConnectivityStatusStoredProcedure","LSEncryptedBackupsBackupTenancy","LSFactory","LSIntEnum","LSInternetConnectionState","LSJSEBInMemoryStorage","LSMetadata","LSPlatformDeviceId","LSPlatformMessengerSyncParams","LSPlatformMqttRealtimeTransport","LSPlatformRealtimeTransport","LSPlatformTaskSystemTransport","LSReStoreWrapper","LSVersion","MAWBridge","MAWEBLSInWorkerSwitch","MAWLSVaultingHooks","MAWODSProxy","MAWVaultMaterialsStorage","MWEncryptedBackupsListenForChangesToBackupStateInitPath","MWPlatformTaskSystem","MqttEnv","Promise","QPLUserFlow","ReQL","ServerAppID","WAAssertUnreachable","WAOdsEnums","WAPromiseDelays","WAResolvable","asyncToGeneratorRuntime","emptyFunction","err","getMWLSRegion","justknobx","nullthrows","promiseDone","qpl","vulture"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_,f,g,h,y,C,b,v,S,R,L,E,k,I,T,D,x,$,P=o("EBLogger").EBLogger().tags(["EBLS"]),N=r("qpl")._(521478817,"2806");function M(){return O()}var w,A,F;function O(){return w?w.promise:B({copyKeys:!0,getNewDB:!1}).promise}function B(e){w!=null&&!w.isSettled&&w.reject(r("err")("LSClient is not settled")),A!=null&&!A.isSettled&&A.reject(r("err")("LSDBStorage is not settled"));var t=new(o("WAResolvable")).Resolvable;return w=t,A=null,W(e).then(function(e){t.resolve(e)},function(e){t.reject(e)}),t}function W(e){return q.apply(this,arguments)}function q(){return q=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t,a=e.getNewDB;o("EBReadyNotifier").resetEBReady(),(t=r("QPLUserFlow")).start(N,{timeoutInMs:6e4}),t.addPoint(N,"ls_storage_creation_start");var i=yield H(a);t.addPoint(N,"ls_storage_creation_end"),t.addPoint(N,"eb_worker_add_device_skipped"),t.endSuccess(N),o("EBReadyNotifier").markEBReady(),P.DEBUG(g||(g=babelHelpers.taggedTemplateLiteralLoose(["Initialised db"])));var l={appId:r("nullthrows")(r("ServerAppID").app_id),executeGraphQLLightSpeedRequest:(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(){r("vulture")("ZrOlCWyJ0L0hG2xX4QdNxz1doLM=");for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];var a=yield o("MAWBridge").getBridge().sendAndReceive("event","executeGraphQLLightSpeedRequest",{args:t});return a});function t(){return e.apply(this,arguments)}return t})(),getDb:H,getEval:function(){return r("LSDatascriptEvaluatorMaybeDeferred")()},platformName:"Messenger",realtimeUnderylingTransport:function(){return($||($=n("Promise"))).resolve(function(e,t){var n;return r("LSPlatformMqttRealtimeTransport")(r("LSVersion"),t,{getInstance:o("LSDedicatedMqttChannel").getInstance(function(){return!0},(n={},n[o("MqttEnv").MqttGkNames.mqttweb_global_connection_counter]=!1,n),function(e,t){return t},r("emptyFunction")),shutdownAndClear:o("LSDedicatedMqttChannel").shutdownAndClear})})},region:r("getMWLSRegion")(),schemaVersion:r("LSVersion"),sendHardcodedInitSync:!1,syncParams:r("LSPlatformMessengerSyncParams")};P.DEBUG(h||(h=babelHelpers.taggedTemplateLiteralLoose(["created config"]))),r("QPLUserFlow").addAnnotations(N,{string:{appId:l.appId}});var s=o("LSPlatformDeviceId").getDeviceIdForProviderType("ephemeral");r("QPLUserFlow").addPoint(N,"platform_client_init_start");var u=yield X(i,l,s);return r("QPLUserFlow").addPoint(N,"platform_client_init_end"),F=yield U(i),P.DEBUG(y||(y=babelHelpers.taggedTemplateLiteralLoose(["finished init successfully"]))),u}),q.apply(this,arguments)}function U(e){return V.apply(this,arguments)}function V(){return V=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=J(e);return yield o("EBIsEbEnabledSubscriber").initIsEbEnabledPubSub(e),yield o("EBEpochChangeListener").initEBEpochChangeListener(e),yield o("EBReenrollmentTriggerListener").initEBReenrollmentTriggerListener(e),o("EBResumeAutomaticEBInitialisation").resumeAutomaticEBInitialisation(),r("justknobx")._("862")&&o("EBOnboardDeviceWithAutomaticEB").onboardDeviceWithAutomaticEB(),t}),V.apply(this,arguments)}function H(e){return G.apply(this,arguments)}function G(){return G=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){if(e===void 0&&(e=!1),!e&&A!=null)return A.promise;var t=new(o("WAResolvable")).Resolvable;A=t,yield o("MAWVaultMaterialsStorage").setupVaultMaterials();var a={clearEbStores:o("EBDB").clearEbStores,flushEBSMtoEBDB:o("EBDBEbsmApi").flushEBSMtoEBDB,rehydrateEBSMFromEBDB:o("EBDBEbsmApi").rehydrateEBSMFromEBDB},l=yield o("LSJSEBInMemoryStorage").makeReStorePersistence(a),s=o("LSReStoreWrapper").createLSReStore(l,o("LSMetadata").schema,[r("MAWLSVaultingHooks")],void 0);return a.updateEBSM=o("EBDBEbsmApi").updateEBSM(s),yield s.runInTransaction((function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){yield o("LSDefaultSyncGroups").seedDb(e,void 0)});return function(t){return e.apply(this,arguments)}})(),"readwrite","ui",void 0,i.id+":245"),t.resolve(s),s}),G.apply(this,arguments)}function z(){return j.apply(this,arguments)}function j(){return j=n("asyncToGeneratorRuntime").asyncToGenerator(function*(){w!=null&&(yield o("EBWorkerAddDeviceUtils").clearLSEBSMTables(yield H()))}),j.apply(this,arguments)}function K(e){var t=r("MWEncryptedBackupsListenForChangesToBackupStateInitPath").listenForChangesToBackupState(e);return function(){t()}}function Q(t,n){var a=n==="Connected"?(D||(D=o("LSIntEnum"))).ofNumber(r("LSInternetConnectionState").CONNECTED):(D||(D=o("LSIntEnum"))).ofNumber(r("LSInternetConnectionState").NOT_CONNECTED);P.DEBUG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Platform client sync connection status: ",""])),n),r("promiseDone")(t.runInTransaction(function(e){return r("LSDeleteAllAndInsertConnectivityStatusStoredProcedure")(r("LSFactory")(e),{internetConnectionState:a})},"readwrite",void 0,void 0,i.id+":283"),function(){P.DEBUG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Platform client sync connection status set successfully"])))},function(e){throw P.MUSTFIX(u||(u=babelHelpers.taggedTemplateLiteralLoose(["Platform client sync connection status set failed: ",""])),e==null?void 0:e.message),e})}function X(e,t,n){return Y.apply(this,arguments)}function Y(){return Y=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t,n){P.DEBUG(C||(C=babelHelpers.taggedTemplateLiteralLoose(["Platform client sync starting..."])));var a=yield t.getEval();P.DEBUG(b||(b=babelHelpers.taggedTemplateLiteralLoose(["Getting datascript evaluator success"])));var i=a()(e);P.DEBUG(v||(v=babelHelpers.taggedTemplateLiteralLoose(["Clearing epoch before resume sync..."]))),P.DEBUG(S||(S=babelHelpers.taggedTemplateLiteralLoose(["Starting realtime transport"])));var l=yield t.realtimeUnderylingTransport(),s=o("LSPlatformRealtimeTransport").LSPlatformRealtimeTransport(l,t.appId,n);P.DEBUG(R||(R=babelHelpers.taggedTemplateLiteralLoose(["Starting task system"])));var u=new(r("MWPlatformTaskSystem"))(e,new(r("LSPlatformTaskSystemTransport"))(e,s,i,t.schemaVersion));P.DEBUG(L||(L=babelHelpers.taggedTemplateLiteralLoose(["Starting backup state listeners"])));var c=null;r("QPLUserFlow").addPoint(N,"sync_system_creation_skipped");var d=K(e);P.DEBUG(E||(E=babelHelpers.taggedTemplateLiteralLoose(["Watching for expired traces"])));var m;return r("promiseDone")(o("LSDataTraceFlushDeferred").watchForExpiredTraces(e).then(function(e){m=e})),P.DEBUG(k||(k=babelHelpers.taggedTemplateLiteralLoose(["Subscribing to mqtt sync status change events"]))),s.onConnectionStatusChange(function(t){Q(e,t)}),P.DEBUG(I||(I=babelHelpers.taggedTemplateLiteralLoose(["Platform client sync starting sucess"]))),{cleanup:function(){P.DEBUG(T||(T=babelHelpers.taggedTemplateLiteralLoose(["Platform client sync cleaning up"]))),u==null||u.cleanup(),s.cleanup(),c==null||c.cleanup(),d(),m==null||m(),F.forEach(function(e){return e()})},db:e}}),Y.apply(this,arguments)}function J(e){var t=[],n=Z(e);return t.push(n),t}function Z(e){var t=null;function a(e){var a=t===null?"null":String(t),i=String(e);o("MAWODSProxy").odsBumpEntityKey({entity:o("WAOdsEnums").Entity.EB_SWITCH_STATE,key:"ebls_switch.state_transition."+a+"_to_"+i}),P.DEBUG(c||(c=babelHelpers.taggedTemplateLiteralLoose(["EBLS Switch state transition: "," -> ",""])),a,i),t===!0&&e===!1&&(P.DEBUG(d||(d=babelHelpers.taggedTemplateLiteralLoose(["EBLS Switch detected true->false transition, setting timeout to check self-correction"]))),o("WAPromiseDelays").delayMs(1e3).then(n("asyncToGeneratorRuntime").asyncToGenerator(function*(){var e=yield o("EBIsEbEnabled").isEBEnabled(),t=e===!0;P.DEBUG(m||(m=babelHelpers.taggedTemplateLiteralLoose(["EBLS Switch true->false correction check: corrected=",", current_state=",""])),String(t),String(e)),o("MAWODSProxy").odsBumpEntityKey({entity:o("WAOdsEnums").Entity.EB_SWITCH_STATE,key:"ebls_switch.true_to_false_correction."+(t?"corrected":"not_corrected")});var n=r("MAWEBLSInWorkerSwitch").isEnabled(),a=e===n?"match":"mismatch";o("MAWODSProxy").odsBumpEntityKey({entity:o("WAOdsEnums").Entity.EB_SWITCH_STATE,key:"ebls_switch.true_to_false_check."+a})})).catch(function(e){P.catching(e).MUSTFIX(p||(p=babelHelpers.taggedTemplateLiteralLoose(["EBLS Switch failed to check true->false correction"])))})),r("MAWEBLSInWorkerSwitch").set(e),t=e}return o("ReQL").firstAsync(o("ReQL").fromTableAscending(e.tables.secure_encrypted_backups_client_state)).then(function(e){e!=null?a(ee(e)):a(!1)}).catch(function(e){P.catching(e).MUSTFIX(_||(_=babelHelpers.taggedTemplateLiteralLoose(["Failed to get initial state for EBLS Switch"])))}),e.tables.secure_encrypted_backups_client_state.subscribe(function(e,t){switch(P.DEBUG(f||(f=babelHelpers.taggedTemplateLiteralLoose(["EBLS Switch state changed. operation: ",""])),t.operation),t.operation){case"delete":a(!1);break;case"add":case"put":a(ee(t.value));break;default:throw t.operation,r("WAAssertUnreachable")(t.operation)}})}function ee(e){var t=e.authorityLevel,n=e.backupTenancy;if(t==null)return!1;var a=n!=null?n:(D||(D=o("LSIntEnum"))).ofNumber(r("LSEncryptedBackupsBackupTenancy").PRODUCTION);return(x||(x=o("I64"))).equal(a,(D||(D=o("LSIntEnum"))).ofNumber(r("LSEncryptedBackupsBackupTenancy").PRODUCTION))&&(x||(x=o("I64"))).equal(t,(D||(D=o("LSIntEnum"))).ofNumber(r("LSAuthorityLevel").AUTHORITATIVE))}l.init=M,l.genLSClient=O,l.getLSStorage=H,l.clearEBSMStorage=z,l.platformClientInit=X}),98);
__d("EBMessageEncryptionKeyStorage",["WABase64","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(e,t){return o("WABase64").encodeB64(e)+"|"+o("WABase64").encodeB64(t)}function u(t){var r=t.io,o=t.logger,a=new Map,i=(function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var n=t.mekCreatorEpochHead,i=t.minosThreadId,l=t.rosterHash,u=s(l,i),c=a.get(u);if(c!=null)return{cacheStatus:"cached-by-memory",registeredMek:c};var d=yield r.loadMessageEncryptionKey(i,l,n).catch(function(t){return o.ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["loadMessageEncryptionKey runtime-error: ",""])),t),null});return d!=null?(a.set(u,d),{cacheStatus:"cached-by-db",registeredMek:d}):null});return function(n){return t.apply(this,arguments)}})(),l=(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=e.createdBySelf,n=e.lastUsedTsMs,o=e.mekCreatorEpochHead,i=e.minosThreadId,l=e.registeredMek,u=e.rosterHash,c=s(u,i);a.set(c,l),yield r.saveNewMessageEncryptionKey(i,l.mek,l.mekFbid,t,n,o)});return function(n){return e.apply(this,arguments)}})();return{getMessageEncryptionKey:i,setNewMessageEncryptionKey:l}}l.createMessageEncryptionKeyStorage=u}),98);
__d("EBMessageEncryptionKeyStorageDecrypt",["asyncToGeneratorRuntime"],(function(t,n,r,o,a,i){"use strict";var e;function l(t){var r=t.io,o=t.logger,a=new Map,i=(function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var n=t.mekId,i=a.get(n);if(i!=null)return{cacheStatus:"cached-by-memory",registeredMek:i};var l=yield r.loadMessageEncryptionKeyForDecryption(n).catch(function(t){return o.ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["loadMessageEncryptionKeyForDecryption runtime-error: ",""])),t),null});return l!=null?(a.set(n,l),{cacheStatus:"cached-by-db",registeredMek:l}):null});return function(n){return t.apply(this,arguments)}})(),l=(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=e.createdBySelf,n=e.lastUsedTsMs,o=e.minosThreadId,i=e.registeredMek,l=i.mek.mekId;a.set(l,i),yield r.saveNewMessageEncryptionKey(o,i.mek,i.mekFbid,t,n,null)});return function(n){return e.apply(this,arguments)}})();return{getMessageEncryptionKeyDecrypt:i,setNewMessageEncryptionKeyDecrypt:l}}i.createMessageEncryptionKeyStorageDecrypt=l}),66);
__d("EBMessagePointQuery_facebookRelayOperation",[],(function(t,n,r,o,a,i){a.exports="32643898351892811"}),null);
__d("EBMessagePointQuery.graphql",["EBMessagePointQuery_facebookRelayOperation"],(function(t,n,r,o,a,i){"use strict";var e=(function(){var e={defaultValue:null,kind:"LocalArgument",name:"app_id"},t={defaultValue:!1,kind:"LocalArgument",name:"minos_gk_enabled"},r={defaultValue:null,kind:"LocalArgument",name:"restore_payload_string"},o={defaultValue:null,kind:"LocalArgument",name:"restore_type"},a=[{kind:"Variable",name:"app_id",variableName:"app_id"},{kind:"Variable",name:"restore_payload_string",variableName:"restore_payload_string"},{kind:"Variable",name:"restore_type",variableName:"restore_type"}],i={alias:null,args:null,kind:"ScalarField",name:"encryption_version",storageKey:null},l={alias:null,args:null,kind:"ScalarField",name:"epoch_anon_id",storageKey:null},s={alias:null,args:null,kind:"ScalarField",name:"epoch_id",storageKey:null},u={alias:null,args:null,kind:"ScalarField",name:"encrypted_protobuf_stanza",storageKey:null},c={alias:null,args:null,kind:"ScalarField",name:"protobuf_timestamp_ms",storageKey:null},d={alias:null,args:null,kind:"ScalarField",name:"sk_ciphertext",storageKey:null},m={alias:null,args:null,kind:"ScalarField",name:"supplemental_key",storageKey:null},p={alias:null,args:null,kind:"ScalarField",name:"supplemental_otid",storageKey:null},_={alias:null,args:null,kind:"ScalarField",name:"actor_token",storageKey:null},f={alias:null,args:null,kind:"ScalarField",name:"encrypted_protobuf",storageKey:null},g={alias:null,args:null,kind:"ScalarField",name:"mek_fbid",storageKey:null},h={alias:null,args:null,kind:"ScalarField",name:"mek_id",storageKey:null},y={alias:null,args:null,kind:"ScalarField",name:"protobuf_timestamp",storageKey:null},C={alias:null,args:null,kind:"ScalarField",name:"transport_sender_signing_pk",storageKey:null},b={alias:null,args:null,kind:"ScalarField",name:"transport_sender_message_signature",storageKey:null},v={alias:null,args:null,kind:"ScalarField",name:"franking_tag",storageKey:null},S={alias:null,args:null,kind:"ScalarField",name:"reporting_tag",storageKey:null},R={alias:null,args:null,kind:"ScalarField",name:"message_encryption_version",storageKey:null},L={alias:null,args:null,kind:"ScalarField",name:"message_metadata_version",storageKey:null},E=[l,s],k={alias:null,args:null,kind:"ScalarField",name:"id",storageKey:null};return{fragment:{argumentDefinitions:[e,t,r,o],kind:"Fragment",metadata:null,name:"EBMessagePointQuery",selections:[{alias:null,args:null,concreteType:"Viewer",kind:"LinkedField",name:"viewer",plural:!1,selections:[{alias:null,args:null,concreteType:"XFBEncryptedBackup",kind:"LinkedField",name:"encrypted_backup",plural:!1,selections:[{alias:null,args:null,concreteType:"XFBEncryptedBackupMailbox",kind:"LinkedField",name:"mailbox",plural:!1,selections:[{alias:null,args:a,concreteType:"XFBEncryptedBackupMessages",kind:"LinkedField",name:"messages_point_restore",plural:!1,selections:[{args:[{kind:"Variable",name:"minos_gk_enabled",variableName:"minos_gk_enabled"}],kind:"FragmentSpread",name:"handleRestoreMessagesGraphQLResponse_XFBEncryptedBackupMessages"}],storageKey:null}],storageKey:null}],storageKey:null}],storageKey:null}],type:"Query",abstractKey:null},kind:"Request",operation:{argumentDefinitions:[r,o,e,t],kind:"Operation",name:"EBMessagePointQuery",selections:[{alias:null,args:null,concreteType:"Viewer",kind:"LinkedField",name:"viewer",plural:!1,selections:[{alias:null,args:null,concreteType:"XFBEncryptedBackup",kind:"LinkedField",name:"encrypted_backup",plural:!1,selections:[{alias:null,args:null,concreteType:"XFBEncryptedBackupMailbox",kind:"LinkedField",name:"mailbox",plural:!1,selections:[{alias:null,args:a,concreteType:"XFBEncryptedBackupMessages",kind:"LinkedField",name:"messages_point_restore",plural:!1,selections:[{alias:null,args:null,concreteType:"XFBEncryptedBackupMessage",kind:"LinkedField",name:"encrypted_messages",plural:!0,selections:[{alias:null,args:null,concreteType:"XFBEchoDocument",kind:"LinkedField",name:"echo_document",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"echo_document_string",storageKey:null},i,l,s,{alias:null,args:null,kind:"ScalarField",name:"epoch_fingerprint",storageKey:null}],storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"otid",storageKey:null},{alias:null,args:null,concreteType:"XFBProtobufStanzas",kind:"LinkedField",name:"protobuf_stanzas",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"message_tags",storageKey:null},{alias:null,args:null,concreteType:"XFBProtobufStanza",kind:"LinkedField",name:"top_level_protobuf",plural:!1,selections:[u,i,l,s,c,d],storageKey:null},{alias:null,args:null,concreteType:"XFBProtobufStanza",kind:"LinkedField",name:"supplemental_protobufs",plural:!0,selections:[u,i,l,s,c,d,m,p],storageKey:null},{alias:null,args:null,concreteType:"XFBUnencryptedProtobufStanza",kind:"LinkedField",name:"top_level_protobuf_unencrypted",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"unencrypted_protobuf",storageKey:null},c],storageKey:null},{condition:"minos_gk_enabled",kind:"Condition",passingValue:!0,selections:[{alias:null,args:null,concreteType:"XFBMinosProtobufStanza",kind:"LinkedField",name:"top_level_protobuf_v2",plural:!1,selections:[_,f,g,h,y,C,b,v,S,R,L],storageKey:null},{alias:null,args:null,concreteType:"XFBMinosProtobufStanza",kind:"LinkedField",name:"supplemental_protobufs_v2",plural:!0,selections:[_,f,y,g,h,m,p,C,b,v,S,R,L],storageKey:null}]}],storageKey:null}],storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"backup_id",storageKey:null},{alias:null,args:null,concreteType:"XFBMessageRangeInfo",kind:"LinkedField",name:"message_range_info",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"has_more_before",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"has_more_after",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"next_message_timestamp_ms_before",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"next_message_timestamp_ms_after",storageKey:null}],storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"should_delete_mailbox",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"exception_string",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"thread_not_found",storageKey:null},{alias:null,args:null,concreteType:"XFBEpochDerivationSet",kind:"LinkedField",name:"epoch_derivation_set",plural:!1,selections:[{alias:null,args:null,concreteType:"XFBEncryptedBackupsEpochEdge",kind:"LinkedField",name:"epoch_edges",plural:!0,selections:[{alias:null,args:null,kind:"ScalarField",name:"backward_edge",storageKey:null},{alias:null,args:null,concreteType:"XFBEpochForwardEdge",kind:"LinkedField",name:"forward_edge",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"auth_public_key",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"encrypted_entropy",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"entropy_fingerprint",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"epoch_storage_public_key",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"psk_fingerprint",storageKey:null}],storageKey:null},{alias:null,args:null,concreteType:"XFBEpochIds",kind:"LinkedField",name:"from_epoch",plural:!1,selections:E,storageKey:null},{alias:null,args:null,concreteType:"XFBEpochIds",kind:"LinkedField",name:"to_epoch",plural:!1,selections:E,storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"from_epoch_fingerprint",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"to_epoch_fingerprint",storageKey:null}],storageKey:null}],storageKey:null},{condition:"minos_gk_enabled",kind:"Condition",passingValue:!0,selections:[{alias:null,args:null,concreteType:"XFBMinosDecryptionKeyMap",kind:"LinkedField",name:"minos_decryption_keys",plural:!0,selections:[k,{alias:null,args:null,concreteType:"XFBMinosDecryptionKeys",kind:"LinkedField",name:"keys",plural:!1,selections:[{alias:null,args:null,concreteType:"XFBMinosMekInfo",kind:"LinkedField",name:"mek_info",plural:!1,selections:[h,{alias:null,args:null,kind:"ScalarField",name:"roster_hash",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"encrypted_mek",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"mek_creation_timestamp",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"mek_encryption_version",storageKey:null}],storageKey:null},{alias:null,args:null,concreteType:"XFBMinosRecipientInfo",kind:"LinkedField",name:"recipient_info",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"epoch_fbid",storageKey:null},l,{alias:null,args:null,kind:"ScalarField",name:"epoch_head",storageKey:null}],storageKey:null},{alias:null,args:null,concreteType:"XFBMekCreatorInfo",kind:"LinkedField",name:"mek_creator_info",plural:!1,selections:[{alias:null,args:null,concreteType:"XFBMinosEncryptionKeys",kind:"LinkedField",name:"minos_keys",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"sender_auth_pk",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"sender_epoch_head",storageKey:null}],storageKey:null},{alias:null,args:null,concreteType:"XFBMinosTransportKeys",kind:"LinkedField",name:"transport_keys",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"ephm_hpke_pk",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"ephm_signature",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"mek_creator_transport_signing_pk",storageKey:null}],storageKey:null}],storageKey:null}],storageKey:null}],storageKey:null}]}],storageKey:null}],storageKey:null},k],storageKey:null}],storageKey:null}]},params:{id:n("EBMessagePointQuery_facebookRelayOperation"),metadata:{},name:"EBMessagePointQuery",operationKind:"query",text:null}}})();a.exports=e}),null);
__d("EBMinosWasmDecryptAndVerifyMessage",["EBMinosTypes","EBMinosWasm.pb","EBMinosWasmReactorSingleton","WAResultOrError","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";function e(){function e(e){return e.success!=null?o("WAResultOrError").makeResult(o("EBMinosTypes").unsafeCastToDecryptedMessage(e.success.plaintext)):o("WAResultOrError").makeError({errorName:"wasm-internal-invalid-result-type",failReason:e.errorMessage})}return(function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var n=t.cipherText,r=t.mekKey,a=t.messageEncryptionVersion,i=t.metadata,l=t.signature,s=t.transportSigningPK;return yield o("EBMinosWasmReactorSingleton").minosCommand({InputSpec:o("EBMinosWasm.pb").MinosCommandSpec,ResultSpec:o("EBMinosWasm.pb").MinosDecryptAndVerifyMessageResultSpec,validateResult:e},{decryptAndVerifyMessage:{encryptedMessageCiphertext:n,encryptedMessageSignature:l,mek:r,messageEncryptionVersion:a,metadata:i,transportSigningPk:s}})});function r(e){return t.apply(this,arguments)}return r})()}var s=e();l.decryptAndVerifyMessage=s}),98);
__d("EBMinosWasmDecryptMekForDistribution",["EBMinosTypes","EBMinosWasm.pb","EBMinosWasmReactorSingleton","WAResultOrError","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";function e(){function e(e){return e.success!=null?o("WAResultOrError").makeResult(o("EBMinosTypes").unsafeCastMekKey(e.success.mek)):o("WAResultOrError").makeError({errorName:"wasm-internal-invalid-result-type",failReason:e.errorMessage})}return(function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var n=t.encryptedMek,r=t.mailboxAuthPk,a=t.mailboxEncSk,i=t.mekEncryptionVersion,l=t.mekId,s=t.recipientEpochHead,u=t.rosterHash,c=t.senderEpochHead;return yield o("EBMinosWasmReactorSingleton").minosCommand({InputSpec:o("EBMinosWasm.pb").MinosCommandSpec,ResultSpec:o("EBMinosWasm.pb").DecryptMekForDistributionResultSpec,validateResult:e},{decryptMekForDistribution:{ciphertext:n,fromPk:r,mekEncryptionVersion:i,mekId:l,rosterHash:u,senderEpochHead:c,toEpochHead:s,toMailboxSk:a}})});function r(e){return t.apply(this,arguments)}return r})()}var s=e();l.decryptMekForDistribution=s}),98);
__d("EBMinosWasmDecryptMekForDistributionFromTransportSender",["EBMinosTypes","EBMinosWasm.pb","EBMinosWasmReactorSingleton","WAResultOrError","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";function e(){function e(e){return e.success!=null?o("WAResultOrError").makeResult(o("EBMinosTypes").unsafeCastMekKey(e.success.mek)):o("WAResultOrError").makeError({errorName:"wasm-internal-invalid-result-type",failReason:e.errorMessage})}return(function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var n=t.mekDistribution,r=t.mekEncryptionVersion,a=t.mekId,i=t.recipientEncSk,l=t.rosterHash;return yield o("EBMinosWasmReactorSingleton").minosCommand({InputSpec:o("EBMinosWasm.pb").MinosCommandSpec,ResultSpec:o("EBMinosWasm.pb").DecryptMekForDistributionFromTransportSenderResultSpec,validateResult:e},{decryptMekForDistributionFromTransportSender:{mekDistribution:n,mekId:a,recipientEncSk:i,rosterHash:l,version:r}})});function r(e){return t.apply(this,arguments)}return r})()}var s=e();l.createMinosWasmDecryptMekForDistributionFromTransportSender=e,l.decryptMekForDistributionFromTransportSender=s}),98);
__d("EBMinosWasmDeriveMailboxAuthKeypair",["EBMinosTypes","EBMinosWasm.pb","EBMinosWasmReactorSingleton","WAResultOrError","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";function e(){function e(e){var t=e.mailboxAuthPrivateKey,n=e.mailboxAuthPublicKey;return o("WAResultOrError").makeResult({pk:o("EBMinosTypes").unsafeCastToMailboxAuthPK(n),sk:o("EBMinosTypes").unsafeCastToMailboxAuthSK(t)})}return(function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var n=t.epochNumber,r=t.exportRootKey;return yield o("EBMinosWasmReactorSingleton").DEPRECATED_minosCommand({InputSpec:o("EBMinosWasm.pb").MinosCommandSpec,ResultSpec:o("EBMinosWasm.pb").DeriveMailboxAuthKeypairResultSpec,validateResult:e},{deriveMailboxAuthKeypair:{epochNumber:n,exportRootKey:r}})});function r(e){return t.apply(this,arguments)}return r})()}var s=e();l.deriveMailboxAuthKeypair=s}),98);
__d("EBMinosWasmDeriveMailboxEncryptionKeypair",["EBMinosTypes","EBMinosWasm.pb","EBMinosWasmReactorSingleton","WAResultOrError","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";function e(){function e(e){var t=e.mailboxEncryptionPrivateKey,n=e.mailboxEncryptionPublicKey;return o("WAResultOrError").makeResult({pk:o("EBMinosTypes").unsafeCastToMailboxEncryptionPK(n),sk:o("EBMinosTypes").unsafeCastToMailboxEncryptionSK(t)})}return(function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var n=t.epochNumber,r=t.exportRootKey;return yield o("EBMinosWasmReactorSingleton").DEPRECATED_minosCommand({InputSpec:o("EBMinosWasm.pb").MinosCommandSpec,ResultSpec:o("EBMinosWasm.pb").DeriveMailboxEncryptionKeypairResultSpec,validateResult:e},{deriveMailboxEncryptionKeypair:{epochNumber:n,exportRootKey:r}})});function r(e){return t.apply(this,arguments)}return r})()}var s=e();l.deriveMailboxEncryptionKeypair=s}),98);
__d("EBMinosWasmEncryptAndSignMessage",["EBMinosClientConfig","EBMinosLogger","EBMinosMessageEncryptionVersion","EBMinosTypes","EBMinosWasm.pb","EBMinosWasmReactorSingleton","WAResultOrError","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(){function t(t){var n=t.ciphertext,r=t.signature,a=t.version,i=o("EBMinosMessageEncryptionVersion").MinosMessageEncryptionVersion.cast(a);return i==null?(o("EBMinosLogger").minosLogger.ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Failed to cast message encryption version: ",""])),a),o("WAResultOrError").makeError("invalid-message-encryption-version")):o("WAResultOrError").makeResult({encryptedMsg:o("EBMinosTypes").unsafeCastToEncryptedMessage(n),signature:o("EBMinosTypes").unsafeCastToEncryptedMessageSignature(r),version:i})}return(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var n=e.mekKey,r=e.metadata,a=e.plaintext,i=e.transportSigningPK,l=e.transportSigningSK;return yield o("EBMinosWasmReactorSingleton").DEPRECATED_minosCommand({InputSpec:o("EBMinosWasm.pb").MinosCommandSpec,ResultSpec:o("EBMinosWasm.pb").MinosEncryptAndSignMessageResultSpec,validateResult:t},{encryptAndSignMessage:{conf:o("EBMinosClientConfig").MINOS_CLIENT_CONFIG,mek:n,metadata:r,plaintext:a,transportSigningPk:i,transportSigningSk:l}})});function r(t){return e.apply(this,arguments)}return r})()}var u=s();l.encryptAndSignMessage=u}),98);
__d("EBMinosWasmGenerateMekRosterHash",["EBMinosTypes","EBMinosWasm.pb","EBMinosWasmReactorSingleton","WAResultOrError","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";function e(){function e(e){var t=e.rosterHash;return o("WAResultOrError").makeResult(o("EBMinosTypes").unsafeCastMekRosterHash(t))}return(function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var n=t.epochHeads;return yield o("EBMinosWasmReactorSingleton").DEPRECATED_minosCommand({InputSpec:o("EBMinosWasm.pb").MinosCommandSpec,ResultSpec:o("EBMinosWasm.pb").GenerateMekRosterHashResultSpec,validateResult:e},{generateMekRosterHash:{epochHeads:n}})});function r(e){return t.apply(this,arguments)}return r})()}var s=e();l.generateMekRosterHash=s}),98);
__d("EBMinosWasmWrapTransportSigningPublicKey",["EBMinosTypes","EBMinosWasm.pb","EBMinosWasmReactorSingleton","WAResultOrError","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";function e(){function e(e){var t=e.prefixedKey;return o("WAResultOrError").makeResult(o("EBMinosTypes").unsafeCastToTransportSigningPK(t))}return(function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var n=t.signalIdentityPublicKey;return yield o("EBMinosWasmReactorSingleton").DEPRECATED_minosCommand({InputSpec:o("EBMinosWasm.pb").MinosCommandSpec,ResultSpec:o("EBMinosWasm.pb").WrapTransportSigningPublicKeyResultSpec,validateResult:e},{wrapTransportSigningPublicKey:{keyBytes:n}})});function r(e){return t.apply(this,arguments)}return r})()}var s=e();l.wrapTransportSigningPublicKey=s}),98);
__d("EBMinosWasmWrapTransportSigningSecretKey",["EBMinosTypes","EBMinosWasm.pb","EBMinosWasmReactorSingleton","WAResultOrError","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";function e(){function e(e){var t=e.prefixedKey;return o("WAResultOrError").makeResult(o("EBMinosTypes").unsafeCastToTransportSigningSK(t))}return(function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var n=t.signalIdentityPrivateKey;return yield o("EBMinosWasmReactorSingleton").DEPRECATED_minosCommand({InputSpec:o("EBMinosWasm.pb").MinosCommandSpec,ResultSpec:o("EBMinosWasm.pb").WrapTransportSigningSecretKeyResultSpec,validateResult:e},{wrapTransportSigningSecretKey:{keyBytes:n}})});function r(e){return t.apply(this,arguments)}return r})()}var s=e();l.wrapTransportSigningSecretKey=s}),98);
__d("EBMinosWrapTransportSigningKeypair",["EBMinosLogger","EBMinosWasmWrapTransportSigningPublicKey","EBMinosWasmWrapTransportSigningSecretKey","WAByteArray","WAResultOrError","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e,s;function u(e){return c.apply(this,arguments)}function c(){return c=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var n=t.privateKey,r=t.publicKey,a=o("EBMinosWasmWrapTransportSigningPublicKey").wrapTransportSigningPublicKey({signalIdentityPublicKey:o("WAByteArray").uint8ArrayToBuffer(r)}),i=yield a,l=o("EBMinosWasmWrapTransportSigningSecretKey").wrapTransportSigningSecretKey({signalIdentityPrivateKey:o("WAByteArray").uint8ArrayToBuffer(n)}),u=yield l;if(!i.success)return o("EBMinosLogger").minosLogger.ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Failed to wrap transport signing public key"]))),o("WAResultOrError").makeError("minos-wrap-transport-signing-keypair-error");if(!u.success)return o("EBMinosLogger").minosLogger.ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Failed to wrap transport signing secret key"]))),o("WAResultOrError").makeError("minos-wrap-transport-signing-keypair-error");var c={pk:i.value,sk:u.value};return o("WAResultOrError").makeResult(c)}),c.apply(this,arguments)}l.wrapTransportSigningKeypair=u}),98);
__d("EBMinosWasmMinosThreadIdFromActThreadId",["EBMinosTypes","EBMinosWasm.pb","EBMinosWasmReactorSingleton","WAResultOrError","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";function e(){function e(e){var t=e.threadId;return o("WAResultOrError").makeResult(o("EBMinosTypes").unsafeCastToMinosThreadId(t))}return(function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var n=t.actThreadId;return yield o("EBMinosWasmReactorSingleton").DEPRECATED_minosCommand({InputSpec:o("EBMinosWasm.pb").MinosCommandSpec,ResultSpec:o("EBMinosWasm.pb").MinosThreadIdFromActThreadIdResultSpec,validateResult:e},{minosThreadIdFromActThreadId:{actThreadId:n}})});function r(e){return t.apply(this,arguments)}return r})()}var s=e();l.minosThreadIdFromActThreadId=s}),98);
__d("EBMinosWasmMinosThreadIdFromOneToOneThread",["EBMinosTypes","EBMinosWasm.pb","EBMinosWasmReactorSingleton","WAResultOrError","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";function e(){function e(e){var t=e.threadId;return o("WAResultOrError").makeResult(o("EBMinosTypes").unsafeCastToMinosThreadId(t))}return(function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var n=t.actThreadId,r=t.selfFbid;return yield o("EBMinosWasmReactorSingleton").DEPRECATED_minosCommand({InputSpec:o("EBMinosWasm.pb").MinosCommandSpec,ResultSpec:o("EBMinosWasm.pb").MinosThreadIdFromOneToOneThreadResultSpec,validateResult:e},{minosThreadIdFromOneToOneThread:{actThreadId:n,selfFbid:r}})});function r(e){return t.apply(this,arguments)}return r})()}var s=e();l.minosThreadIdFromOneToOneThread=s}),98);
__d("MpsThreadIdToMinosThreadId",["EBMinosLogger","EBMinosWasmMinosThreadIdFromActThreadId","EBMinosWasmMinosThreadIdFromOneToOneThread","Promise","WAJids","WAResultOrError"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u;function c(t,r){var a=o("WAJids").validateUserJid(t);if(a!=null){var i=o("WAJids").userIdFromJid(a);return o("EBMinosWasmMinosThreadIdFromOneToOneThread").minosThreadIdFromOneToOneThread({actThreadId:i,selfFbid:r}).then(function(t){return t.success?o("WAResultOrError").makeResult(t.value):(o("EBMinosLogger").minosLogger.ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["mpsThreadIdToMinosThreadId UserJid error: ",""])),t.error),o("WAResultOrError").makeError("create-minos-thread-id-error"))})}var l=o("WAJids").validateGroupJid(t);if(l!=null){var c=o("WAJids").groupIdFromJid(l);return o("EBMinosWasmMinosThreadIdFromActThreadId").minosThreadIdFromActThreadId({actThreadId:c}).then(function(e){return e.success?o("WAResultOrError").makeResult(e.value):(o("EBMinosLogger").minosLogger.ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["mpsThreadIdToMinosThreadId GroupJid error: ",""])),e.error),o("WAResultOrError").makeError("create-minos-thread-id-error"))})}return(u||(u=n("Promise"))).resolve(o("WAResultOrError").makeError("invalid-mps-thread-id"))}l.mpsThreadIdToMinosThreadId=c}),98);
__d("MpsThreadIdToWaThreadId",["WAJids"],(function(t,n,r,o,a,i,l){"use strict";function e(e){var t=o("WAJids").validateUserJid(e);if(t!=null)return o("WAJids").userIdFromJid(t);var n=o("WAJids").validateGroupJid(e);return n!=null?o("WAJids").groupIdFromJid(n):null}l.mpsThreadIdToWaThreadId=e}),98);
__d("EBMinosCryptoLibrary",["Base64Utils","EBDecryptQplFlow","EBDeps","EBGenerateAndUploadMek","EBGetMinosAttachmentPayloadFromMpsMessage","EBMessageEncryptionKeyStorage","EBMessageEncryptionKeyStorageDecrypt","EBMinosCheckWasmFeatureSupport","EBMinosLogger","EBMinosMessageMetadataVersion","EBMinosProcessMessages","EBMinosTypes","EBMinosWasmDecryptAndVerifyMessage","EBMinosWasmDecryptMekForDistribution","EBMinosWasmDecryptMekForDistributionFromTransportSender","EBMinosWasmDeriveMailboxAuthKeypair","EBMinosWasmDeriveMailboxEncryptionKeypair","EBMinosWasmEncryptAndSignMessage","EBMinosWasmGenerateMekRosterHash","EBMinosWrapTransportSigningKeypair","MAWProtobufDeserializers","MpsThreadIdToMinosThreadId","MpsThreadIdToWaThreadId","MpsTypes","WAFrankingTypes","WAGetPlatformFromStanzaId","WAGlobals","WAResultOrError","WAStanzaUtils","asyncToGeneratorRuntime","err","gkx","nullthrows"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_,f,g,h,y,C,b,v,S,R,L,E;function k(e){return I.apply(this,arguments)}function I(){return I=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=e.io,a=t.loadMessageEncryptionKey,i=t.loadMessageEncryptionKeyForDecryption,l=t.loadMostRecentSelfMinosEpoch,s=t.loadSelfMinosEpochForDecryption,u=t.registerMinosMessageEncryptionKey,c=t.saveNewMessageEncryptionKey,d=e.logger,R=e.transportSigningKeypair,L=yield o("EBMinosCheckWasmFeatureSupport").checkWasmFeatureSupportAndGK();d.DEV(m||(m=babelHelpers.taggedTemplateLiteralLoose(["gk minos_rollout_enabled: ",""])),L);var E=o("EBMessageEncryptionKeyStorage").createMessageEncryptionKeyStorage({io:{loadMessageEncryptionKey:a,saveNewMessageEncryptionKey:c},logger:d}),k=o("EBMessageEncryptionKeyStorageDecrypt").createMessageEncryptionKeyStorageDecrypt({io:{loadMessageEncryptionKeyForDecryption:i,saveNewMessageEncryptionKey:c},logger:d}),I=yield o("EBMinosWrapTransportSigningKeypair").wrapTransportSigningKeypair(R);if(I.success===!1)return o("WAResultOrError").makeError("transport-signing-keypair-error");var T=I.value,D=(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=e.qplFlow,n=e.uploadEntity,a=n.deletionOfflineThreadingId,i=n.directive,s=n.isEphemeral,c=n.mailboxKeys,m=n.messageId,y=n.payload,C=n.senderId,b=n.supplementalOpToken,v=n.tags,S=n.threadId,R=n.timestampMs;t.addAnnotations({bool:{mek_reuse_enabled:r("gkx")("7918")}}),t.addPoint("generate_mek_roster_hash_start");var L=c.map(function(e){var t=e.epochHead;return t}),k=yield o("EBMinosWasmGenerateMekRosterHash").generateMekRosterHash({epochHeads:L});if(!k.success)return t.addPoint("generate_mek_roster_hash_fail"),o("WAResultOrError").makeError("generate-mek-roster-hash-error");var I=k.value;t.addPoint("generate_mek_roster_hash_end"),t.addPoint("get_or_generate_mek_start");var D=o("EBMinosTypes").userJidToUserFbId(o("WAGlobals").getMyUserJid());if(D==null)return d.ERROR(p||(p=babelHelpers.taggedTemplateLiteralLoose(["selfFbid is invalid"]))),o("WAResultOrError").makeError("invalid-self-fbid");var x=yield o("MpsThreadIdToMinosThreadId").mpsThreadIdToMinosThreadId(S,D);if(!x.success)return d.ERROR(_||(_=babelHelpers.taggedTemplateLiteralLoose(["mpsThreadIdToMinosThreadId error: ",""])),x.error),o("WAResultOrError").makeError("create-minos-thread-id-error");var P=x.value,N=yield M({actThreadId:r("nullthrows")(o("MpsThreadIdToWaThreadId").mpsThreadIdToWaThreadId(S),"invalid MPS threadId"),io:{loadMostRecentSelfMinosEpoch:l,registerMinosMessageEncryptionKey:u},logger:d,mailboxKeys:c,mekStorage:E,minosThreadId:P,msgUploadQpl:t,rosterHash:I,transportSigningKeypair:T});if(!N.success)return d.ERROR(f||(f=babelHelpers.taggedTemplateLiteralLoose(["get or generate mek error: ",""])),N.error),t.addPoint("get_or_generate_mek_fail"),o("WAResultOrError").makeError("get-mek-error");t.addPoint("get_or_generate_mek_end",{string:{mekCacheStatus:N.value.cacheStatus}});var w=N.value.registeredMek,A=w.mek,F=w.mekFbid,O=o("EBMinosMessageMetadataVersion").MESSAGE_METADATA_CURRENT_VERSION;t.addAnnotations({int:{message_metadata_version:O}});var B=o("EBMinosProcessMessages").createMessageTimestamp(R,O,m);t.addPoint("encrypt_message_start");var W=yield o("EBMinosWasmEncryptAndSignMessage").encryptAndSignMessage({mekKey:A.key,metadata:{mekId:A.mekId,messageId:m,threadId:P,timestamp:B},plaintext:new Uint8Array(y),transportSigningPK:T.pk,transportSigningSK:T.sk});if(!W.success)return d.ERROR(g||(g=babelHelpers.taggedTemplateLiteralLoose(["message encryption error: ",""])),W.error),t.addPoint("encrypt_message_fail"),o("WAResultOrError").makeError("encrypt-message-error");t.addAnnotations({int:{message_encryption_version:W.value.version}}),t.addPoint("encrypt_message_end");var q=yield o("EBGetMinosAttachmentPayloadFromMpsMessage").getMinosAttachmentPayloadFromMpsMessage({logger:d,message:{messageId:m,payload:y,senderId:C,threadId:S,timestampMs:R},qplFlow:t});d.DEV(h||(h=babelHelpers.taggedTemplateLiteralLoose([""," attchmentSecrets generated"])),q.length);var U=$(a,y),V=U.frankingTag,H=U.reportingTag;return o("WAResultOrError").makeResult({attachmentPayload:q,backupActionType:i.actionType,backupFbid:n.backupFbid,deletionOfflineThreadingId:a,encryptedMsg:W.value.encryptedMsg,encryptedMsgSignature:W.value.signature,frankingTag:V,isEphemeral:s,mekFbid:F,mekId:A.mekId,messageEncryptionVersion:W.value.version,messageMetadataVersion:O,messageTimestampMs:R,otid:m,reportingTag:H,supplementalOpToken:b,tags:v,toplevelOfflineThreadingId:o("MpsTypes").toMessageId(i.originalMsgProtocolId.externalId),transportSigningPK:T.pk,waThreadId:S})});return function(n){return e.apply(this,arguments)}})(),x=(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t,n=e.encryptedMessage,a=e.encryptedMsgSignature,i=e.entryPoint,l=e.mekCreatorInfo,u=e.mekFbid,c=e.mekInfo,m=e.messageEncryptionVersion,p=e.messageInfo,_=e.messageMetadataVersion,f=e.recipientInfo,g=e.source,h=e.threadId,R=e.transportSigningPK,L=o("EBDecryptQplFlow").startDecryptQplFlow({decryptionType:"protobuf_message_decryptor",entryPoint:i,isMinos:!0,source:g,threadId:h});L.addAnnotations({bool:{mek_reuse_enabled:r("gkx")("7918")},int:{mek_creation_time_sec:c.mekCreationTimestamp,mek_encryption_version:c.mekEncryptionVersion,message_encryption_version:m,metadata_version:_,timestamp_ms:p.timestamp},string:{mek_fbid:u,message_id:p.messageId,platform_type:o("WAGetPlatformFromStanzaId").getPlatformFromStanzaId(o("WAStanzaUtils").toStanzaId(p.messageId)),sender_type:l.senderType}}),L.addPoint("load_self_minos_epoch_for_decryption_start");var E=yield s(f.epochFbId,c.mekEncryptionVersion);if(!E.success&&r("gkx")("269")&&E.error==="no-self-epoch-found"){d.WARN(y||(y=babelHelpers.taggedTemplateLiteralLoose(["no self epoch found - will try to sync epochs"]))),L.addPoint("sync_epochs_start");var I=yield o("EBDeps").getDeps().getEBSMAPI(),T=yield I.repairEpochs();T.success?(L.addPoint("sync_epochs_end"),E=yield s(f.epochFbId,c.mekEncryptionVersion)):(d.ERROR(C||(C=babelHelpers.taggedTemplateLiteralLoose(["sync epochs error: ",""])),T.error),L.addAnnotations({string:{sync_epochs_error:T.error.message,sync_epochs_error_code:T.error.errorCode}}),L.addPoint("sync_epochs_fail"))}if(!E.success)return d.ERROR(b||(b=babelHelpers.taggedTemplateLiteralLoose(["epoch decryption error for message ID ",": ",""])),p.messageId,E.error),L.endFailWithError("load_self_minos_epoch_for_decryption_fail",E.error),o("WAResultOrError").makeError(E.error);L.addPoint("load_self_minos_epoch_for_decryption_end"),L.addPoint("derive_mailbox_encryption_key_pair_start");var D=yield o("EBMinosWasmDeriveMailboxEncryptionKeypair").deriveMailboxEncryptionKeypair({epochNumber:f.epochAnonId,exportRootKey:E.value.exportRootKey});if(!D.success)return d.ERROR(v||(v=babelHelpers.taggedTemplateLiteralLoose(["mailbox encryption key pair derivation error for message ID ",": ",""])),p.messageId,D.error),L.endFailWithError("derive_mailbox_encryption_key_pair_fail",D.error),o("WAResultOrError").makeError("derive-mailbox-keys-error");var x=D.value.sk;L.addPoint("derive_mailbox_encryption_key_pair_end"),L.addPoint("get_or_decrypt_message_encryption_key_start");var $=yield P({logger:d,mailboxEncryptionSK:x,mekCreatorInfo:l,mekFbid:u,mekInfo:c,mekStorageDecrypt:k,minosThreadId:p.threadId,qplFlow:L,recipientEpochHead:(t=f.epochHead)!=null?t:E.value.exportEpochHead,transportSigningPK:R});if(!$.success){var N;return L.endFailWithError($.error.errorName,(N=$.error.failReason)!=null?N:"decrypt-mek-error"),o("WAResultOrError").makeError("decrypt-mek-error")}L.addPoint("get_or_decrypt_mailbox_encryption_key_end",{string:{mekCacheStatus:$.value.cacheStatus}}),L.addPoint("decrypt_and_verify_message_start");var M=yield o("EBMinosWasmDecryptAndVerifyMessage").decryptAndVerifyMessage({cipherText:n,mekKey:$.value.mekKey,messageEncryptionVersion:m,metadata:{mekId:c.mekId,messageId:p.messageId,threadId:p.threadId,timestamp:p.timestamp},signature:a,transportSigningPK:R});if(!M.success){var w=M.error,A=w.errorName,F=w.failReason;return d.ERROR(S||(S=babelHelpers.taggedTemplateLiteralLoose(["message decryption error for message ID ",": ",""])),p.messageId,F!=null?F:A),L.endFailWithError("decrypt_and_verify_message_fail",F!=null?F:A),o("WAResultOrError").makeError("decrypt-message-error")}return L.addPoint("decrypt_and_verify_message_end"),L.endSuccess(),o("WAResultOrError").makeResult(M.value)});return function(n){return e.apply(this,arguments)}})();return o("WAResultOrError").makeResult({decryptMessage:x,encryptMessage:D})}),I.apply(this,arguments)}var T=null;function D(t){if(T!=null){o("EBMinosLogger").minosLogger.DEV(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Minos crypto library is already set"])));return}o("EBMinosLogger").minosLogger.DEV(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Minos crypto library is initialized"]))),T=t}function x(){if(T==null)throw o("EBMinosLogger").minosLogger.ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["Minos crypto library is not set"]))),r("err")("Minos crypto library is not set");return T}function $(e,t){var n=null,r=null;if(e==null){var a,i,l=o("MAWProtobufDeserializers").DeserializedBackupMessage.create(t),s=(a=l.proto.metadata)==null||(a=a.frankingMetadata)==null?void 0:a.frankingTag;s==null?o("EBMinosLogger").minosLogger.ERROR(c||(c=babelHelpers.taggedTemplateLiteralLoose(["missing frankingTag in upload"]))):n=o("WAFrankingTypes").castToFrankingTag(new Uint8Array(s));var u=(i=l.proto.metadata)==null||(i=i.frankingMetadata)==null?void 0:i.reportingTag;u==null?o("EBMinosLogger").minosLogger.ERROR(d||(d=babelHelpers.taggedTemplateLiteralLoose(["missing reportingTag in upload"]))):r=o("WAFrankingTypes").castToReportingTag(new Uint8Array(u))}return{frankingTag:n,reportingTag:r}}function P(e){return N.apply(this,arguments)}function N(){return N=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=e.logger,n=e.mailboxEncryptionSK,a=e.mekCreatorInfo,i=e.mekFbid,l=e.mekInfo,s=e.mekStorageDecrypt,u=e.minosThreadId,c=e.qplFlow,d=e.recipientEpochHead,m=e.transportSigningPK;if(r("gkx")("7918")){var p=yield s.getMessageEncryptionKeyDecrypt({mekId:l.mekId});if(c.addAnnotations({bool:{mek_reuse:p!=null}}),p!=null)return o("WAResultOrError").makeResult({cacheStatus:p.cacheStatus,mekKey:p.registeredMek.mek.key})}c.addPoint("decrypt_mek_start");var _=a.senderType==="Transport"?yield o("EBMinosWasmDecryptMekForDistributionFromTransportSender").decryptMekForDistributionFromTransportSender({mekDistribution:{encryptedMek:l.encryptedMek,ephemeralEncryptionPk:a.transportSenderEphemeralPK,recipientEpochHead:d,signature:a.transportSenderEphemeralKeySig,signingPk:m},mekEncryptionVersion:l.mekEncryptionVersion,mekId:l.mekId,recipientEncSk:n,rosterHash:l.mekRosterHash}):yield o("EBMinosWasmDecryptMekForDistribution").decryptMekForDistribution({encryptedMek:l.encryptedMek,mailboxAuthPk:a.senderMailboxAuthPK,mailboxEncSk:n,mekEncryptionVersion:l.mekEncryptionVersion,mekId:l.mekId,recipientEpochHead:d,rosterHash:l.mekRosterHash,senderEpochHead:a.senderEpochHead});if(c.addPoint("decrypt_mek_end"),!_.success)return t.ERROR(R||(R=babelHelpers.taggedTemplateLiteralLoose(["mek decryption error: ",""])),_.error),_;if(r("gkx")("7918")&&a.senderType!=="Transport"){var f={key:_.value,mekId:l.mekId,rosterHash:l.mekRosterHash},g={mek:f,mekFbid:i};yield s.setNewMessageEncryptionKeyDecrypt({createdBySelf:!1,lastUsedTsMs:o("MpsTypes").toTimestamp(Date.now()),minosThreadId:u,registeredMek:g})}return o("WAResultOrError").makeResult({cacheStatus:"new",mekKey:_.value})}),N.apply(this,arguments)}function M(e){return w.apply(this,arguments)}function w(){return w=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=e.actThreadId,r=e.io,a=e.logger,i=e.mailboxKeys,l=e.mekStorage,s=e.minosThreadId,u=e.msgUploadQpl,c=e.rosterHash,d=e.transportSigningKeypair,m=yield r.loadMostRecentSelfMinosEpoch().then((function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){if(e==null)return o("WAResultOrError").makeError("unable-to-get-latest-epoch");var t=yield o("EBMinosWasmDeriveMailboxAuthKeypair").deriveMailboxAuthKeypair({epochNumber:e.epochNumber,exportRootKey:e.exportRootKey});return t.success?(u.addAnnotations({string:{epoch_fbid:e.epochFbId,epoch_head:o("Base64Utils").fromArrayBuffer(e.epochHead)}}),o("WAResultOrError").makeResult({epochFbId:e.epochFbId,epochHead:e.epochHead,mailboxAuthKeyPair:t.value})):(a.ERROR(L||(L=babelHelpers.taggedTemplateLiteralLoose(["Unable to get mailbox auth key pair for sender - failed with exception ",""])),t.error),o("WAResultOrError").makeError("unable-to-get-sender-mailbox-auth-key-pair"))});return function(t){return e.apply(this,arguments)}})()),p=m.success?{fromKeypair:m.value.mailboxAuthKeyPair,senderEpochFbId:m.value.epochFbId,senderEpochHead:m.value.epochHead,senderType:"Minos"}:{senderType:"Transport",transportSigningKp:d};if(p.senderType!=="Transport"){var _=yield l.getMessageEncryptionKey({mekCreatorEpochHead:p.senderEpochHead,minosThreadId:s,rosterHash:c});if(_!=null)return o("WAResultOrError").makeResult(_)}var f=yield o("EBGenerateAndUploadMek").generateAndUploadMek({actThreadId:t,io:{registerMinosMessageEncryptionKey:r.registerMinosMessageEncryptionKey},logger:a,msgUploadQpl:u,participantMailboxes:i,sender:p});if(!f.success)return a.ERROR(E||(E=babelHelpers.taggedTemplateLiteralLoose(["mek register error: ",""])),f.error),o("WAResultOrError").makeError("register-mek-error");var g={mek:f.value.mek,mekFbid:f.value.mekFbid};return p.senderType!=="Transport"&&(yield l.setNewMessageEncryptionKey({createdBySelf:!0,lastUsedTsMs:o("MpsTypes").toTimestamp(Date.now()),mekCreatorEpochHead:p.senderEpochHead,minosThreadId:s,registeredMek:g,rosterHash:c})),o("WAResultOrError").makeResult({cacheStatus:"new",registeredMek:g})}),w.apply(this,arguments)}l.createMinosCryptoLibrary=k,l.setMinosCryptoLibrary=D,l.getMinosCryptoLibrary=x}),98);
__d("EBMinosSaveNewMinosMessageEpochHead",["EBMinosDb","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e=(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t,n){var r=yield o("EBMinosDb").getEBMinosDb();yield r.runInTransaction(["secure_minos_message_epoch_heads"],"readwrite",function(r){return r.stores.secure_minos_message_epoch_heads.bulkPut([{epoch_head:e,message_id:t,thread_id:n}])},"SaveNewMinosMessageEpochHead")});return function(n,r,o){return e.apply(this,arguments)}})();l.saveNewMinosMessageEpochHead=e}),98);
__d("EBMinosDecryptMessages",["EBMinosCryptoLibrary","EBMinosLogger","EBMinosProcessMessages","EBMinosSaveNewMinosMessageEpochHead","EBMinosTypes","MpsThreadIdToMinosThreadId","MpsTypes","Promise","WAGlobals","WAResultOrError","WATimeUtils","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u;function c(e){var t=e.keys.mekCreatorInfo.minosKeys,n=e.keys.mekCreatorInfo.transportKeys;return t!=null?{senderEpochHead:t.senderEpochHead,senderMailboxAuthPK:t.senderAuthPk,senderType:"Minos"}:n?{senderType:"Transport",transportSenderEphemeralKeySig:n.ephmSignature,transportSenderEphemeralPK:n.ephmHpkePk}:null}function d(e,t,n,r,o,a,i){return m.apply(this,arguments)}function m(){return m=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t,n,r,a,i,l,s){var u=r.get(a.mekFbid);if(u==null)return o("WAResultOrError").makeError("missing-encrypted-mek");var d=c(u);if(d==null)return o("WAResultOrError").makeError("missing-mek-creator-info");var m=o("EBMinosProcessMessages").createMessageTimestamp(a.protobufTimestamp,a.messageMetadataVersion,n),p=yield o("EBMinosCryptoLibrary").getMinosCryptoLibrary().decryptMessage({encryptedMessage:a.encryptedProtobuf,encryptedMsgSignature:a.transportSenderMessageSignature,entryPoint:s,mekCreatorInfo:d,mekFbid:a.mekFbid,mekInfo:u.keys.mekInfo,messageEncryptionVersion:a.messageEncryptionVersion,messageInfo:{messageId:n,threadId:t,timestamp:m},messageMetadataVersion:a.messageMetadataVersion,recipientInfo:u.keys.recipientInfo,source:l,threadId:i,transportSigningPK:a.transportSenderSigningPk});if(!p.success)return o("WAResultOrError").makeError(p.error);var _={decryptedProtobuf:p.value,decryptedSupplementalKey:null,protobufTimestampMs:o("WATimeUtils").castLongIntToMillisTime(a.protobufTimestamp)};return d.senderType==="Minos"&&(yield o("EBMinosSaveNewMinosMessageEpochHead").saveNewMinosMessageEpochHead(d.senderEpochHead,n,i).catch(function(t){return o("EBMinosLogger").minosLogger.ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["saveNewMinosMessageEpochHead failed with error: ",""])),t),o("WAResultOrError").makeError("failed-to-save-epoch-head")})),o("WAResultOrError").makeResult(_)}),m.apply(this,arguments)}function p(e,t,n,r,o,a,i){return _.apply(this,arguments)}function _(){return _=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t,n,r,a,i,l){var u=n.supplementalOtid,d=t.get(n.mekFbid);if(d==null)return o("WAResultOrError").makeError("missing-encrypted-mek");var m=c(d);if(m==null)return o("WAResultOrError").makeError("missing-mek-creator-info");if(u==null)return o("WAResultOrError").makeError("missing-supplemental-otid");var p=o("MpsTypes").toMessageId(u),_=o("EBMinosProcessMessages").createMessageTimestamp(n.protobufTimestamp,n.messageMetadataVersion,p),f=yield o("EBMinosCryptoLibrary").getMinosCryptoLibrary().decryptMessage({encryptedMessage:n.encryptedProtobuf,encryptedMsgSignature:n.transportSenderMessageSignature,entryPoint:l,mekCreatorInfo:m,mekFbid:n.mekFbid,mekInfo:d.keys.mekInfo,messageEncryptionVersion:n.messageEncryptionVersion,messageInfo:{messageId:p,threadId:e,timestamp:_},messageMetadataVersion:n.messageMetadataVersion,recipientInfo:d.keys.recipientInfo,source:i,threadId:a,transportSigningPK:n.transportSenderSigningPk});if(!f.success)return o("WAResultOrError").makeError(f.error);var g={decryptedProtobuf:f.value,decryptedSupplementalKey:r,protobufTimestampMs:o("WATimeUtils").castLongIntToMillisTime(n.protobufTimestamp)};return m.senderType==="Minos"&&(yield o("EBMinosSaveNewMinosMessageEpochHead").saveNewMinosMessageEpochHead(m.senderEpochHead,p,a).catch(function(e){return o("EBMinosLogger").minosLogger.ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["saveNewMinosMessageEpochHead failed with error: ",""])),e),o("WAResultOrError").makeError("save-epoch-head-error")})),o("WAResultOrError").makeResult(g)}),_.apply(this,arguments)}function f(e,t,n,r,o){return g.apply(this,arguments)}function g(){return g=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t,r,a,i){var l=new Map,s=o("EBMinosTypes").userJidToUserFbId(o("WAGlobals").getMyUserJid());if(s==null)return o("WAResultOrError").makeError("invalid-self-fbid");var c=yield o("MpsThreadIdToMinosThreadId").mpsThreadIdToMinosThreadId(e,s);if(!c.success)return o("WAResultOrError").makeError("create-minos-thread-id-error");var m=[];return yield(u||(u=n("Promise"))).all(r.map((function(){var r=n("asyncToGeneratorRuntime").asyncToGenerator(function*(r){var s=r.messageTags,_=r.otid,f=r.supplementalProtobufsV2,g=r.topLevelProtobufV2,h=yield d(c.value,_,t,g,e,a,i);if(!h.success)return m.push("failed_to_decrypt_top_level_protobuf_"+h.error);var y=new Map;f!=null&&(yield(u||(u=n("Promise"))).all(f.map((function(){var r=n("asyncToGeneratorRuntime").asyncToGenerator(function*(n){var r=n.supplementalKey;if(r!=null){var l=yield p(c.value,t,n,r,e,a,i);if(l.success)y.set(o("MpsTypes").toSupplementalKey(r),l.value);else return m.push("failed_to_decrypt_supplemental_level_protobuf_"+l.error)}});return function(e){return r.apply(this,arguments)}})()))),l.set(_,{messageTags:s,otid:_,supplementalProtobufs:y,topLevelProtobuf:h.value})});return function(e){return r.apply(this,arguments)}})())),o("WAResultOrError").makeResult({decryptionResult:l,errorMessages:m})}),g.apply(this,arguments)}l.minosDecryptMessages=f}),98);
__d("EBValidateMinosMessages",["EBMinosLogger","EBMinosProcessMessages","EBMinosTypes","MAWProtobufDeserializers","MpsTypes","Promise","WAArmadilloXMA.pb","WACryptoUtils","WAFranking","WAFrankingTypes","WAGlobals","WALongInt","WAResultOrError","asyncToGeneratorRuntime","getErrorSafe","gkx"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c;function d(e,t,n,r){return m.apply(this,arguments)}function m(){return m=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t,a,i){var l=yield(c||(c=n("Promise"))).all(e.map((function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var n=e.otid,i=e.topLevelProtobufV2.protobufTimestamp,l=e.topLevelProtobufV2.actorToken,c=t.get(n);if(c==null)return t.delete(n),"message-id-not-found";var d=o("MAWProtobufDeserializers").DeserializedBackupMessage.create(c.topLevelProtobuf.decryptedProtobuf);if(d==null)return t.delete(n),"failed-to-deserialize-decrypted-protobuf";var m=d.proto.metadata;if(m==null)return t.delete(n),"protobuf-message-metadata-null";var g=m.timestampMs;if(g==null)return t.delete(n),"minos-protobuf-timestamps-mismatch";try{var h=o("WALongInt").numberOrThrowIfTooLarge(g);if(o("MpsTypes").toTimestamp(h)!==i)return t.delete(n),"minos-protobuf-timestamps-mismatch"}catch(e){return o("EBMinosLogger").minosLogger.ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["timestamp-convert-error-",""])),r("getErrorSafe")(e).message),t.delete(n),"timestamp-covert-error"}if(m.senderId==null||o("EBMinosTypes").unsafeCastToUserFbId(m.senderId)!==l)return t.delete(n),"sender-id-actor-token-mismatch";var y=d.payload();if(y==null)return t.delete(n),"protobuf-message-payload-null";if(p(d,l))return t.delete(n),"peer-only-protobuf-message-validation-failure";if(_(d))return t.delete(n),"calling-xma-protobuf-message-validation-failure";var C=yield f(d,a);if(!C.success)return t.delete(n),o("EBMinosLogger").minosLogger.ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["act sanitizer validation failed: ",""])),C.error),"act_sanitizer_validation_failed";if(y.kind==="messageApplication"){var b,v,S,R,L=y.consumerMessage(),E=L==null||(b=L.payload)==null||(b=b.applicationData)==null?void 0:b.revoke;if(E!=null)return;var k=(v=y.proto.metadata)==null?void 0:v.frankingKey,I=y.bytes,T=e.topLevelProtobufV2.frankingTag,D=(S=y.proto.metadata)==null?void 0:S.frankingVersion;if(k==null)return t.delete(n),"franking-key-null";if(T==null)return r("gkx")("704")&&t.delete(n),"franking-tag-null";var x=yield o("WAFranking").validateFrankingTag(new Uint8Array(I),o("WAFrankingTypes").castToFrankingKey(new Uint8Array(k)),o("WAFrankingTypes").castToFrankingTag(new Uint8Array(T)),D);if(x===!1)return r("gkx")("704")&&t.delete(n),"franking-tag-validation-failed";var $=e.topLevelProtobufV2.reportingTag,P=(R=m.frankingMetadata)==null?void 0:R.reportingTag;if($==null||P==null)return r("gkx")("704")&&t.delete(n),"reporting-tag-null";if(!o("WACryptoUtils").arrayBuffersEqual($.buffer,P))return r("gkx")("704")&&t.delete(n),"reporting-tag-mismatch";var N=m.clientTimestampMs;if(N!=null?N=o("WALongInt").numberOrThrowIfTooLarge(N):N=o("EBMinosProcessMessages").extractTimestampFromOtid(n),Math.abs(N-i)>36e5)return t.delete(n),"client_server_timestamp_delta_over_1_hour"}});return function(t){return e.apply(this,arguments)}})())),d=l.filter(Boolean);return i.addAnnotations({bool:{minos_validation_success:d.length===0},string_array:{minos_validation_errors:d}}),t}),m.apply(this,arguments)}function p(t,n){var r,a=(r=t.encryptedTransportMessage())==null||(r=r.armadillo())==null||(r=r.payload)==null||(r=r.applicationData)==null||(r=r.metadataSync)==null?void 0:r.actions;if(a==null)return!1;var i=o("EBMinosTypes").userJidToUserFbId(o("WAGlobals").getMyUserJid());if(i==null)return o("EBMinosLogger").minosLogger.ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Failed-to-get-userFbid"]))),!0;for(var l of a!=null?a:[])if((l.attachmentInterventionAction!=null||l.chatAction!=null||l.messageAction!=null||l.spectraAction!=null)&&i!==n)return!0;return!1}function _(e){var t,n=(t=e.encryptedTransportMessage())==null||(t=t.armadillo())==null||(t=t.extendedContentMessage())==null||(t=t.payload)==null?void 0:t.targetType;return!r("gkx")("5782")||n==null?!1:n===o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_AUDIO_CALL||n===o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_VIDEO_CALL||n===o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_MISSED_AUDIO_CALL||n===o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_MISSED_VIDEO_CALL||n===o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_GROUP_AUDIO_CALL||n===o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_GROUP_VIDEO_CALL||n===o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_MISSED_GROUP_AUDIO_CALL||n===o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_MISSED_GROUP_VIDEO_CALL||n===o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_ONGOING_AUDIO_CALL||n===o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_ONGOING_VIDEO_CALL}function f(e,t){return g.apply(this,arguments)}function g(){return g=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t){var n,r=(n=e.encryptedTransportMessage())==null||(n=n.armadillo())==null||(n=n.payload)==null||(n=n.content)==null?void 0:n.extendedContentMessage;if(r==null)return o("WAResultOrError").makeResult();var a=yield t(r);return a}),g.apply(this,arguments)}l.validateMinosMessages=d}),98);
__d("EBMinosDecryptAndValidateMessages",["Base64Utils","EBMinosDecryptMessages","EBMinosEncryptedMekVersion","EBMinosLogger","EBMinosTypes","EBValidateMinosMessages","MpsTypes","WALongInt","WAResultOrError","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d;function m(t){if(t==null)return null;var n=t.id,r=t.keys;if(n==null||r==null)return null;var a=o("EBMinosTypes").unsafeCastToMekFbId(n),i=r.mek_creator_info,l=r.mek_info,s=r.recipient_info;if(l==null||i==null||s==null)return null;var u=l.encrypted_mek,c=l.mek_creation_timestamp,d=l.mek_encryption_version,m=l.mek_id,p=l.roster_hash;if(u==null||d==null||m==null||p==null||c==null)return null;var _=o("EBMinosEncryptedMekVersion").MinosEncryptedMekVersion.cast(d);if(_==null)return o("EBMinosLogger").minosLogger.ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Failed to cast mek encryption version: ",""])),d),null;var f={encryptedMek:o("EBMinosTypes").unsafeCastToEncryptedMek(o("Base64Utils").toArrayBuffer(u)),mekCreationTimestamp:o("MpsTypes").toTimestamp(parseInt(c,10)),mekEncryptionVersion:_,mekId:o("EBMinosTypes").unsafeCastToMekId(o("Base64Utils").toArrayBuffer(m)),mekRosterHash:o("EBMinosTypes").unsafeCastMekRosterHash(o("Base64Utils").toArrayBuffer(p))},g=s.epoch_anon_id,h=s.epoch_fbid,y=s.epoch_head;if(g==null||h==null||y==null)return null;var C={epochAnonId:o("EBMinosTypes").unsafeCastToEpochNumber(o("WALongInt").decimalStringToLongInt(new TextDecoder().decode(o("Base64Utils").toArrayBuffer(g)))),epochFbId:o("EBMinosTypes").unsafeCastToEpochFbId(h),epochHead:o("EBMinosTypes").unsafeCastToEpochHead(o("Base64Utils").toArrayBuffer(y))},b=i.minos_keys,v=i.transport_keys;if(b==null&&v==null)return null;var S=b!=null?b:{},R=S.sender_auth_pk,L=S.sender_epoch_head,E=R!=null&&L!=null?{senderAuthPk:o("EBMinosTypes").unsafeCastToMailboxAuthPK(o("Base64Utils").toArrayBuffer(R)),senderEpochHead:o("EBMinosTypes").unsafeCastToEpochHead(o("Base64Utils").toArrayBuffer(L))}:null,k=v!=null?v:{},I=k.ephm_hpke_pk,T=k.ephm_signature,D=k.mek_creator_transport_signing_pk,x=I!=null&&T!=null&&D!=null?{ephmHpkePk:o("EBMinosTypes").unsafeCastToTransportSenderEphemeralPK(o("Base64Utils").toArrayBuffer(I)),ephmSignature:o("EBMinosTypes").unsafeCastToTransportSenderEphemeralKeySig(o("Base64Utils").toArrayBuffer(T)),mekCreatorTransportSigningPk:o("EBMinosTypes").unsafeCastToTransportSigningPK(o("Base64Utils").toArrayBuffer(D))}:null;return E==null&&x==null?null:{id:a,keys:{mekCreatorInfo:{minosKeys:E,transportKeys:x},mekInfo:f,recipientInfo:C}}}function p(e){var t=new Map((e!=null?e:[]).map(function(e){return e.id==null?null:[o("EBMinosTypes").unsafeCastToMekFbId(e.id),m(e)]}).filter(Boolean));return t}function _(e){return f.apply(this,arguments)}function f(){return f=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=e.encryptedMinosMessages,n=e.entryPoint,r=e.minosDecryptionKeys,a=e.qplFlow,i=e.source,l=e.threadId,m=e.validator;if(t.length===0)return o("WAResultOrError").makeResult({decryptionResult:new Map,errorMessages:[]});try{var _=p(r),f=yield o("EBMinosDecryptMessages").minosDecryptMessages(l,_,t,i,n);if(!f.success)return o("EBMinosLogger").minosLogger.ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["decrypt msgs failed: "," }"])),f.error),f;if(o("EBMinosLogger").minosLogger.DEV(u||(u=babelHelpers.taggedTemplateLiteralLoose(["decrypt msgs completed. total: ",", success: ",", failed: ",""])),t.length,f.value.decryptionResult.size,f.value.errorMessages.length),f.value.decryptionResult.size===0)return f;var g=yield o("EBValidateMinosMessages").validateMinosMessages(t,f.value.decryptionResult,m,a);return o("EBMinosLogger").minosLogger.DEV(c||(c=babelHelpers.taggedTemplateLiteralLoose(["validate msgs completed. total: ",", success: ",""])),t.length,g.size),o("WAResultOrError").makeResult({decryptionResult:g,errorMessages:f.value.errorMessages})}catch(e){return o("EBMinosLogger").minosLogger.ERROR(d||(d=babelHelpers.taggedTemplateLiteralLoose(["Failed to decrypt messages: ",""])),e),o("WAResultOrError").makeError("runtime-error")}}),f.apply(this,arguments)}l.minosDecryptAndValidateMessages=_}),98);
__d("EBgenerateMPSMessageQuery",["EBGraphQLRestoreDefinition","MSGDataclassTypes.flow"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t){return{__typename:"MPSMessageQuery",ctx:{__typename:"MPSQueryContext",caller:o("MSGDataclassTypes.flow").MpsQueryCaller.HistoryRestore},query:{__typename:"MPSMessagePointQuery",include_deleted:!1,otids:t,thread_id:e}}}function s(t,n){return o("EBGraphQLRestoreDefinition").toMpsMessageQueryForGraphQLQuery(JSON.stringify(e(t,n)))}l.generateMPSMessageQuery=e,l.generateMPSMessageQueryForGraphQLQuery=s}),98);
__d("MAWDexie",["cr:10766"],(function(t,n,r,o,a,i,l){"use strict";i.exports=n("cr:10766")}),34);
__d("MAWDexieTable",["MAWDexie","Promise","asyncToGeneratorRuntime","justknobx"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(t){return(e||(e=n("Promise"))).resolve(t)}function u(e){return e.reduce(function(e,t,n){return e.then(function(e){return t(n).then(function(t){return e.push(t),e})})},g([]))}function c(e){return r("MAWDexie").Promise.all(e)}function d(e){return r("MAWDexie").Promise.allSettled(e)}function m(e){return r("MAWDexie").Promise.PSD[e]}function p(e,t){r("MAWDexie").Promise.PSD[e]=t}function _(e){r("MAWDexie").Promise.PSD[e]=void 0}var f=(function(){function e(e,t,n,o){n===void 0&&(n=!0);var a=new(r("MAWDexie"))(e,babelHelpers.extends({},o,{chromeTransactionDurability:"relaxed",modifyChunkSize:r("justknobx")._("3166")}));t(a),this.name=e,this.stores=a,n&&this.open()}var t=e.prototype;return t.open=function(){this.stores.open()},t.close=function(){this.stores.close()},t.transact=function(t,r,o){var e=this;return s(this.stores.transaction(t,r.map(function(t){return e.stores[t]}),n("asyncToGeneratorRuntime").asyncToGenerator(function*(){var e=yield o();return e})))},babelHelpers.createClass(e,[{key:"tables",get:function(){return this.stores.tables}}])})();function g(e){return r("MAWDexie").Promise.resolve(e)}l.DEXIE_MIN_KEY=o("MAWDexie").Dexie.minKey,l.DEXIE_MAX_KEY=o("MAWDexie").Dexie.maxKey,l.undexify=s,l.dexieSequentialAll=u,l.dexieAll=c,l.dexieAllSettled=d,l.getDexiePSDItem=m,l.setDexiePSDItem=p,l.clearDexiePSDItem=_,l.DexieTable=f,l.dexieResolve=g}),98);
__d("MAWDbParticipant",[],(function(t,n,r,o,a,i){"use strict";function e(e,t){return e+"_"+t}i.craftParticipantId=e}),66);
__d("MAWDbThread",["MAWHexUtils"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t){return o("MAWHexUtils").orderPreservingHex(e)+"_"+t}l.craftThreadOrder=e}),98);
__d("MAWDbSchema.dexie",["FBLogger","MAWDbMsg","MAWDbParticipant","MAWDbThread","MAWDbVersionList","MAWDexie","MAWDexieTable","MAWFolderTypes","MAWLocalizationType","MAWODSProxy","MAWTimeUtils","WAJids","WALogger","WAMsg","WAMsgType","WAOdsEnums","WAStanzaUtils","WATimeUtils","emptyFunction","vulture"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u=function(t){var e=function(t){var e,n=(e=t.quote)==null?void 0:e.content;return t.quoteExternalId!=null&&(n==null?void 0:n.media)!=null};return t.messages.where("quoteExternalId").between(o("WAStanzaUtils").toStanzaId("0"),o("WAStanzaUtils").toStanzaId("["),!0,!0).filter(e).toArray().catch(function(){return t.messages.filter(e).toArray()}).then(function(e){var n=new Set(e.map(function(e){var t,n,r=(t=e.quote)==null?void 0:t.content;return r==null||(n=r.media)==null?void 0:n.plaintextHash}).filter(Boolean)),r=e.map(function(e){var t=e.msgId;return t});return t.media.filter(function(e){var t=e.plaintextHash;return n.has(t)}).toArray().then(function(e){var n=new Map(e.map(function(e){var t=e.mediaId,n=e.plaintextHash;return[n,t]}));return t.messages.where("msgId").anyOf(r).modify(function(e){var t=e.quote;if(t!=null&&t.content!=null){var r=t.content;r.mediaId=n.get(r.media.plaintextHash),delete r.media}})})})},c=function(t){return t.groupInfo.toCollection().modify(function(e){typeof e.inviter=="number"&&delete e.inviter})},d=function(){return o("MAWDexieTable").dexieResolve()},m=function(t){return t.threads.filter(function(e){return o("WAJids").switchOnMsgrChatJidType(e.jid,{group:function(){return!1},user:function(){return e.oldestMsg!=null}})}).toArray().then(function(e){var n=[];return e.forEach(function(e){n.push(e.oldestMsg),n.push(o("MAWDbMsg").toMsgId__UNSAFE_DO_NOT_USE(e.newestMsg))}),t.messages.where("msgId").anyOf(n.filter(Boolean)).toArray().then(function(n){var r=new Map,a=[],i=[];n.forEach(function(e){r.set(e.msgId,e)}),e.forEach(function(e){var n=r.get(e.oldestMsg),l=r.get(e.newestMsg);return(n==null?void 0:n.type)==="Admin"&&(l==null?void 0:l.type)==="Admin"&&(n.msgId===l.msgId?i.push(e.chatId):a.push(e)),o("MAWDexieTable").dexieAll(a.map(function(e){return t.messages.where("thread").equals(e.chatId).toArray()})).then(function(e){return e.forEach(function(e){if(e.length!==0){var t=e[0].thread,n=e.filter(function(e){return e.type!=="Admin"});n.length>0||i.push(t)}}),o("MAWDexieTable").dexieAll([t.threads.bulkDelete(i),t.messages.where("thread").anyOf(i).delete()])})})})})},p=function(t){return t.unrenderedMessages.toCollection().modify(function(e){if(e.type===o("WAMsgType").MSG_TYPE.DELETE_FOR_ME){var t=e.messageDeleteForMeTs;e.messageDeleteForMeTs=t}})},_=function(t){var e=0,n=0,a=r("MAWDexie").currentTransaction;if(a==null)throw r("FBLogger")("maw_db").mustfixThrow("transaction does not exist");return a.on("complete",function(){e>0&&o("MAWODSProxy").odsBumpEntityKey({amount:e,entity:o("WAOdsEnums").Entity.MESSAGE_MISSING_THREAD_JID,key:"fail"}),n>0&&o("MAWODSProxy").odsBumpEntityKey({amount:n,entity:o("WAOdsEnums").Entity.MESSAGE_MISSING,key:"fail"})}),t.threads.toArray().then(function(r){var a=r.reduce(function(e,t){return t!=null&&e.set(t.chatId,t),e},new Map);return o("MAWDexieTable").dexieAll([t.messages.toCollection().modify(function(t){if(t!=null){var r=a.get(t.thread);r!=null?t.threadJid=r.jid:e+=1}else n+=1}),t.unrenderedMessages.toCollection().modify(function(t){if(t!=null){var r=a.get(t.thread);r!=null?t.threadJid=r.jid:e+=1}else n+=1})])})},f=function(t){return t.isDualSend.toCollection().modify(function(e){e.version==null&&(e.version=1)})},g=function(t){return t.messages.toCollection().modify(function(e){e.type===o("WAMsgType").MSG_TYPE.ADMIN&&e.msgContent.adminType===o("MAWLocalizationType").LOCALIZATION_TYPE.E2EE_THREAD_DESCRIPTION&&(e.altIndex=o("MAWDbMsg").craftE2eeAdminMsgAltIndex(e.thread))})},h=function(t){return t.messages.toCollection().modify(function(e){e.sortOrderMs=o("MAWDbMsg").getSortOrderWithFallback(e)})},y=function(t){return t.threads.toCollection().modify(function(e){e.folder==null&&(e.folder=o("MAWFolderTypes").FOLDER_ID.INBOX)})},C=function(t){return t.messages.toCollection().modify(function(e){e.sortOrderMs=o("MAWDbMsg").getSortOrderWithFallback(e)})},b=function(t){return t.personalSenderKeyStatuses.toCollection().modify(function(e){e.rotateSenderKey=!0,e.hasSenderKey=new Set})},v=function(t){return t.messages.toCollection().modify(function(e){e.type===o("WAMsgType").MSG_TYPE.ADMIN&&e.msgContent.adminType===o("MAWLocalizationType").LOCALIZATION_TYPE.CUTOVER_THREAD_ADMIN_MESSAGE&&e.sortOrderMs!=null&&e.sortOrderMs>0&&(e.sortOrderMs=0)})},S=function(t){return t.messages.toCollection().modify(function(e){!(e.type===o("WAMsgType").MSG_TYPE.ADMIN&&(e.msgContent.adminType===o("MAWLocalizationType").LOCALIZATION_TYPE.CUTOVER_THREAD_ADMIN_MESSAGE||e.msgContent.adminType===o("MAWLocalizationType").LOCALIZATION_TYPE.E2EE_THREAD_DESCRIPTION))&&e.sortOrderMs!=null&&e.sortOrderMs<1661204086&&(e.sortOrderMs=o("MAWDbMsg").getCanonicalTsFromMsg(e)*1e3)})},R=function(t){return t.threads.filter(function(e){return e.isMigratedLocally===!0&&e.newestMsg!=null}).toArray().then(function(e){var n=e.map(function(e){return e.chatId}),r=new Map;return o("MAWDexieTable").dexieAll(e.map(function(e){return t.messages.where(["thread","sortOrderMs"]).between([e.chatId,0],[e.chatId,Number.MAX_VALUE]).last().then(function(e){e!=null&&r.set(e.thread,e.msgId)})})).then(function(){return t.threads.where("chatId").anyOf(n)})})},L=function(){return o("MAWDexieTable").dexieResolve()},E=function(t){return t.threads.toCollection().modify(function(e){if(e.lastReadMsgTs!=null&&e.lastReadMsgTs<o("WATimeUtils").MAX_INT&&(e.lastReadMsgTs=o("MAWTimeUtils").ensureValidMillisTime(e.lastReadMsgTs)),e.newestMsgTs!=null&&e.newestMsgTs<o("WATimeUtils").MAX_INT){var t=o("MAWTimeUtils").ensureValidMillisTime(e.newestMsgTs);e.newestMsgTs=t,t!=null&&(e.threadOrder=o("MAWDbThread").craftThreadOrder(t,e.jid))}})},k=function(t){return t.messages.toCollection().modify(function(e){e.type===o("WAMsgType").MSG_TYPE.ADMIN&&e.msgContent.adminType===o("MAWLocalizationType").LOCALIZATION_TYPE.CUTOVER_THREAD_ADMIN_MESSAGE&&(e.altIndex=o("MAWDbMsg").craftCutoverAdminMsgAltIndex(e.thread))})},I=function(){return o("MAWDexieTable").dexieResolve()},T=function(){return o("MAWDexieTable").dexieResolve()},D=function(){return o("MAWDexieTable").dexieResolve()},x=function(t){return t.participants.toCollection().modify(function(e){var t;e==null||!((t=e.userJid)!=null&&t.includes("@msgr@msgr"))||(e.id=e.id.replace("@msgr@msgr","@msgr"),e.userJid=e.userJid.replace("@msgr@msgr","@msgr"))}).then(r("emptyFunction"))},$=function(t){var e=t.threads.filter(function(e){return e.snippetMsg!=null&&e.snippetMsgTs==null});return e.toArray().then(function(n){var r=n.reduce(function(e,t){return t!=null&&t.snippetMsg!=null&&e.set(t.jid,t.snippetMsg),e},new Map),a=Array.from(r.values());return t.messages.where("msgId").anyOf(a).toArray().then(function(t){var n=t.reduce(function(e,t){return t!=null&&t.serverTs!=null&&e.set(t.msgId,t.serverTs),e},new Map);e.modify(function(e){var t=r.get(e.jid);if(t!=null){var a=n.get(t);a!=null&&(e.snippetMsgTs=o("WATimeUtils").castUnixTimeToMillisTime(a))}})})})},P=function(t){return t.threads.toArray().then(function(e){return o("MAWDexieTable").dexieAll(e.map(function(e){return t.participants.where("threadId").equals(e.chatId).modify(function(t){var n;t.threadJid=(n=t.threadJid)!=null?n:e.jid})}))})},N=P,M=function(t){var e=[];return t.groupInvites.toArray().then(function(n){var o=n.map(function(e){return e.invitedParticipantId});return t.participants.bulkGet(o).then(function(o){o.forEach(function(t,r){if(t==null){var o=n[r];e.push(o)}});var a=o.filter(Boolean);return t.groupInvites.bulkPut(n.map(function(t){r("vulture")("ENZBv3M2AdQWc64Uu-LwyNOTxR0=");var n=a.find(function(e){return e.id===t.invitedParticipantId});return n!=null?(t.inviteeJid=n.userJid,t.threadJid=n.threadJid,babelHelpers.extends({},t,{inviteeJid:n.userJid,threadJid:n.threadJid})):(e.push(t),t)}))})}).then(function(){return t.groupInvites.bulkDelete(e.map(function(e){return[e.invitedParticipantId,e.inviterJid]}))})},w=function(n){var t=new Map;return n.receipts.toArray().then(function(a){return o("MAWDexieTable").dexieAll(a.map(function(a){return n.messages.get({msgId:a.msgId}).then(function(i){if(i==null)return n.receipts.delete(a.msgId).then(r("emptyFunction"));var l=o("WAMsg").craftWAMsgIdString({author:i.author,chat:i.threadJid,externalId:i.externalId});if(t.has(l)){var s,u=(s=t.get(l))!=null?s:1;return t.set(l,u),o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Duplicate waMsgId found for receipt, number of duplicates: ",""])),u),n.receipts.delete(a.msgId).then(r("emptyFunction"))}else return t.set(l,1),n.receipts.where("msgId").equals(i.msgId).modify(function(e){e.waMsgId=l}).then(r("emptyFunction"))})}))})},A=function(){return o("MAWDexieTable").dexieResolve()},F=function(t){return t.participants.toArray().then(function(e){var n=e.map(function(e){return babelHelpers.extends({},e,{id:o("MAWDbParticipant").craftParticipantId(e.threadJid,e.userJid)})}),r=e.map(function(e){return e.id});return t.participants.bulkDelete(r).then(function(){t.participants.bulkPut(n)})})},O=function(t){return t.reactions.toCollection().modify(function(e){e.ts=e.ts})},B=new Map([[(s=o("MAWDbVersionList")).VERSION.V26,u],[s.VERSION.V27,c],[s.VERSION.V28,d],[s.VERSION.V29,m],[s.VERSION.V30,p],[s.VERSION.V31,_],[s.VERSION.V43,f],[s.VERSION.V44,g],[s.VERSION.V45,h],[s.VERSION.V46,y],[s.VERSION.V47,C],[s.VERSION.V53,b],[s.VERSION.V54,v],[s.VERSION.V55,S],[s.VERSION.V56,R],[s.VERSION.V57,L],[s.VERSION.V58,E],[s.VERSION.V60,k],[s.VERSION.V66,I],[s.VERSION.V68,T],[s.VERSION.V71,D],[s.VERSION.V72,x],[s.VERSION.V82,$],[s.VERSION.V85,P],[s.VERSION.V87,N],[s.VERSION.V90,M],[s.VERSION.V91,w],[s.VERSION.V101,A],[s.VERSION.V104,F],[s.VERSION.V116,O]]);l.dbUpgrades=B}),98);
__d("MAWDbSchemaReStoreDexieUtils",["FBLogger","MAWDbSchema","MAWDbSchema.dexie","sortBy"],(function(t,n,r,o,a,i,l){"use strict";var e=r("sortBy")(Array.from(new Set([].concat(Array.from(o("MAWDbSchema").dbSchema.keys()),Array.from(o("MAWDbSchema.dexie").dbUpgrades.keys())))).map(function(e){return{schema:o("MAWDbSchema").dbSchema.get(e),upgrade:o("MAWDbSchema.dexie").dbUpgrades.get(e),version:e}}),function(e){var t=e.version;return t}),s=function(t,n){return Array.from(t.filter(function(e){return e.version<=n&&e.schema!=null}).reduce(function(e,t){var n;return(n=t.schema)==null||n.forEach(function(t){e.set(t.name,t)}),e},new Map).values())},u=function(t,n){return s(t,n).reduce(function(e,t){var n=t.autoIncrement,o=t.dexieOnly_primaryKeyUnique,a=t.name,i=t.primaryKey,l=t.removed,s=a.replace(/^e2ee_/,"");if(l===!0)return e[s]=null,e;if(n&&o===!0)throw r("FBLogger")("messenger_web").mustfixThrow("Invalid schema, cannot have both autoincremnet and unique constraints "+JSON.stringify(t));var u=n?"++":"",c=o===!0?"&":"",d=(i.length>1?"[":"")+i.join("+")+(i.length>1?"]":""),m=Object.values(t.indexes).map(function(e){var t=e.columns,n=e.unique!==!1,r=t.length>1,o=e.multiEntry_DO_NOT_USE===!0,a=n&&!o?"&":"",i=o?"*":"",l=""+a+i;return""+l+(r?"[":"")+t.join("+")+(r?"]":"")}).join(",");return e[s]=[""+u+c+d,m].filter(Boolean).join(","),e},{})},c=function(n){return u(e,n)};l.MAW_DB_VERSION_CHANGES=e,l.getDexieSchemaForVersion=u,l.getCompleteDexieSchemaForVersion=c}),98);
__d("MAWDbVersion",["MAWCurrentUser","MAWDbSchemaReStoreDexieUtils","MAWDbVersionList","MAWGetDbVersion","MAWIndexedDbMetadata","MAWODSProxy","MWFBLogger","Promise","WAOdsEnums"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_,f,g,h=o("MWFBLogger").MWLogger().tags(["db","getDexieDbVersion"]),y=o("MAWGetDbVersion").getArmadilloDbVersion(),C=o("MAWDbSchemaReStoreDexieUtils").getCompleteDexieSchemaForVersion(Math.min(o("MAWDbSchemaReStoreDexieUtils").MAW_DB_VERSION_CHANGES[o("MAWDbSchemaReStoreDexieUtils").MAW_DB_VERSION_CHANGES.length-1].version,y>0?y:1/0));function b(e,t){var n=t.schema,r=t.upgrade,o=t.version;return n!=null&&r!=null?e.version(o).stores(n).upgrade(r):n!=null?e.version(o).stores(n):r!=null?e.version(o).upgrade(r):e.version(o),o}function v(t){return new(g||(g=n("Promise")))(function(n){if(!indexedDB){n();return}var r=indexedDB.open(t);r.onupgradeneeded=function(r){r.target.transaction.abort();var o=r.target.result;h.DEBUG(e||(e=babelHelpers.taggedTemplateLiteralLoose([""," onupgradeneeded - closing db"])),t),o==null||o.close(),n()},r.onsuccess=function(e){var r=e.target.result,a=r==null?void 0:r.version;h.DEBUG(s||(s=babelHelpers.taggedTemplateLiteralLoose([""," version: ",""])),t,a!=null?a:"null"),r==null||r.close(),a!=null?(a%10>=1&&o("MAWODSProxy").odsBumpEntityKey({amount:1,entity:o("WAOdsEnums").Entity.MAW_DB_UNEXPECTED_VERSION,key:"fail_"+a%10}),n(o("MAWDbVersionList").toVersion(a/10))):n()},r.onerror=function(e){var r;h.DEBUG(u||(u=babelHelpers.taggedTemplateLiteralLoose([""," error ",""])),t,e==null||(r=e.target)==null||(r=r.error)==null?void 0:r.message),n()},r.onblocked=function(e){var n=e.target.result,r=n==null?void 0:n.version;h.DEBUG(c||(c=babelHelpers.taggedTemplateLiteralLoose([""," blocked, version: ",""])),t,r!=null?r:"null"),n==null||n.close()}})}function S(){var e=o("MAWCurrentUser").getID();return v(o("MAWIndexedDbMetadata").dbName(e))}function R(e,t){if(e.upgrade!=null||t.upgrade!=null)return!0;var n=Object.keys((e==null?void 0:e.schema)||{}),r=Object.keys((t==null?void 0:t.schema)||{}),o=[].concat(n,r),a=new Set(o);return a.size!==o.length}function L(e){return e.reduce(function(e,t,n){if(n===0)return[babelHelpers.extends({},t,{schema:o("MAWDbSchemaReStoreDexieUtils").getCompleteDexieSchemaForVersion(t.version)})];var r=e[e.length-1],a=babelHelpers.extends({},t,{schema:t.schema!=null?o("MAWDbSchemaReStoreDexieUtils").getDexieSchemaForVersion([t],t.version):null});return R(r,a)?(e.push(a),e):(e.splice(e.length-1,1,babelHelpers.extends({},r,a,{schema:babelHelpers.extends({},r==null?void 0:r.schema,a==null?void 0:a.schema)})),e)},[])}function E(e,t,n,r){var a=r!=null?r:o("MAWGetDbVersion").getArmadilloDbVersion==null?void 0:o("MAWGetDbVersion").getArmadilloDbVersion();h.DEBUG(d||(d=babelHelpers.taggedTemplateLiteralLoose(["current db version: ",", target db version: ",""])),n,a),a==null&&h.WARN(m||(m=babelHelpers.taggedTemplateLiteralLoose(["version is not set in QE"]))),n!=null&&n>a&&(h.WARN(p||(p=babelHelpers.taggedTemplateLiteralLoose(["current db version is greater than target db version"]))),a=n);var i=o("MAWDbSchemaReStoreDexieUtils").MAW_DB_VERSION_CHANGES.filter(function(e){var t=e.version;return n==null||t>n}).filter(function(e){var t=e.version;return a==null||a>=t}),l=o("MAWDbSchemaReStoreDexieUtils").MAW_DB_VERSION_CHANGES.filter(function(e){var t=e.version;return a==null||a>=t});if(i.length===0||i.length===l.length){h.DEBUG(_||(_=babelHelpers.taggedTemplateLiteralLoose(["Skipping db upgrade and just applying latest schema"]))),t.addAnnotations({bool:{isUpgradeNeeded:!1}});var s=o("MAWDbSchemaReStoreDexieUtils").MAW_DB_VERSION_CHANGES[o("MAWDbSchemaReStoreDexieUtils").MAW_DB_VERSION_CHANGES.length-1].version,u=Math.min(a!=null&&a>0?a:s,s);return e.version(u).stores(o("MAWDbSchemaReStoreDexieUtils").getCompleteDexieSchemaForVersion(u)),u}var c=L(i);h.DEBUG(f||(f=babelHelpers.taggedTemplateLiteralLoose(["Applying "," updates between "," and ",""])),c.length,i[0].version,i[i.length-1].version);var g=c.filter(function(e){return!!e.upgrade}).map(function(e){return e.version.toString()}),y=c.filter(function(e){return!!e.schema}).map(function(e){return e.version.toString()});g.length&&t.addAnnotations({string_array:{dataMigrationVersions:g}}),y.length&&t.addAnnotations({string_array:{schemaUpgradeVersions:y}}),t.addAnnotations({bool:{isUpgradeNeeded:!0}});var C=0;return c.forEach(function(t){var n;C=Math.max((n=b(e,t))!=null?n:0,C!=null?C:0)}),C}l.CURRENT_MAW_STORES=C,l.getDexieDbVersion=v,l.getDBVersion=S,l.updateDB=E}),98);
__d("MAWDexieError",[],(function(t,n,r,o,a,i){"use strict";var e="ModifyError",l="BulkError",s="OpenFailedError",u="VersionChangeError",c="SchemaError",d="UpgradeError",m="InvalidTableError",p="MissingAPIError",_="NoSuchDatabaseError",f="InvalidArgumentError",g="SubTransactionError",h="UnsupportedError",y="InternalError",C="DatabaseClosedError",b="PrematureCommitError",v="ForeignAwaitError",S="UnknownError",R="ConstraintError",L="DataError",E="TransactionInactiveError",k="ReadOnlyError",I="VersionError",T="NotFoundError",D="InvalidStateError",x="InvalidAccessError",$="AbortError",P="TimeoutError",N="QuotaExceededError",M="SyntaxError",w="DataCloneError",A={AbortError:$,BulkError:l,ConstraintError:R,DatabaseClosedError:C,DataCloneError:w,DataError:L,ForeignAwaitError:v,InternalError:y,InvalidAccessError:x,InvalidArgumentError:f,InvalidStateError:D,InvalidTableError:m,MissingAPIError:p,ModifyError:e,NoSuchDatabaseError:_,NotFoundError:T,OpenFailedError:s,PrematureCommitError:b,QuotaExceededError:N,ReadOnlyError:k,SchemaError:c,SubTransactionError:g,SyntaxError:M,TimeoutError:P,TransactionInactiveError:E,UnknownError:S,UnsupportedError:h,UpgradeError:d,VersionChangeError:u,VersionError:I};i.DEXIE_ERROR=A}),66);
__d("MAWIDbSetupQplEventListener",["MAWDexieError","MAWQplProxy","qpl"],(function(t,n,r,o,a,i,l){"use strict";var e,s=null;function u(t){var n=new Set(Object.keys(o("MAWDexieError").DEXIE_ERROR));n.has(t.reason)&&e!=null&&(e.endFail(t.reason),o("MAWQplProxy").sendQplPointThroughBridge(r("qpl")._(25310776,"6155"),"database_setup_failed"),s!=null&&(s(),s=null))}var c=function(r,o){return e=r,s=o,t.addEventListener("unhandledrejection",u),function(){return t.removeEventListener("unhandledrejection",u)}};l.trackDbSetupFailure=c}),98);
__d("MAWLowLevelApiTypes",["$InternalEnum"],(function(t,n,r,o,a,i){"use strict";var e={EXISTING_GROUP_INVITE:"existing_group_invite",MISSING_GROUP:"missing_group"},l={EXPIRED_GROUP_INVITE:"expired_group_invite",MISSING_GROUP:"missing_group",MISSING_GROUP_INVITE:"missing_group_invite"},s=n("$InternalEnum")({Initializing:"initializing",Open:"open",Closed:"closed",Error:"error",Upgrading:"upgrading"});i.WRITE_GROUP_INVITE_ERROR=e,i.GET_GROUP_INVITE_ERROR=l,i.DatabaseState=s}),66);
__d("MAWDbFactory",["ClientConsistencyEventEmitter","Deferred","MAWCurrentUser","MAWDbVersion","MAWDexieTable","MAWGetDbVersion","MAWIDbSetupQplEventListener","MAWIndexedDBDeletion","MAWIndexedDbMetadata","MAWLowLevelApiTypes","MAWQplProxy","MAWReliabilityMonitor","MWFBLogger","Promise","asyncToGeneratorRuntime","getErrorSafe","gkx","promiseDone","qpl"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_,f,g=["backendInitPromise","middleware","onDbPopulate"],h;function y(t,a){var i=null,l=o("MWFBLogger").MWLogger().tags(["db",t,a]),y=new(r("Deferred")),C=!1,b=!1,v,S=!1,R=null,L=a!=="worker"?null:o("MAWReliabilityMonitor").MAWReliabilityMonitorSingleton.startMonitoring("DB_"+t+"_"+a,function(){return{extra:{isMakingDB:String(C),willBeSetup:String(b)},reason:String(R),state:(function(){if(R==null)return o("MAWReliabilityMonitor").HealthReportState.UNKNOWN;switch(R){case o("MAWLowLevelApiTypes").DatabaseState.Initializing:case o("MAWLowLevelApiTypes").DatabaseState.Upgrading:return o("MAWReliabilityMonitor").HealthReportState.PENDING;case o("MAWLowLevelApiTypes").DatabaseState.Open:return o("MAWReliabilityMonitor").HealthReportState.OK;case o("MAWLowLevelApiTypes").DatabaseState.Closed:case o("MAWLowLevelApiTypes").DatabaseState.Error:return o("MAWReliabilityMonitor").HealthReportState.ERROR}})()}});function E(){y=new(r("Deferred")),v==null||v(),C=!1,b=!1}function k(){return b}function I(){return y.getPromise().then(function(){return S})}function T(e,t,n){return D.apply(this,arguments)}function D(){return D=n("asyncToGeneratorRuntime").asyncToGenerator(function*(n,h,k){var I=h.backendInitPromise,T=h.middleware,D=h.onDbPopulate,x=babelHelpers.objectWithoutPropertiesLoose(h,g),$=o("MAWCurrentUser").getID(),P=o("MAWIndexedDbMetadata").dbName($),N=r("qpl")._(25310776,"6155");function M(e){R=e,L==null||L.updateState()}if(i!=null){l.DEBUG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["DB exists"]))),o("MAWQplProxy").sendQplPointThroughBridge(N,"database_"+t+"_exsists");return}var w=o("MAWQplProxy").startQplUserFlow(r("qpl")._(1056836116,"905"),{string:{db:t,name:P}});if(b=!0,C)return o("MAWQplProxy").sendQplPointThroughBridge(N,"database_"+t+"_make_in_progress"),y.getPromise();l.DEBUG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Starting DB Setup"]))),C=!0,o("MAWQplProxy").sendQplPointThroughBridge(N,"database_"+t+"_make_started"),v=o("MAWIDbSetupQplEventListener").trackDbSetupFailure(w,function(){M(o("MAWLowLevelApiTypes").DatabaseState.Error),y.reject("DB setup failed"),o("MAWQplProxy").sendQplPointThroughBridge(N,"database_"+t+"_setup_failed"),E()}),M(o("MAWLowLevelApiTypes").DatabaseState.Initializing);var A=yield o("MAWDbVersion").getDexieDbVersion(P);A==null&&(S=!0),w.addAnnotations({int:{currentVersion:A}});var F=k!=null?k:o("MAWGetDbVersion").getArmadilloDbVersion();if(w.addAnnotations({int:{targetVersion:F}}),I&&(A||0)<F){w.addPoint("separate_read_waiting_on_worker_upgrade"),l.DEBUG(u||(u=babelHelpers.taggedTemplateLiteralLoose(["Waiting for worker to upgrade schema..."])));try{yield I}catch(e){throw l.catching(r("getErrorSafe")(e)).mustfixThrow("Worker startup promise rejected, schema upgrade failed.")}var O=yield o("MAWDbVersion").getDexieDbVersion(P);if(O!==F)throw l.mustfixThrow("Main thread waiting on worker schema upgrade from %s to %s, upgrade failed with version %s",A,F,O);A=O}else a==="worker"&&(o("MAWQplProxy").sendQPLIntAnnotationThroughBridge(r("qpl")._(1056839232,"112"),"dbVersion",A!=null?A:0),o("MAWQplProxy").sendQPLIntAnnotationThroughBridge(r("qpl")._(1056839232,"112"),"useSentBytesCache",r("gkx")("33008")?1:0));var B=function(n){var e=o("MAWDbVersion").updateDB(n,w,A,k);return!I&&a==="worker"&&o("MAWQplProxy").sendQPLBoolAnnotationThroughBridge(r("qpl")._(1056839232,"112"),"dbUpgradeNeeded",A!==e),l.DEBUG(c||(c=babelHelpers.taggedTemplateLiteralLoose(["latest pushed version: ",", current: ",", requested: ",""])),e,A,k!=null?k:"<latest>"),a==="worker"&&(A!==e?o("MAWQplProxy").sendQplPointThroughBridge(N,"database_"+t+"_version_upgraded"):o("MAWQplProxy").sendQplPointThroughBridge(N,"database_"+t+"_version_upgrade_not_required")),e};return i=new(o("MAWDexieTable")).DexieTable(P,function(e){T.forEach(function(t){e.use(t(n))});var i=B(e);e.on("populate",function(e){if(!e){M(o("MAWLowLevelApiTypes").DatabaseState.Error),y.reject("Missing DB for populate event"),w.endFail("on_populata-missing_txn"),o("MAWQplProxy").sendQplPointThroughBridge(N,"database_"+t+"_on_populate_missing_txn");return}l.info("MAWDB populated. HasPopulateEvent: %s",!!D),D==null||D(e)}),e.on("blocked",function(){l.MUSTFIX(d||(d=babelHelpers.taggedTemplateLiteralLoose(["DB Open blocked"]))),M(o("MAWLowLevelApiTypes").DatabaseState.Error),y.reject("DB Open blocked"),w.endFail("db_blocked"),o("MAWQplProxy").sendQplPointThroughBridge(N,"database_"+t+"_blocked"),E()}),e.on("ready",function(e){if(l.DEBUG(m||(m=babelHelpers.taggedTemplateLiteralLoose(["MAW DB setup complete"]))),C=!1,e==null){M(o("MAWLowLevelApiTypes").DatabaseState.Error),l.MUSTFIX(p||(p=babelHelpers.taggedTemplateLiteralLoose(["DB is null"]))),y.reject("DB is null"),w.endFail("db_null"),o("MAWQplProxy").sendQplPointThroughBridge(N,"database_"+t+"_null"),E();return}M(o("MAWLowLevelApiTypes").DatabaseState.Open),v==null||v(),y.resolve(),w.endSuccess({int:{dbVersion:i}}),o("MAWQplProxy").sendQplPointThroughBridge(N,"database_"+t+"_ready")}),e.on("close",function(){M(o("MAWLowLevelApiTypes").DatabaseState.Closed),l.WARN(_||(_=babelHelpers.taggedTemplateLiteralLoose(["DB forcibly closed"]))),o("MAWQplProxy").sendQplPointThroughBridge(N,"database_"+t+"_forcibly_closed")}),e.on("versionchange",function(e){l.WARN(f||(f=babelHelpers.taggedTemplateLiteralLoose(["Versionchange detected: ("," -> "," (event version: ",", highestUsed: (","), name: ",""])),e==null?void 0:e.oldVersion,e==null?void 0:e.newVersion,String(e==null?void 0:e.version),i,e==null?void 0:e.name),M(o("MAWLowLevelApiTypes").DatabaseState.Upgrading),a!=="worker"&&r("ClientConsistencyEventEmitter").emit("softRefresh","mawdb_versionchange"),o("MAWQplProxy").sendQplPointThroughBridge(N,"database_"+t+"_versionchange")})},void 0,x),o("MAWQplProxy").sendQplPointThroughBridge(N,"database_"+t+"_make_requested"),y.getPromise()}),D.apply(this,arguments)}function x(e){if(i==null)throw l.mustfixThrow('IndexDB has not been initialized before executing "'+(e!=null?e:"unnamed")+'"');return i}function $(e){return i!=null&&!C?(h||(h=n("Promise"))).resolve(i):(y=y||new(r("Deferred")),y.getPromise().then(function(){return x(e)}))}function P(){return N.apply(this,arguments)}function N(){return N=n("asyncToGeneratorRuntime").asyncToGenerator(function*(){var e=yield $();e!=null&&(e.close(),i=null),E()}),N.apply(this,arguments)}function M(){i=null,E()}function w(e){r("promiseDone")(P());var t=o("MAWIndexedDbMetadata").dbName(e!=null?e:o("MAWCurrentUser").getID());r("promiseDone")(o("MAWIndexedDBDeletion").deleteDB(t,"maw")),L==null||L.stopMonitoring()}return{closeDB:P,deleteDb:w,getDB:$,getDBExn:x,isNewDb:I,makeDB:T,reset_singleton_INTERNAL_ONLY:M,setupPromise:function(){return y.getPromise()},willSetupDB:k}}l.makeIDBFactory=y}),98);
__d("MAWIndexedDbUI",["ExecutionEnvironment","MAWDbFactory","MAWDbMutationMiddleware","MAWDbProtocolMsgIdMiddleware","MAWDexieTable","MAWIndexedDb","MAWTransactor","Promise","cr:3527","gkx","performance"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u;function c(){var e=o("MAWDbFactory").makeIDBFactory("ui_idb","main");return{closeDB:e.closeDB,deleteDb:e.deleteDb,getDB:e.getDB,makeDB:function(a,i,l){var t=[o("MAWDbMutationMiddleware").getMAWDbMutationMiddleware];r("gkx")("1760")&&t.push(o("MAWDbProtocolMsgIdMiddleware").MAWDbProtocolMsgIdMiddleware),n("cr:3527")!=null&&t.push(n("cr:3527"));var s=e.makeDB(a,{autoOpen:r("gkx")("6817"),backendInitPromise:i.backendInitPromise,cache:"disabled",middleware:t,onDbPopulate:i.onDbPopulate},l);return s},reset_singleton_INTERNAL_ONLY:e.reset_singleton_INTERNAL_ONLY}}var d=c(),m=d.makeDB,p=d.closeDB,_=d.getDB,f=d.deleteDb,g=d.reset_singleton_INTERNAL_ONLY,h=(s||(s=r("ExecutionEnvironment"))).isInBrowser?_("MawDbInUISingleton_INTERNAL_ONLY").then(function(e){return{openReadonlyTransaction:function(n,a,i){return e.stores.transaction("r",a,function(){return o("MAWDexieTable").setDexiePSDItem("transactorName",n),o("MAWDexieTable").setDexiePSDItem("transactionRequested",(u||(u=r("performance"))).now()+u.timeOrigin),i(e.stores)})},openReadWriteTransaction:function(n,a,i){return e.stores.transaction("rw",a,function(){return o("MAWDexieTable").setDexiePSDItem("transactorName",n),o("MAWDexieTable").setDexiePSDItem("transactionRequested",(u||(u=r("performance"))).now()+u.timeOrigin),i(e.stores)})}}}):new(e||(e=n("Promise")))(function(){});l.makeMsgrTransactor=o("MAWTransactor").makeMsgrUITransactor_IMPORT_FROM_MAWIndexedDbUI_INSTEAD,l.afterTransaction=o("MAWIndexedDb").afterTransaction,l.makeMAWIndexedDBFactory=c,l.makeDB=m,l.closeDB=p,l.getDB=_,l.deleteDb=f,l.reset_singleton_INTERNAL_ONLY=g,l.MawDbInUISingleton=h}),98);
__d("MAWCacheServiceMiddleware",["FBLogger","getErrorSafe"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t){var n=e.table(t);return n}function s(){return{create:function(n){try{return babelHelpers.extends({},n,{table:function(r){return e(n,r)}})}catch(e){var t=r("getErrorSafe")(e);return r("FBLogger")("MAWCacheService").catching(t).mustfix("Error applying MAW Cache Service Middleware"),n}},name:"MAWCacheServiceMiddleware",stack:"dbcore"}}l.default=s}),98);
__d("MAWDataSyncQueue",["Promise","WALogger","asyncToGeneratorRuntime","getErrorSafe","qex","throttle"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c=r("qex")._("853")||1e3,d=r("qex")._("855")||1e3,m=function(){return f=!1,b({isUnloading:!0})},p=[],_=[],f=!1,g=[],h=function(){var e,t=p.splice(0,p.length);(e=_).push.apply(e,t)},y=function(){return _.splice(0,c)},C=function(r){var t=y();if(t.length!==0)return(u||(u=n("Promise"))).all(g.map(function(n,a){return n(t,r).catch(function(t){o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Unhandled exception caught in middleware "," sync: ",""])),a,t)})})).then(function(){return C(r)})},b=(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){if(!f){f=!0,h();try{yield C(e)}catch(e){var t,n=r("getErrorSafe")(e);throw o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["[MAWIndexedDbMiddleware] error handling queue batch: ",""])),(t=n==null?void 0:n.message)!=null?t:n.toString()),e}finally{f=!1,p.length>0&&v()}}});return function(n){return e.apply(this,arguments)}})(),v=r("throttle")(b,d),S=function(t,n){p.push({type:t,value:n}),v()},R=function(t){g.some(function(e){return e===t})||g.push(t)},L=function(){g=[]},E=function(){p=[],_=[]},k=function(){return p};l.forceFlushDataSyncQueue=m,l.addSyncItem=S,l.registerDataSyncCallback=R,l.clearDataSyncCallbacks=L,l.clearDataSyncQueue_FOR_TESTING_ONLY=E,l.getDataSyncQueue_FOR_TESTING_ONLY=k}),98);
__d("MAWDataSyncMiddleware",["FBLogger","MAWDataSyncQueue","getErrorSafe"],(function(t,n,r,o,a,i,l){"use strict";var e=new Set(["contacts","groupInfo","messages","participants","threads","reactions","xma","pendingStanzas"]);function s(t,n){var r=t.table(n);return e.has(n)?babelHelpers.extends({},r,{mutate:function(t){return r.mutate(t).then(function(e){return t.type==="delete"?(t.keys.forEach(function(e){o("MAWDataSyncQueue").addSyncItem(t.type,{key:e,tableName:n})}),e):(e.results!=null?e.results.forEach(function(e){o("MAWDataSyncQueue").addSyncItem(t.type,{key:e,tableName:n,values:t.values})}):e.lastResult!=null&&o("MAWDataSyncQueue").addSyncItem(t.type,{key:e.lastResult,tableName:n,values:t.values}),e)})}}):r}function u(){return{create:function(t){try{return babelHelpers.extends({},t,{table:function(n){return s(t,n)}})}catch(n){var e=r("getErrorSafe")(n);return r("FBLogger")("messenger_web").catching(e).mustfix("Error applying DataSync Middleware, messages made during this session will not be properly synced to registered consumers"),t}},name:"MAWDataSyncMiddleware",stack:"dbcore"}}l.getDataSyncMiddleware=u}),98);
__d("MAWIndexedDb",["ExecutionEnvironment","FBLogger","MAWBridge","MAWCacheServiceMiddleware","MAWDataSyncMiddleware","MAWDbFactory","MAWDbMutationMiddleware","MAWDbProtocolMsgIdMiddleware","MAWDbSchema","MAWDexie","MAWLSDataSyncMiddleware","MAWLoadDbMigrationVersion","MAWMpsGating","MAWTransactor","MWFBLogger","asyncToGeneratorRuntime","cr:10181","cr:10182","cr:3527","gkx","justknobx"],(function(t,n,r,o,a,i,l){"use strict";var e,s;function u(e){e===void 0&&(e="idb");var t=o("MAWDbFactory").makeIDBFactory(e,"worker");function a(e){return t.setupPromise().then(function(){return t.getDBExn(e)})}return babelHelpers.extends({},t,{getSignalDB:a,makeDB:(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,a,i){var l=[o("MAWDbMutationMiddleware").getMAWDbMutationMiddleware];return o("MAWMpsGating").isMpsMessageRendering()||l.push(o("MAWLSDataSyncMiddleware").getMAWLSDataSyncMiddleware),r("gkx")("1760")&&l.push(o("MAWDbProtocolMsgIdMiddleware").MAWDbProtocolMsgIdMiddleware),l.push(r("MAWCacheServiceMiddleware")),a.enableDataSyncMiddleware&&l.push(o("MAWDataSyncMiddleware").getDataSyncMiddleware),n("cr:3527")!=null&&l.push(n("cr:3527")),r("justknobx")._("4087")&&(yield r("MAWLoadDbMigrationVersion")(e)),t.makeDB(e,{autoOpen:!0,middleware:l,onDbPopulate:a.onDbPopulate},i)});function a(t,n,r){return e.apply(this,arguments)}return a})()})}var c=u(),d="idle",m=c.isNewDb,p=c.willSetupDB,_=function(t,n,r){return c.makeDB(t,n,r).then(function(){d="ready"})},f=c.closeDB,g=c.getDBExn,h=c.getSignalDB,y=c.getDB,C=function(t){return c.reset_singleton_INTERNAL_ONLY()},b=c.deleteDb;function v(){return d}function S(e){var t=d;return d="migrating",e.finally(function(){d=t})}var R=new WeakMap,L=new WeakMap,E=o("MWFBLogger").MWLogger().tags(["db","afterTransaction"]);function k(e){var t=r("MAWDexie").currentTransaction;if(t==null)throw E.mustfixThrow("afterTransactionEffect called outside of dexie transaction");if(typeof e=="function"){var n=R.get(t)||[];n.push(e),R.set(t,n),n.length===1&&t.on("complete",function(){var e=R.get(t)||[];e.forEach(function(e){e()}),R.delete(t)})}}function I(e){var t=r("MAWDexie").currentTransaction;if(t==null)throw E.mustfixThrow("afterTransaction called outside of dexie transaction","maw_db");var a=L.get(t);if(a!=null)a.push(e);else{var i=[e];L.set(t,i),t.on("complete",function(){L.delete(t),r("gkx")("5675")&&(s||(s=r("ExecutionEnvironment"))).isInMainThread&&n("cr:10182")!==null&&n("cr:10181")!==null?n("cr:10182").handleEvents(n("cr:10181").LSDatabaseSingleton,i):o("MAWBridge").getBridge().fireAndForget("event","uiUpdate",{events:i})})}}var T=new Set(["NewMsg","NewMsgs","MsgUpdated","NewMedia","NewMediaRange","MediaExpired","XMAShareExpired","DeleteMessagesOfThread","UpsertReaction","DeleteReaction","DeleteMessages","NewXMA","EditMsgHistoryAdded","MsgsStartCountdown","MsgClearCountdown","XMAShareTombstoned","NewReceiverFetchInfo","NewXMAs","NewPoll","RavenActionUpdate"]);function D(t,n){if(n!==!0&&o("MAWMpsGating").isMpsMessageRendering()&&T.has(t.tag)){r("FBLogger")("wmi").INFO(e||(e=babelHelpers.taggedTemplateLiteralLoose(["[MpsMessageRendering] Ignoring afterTxn event: ",""])),t.tag);return}if(t.tag==="UpdateThreadActivity"&&r("FBLogger")("wmi").mustfix("Thread consistency uses MAW DB mechanism instead of new one"),t.tag==="ThreadUpdated")try{var a=t.value.snippetContactIDs;a!=null&&a.some(function(e){return e==="Facebook User"})&&(E.mustfix('Something is still setting a contact id as "Facebook User"'),t.value=babelHelpers.extends({},t.value,{snippetContactIDs:a.map(function(e){return e==="Facebook User"?"0":e})}))}catch(e){}I(t)}function x(e,t){var n=r("MAWDexie").currentTransaction;if(n==null)throw E.mustfixThrow("afterTransactionForThreadEvent called outside of dexie transaction","maw_db");n.on("complete",function(){o("MAWBridge").getBridge().fireAndForget("threadEvent",t,e)})}l.TABLES_TO_ENCRYPT=o("MAWDbSchema").TABLES_TO_ENCRYPT,l.makeMsgrTransactor=o("MAWTransactor").makeMsgrTransactor,l.makeMAWIndexedDBFactory=u,l.isNewDb=m,l.willSetupDB=p,l.makeDB=_,l.closeDB=f,l.getDBExn=g,l.getSignalDB=h,l.getDB=y,l.setDB_INTERNAL_USE_ONLY=C,l.deleteDb=b,l.getDbStatus=v,l.updateStatusDuringMigration=S,l.afterTransactionEffect=k,l.afterTransaction=D,l.afterTransactionThreadEvent=x}),98);
__d("MAWDbAppMeta",[],(function(t,n,r,o,a,i){"use strict";var e={allowSecurityAlert:"allowSecurityAlert",allowSecurityAlertForSelf:"allowSecurityAlertForSelf",dbMigrationVersion:"dbMigrationVersion",deviceJid:"deviceJid",hasMigratedFromDexie:"hasMigratedFromDexie",hmacKey:"hmacKey",hotlikeSticker:"hotlikeSticker",isBackfilledForOccamadillo:"isBackfilledForOccamadillo",msgTypeVersion:"msgTypeVersion",restoreMigrationAttempts:"restoreMigrationAttempts",restoreToDexieMigrationComplete:"restoreToDexieMigrationComplete"};i.AppMetaKeysEnum=e}),66);
__d("MAWLoadDbMigrationVersion",["ExecutionEnvironment","MAWBridge","MAWCurrentUser","MAWDBMigrationUtils","MAWDbAppMeta","MAWDbObjEncryption","MAWIndexedDbMetadata","MAWUnrecoverableDbErrors","MWFBLogger","Promise","getErrorSafe"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_,f,g=o("MWFBLogger").MWLogger().tags(["db","MAWLoadDbMigrationVersion"]);function h(t){var a=o("MAWCurrentUser").getID(),i=o("MAWIndexedDbMetadata").dbName(a);return new(f||(f=n("Promise")))(function(n){if(!indexedDB){n();return}var a=indexedDB.open(i);a.onupgradeneeded=function(t){t.target.transaction.abort();var r=t.target.result;g.DEBUG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["[MAWLoadDbMigrationVersion] "," onupgradeneeded - closing db"])),i),r==null||r.close(),n()},a.onsuccess=function(e){var a=e.target.result;if(a==null){n();return}try{var i=a.transaction("appMeta","readonly");i.onerror=function(e){var t;g.DEBUG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["[MAWLoadDbMigrationVersion] Transaction error: ",""])),(t=e.target.error)==null?void 0:t.message),a.close(),n()};var l=i.objectStore("appMeta"),m=l.get(o("MAWDbAppMeta").AppMetaKeysEnum.dbMigrationVersion);m.onerror=function(e){var t;g.DEBUG(u||(u=babelHelpers.taggedTemplateLiteralLoose(["[MAWLoadDbMigrationVersion] Request error: ",""])),(t=e.target.error)==null?void 0:t.message),a.close(),n()},m.onsuccess=function(e){a.close();var i=e.target.result;if(i!=null)try{var l=o("MAWDbObjEncryption").decryptDbObj(babelHelpers.extends({},i),"appMeta",t),s=l.value.dbMigrationVersion;s!=null&&(o("MAWDBMigrationUtils").mawDbMigrationVersion.version=s)}catch(e){var u=r("getErrorSafe")(e);g.catching(u).MUSTFIX(c||(c=babelHelpers.taggedTemplateLiteralLoose(["[MAWLoadDbMigrationVersion] Failed to decrypt appMeta row"]))),(_||(_=r("ExecutionEnvironment"))).isInWorker&&o("MAWBridge").getBridge().fireAndForget("event","unrecoverableDbError",{error:new(o("MAWUnrecoverableDbErrors")).EarRuntimeError})}n()}}catch(e){var p=r("getErrorSafe")(e);g.DEBUG(d||(d=babelHelpers.taggedTemplateLiteralLoose(["[MAWLoadDbMigrationVersion] Error accessing appMeta: ",""])),p.message),a.close(),n()}},a.onerror=function(e){var t;g.DEBUG(m||(m=babelHelpers.taggedTemplateLiteralLoose(["[MAWLoadDbMigrationVersion] "," error ",""])),i,e==null||(t=e.target)==null||(t=t.error)==null?void 0:t.message),n()},a.onblocked=function(e){var t=e.target.result;g.DEBUG(p||(p=babelHelpers.taggedTemplateLiteralLoose(["[MAWLoadDbMigrationVersion] "," blocked"])),i),t==null||t.close()}})}l.default=h}),98);
__d("MAWLLAMigrationUtils",["Random","gkx","justknobx","qpl"],(function(t,n,r,o,a,i,l){"use strict";var e=r("justknobx")._("652"),s=Math.max(e,10),u=s*10,c=new Map([["FTS",u]]);function d(e){if(r("gkx")("9340"))return 1;var t=c.get(e);return t!=null?t:s}function m(e,t){t===void 0&&(t={});var n=d(e);return e==="debug"||e==="test"?[]:r("gkx")("23956")&&o("Random").coinflip(n)?[r("qpl")._(1056839327,"560"),babelHelpers.extends({double:{sampleRate:1/n},string:{transactor:e}},t)]:[]}l.getTransactorQPLParam=m}),98);
__d("MAWTransactor",["MAWDexie","MAWDexieTable","MAWErrorObject","MAWIndexedDb","MAWIndexedDbUI","MAWLLAMigrationUtils","MAWQplProxy","MAWTransactionMode","MWFBLogger","WAExceededStorageQuota","WALogger","gkx","performance"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c=["MWPTransactor"],d=o("MWFBLogger").MWLogger();function m(t,n,a,i,l,s){return i!=null&&r("MAWDexie").currentTransaction!=null&&i.endFail("invoked_in_nested_transaction",{string:{current_transaction_mode:r("MAWDexie").currentTransaction.mode},string_array:{current_transaction_store_names:r("MAWDexie").currentTransaction.storeNames}}),r("MAWDexie").currentTransaction!=null&&o("WALogger").WARN(e||(e=babelHelpers.taggedTemplateLiteralLoose(["makeMsgrTransactor "," should not be called inside another transaction. The transaction will be forced to execute on top-level"])),l),t.transact(n,a,s)}function p(e){var t=o("MAWLLAMigrationUtils").getTransactorQPLParam(e),n=t.length===2?t:[null,void 0],r=n[0],a=n[1];return r!=null?o("MAWQplProxy").startQplUserFlow(r,a,{sendThroughBridge:!1}):null}function _(e,t,n,r){return C(e,t,function(e){return o("MAWIndexedDb").getDB(e)},n,r)}function f(e,t,n){return C(e,t,o("MAWIndexedDbUI").getDB,n)}function g(e,t,n){return C(e,t,o("MAWIndexedDbUI").getDB,n)}var h=0,y=new Map;function C(e,t,n,a,i){var l=Object.keys(e),_=l.some(function(t){return e[t]===o("MAWTransactionMode").READWRITE})?o("MAWTransactionMode").READWRITE:o("MAWTransactionMode").READONLY;return function(){for(var e=arguments.length,f=new Array(e),g=0;g<e;g++)f[g]=arguments[g];var C=p(t),S=null,R=function(){return self.clearInterval(S)};if(C!=null&&(C.addAnnotations({string:{mode:_===o("MAWTransactionMode").READWRITE?"readwrite":"readonly"},string_array:{stores:l}}),r("gkx")("1006")&&t==="bulkCreateThreadByJid")){var L=1e3,E=Date.now();S=self.setInterval(function(){C.addAnnotations({int:{heartbeatLatestAliveSinceStartMs:Date.now()-E}})},L),self.setTimeout(R,o("MAWQplProxy").DEFAULT_WORKER_QPL_TIMEOUT_MS)}var k=(u||(u=r("performance"))).now()+u.timeOrigin;return n(t).then(function(e){var n=Array.from(y.values());C==null||C.addPoint("lock_wait_start",{string_array:{maybeLockedOn:n}});var p=(u||(u=r("performance"))).now();return i==null||i.onTxnRequestedCb==null||i.onTxnRequestedCb.apply(i,f),m(e,_,l,C,t,function(){o("MAWDexieTable").setDexiePSDItem("transactionRequested",k),o("MAWDexieTable").setDexiePSDItem("transactorName",t),C==null||C.addPoint("dexie_transaction_start"),h+=1;var m=h;y.set(m,t);var _=C!=null?e.stores[l[0]].get("").then(function(){C==null||C.addPoint("lock_wait_end"),C==null||C.addPoint("transaction_opened"),C==null||C.addPoint("transactor_execution_start")}):o("MAWDexieTable").dexieResolve();return _.then(function(){return a(e.stores).apply(void 0,f)}).then(function(e){if(r("gkx")("6795")&&(i==null?void 0:i.explicitlyCloseTxn)===!0){var a;(a=r("MAWDexie").currentTransaction)==null||(a=a.idbtrans)==null||a.commit==null||a.commit()}y.delete(m),C==null||C.addPoint("transactor_execution_end"),C==null||C.endSuccess(),R();var l=(u||(u=r("performance"))).now()-p;return l>5e3&&(o("WALogger").WARN(s||(s=babelHelpers.taggedTemplateLiteralLoose(["[Slow maw transaction] "," took ","ms to complete. Potentially waiting for locks on ",""])),t,l,n.join(", ")),d.mustfix("[Slow maw transaction] %s took long to complete. Potentially waiting for locks on $s",t,n.join(", "))),e}).catch(function(e){y.delete(m),o("WAExceededStorageQuota").checkQuotaExceededError(e);var n=e.name==="AbortError"?e==null?void 0:e.inner:null,r=b(n);if(C==null||C.markError("transaction_error",null,e),e instanceof Error){var a=e,i=typeof(a==null?void 0:a.stack)=="string"?a.stack:typeof(a==null?void 0:a.stack),l=typeof(a==null?void 0:a.message)=="string"?a.message:typeof(a==null?void 0:a.message);C==null||C.addAnnotations({string:{errMessage:l,errStack:i,innerError:r}})}C==null||C.endFail("transaction_fail"),R();var s=o("MAWErrorObject").getErrorObject(e);throw v(s).mustfixThrow("[%s] Error performing %s transaction. Inner error: %s",c.join("|"),t!=null?t:"",r!=null?r:"unknown")})})}).catch(function(e){o("WAExceededStorageQuota").checkQuotaExceededError(e),C==null||C.endFail("transaction_fail"),R();var n=o("MAWErrorObject").getErrorObject(e);throw v(n).mustfixThrow("[%s] Error performing %s transaction",c.join("|"),t!=null?t:"")})}}function b(e){if(typeof e=="string")return e;if(e instanceof Error)return e.name+": "+e.message;if(typeof e=="object")try{return JSON.stringify(e)}catch(e){}return null}function v(e){return e?d.catching(e):d}l.makeMsgrTransactor=_,l.makeMsgrUITransactor_IMPORT_FROM_MAWIndexedDbUI_INSTEAD=f,l.makeMsgrUIWritableTransactor=g}),98);
__d("MAWVaultDb",["FBLogger","MAWQplProxy","MAWVault","getErrorSafe","gkx","isObject","isPlainObject","qpl"],(function(t,n,r,o,a,i,l){"use strict";var e=.001,s=new WeakMap;function u(e,t){return t[e]!=null}var c=r("gkx")("23909");function d(t,n,a){if(!r("isPlainObject")(t)||!c||!u(n,a)||t==null)return t;var i=s.get(t);if(i!=null)return i;var l=Math.random()<e?o("MAWQplProxy").startQplUserFlow(r("qpl")._(25301509,"119")):null;try{var d=a[n],m=p(t,d,o("MAWVault").vault);return l==null||l.endSuccess(),s.set(t,m),m}catch(e){l==null||l.endFail("vault_fail");var _=r("getErrorSafe")(e);throw r("FBLogger")("messenger_web").mustfixThrow("%s - Failed to vault an entity in the table: %s",_.message,n)}}function m(t,n,a){if(!r("isPlainObject")(t)||!c||!u(n,a)||t==null)return t;var i=Math.random()<e?o("MAWQplProxy").startQplUserFlow(r("qpl")._(741087294,"2028")):null;try{var l=p(t,a[n],o("MAWVault").unvault);return i==null||i.endSuccess(),l}catch(e){i==null||i.endFail("unvault_fail");var s=r("getErrorSafe")(e);throw r("FBLogger")("messenger_web").mustfixThrow("%s - Unvaulting failed for an entity in the table: %s",s.message,n)}}function p(e,t,n){if(e==null)return e;var o=Object.entries(t).filter(function(t){var n=t[0];return e[n]!=null});return o.length===0?e:o.reduce(function(e,t){var o=t[0],a=t[1];return typeof a!="boolean"&&r("isObject")(a)?e[o]=p(e[o],a,n):a===!0&&(e[o]=n(e[o])),e},babelHelpers.extends({},e))}l.vaultDbRow=d,l.unvaultDbRow=m,l.setInPath=p}),98);
__d("MAWVaultDefinitions",[],(function(t,n,r,o,a,i){"use strict";var e={editMsgHistory:{msgContent:{content:!0}},messages:{msgContent:{content:!0},quote:{content:{msgContent:{content:!0}}}},unrenderedMessages:{msgContent:!0}},l={edit_message_history:{messageContent:!0},messages:{replyMessageText:!0,text:!0},threads:{snippet:!0}};i.ARMADILLO_IDB_VAULT_DEFINITIONS=e,i.PERSISTED_DB_VAULT_DEFINITIONS=l}),66);
__d("isEncryptionAtRestEnabled",["isInstamadillo","qex"],(function(t,n,r,o,a,i,l){"use strict";function e(){return r("qex")._("507")===!0?!0:r("isInstamadillo")()}l.default=e}),98);
__d("MAWDbMiddlewareMutations",["MAWDbObjEncryption","MAWVaultDb","MAWVaultDefinitions","gkx","isEncryptionAtRestEnabled"],(function(t,n,r,o,a,i,l){"use strict";var e=r("gkx")("23909");function s(t,n,a){if(!e&&!(r("isEncryptionAtRestEnabled")()||r("gkx")("23910")))return t;var i=babelHelpers.extends({},t);return i=o("MAWVaultDb").unvaultDbRow(i,n,o("MAWVaultDefinitions").ARMADILLO_IDB_VAULT_DEFINITIONS),i=o("MAWDbObjEncryption").encryptDbObj(i,n,a),i}function u(t,n){return e?o("MAWVaultDb").unvaultDbRow(babelHelpers.extends({},t),n,o("MAWVaultDefinitions").ARMADILLO_IDB_VAULT_DEFINITIONS):t}function c(t,n,r){var a=o("MAWDbObjEncryption").decryptDbObj(babelHelpers.extends({},t),n,r);return e?o("MAWVaultDb").vaultDbRow(a,n,o("MAWVaultDefinitions").ARMADILLO_IDB_VAULT_DEFINITIONS):a}function d(t,n){if(t!=null)return e?o("MAWVaultDb").vaultDbRow(t,n,o("MAWVaultDefinitions").ARMADILLO_IDB_VAULT_DEFINITIONS):t}l.mutateValue=s,l.mutateVaultedValue=u,l.getValue=c,l.getVaultedValue=d}),98);
__d("MAWDbProtocolMsgIdMiddleware",["FBLogger","MAWDBMigrationUtils","MAWJidUtils","MAWODSProxy","Random","WAOdsEnums","getErrorSafe","justknobx"],(function(t,n,r,o,a,i,l){"use strict";var e=r("justknobx")._("3300");function s(t){return babelHelpers.extends({},t,{get:function(n){return t.get(n).then(function(e){return d(e,"get"),e})},getMany:function(n){return t.getMany(n).then(function(e){return e==null?void 0:e.map(function(e){return d(e,"getMany"),e})})},mutate:function(r){return r.type==="add"?r.values.map(function(e){return u(e)}):r.type==="put"&&r.values.map(function(t){t.protocolMsgId==null&&(o("MAWDBMigrationUtils").mawDbMigrationVersion.version>=o("MAWDBMigrationUtils").MAWDB_DEDUPE_MSGS_MIGRATION_VERSION?(o("Random").coinflip(e)&&o("MAWODSProxy").odsBumpEntityKey({entity:o("WAOdsEnums").Entity.MAW_PROTOCOL_MSG_ID_INDEX,key:"null_protocol_msg_id.put_operation_after_migration_complete.migration_version_"+o("MAWDBMigrationUtils").mawDbMigrationVersion.version}),u(t)):t.rowId<o("MAWDBMigrationUtils").mawDbDedupeMsgsMigrationStatus.cursorValue?(o("Random").coinflip(e)&&o("MAWODSProxy").odsBumpEntityKey({entity:o("WAOdsEnums").Entity.MAW_PROTOCOL_MSG_ID_INDEX,key:"null_protocol_msg_id.put_operation_below_migration_cursor.migration_version_"+o("MAWDBMigrationUtils").mawDbMigrationVersion.version}),u(t)):o("MAWDBMigrationUtils").mawDbDedupeMsgsMigrationStatus.isRunning&&t.rowId<o("MAWDBMigrationUtils").mawDbDedupeMsgsMigrationStatus.cursorValue+o("MAWDBMigrationUtils").mawDbDedupeMsgsMigrationStatus.batchSize&&(o("Random").coinflip(e)&&o("MAWODSProxy").odsBumpEntityKey({entity:o("WAOdsEnums").Entity.MAW_PROTOCOL_MSG_ID_INDEX,key:"null_protocol_msg_id.put_operation_in_current_migration_batch.migration_version_"+o("MAWDBMigrationUtils").mawDbMigrationVersion.version}),u(t)))}),t.mutate(r)},query:function(n){return t.query(n).then(function(e){var t;return e==null||(t=e.result)==null||t.map(function(e){d(e,"query")}),e})}})}function u(e){e.protocolMsgId=o("MAWJidUtils").toProtocolMsgIdStringForMAWStorage(e)}function c(e){return(e==null?void 0:e.rowId)==null&&(e==null?void 0:e.externalId)==null}function d(t,n){try{if(c(t)){n!=="get"&&o("Random").coinflip(e)&&r("FBLogger")("messenger_web").warn("Corrupted message row returned from DB, msg is null:%s, queryType: %s",t==null,n);return}(t==null?void 0:t.protocolMsgId)==null&&o("Random").coinflip(e)&&(o("MAWODSProxy").odsBumpEntityKey({entity:o("WAOdsEnums").Entity.MAW_PROTOCOL_MSG_ID_INDEX,key:"null_protocol_msg_id.migration_version_"+o("MAWDBMigrationUtils").mawDbMigrationVersion.version+".append_protocol_msg_id_for_put_operation_jk_"+String(!0)}),o("MAWDBMigrationUtils").mawDbMigrationVersion.version>=o("MAWDBMigrationUtils").MAWDB_DEDUPE_MSGS_MIGRATION_VERSION&&r("FBLogger")("maw_db_migration").warn("Message with null protocolMsgId after the msg dedupe migration. type: %s, rowId: %s, externalId: %s",t==null?void 0:t.type,t==null?void 0:t.rowId,t==null?void 0:t.externalId)),t!=null&&t.protocolMsgId!=null&&t.protocolMsgId!==o("MAWJidUtils").toProtocolMsgIdStringForMAWStorage(t)&&o("Random").coinflip(e)&&o("MAWODSProxy").odsBumpEntityKey({entity:o("WAOdsEnums").Entity.MAW_PROTOCOL_MSG_ID_INDEX,key:"inconsistent_protocol_msg_id."+(t==null?void 0:t.type)+".migration_version_"+o("MAWDBMigrationUtils").mawDbMigrationVersion.version+".append_protocol_msg_id_for_put_operation_jk_"+String(!0)})}catch(e){var a=r("getErrorSafe")(e);r("FBLogger")("messenger_web").catching(a).mustfix("Error while checking protocol msg id")}}function m(){return{create:function(t){try{return babelHelpers.extends({},t,{table:function(n){return n!=="messages"?t.table(n):s(t.table(n))}})}catch(n){var e=r("getErrorSafe")(n);return r("FBLogger")("messenger_web").catching(e).mustfix("Error applying Protocol MsgId Middleware"),t}},name:"MAWDbProtocolMsgIdMiddleware",stack:"dbcore"}}l.appendProtocolMsgId=u,l.isCorruptedMsgRow=c,l.MAWDbProtocolMsgIdMiddleware=m}),98);
__d("MAWLSDataSyncMiddleware",["FBLogger","MAWBridge","MAWLSEditMsgHistoryAddedDataSyncHandler","MAWLSMsgsDataSync","MAWLSReactionsDataSyncHandler","getErrorSafe"],(function(t,n,r,o,a,i,l){"use strict";var e=new Map;function s(){var t=new Set;t.add(o("MAWLSReactionsDataSyncHandler").mawLSReactionsDataSyncHandler),t.add(o("MAWLSEditMsgHistoryAddedDataSyncHandler").mawLSEditHistoryDataSyncHandler),t.add(o("MAWLSMsgsDataSync").mawLSMsgsDataSyncHandler),t.forEach(function(t){e.set(t.tableName,t)})}function u(t){return babelHelpers.extends({},t,{mutate:function(r){var n=e.get(t.name);return n!=null?n.performAndSyncMutation(r,t):t.mutate(r)}})}function c(){return s(),{create:function(n){try{return babelHelpers.extends({},n,{table:function(r){return e.has(r)?u(n.table(r)):n.table(r)}})}catch(e){var t=r("getErrorSafe")(e);return r("FBLogger")("maw_db").catching(t).mustfix("Error applying MAW to LS data sync middleware"),n}},name:"MAWLSDataSyncMiddleware",stack:"dbcore"}}function d(e){o("MAWBridge").getBridge().fireAndForget("event","uiUpdate",{events:[e]})}l.getMAWLSDataSyncMiddleware=c,l.syncToLS=d}),98);
__d("MAWLSEditMsgHistoryAddedDataSyncHandler",["MAWIndexedDb","MAWLSDataSyncMiddleware"],(function(t,n,r,o,a,i,l){"use strict";function e(e){var t=e.map(function(e){return babelHelpers.extends({},e)});o("MAWLSDataSyncMiddleware").syncToLS({tag:"EditMsgHistoryAdded",value:t})}var s={performAndSyncMutation:function(n,r){switch(n.type){case"put":case"add":{var t=[].concat(n.values);o("MAWIndexedDb").afterTransactionEffect(function(){return e(t)})}break}return r.mutate(n)},tableName:"editMsgHistory"};l.mawLSEditHistoryDataSyncHandler=s}),98);
__d("MAWBridgeTypesCreators",["FBLogger","MAWAudioUtils","MAWDbMsg","MAWImageUtils","MAWMsgType","MAWUserJidWrapper","WAJids","WAMediaUtils","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";function e(e){return{threadJid:e}}function s(e){var t,n=e.ts;switch(e.type){case o("MAWMsgType").MSG_TYPE.REVOKED:n=(t=e.originalTs)!=null?t:e.ts;break;default:n=o("MAWDbMsg").getCanonicalTsFromMsg(e)}return{msgId:e.msgId,ts:n}}function u(e,t){var n=t.map(s);return{messages:n,threadJid:e}}function c(e){return{ravenMsgId:e.msgId,threadJid:e.threadJid}}function d(e,t){return e.filter(function(e){return t===e.threadJid}).map(function(e){return e.msgId})}function m(e){var t,n,a,i,l,s,u,c,d,m,p,_,f,g,h,y,C,b,v,S,R=e.chatJid,L=e.filteredMsgIds,E=e.hasMediaForUI,k=e.hdTypes,I=e.media,T=e.offlineAttachmentId,D=e.ravenSettings,x=e.sortOrderMs,$=e.transportKey;switch(I.mediaType){case"Image":return{duration:null,ephemeralMediaState:D==null?void 0:D.ephemeralMediaState,ephemeralMediaViewMode:D==null?void 0:D.ephemeralMediaViewMode,filesize:I.size,hasMedia:E,hasPreviewMedia:((t=I.validatedImageInfo)==null?void 0:t.jpegThumbnail)!=null,hdTypes:k,mediaId:I.mediaId,mediaType:I.mediaType,msgIds:L,offlineAttachmentId:T,plaintextHash:I.plaintextHash,previewHeight:(n=I.validatedImageInfo)==null?void 0:n.jpegThumbnailHeight,previewHeightLarge:(a=I.validatedImageInfo)==null?void 0:a.height,previewWidth:(i=I.validatedImageInfo)==null?void 0:i.jpegThumbnailWidth,previewWidthLarge:(l=I.validatedImageInfo)==null?void 0:l.width,sortOrderMs:o("WATimeUtils").castToMillisTime(x!=null?x:I.ts*1e3),threadJid:R,transportKey:$,ts:o("WATimeUtils").castToUnixTime(x!=null?x/1e3:I.ts)};case"Video":return{duration:((s=I.validatedVideoInfo)==null?void 0:s.duration)!=null?((u=I.validatedVideoInfo)==null?void 0:u.duration)*1e3:0,ephemeralMediaState:D==null?void 0:D.ephemeralMediaState,ephemeralMediaViewMode:D==null?void 0:D.ephemeralMediaViewMode,filesize:I.size,gifPlayback:((c=I.validatedVideoInfo)==null?void 0:c.gifPlayback)===!0||I.isVideoGif===!0,hasMedia:E,hasPreviewMedia:((d=I.validatedVideoInfo)==null?void 0:d.jpegThumbnail)!=null,mediaId:I.mediaId,mediaType:I.mediaType,msgIds:L,offlineAttachmentId:T,plaintextHash:I.plaintextHash,previewHeight:(m=I.validatedVideoInfo)==null?void 0:m.jpegThumbnailHeight,previewHeightLarge:(p=I.validatedVideoInfo)==null?void 0:p.height,previewWidth:(_=I.validatedVideoInfo)==null?void 0:_.jpegThumbnailWidth,previewWidthLarge:(f=I.validatedVideoInfo)==null?void 0:f.width,sortOrderMs:o("WATimeUtils").castToMillisTime(x!=null?x:I.ts*1e3),threadJid:R,transportKey:$,ts:o("WATimeUtils").castToUnixTime(x!=null?x/1e3:I.ts)};case"Ptt":return{duration:(g=I.validatedAudioInfo)!=null&&g.duration?I.validatedAudioInfo.duration*1e3:null,filesize:I.size,hasMedia:E,mediaId:I.mediaId,mediaType:I.mediaType,msgIds:L,offlineAttachmentId:T,plaintextHash:I.plaintextHash,previewHeight:null,previewHeightLarge:null,previewWidth:null,previewWidthLarge:null,sortOrderMs:o("WATimeUtils").castToMillisTime(x!=null?x:I.ts*1e3),threadJid:R,transportKey:$,ts:o("WATimeUtils").castToUnixTime(x!=null?x/1e3:I.ts),waveformData:((h=I.validatedAudioInfo)==null?void 0:h.waveform)!=null?o("MAWAudioUtils").serializeWaveform(I.validatedAudioInfo.waveform):void 0};case"Gif":return{accessibilitySummaryText:(y=I.accessibilitySummaryText)!=null?y:void 0,duration:null,filesize:I.size,hasMedia:E,mediaId:I.mediaId,mediaType:I.mediaType,msgIds:I.msgIds,offlineAttachmentId:T,plaintextHash:I.plaintextHash,previewHeight:(C=I.validatedImageInfo)==null?void 0:C.jpegThumbnailHeight,previewHeightLarge:(b=I.validatedImageInfo)==null?void 0:b.height,previewWidth:(v=I.validatedImageInfo)==null?void 0:v.jpegThumbnailWidth,previewWidthLarge:(S=I.validatedImageInfo)==null?void 0:S.width,sortOrderMs:o("WATimeUtils").castToMillisTime(x!=null?x:I.ts*1e3),threadJid:R,transportKey:$,ts:o("WATimeUtils").castToUnixTime(x!=null?x/1e3:I.ts)};case"Sticker":{var P,N,M,w=o("MAWImageUtils").boundHeightWidth((P=I.validatedImageInfo)==null?void 0:P.jpegThumbnailHeight,(N=I.validatedImageInfo)==null?void 0:N.jpegThumbnailWidth,o("MAWImageUtils").STICKER_THUMBNAIL_MAX_SIZE),A=w.height,F=w.width;return{accessibilitySummaryText:(M=I.accessibilitySummaryText)!=null?M:void 0,duration:null,filesize:I.size,hasMedia:E,mediaId:I.mediaId,mediaType:I.mediaType,msgIds:I.msgIds,offlineAttachmentId:T,plaintextHash:I.plaintextHash,previewHeight:A,previewHeightLarge:A,previewWidth:F,previewWidthLarge:F,sortOrderMs:o("WATimeUtils").castToMillisTime(x!=null?x:I.ts*1e3),threadJid:R,transportKey:$,ts:o("WATimeUtils").castToUnixTime(x!=null?x/1e3:I.ts)}}case"DocumentFile":{var O,B={};for(var W of I.mediaEntries){var q=W[0],U=W[1],V=o("WAMediaUtils").mediaEntryDataToRawData(I.plaintextHash,U),H=V.filename;H!=null&&(B[q]=H)}return{defaultFilename:(O=I.validatedDocumentFileInfo)==null?void 0:O.filename,duration:null,filenames:B,filesize:I.size,hasMedia:E,mediaId:I.mediaId,mediaType:I.mediaType,msgIds:L,offlineAttachmentId:T,plaintextHash:I.plaintextHash,previewHeight:null,previewHeightLarge:null,previewWidth:null,previewWidthLarge:null,sortOrderMs:o("WATimeUtils").castToMillisTime(x!=null?x:I.ts*1e3),threadJid:R,transportKey:$,ts:o("WATimeUtils").castToUnixTime(x!=null?x/1e3:I.ts)}}default:throw I.mediaType,r("FBLogger")("messenger_web").mustfixThrow("[createBridgeMedia] Unsupported media type: "+I.mediaType)}}function p(e,t,n){return{chatJid:e,deliveredWatermarkTs:n!=null?n:o("WATimeUtils").castToUnixTime(0),fbid:t,lastReadActionTs:o("WATimeUtils").castToUnixTime(0),lastReadWatermarkTs:o("WATimeUtils").castToUnixTime(0)}}function _(e){var t=e.cannotReplyReason,n=e.folder,r=e.snippetParams,o=e.snippetSenderContactId,a=e.snippetType,i=e.threadJid;return{cannotReplyReason:t,folder:n,snippetContactIDs:r==null?void 0:r.contactIDs,snippetMentionJIDs:r==null?void 0:r.mentionJIDs,snippetParams:r==null?void 0:r.strings,snippetSenderContactId:o,snippetType:a,threadJid:i}}function f(e){return{chatJid:e.groupJid,memberAddMode:e.memberAddMode,threadName:e.name}}var g={snippetContactIDs:[],snippetMentionJIDs:[],snippetParams:[],snippetSenderContactId:null,snippetType:null};function h(e){var t,n=e.bumpTimestampMs,r=e.description,o=e.isMessageAuthorMe,a=e.isUnbump,i=e.skipBumpTimestampValidation,l=e.skipServerThreadBump,s=e.snippetData,u=e.threadJid,c=s==null?g:{snippetContactIDs:s.params.contactIDs,snippetMentionJIDs:(t=s.params.mentionJIDs)!=null?t:[],snippetParams:s.params.strings,snippetSenderContactId:s.senderContactId,snippetType:s.type};return babelHelpers.extends({},c,{bumpTimestampMs:n,description:r,isMessageAuthorMe:o,isUnbump:a,skipBumpTimestampValidation:i!=null?i:!1,skipServerThreadBump:l!=null?l:!1,threadJid:u})}function y(e){var t=e.author,n=e.chatJid,r=e.reaction,a=e.reactToMsgId,i=e.ts;return{actorId:o("WAJids").authorToUserId(t,o("WAJids").extractUserId(o("MAWUserJidWrapper").getMyUserJid())),chatJid:n,messageId:a,reaction:r,ts:i}}function C(e){var t=o("WAJids").extractUserId(o("MAWUserJidWrapper").getMyUserJid()),n=e.author,r=e.chatJid,a=e.reactToMsgId;return{actorId:o("WAJids").authorToUserId(n,t),chatJid:r,messageId:a}}function b(e){return{creationTs:e.creationTs,creator:e.creator,groupJid:e.groupJid,msgExpiration:e.msgExpiration,name:e.name,nameOwner:e.nameOwner,nameTs:e.nameTs,participantVersion:e.participantVersion}}function v(e){var t=e.threadJid,n=e.inviteeJid;return{caption:e.caption,inviteCode:e.inviteCode,inviteeId:n,inviteExpireTs:e.inviteExpirationTs,inviterId:o("WAJids").extractUserId(e.inviterJid),threadJid:t}}function S(e){return{threadJid:e}}function R(e,t,n){return{senderId:o("WAJids").extractUserId(t),state:n,threadJid:e}}l.createBridgeUpdateE2EEMetadataParticipants=e,l.createBridgeDeletedMessage=s,l.createBridgeDeleteMessages=u,l.createBridgeRavenAction=c,l.getMsgIdsFilteredByJid=d,l.createBridgeMedia=m,l.createBridgeReceivedReceipt=p,l.createBridgeUpdatedThread=_,l.createBridgeUpdatedGroupInfo=f,l.createBridgeBumpedThreadV2=h,l.createBridgeUpsertReaction=y,l.createBridgeDeleteReaction=C,l.createBridgeGroupInfo=b,l.createBridgeGroupInvite=v,l.createBridgeDeleteGroupInvite=S,l.createBridgeReceivedChatState=R}),98);
__d("MAWLSMsgsDataSync",["MAWBridgeTypesCreators","MAWIndexedDb","MAWLSDataSyncMiddleware"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t){var n=t.keys,r=t.trans;return e.getMany({keys:n,trans:r}).then(function(e){return e.filter(Boolean)})}function s(e){var t=e.reduce(function(e,t){var n,r=o("MAWBridgeTypesCreators").createBridgeDeletedMessage(t);return e.has(t.threadJid)||e.set(t.threadJid,[]),(n=e.get(t.threadJid))==null||n.push(r),e},new Map);t.entries().forEach(function(e){var t=e[0],n=e[1],r={messages:n,threadJid:t};o("MAWLSDataSyncMiddleware").syncToLS({tag:"DeleteMessages",value:r})})}var u={performAndSyncMutation:function(n,r){switch(n.type){case"delete":return e(r,n).then(function(e){return o("MAWIndexedDb").afterTransactionEffect(function(){return s(e)}),r.mutate(n)});default:return r.mutate(n)}},tableName:"messages"};l.mawLSMsgsDataSyncHandler=u}),98);
__d("MAWLSReactionsDataSyncHandler",["MAWBridgeTypesCreators","MAWIndexedDb","MAWLSDataSyncMiddleware"],(function(t,n,r,o,a,i,l){"use strict";function e(e){var t=e.author,n=e.reaction,r=e.reactToMsgId,a=e.threadJid,i=e.ts;r!=null&&o("MAWLSDataSyncMiddleware").syncToLS({tag:"UpsertReaction",value:o("MAWBridgeTypesCreators").createBridgeUpsertReaction({author:t,chatJid:a,reaction:n||"",reactToMsgId:r,ts:i})})}function s(e){var t=e.author,n=e.reactToMsgId,r=e.threadJid;n!=null&&o("MAWLSDataSyncMiddleware").syncToLS({tag:"DeleteReaction",value:o("MAWBridgeTypesCreators").createBridgeDeleteReaction({author:t,chatJid:r,reactToMsgId:n})})}function u(t){t.forEach(function(t){t.reaction==null?s(t):e(t)})}var c={performAndSyncMutation:function(t,n){switch(t.type){case"put":case"add":{var e=[].concat(t.values);o("MAWIndexedDb").afterTransactionEffect(function(){return u(e)})}break}return n.mutate(t)},tableName:"reactions"};l.mawLSReactionsDataSyncHandler=c}),98);
__d("MAWDBMigrationUtils",["MAWDbAppMeta","MAWIndexedDb","MAWTransactionMode"],(function(t,n,r,o,a,i,l){"use strict";var e={batchSize:0,cursorValue:0,isRunning:!1},s={version:0},u=o("MAWIndexedDb").makeMsgrTransactor({appMeta:o("MAWTransactionMode").READONLY},"getMigrationVersion",function(e){return function(){return e.appMeta.get(o("MAWDbAppMeta").AppMetaKeysEnum.dbMigrationVersion).then(function(e){var t,n=(t=e==null?void 0:e.value.dbMigrationVersion)!=null?t:0;return s.version=n,n})}}),c=6;l.mawDbDedupeMsgsMigrationStatus=e,l.mawDbMigrationVersion=s,l.getMigrationVersion=u,l.MAWDB_DEDUPE_MSGS_MIGRATION_VERSION=c}),98);
__d("MAWDbMutationMiddleware",["FBLogger","MAWDbMiddlewareMutations","getErrorSafe","vulture"],(function(t,n,r,o,a,i,l){"use strict";function e(e){return{create:function(n){return babelHelpers.extends({},n,{table:function(a){var t=n.table(a);try{return babelHelpers.extends({},t,{get:function(r){return t.get(r).then(function(t){if(t!=null)return o("MAWDbMiddlewareMutations").getValue(t,a,e)})},getMany:function(r){return t.getMany(r).then(function(t){return t.map(function(t){if(t!=null)return o("MAWDbMiddlewareMutations").getValue(t,a,e)})})},mutate:function(r){var n=null;switch(r.type){case"add":case"put":n=r.values.map(function(t){return o("MAWDbMiddlewareMutations").mutateValue(t,a,e)});break;case"delete":break;case"deleteRange":break}return r.type==="delete"||r.type==="deleteRange"||n==null?t.mutate(r):(r.values=n,t.mutate(r).then(function(e){return e}))},openCursor:function(r){return t.openCursor(r).then(function(t){return t==null||t.value==null?t:u(t,a,e)})},query:function(r){return t.query(r).then(function(t){if(t.result.length===0||typeof t.result[0]!="object")return t;var n=t.result.map(function(t){return o("MAWDbMiddlewareMutations").getValue(t,a,e)});return t.result=n,t})}})}catch(e){var i=r("getErrorSafe")(e);return r("FBLogger")("messenger_web").catching(i).mustfix("Error applying MAWDbMiddleware"),t}}})},name:"MAWDbMutationMiddleware",stack:"dbcore"}}function s(){return{create:function(t){return babelHelpers.extends({},t,{table:function(n){var e=t.table(n);try{return babelHelpers.extends({},e,{get:function(r){return e.get(r).then(function(e){return o("MAWDbMiddlewareMutations").getVaultedValue(e,n)})},getMany:function(a){return e.getMany(a).then(function(e){return r("vulture")("SMxI1wxhqOhNsUbqaKEGeOiO21w="),e.map(function(e){return o("MAWDbMiddlewareMutations").getVaultedValue(e,n)})})},mutate:function(r){return r.type==="delete"||r.type==="deleteRange"||(r.values=r.values.map(function(e){return o("MAWDbMiddlewareMutations").mutateVaultedValue(e,n)})),e.mutate(r)},openCursor:function(r){return e.openCursor(r).then(function(e){return e==null||e.value==null?e:c(e,n)})},query:function(r){return e.query(r).then(function(e){return e.result.length===0||typeof e.result[0]!="object"?e:babelHelpers.extends({},e,{result:e.result.map(function(e){return o("MAWDbMiddlewareMutations").getVaultedValue(e,n)})})})}})}catch(t){var a=r("getErrorSafe")(t);return r("FBLogger")("messenger_web").catching(a).mustfix("Error applying MAWDbMiddleware"),e}}})},name:"getMAWVaultMiddleware",stack:"dbcore"}}function u(e,t,n){var r;return Object.create(e,{continue:{get:function(){return e.continue}},continuePrimaryKey:{get:function(){return e.continuePrimaryKey}},key:{get:function(){return e.key}},primaryKey:{get:function(){return e.primaryKey}},start:{value:function(i){return e.start(function(){r=o("MAWDbMiddlewareMutations").getValue(e.value,t,n);try{e.value=r}catch(e){}i()})}},value:{get:function(){return r}}})}function c(e,t){var n;return Object.create(e,{continue:{get:function(){return e.continue}},continuePrimaryKey:{get:function(){return e.continuePrimaryKey}},key:{get:function(){return e.key}},primaryKey:{get:function(){return e.primaryKey}},start:{value:function(a){return e.start(function(){n=o("MAWDbMiddlewareMutations").getVaultedValue(e.value,t);try{e.value=n}catch(e){}a()})}},value:{get:function(){return n}}})}l.getMAWDbMutationMiddleware=e,l.getMAWVaultMiddleware=s}),98);
__d("MAWDbEncryptObjContent",["MAWKeychainNaClCrypto"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t,n){return o("MAWKeychainNaClCrypto").encryptTweetNaClArrayBuffer(e,t,n)}l.encryptContent=e}),98);
__d("MAWArmadilloAppDataTableSchema.pb",["WAProtoConst"],(function(t,n,r,o,a,i,l){var e,s={},u={},c={},d={},m={},p={},_={},f={},g={},h={},y={},C={},b={},v={},S={},R={},L={};s.name="ProtocolMsgId",s.internalSpec={externalId:[1,(e=o("WAProtoConst")).TYPES.STRING],author:[2,e.TYPES.STRING],chat:[3,e.TYPES.STRING]},u.name="MetaSyncMessageKeyProto",u.internalSpec={fromMe:[1,e.TYPES.BOOL],id:[2,e.TYPES.STRING]},c.name="MetaSyncMessageProto",c.internalSpec={key:[1,e.TYPES.MESSAGE,u],ts:[2,e.TYPES.INT64]},d.name="MetaSyncMessageRangeProto",d.internalSpec={lastMessageTimestamp:[1,e.TYPES.INT64],lastSystemMessageTimestamp:[2,e.TYPES.INT64],messages:[3,e.FLAGS.REPEATED|e.TYPES.MESSAGE,c]},m.name="MetaSyncChatActionProto",m.internalSpec={type:[1,e.TYPES.STRING],chatJid:[2,e.TYPES.STRING],archived:[3,e.TYPES.BOOL],ts:[4,e.TYPES.INT64],messageRange:[5,e.TYPES.MESSAGE,d],read:[6,e.TYPES.BOOL]},p.name="MetaSyncMessageActionProto",p.internalSpec={type:[1,e.TYPES.STRING],protocolMsgId:[2,e.TYPES.MESSAGE,s]},_.name="MetaSyncActionProto",_.internalSpec={chatAction:[1,e.TYPES.MESSAGE,m],messageAction:[2,e.TYPES.MESSAGE,p],__oneofs__:{action:["chatAction","messageAction"]}},f.name="MetaSyncAppDataProto",f.internalSpec={actions:[1,e.FLAGS.REPEATED|e.TYPES.MESSAGE,_]},g.name="EncryptedBackupsSecretsEpochProto",g.internalSpec={id:[1,e.TYPES.UINT64],anonId:[2,e.TYPES.BYTES],rootKey:[3,e.TYPES.BYTES],status:[4,e.TYPES.INT32]},h.name="EncryptedBackupsSecretsProto",h.internalSpec={backupId:[1,e.TYPES.UINT64],serverDataId:[2,e.TYPES.UINT64],epoch:[3,e.FLAGS.REPEATED|e.TYPES.MESSAGE,g],tempOcmfClientState:[4,e.TYPES.BYTES],mailboxRootKey:[5,e.TYPES.BYTES],obliviousValidationToken:[6,e.TYPES.BYTES]},y.name="FingerprintProto",y.internalSpec={currentIndex:[1,e.TYPES.UINT32],deviceIndexes:[2,e.FLAGS.REPEATED|e.TYPES.UINT32],rawId:[3,e.TYPES.UINT32]},C.name="SyncKeyDataProto",C.internalSpec={keyId:[1,e.TYPES.BYTES],keyData:[2,e.TYPES.BYTES],keyEpoch:[3,e.TYPES.UINT32],timestamp:[4,e.TYPES.INT64],fingerprint:[5,e.TYPES.MESSAGE,y]},b.name="SyncKeyShareProto",b.internalSpec={keys:[1,e.FLAGS.REPEATED|e.TYPES.MESSAGE,C],orphanKeys:[2,e.FLAGS.REPEATED|e.TYPES.BYTES]},v.name="SyncKeyRequestProto",v.internalSpec={keyIds:[1,e.FLAGS.REPEATED|e.TYPES.BYTES]},S.name="AppDataProto",S.internalSpec={type:[1,e.TYPES.STRING],actions:[2,e.FLAGS.REPEATED|e.TYPES.MESSAGE,_],encryptedBackupsSecrets:[3,e.TYPES.MESSAGE,h],syncKeyShare:[4,e.TYPES.MESSAGE,b],syncKeyRequest:[5,e.TYPES.MESSAGE,v]},R.name="IdentitiesPerDeviceProto",R.internalSpec={deviceJid:[1,e.TYPES.STRING],serializedPubKey:[2,e.TYPES.BYTES],baseKey:[3,e.TYPES.BYTES]},L.name="AppDataTableSchemaProto",L.internalSpec={externalId:[1,e.TYPES.STRING],ts:[2,e.TYPES.INT64],contents:[3,e.TYPES.MESSAGE,S],permittedIdentitiesPerDevice:[4,e.FLAGS.REPEATED|e.TYPES.MESSAGE,R],ack:[5,e.TYPES.INT32],appDataId:[6,e.TYPES.INT32],recipientDevices:[7,e.FLAGS.REPEATED|e.TYPES.STRING],sendPartial:[8,e.TYPES.BOOL]},l.ProtocolMsgIdSpec=s,l.MetaSyncMessageKeyProtoSpec=u,l.MetaSyncMessageProtoSpec=c,l.MetaSyncMessageRangeProtoSpec=d,l.MetaSyncChatActionProtoSpec=m,l.MetaSyncMessageActionProtoSpec=p,l.MetaSyncActionProtoSpec=_,l.MetaSyncAppDataProtoSpec=f,l.EncryptedBackupsSecretsEpochProtoSpec=g,l.EncryptedBackupsSecretsProtoSpec=h,l.FingerprintProtoSpec=y,l.SyncKeyDataProtoSpec=C,l.SyncKeyShareProtoSpec=b,l.SyncKeyRequestProtoSpec=v,l.AppDataProtoSpec=S,l.IdentitiesPerDeviceProtoSpec=R,l.AppDataTableSchemaProtoSpec=L}),98);
__d("MAWArmadilloAppMetaTableSchema.pb",["WAProtoConst"],(function(t,n,r,o,a,i,l){var e,s={},u={};s.name="DbAppMetaValuesProto",s.internalSpec={msgTypeVersion:[1,(e=o("WAProtoConst")).TYPES.INT32],hmacKey:[2,e.TYPES.BYTES],allowSecurityAlert:[3,e.TYPES.BOOL],hotlikeSticker:[4,e.TYPES.BYTES],isBackfilledForOccamadillo:[5,e.TYPES.BOOL],allowSecurityAlertForSelf:[11,e.TYPES.BOOL],hasMigratedFromDexie:[12,e.TYPES.BOOL],restoreMigrationAttempts:[13,e.TYPES.INT32],deviceJid:[14,e.TYPES.STRING],restoreToDexieMigrationComplete:[15,e.TYPES.BOOL],dbMigrationVersion:[16,e.TYPES.INT32]},u.name="AppMetaTableSchemaProto",u.internalSpec={key:[1,e.TYPES.STRING],value:[2,e.TYPES.MESSAGE,s]},l.DbAppMetaValuesProtoSpec=s,l.AppMetaTableSchemaProtoSpec=u}),98);
__d("MAWArmadilloCollectionVersionsTableSchema.pb",["WAProtoConst"],(function(t,n,r,o,a,i,l){var e,s={};s.name="CollectionVersionsTableSchemaProto",s.internalSpec={collection:[1,(e=o("WAProtoConst")).TYPES.STRING],version:[2,e.TYPES.INT32],state:[3,e.TYPES.STRING],finiteFailureStartTime:[4,e.TYPES.INT64],ltHash:[5,e.TYPES.BYTES],isCollectionInMacMismatchFatal:[6,e.TYPES.BOOL],isCollectionLthashInconsistent:[7,e.TYPES.BOOL]},l.CollectionVersionsTableSchemaProtoSpec=s}),98);
__d("MAWArmadilloDeletedMessagesTableSchema.pb",["WAProtoConst"],(function(t,n,r,o,a,i,l){var e,s={};s.name="DeletedMessagesTableSchemaProto",s.internalSpec={author:[1,(e=o("WAProtoConst")).TYPES.STRING],chat:[2,e.TYPES.STRING],externalId:[3,e.TYPES.STRING],reason:[4,e.TYPES.STRING]},l.DeletedMessagesTableSchemaProtoSpec=s}),98);
__d("MAWArmadilloDeviceChangeAlertsTableSchema.pb",["WAProtoConst"],(function(t,n,r,o,a,i,l){var e,s={};s.name="DeviceChangeAlertsTableSchemaProto",s.internalSpec={action:[1,(e=o("WAProtoConst")).TYPES.STRING],isArchived:[2,e.TYPES.BOOL],deviceChangeAlertsId:[3,e.TYPES.INT64],location:[4,e.TYPES.STRING],model:[5,e.TYPES.STRING],ts:[6,e.TYPES.INT64],loggedOut:[7,e.TYPES.BOOL],deviceJid:[8,e.TYPES.STRING],identity:[9,e.TYPES.BYTES],platform:[10,e.TYPES.STRING],latitude:[11,e.TYPES.STRING],longitude:[12,e.TYPES.STRING],isConfirmed:[13,e.TYPES.BOOL],isNotified:[14,e.TYPES.BOOL]},l.DeviceChangeAlertsTableSchemaProtoSpec=s}),98);
__d("MAWArmadilloDyiBatchTableSchema.pb",["WAProtoConst"],(function(t,n,r,o,a,i,l){var e,s={BACKUP_RESTORE:0,E2E_DYI:1},u={};u.name="DyiBatchTableSchemaProto",u.internalSpec={batchId:[1,(e=o("WAProtoConst")).TYPES.INT32],numMessages:[2,e.TYPES.INT32],oldestTs:[3,e.TYPES.INT64],threadId:[4,e.TYPES.STRING],isThread:[5,e.TYPES.BOOL],numMessagesRestored:[6,e.TYPES.INT32],qplInstanceKeyForThread:[7,e.TYPES.INT64],qplFlowDescriptor:[8,e.TYPES.ENUM,s],qplInstanceKeyE2E:[9,e.TYPES.INT64],numThreadsRestored:[10,e.TYPES.INT64]},l.DYI_BATCH_TABLE_SCHEMA_PROTO_QPL_FLOW_DESCRIPTOR=s,l.DyiBatchTableSchemaProtoSpec=u}),98);
__d("MAWArmadilloEBMsgRangesTableSchema.pb",["WAProtoConst"],(function(t,n,r,o,a,i,l){var e,s={};s.name="EBMsgRangesTableSchemaProto",s.internalSpec={rangeId:[1,(e=o("WAProtoConst")).TYPES.UINT32],threadJid:[2,e.TYPES.STRING],minMsgExternalId:[3,e.TYPES.STRING],maxMsgExternalId:[4,e.TYPES.STRING],minMsgSortOrderMs:[5,e.TYPES.UINT64],maxMsgSortOrderMs:[6,e.TYPES.UINT64],creationTime:[7,e.TYPES.INT64]},l.EBMsgRangesTableSchemaProtoSpec=s}),98);
__d("MAWArmadilloContactsTableSchema.pb",["WAProtoConst"],(function(t,n,r,o,a,i,l){var e,s={},u={};s.name="EphemeralSettingProto",s.internalSpec={ephemeralExpirationInSec:[1,(e=o("WAProtoConst")).TYPES.UINT32],ephemeralLastUpdatedOrSetTimestamp:[2,e.TYPES.INT64]},u.name="EphemeralSyncResponseBackoffInfo",u.internalSpec={syncResponseRetries:[1,e.TYPES.INT32],syncResponseSentTs:[2,e.TYPES.INT64]},l.EphemeralSettingProtoSpec=s,l.EphemeralSyncResponseBackoffInfoSpec=u}),98);
__d("MAWArmadilloMessagesTableSchema.pb",["MAWArmadilloContactsTableSchema.pb","WAProtoConst"],(function(t,n,r,o,a,i,l){var e,s={},u={},c={},d={},m={},p={},_={},f={},g={},h={},y={};s.name="MsgContentProto",s.internalSpec={content:[1,(e=o("WAProtoConst")).TYPES.STRING],adminMsgContent:[2,e.FLAGS.REPEATED|e.TYPES.STRING],adminType:[3,e.TYPES.STRING],obsoleteExpiration:[4,e.TYPES.INT32],obsoleteTs:[5,e.TYPES.INT64],subtype:[6,e.TYPES.STRING],protobuf:[7,e.TYPES.BYTES],screenshotActionType:[8,e.TYPES.INT32],authorName:[9,e.TYPES.STRING],version:[10,e.TYPES.INT32],mentionedJids:[11,e.FLAGS.REPEATED|e.TYPES.STRING],commands:[12,e.FLAGS.REPEATED|e.TYPES.MESSAGE,u]},u.name="MsgContentCommandProto",u.internalSpec={commandType:[1,e.TYPES.INT32],offset:[2,e.TYPES.INT32],length:[3,e.TYPES.INT32],validationToken:[4,e.TYPES.STRING]},c.name="ReportingMetaProto",c.internalSpec={frankingTag:[1,e.TYPES.BYTES],frankingVersion:[2,e.TYPES.INT32],reportingContent:[3,e.TYPES.BYTES],reportingTag:[4,e.TYPES.BYTES],frankingKey:[5,e.TYPES.BYTES]},d.name="DbQuotedMsgProto",d.internalSpec={remoteJid:[1,e.TYPES.STRING],content:[2,e.TYPES.MESSAGE,h]},m.name="VideoMsgContentProto",m.internalSpec={duration:[1,e.TYPES.INT32],width:[2,e.TYPES.INT32],height:[3,e.TYPES.INT32],mimetype:[4,e.TYPES.STRING],jpegThumbnail:[5,e.TYPES.BYTES],jpegThumbnailHeight:[6,e.TYPES.INT32],jpegThumbnailWidth:[7,e.TYPES.INT32]},p.name="ImageMsgContentProto",p.internalSpec={width:[1,e.TYPES.UINT32],height:[2,e.TYPES.UINT32],jpegThumbnail:[3,e.TYPES.BYTES],jpegThumbnailHeight:[4,e.TYPES.INT32],jpegThumbnailWidth:[5,e.TYPES.INT32]},_.name="AudioMsgContentProto",_.internalSpec={duration:[1,e.TYPES.INT32],mimetype:[2,e.TYPES.STRING],played:[3,e.TYPES.BOOL],waveform:[4,e.TYPES.BYTES]},f.name="DocumentFileMsgContentProto",f.internalSpec={filename:[1,e.TYPES.STRING],mimetype:[2,e.TYPES.STRING]},g.name="QuotedDbMediaProto",g.internalSpec={mediaType:[1,e.TYPES.STRING],plaintextHash:[2,e.TYPES.STRING],size:[3,e.TYPES.INT32],ts:[4,e.TYPES.INT64],mediaEntry:[5,e.TYPES.BYTES],validatedVideoInfo:[6,e.TYPES.MESSAGE,m],validatedImageInfo:[7,e.TYPES.MESSAGE,p],validatedAudioInfo:[8,e.TYPES.MESSAGE,_],validatedDocumentFileInfo:[9,e.TYPES.MESSAGE,f]},h.name="DbQuotedMsgContentProto",h.internalSpec={type:[1,e.TYPES.STRING],ts:[2,e.TYPES.INT64],externalId:[3,e.TYPES.STRING],author:[4,e.TYPES.STRING],msgContent:[5,e.TYPES.MESSAGE,s],obsoleteMedia:[6,e.TYPES.MESSAGE,g],msgId:[7,e.TYPES.STRING],mediaId:[8,e.TYPES.INT32],sourceId:[9,e.TYPES.STRING],xmaMessageType:[10,e.TYPES.INT32],specialTextSize:[11,e.TYPES.INT32],plaintextHash:[12,e.TYPES.STRING],expirationTs:[13,e.TYPES.INT64]},y.name="MessagesTableSchemaProto",y.internalSpec={type:[1,e.TYPES.STRING],ts:[2,e.TYPES.INT64],externalId:[3,e.TYPES.STRING],msgId:[4,e.TYPES.STRING],author:[5,e.TYPES.STRING],ack:[6,e.TYPES.INT32],resendCount:[7,e.TYPES.INT32],msgContent:[8,e.TYPES.MESSAGE,s],altIndex:[9,e.TYPES.STRING],forwardingScore:[10,e.TYPES.INT32],quote:[11,e.TYPES.MESSAGE,d],messageExpirationTs:[12,e.TYPES.INT64],ephemeralSetting:[13,e.TYPES.MESSAGE,o("MAWArmadilloContactsTableSchema.pb").EphemeralSettingProtoSpec],revokedExternalId:[14,e.TYPES.STRING],isForwarded:[15,e.TYPES.BOOL],originalTs:[17,e.TYPES.INT64],sortOrderMs:[18,e.TYPES.INT64],reportingMeta:[19,e.TYPES.MESSAGE,c],messageDeleteTs:[20,e.TYPES.INT64],ephemeralCounterStarted:[21,e.TYPES.BOOL],quoteExternalId:[22,e.TYPES.STRING],unsendMsgContentDeleteTs:[23,e.TYPES.INT64],rowId:[24,e.TYPES.INT32],thread:[25,e.TYPES.INT32],mediaId:[26,e.TYPES.INT32],ephemeralMsgDisappeared:[27,e.TYPES.BOOL],threadJid:[28,e.TYPES.STRING],xmaId:[29,e.TYPES.INT32],specialTextSize:[30,e.TYPES.INT32],xmaMessageType:[31,e.TYPES.INT32],isExpiredXmaMsg:[32,e.TYPES.BOOL],ravenEphemeralType:[33,e.TYPES.INT32],ravenEphemeralMediaState:[34,e.TYPES.INT32],editCount:[35,e.TYPES.INT32],groupId:[36,e.TYPES.STRING],groupIndex:[37,e.TYPES.INT64],groupSize:[38,e.TYPES.INT64],receiverFetchId:[39,e.TYPES.STRING],source:[40,e.TYPES.STRING],quoteExpirationTs:[41,e.TYPES.INT64],applicationErrorCode:[42,e.TYPES.INT32],hdType:[43,e.TYPES.INT32],pollStanzaId:[44,e.TYPES.STRING],collapsibleId:[45,e.TYPES.STRING],isCollapsed:[46,e.TYPES.BOOL]},l.MsgContentProtoSpec=s,l.MsgContentCommandProtoSpec=u,l.ReportingMetaProtoSpec=c,l.DbQuotedMsgProtoSpec=d,l.VideoMsgContentProtoSpec=m,l.ImageMsgContentProtoSpec=p,l.AudioMsgContentProtoSpec=_,l.DocumentFileMsgContentProtoSpec=f,l.QuotedDbMediaProtoSpec=g,l.DbQuotedMsgContentProtoSpec=h,l.MessagesTableSchemaProtoSpec=y}),98);
__d("MAWArmadilloEditMsgHistoryTableSchema.pb",["MAWArmadilloMessagesTableSchema.pb","WAProtoConst"],(function(t,n,r,o,a,i,l){var e,s={};s.name="EditMsgHistoryTableSchemaProto",s.internalSpec={author:[1,(e=o("WAProtoConst")).TYPES.STRING],editMsgHistoryId:[2,e.TYPES.INT32],editTs:[3,e.TYPES.INT64],msgContent:[4,e.TYPES.MESSAGE,o("MAWArmadilloMessagesTableSchema.pb").MsgContentProtoSpec],originalMsgExternalId:[5,e.TYPES.STRING],specialTextSize:[6,e.TYPES.INT32],threadJid:[7,e.TYPES.STRING],editExternalId:[8,e.TYPES.STRING],sendStatus:[9,e.TYPES.INT32]},l.EditMsgHistoryTableSchemaProtoSpec=s}),98);
__d("MAWArmadilloGroupInfoTableSchema.pb",["WAProtoConst"],(function(t,n,r,o,a,i,l){var e,s={};s.name="GroupInfoSchemaProto",s.internalSpec={groupJid:[1,(e=o("WAProtoConst")).TYPES.STRING],threadId:[2,e.TYPES.INT32],creator:[3,e.TYPES.STRING],creationTs:[4,e.TYPES.INT64],name:[5,e.TYPES.STRING],nameOwner:[6,e.TYPES.STRING],nameTs:[7,e.TYPES.INT64],msgExpiration:[8,e.TYPES.INT32],participantVersion:[9,e.TYPES.STRING],inviter:[10,e.TYPES.STRING],memberAddMode:[11,e.TYPES.STRING]},l.GroupInfoSchemaProtoSpec=s}),98);
__d("MAWArmadilloGroupInvitesTableSchema.pb",["WAProtoConst"],(function(t,n,r,o,a,i,l){var e,s={};s.name="GroupInvitesTableSchemaProto",s.internalSpec={inviterJid:[1,(e=o("WAProtoConst")).TYPES.STRING],invitedParticipantId:[2,e.TYPES.STRING],inviteCode:[3,e.TYPES.STRING],inviteExpirationTs:[4,e.TYPES.INT64],caption:[5,e.TYPES.STRING]},l.GroupInvitesTableSchemaProtoSpec=s}),98);
__d("MAWArmadilloMediaTablesSchema.pb",["WAProtoConst"],(function(t,n,r,o,a,i,l){var e,s={NONE:0,LQ_4K:1,HQ_4K:2},u={},c={},d={},m={},p={},_={},f={},g={},h={};u.name="ChunkTableSchemaProto",u.internalSpec={plaintextHash:[1,(e=o("WAProtoConst")).TYPES.STRING],blobData:[2,e.TYPES.BYTES],mimetype:[3,e.TYPES.STRING],hashedPlaintextHash:[4,e.TYPES.STRING],chunkId:[5,e.TYPES.INT32]},c.name="MediaBackupSchemaProto",c.internalSpec={mediaBackupId:[1,e.TYPES.INT32],mediaId:[2,e.TYPES.INT32],objectId:[3,e.TYPES.STRING],msgId:[4,e.TYPES.STRING],fbid:[5,e.TYPES.STRING]},d.name="MediaEntriesProto",d.internalSpec={msgId:[1,e.TYPES.STRING],mediaEntryData:[2,e.TYPES.BYTES]},m.name="VideoMsgContentProto",m.internalSpec={duration:[1,e.TYPES.UINT32],width:[2,e.TYPES.UINT32],height:[3,e.TYPES.UINT32],mimetype:[4,e.TYPES.STRING],jpegThumbnail:[5,e.TYPES.BYTES],jpegThumbnailHeight:[6,e.TYPES.UINT32],jpegThumbnailWidth:[7,e.TYPES.UINT32],thumbnailPlaintextHash:[8,e.TYPES.STRING],gifPlayback:[9,e.TYPES.BOOL]},p.name="ImageMsgContentProto",p.internalSpec={width:[1,e.TYPES.UINT32],height:[2,e.TYPES.UINT32],jpegThumbnail:[3,e.TYPES.BYTES],jpegThumbnailHeight:[4,e.TYPES.UINT32],jpegThumbnailWidth:[5,e.TYPES.UINT32],thumbnailPlaintextHash:[6,e.TYPES.STRING],hdType:[7,e.TYPES.ENUM,s]},_.name="AudioMsgContentProto",_.internalSpec={duration:[1,e.TYPES.UINT32],mimetype:[2,e.TYPES.STRING],played:[3,e.TYPES.BOOL],waveform:[4,e.TYPES.BYTES]},f.name="DocumentFileMsgContentProto",f.internalSpec={filename:[1,e.TYPES.STRING],mimetype:[2,e.TYPES.STRING]},g.name="ValidatedResult",g.internalSpec={validatedMimeType:[1,e.TYPES.STRING],videoStreamType:[2,e.TYPES.STRING],videoCalculatedFps:[3,e.TYPES.UINT32],videoNominalFps:[4,e.TYPES.UINT32],videoWidth:[5,e.TYPES.UINT32],videoHeight:[6,e.TYPES.UINT32],videoDuration:[7,e.TYPES.UINT32],videoAvgBitsPerSecond:[8,e.TYPES.UINT32],audioStreamType:[9,e.TYPES.STRING],audioSamplingRate:[10,e.TYPES.UINT32],audioNumberOfChannels:[11,e.TYPES.UINT32],audioAvgBitsPerSecond:[12,e.TYPES.UINT32]},h.name="MediaTableSchemaProto",h.internalSpec={mediaType:[1,e.TYPES.STRING],plaintextHash:[2,e.TYPES.STRING],size:[3,e.TYPES.UINT64],mediaEntries:[4,e.FLAGS.REPEATED|e.TYPES.MESSAGE,d],ts:[5,e.TYPES.INT64],validatedVideoInfo:[6,e.TYPES.MESSAGE,m],validatedImageInfo:[7,e.TYPES.MESSAGE,p],validatedAudioInfo:[8,e.TYPES.MESSAGE,_],hashedPlaintextHash:[9,e.TYPES.STRING],mediaId:[10,e.TYPES.INT32],msgIds:[11,e.FLAGS.REPEATED|e.TYPES.STRING],objectId:[12,e.TYPES.STRING],fbid:[13,e.TYPES.STRING],validatedDocumentFileInfo:[14,e.TYPES.MESSAGE,f],validatedResult:[15,e.TYPES.MESSAGE,g],accessibilitySummaryText:[16,e.TYPES.STRING],isVideoGif:[17,e.TYPES.BOOL]},l.HD_TYPE=s,l.ChunkTableSchemaProtoSpec=u,l.MediaBackupSchemaProtoSpec=c,l.MediaEntriesProtoSpec=d,l.VideoMsgContentProtoSpec=m,l.ImageMsgContentProtoSpec=p,l.AudioMsgContentProtoSpec=_,l.DocumentFileMsgContentProtoSpec=f,l.ValidatedResultSpec=g,l.MediaTableSchemaProtoSpec=h}),98);
__d("MAWArmadilloMissingKeysTableSchema.pb",["WAProtoConst"],(function(t,n,r,o,a,i,l){var e,s={},u={};s.name="DeviceResponse",s.internalSpec={deviceId:[1,(e=o("WAProtoConst")).TYPES.INT32],deviceResponse:[2,e.TYPES.BOOL]},u.name="MissingKeysTableSchemaProto",u.internalSpec={keyHex:[1,e.TYPES.STRING],keyId:[2,e.TYPES.BYTES],timestamp:[3,e.TYPES.INT64],deviceResponses:[4,e.FLAGS.REPEATED|e.TYPES.MESSAGE,s]},l.DeviceResponseSpec=s,l.MissingKeysTableSchemaProtoSpec=u}),98);
__d("MAWArmadilloParticipantsTableSchema.pb",["WAProtoConst"],(function(t,n,r,o,a,i,l){var e,s={};s.name="ParticipantsTableSchemaProto",s.internalSpec={id:[1,(e=o("WAProtoConst")).TYPES.STRING],userJid:[2,e.TYPES.STRING],deliveredWatermarkTs:[3,e.TYPES.INT64],lastReadWatermarkTs:[4,e.TYPES.INT64],type:[5,e.TYPES.STRING],addressable:[6,e.TYPES.BOOL],lastReadActionTs:[7,e.TYPES.INT64],threadId:[9,e.TYPES.INT32],threadJid:[10,e.TYPES.STRING]},l.ParticipantsTableSchemaProtoSpec=s}),98);
__d("MAWArmadilloPendingMutationsTableSchema.pb",["WAProtoConst"],(function(t,n,r,o,a,i,l){var e,s={SET:0,REMOVE:1},u={};u.name="PendingMutationsTableSchemaProto",u.internalSpec={id:[1,(e=o("WAProtoConst")).TYPES.INT32],collection:[2,e.TYPES.STRING],index:[3,e.TYPES.STRING],binarySyncAction:[4,e.TYPES.BYTES],version:[5,e.TYPES.INT32],operation:[6,e.TYPES.ENUM,s],timestamp:[7,e.TYPES.INT64],action:[8,e.TYPES.STRING]},l.SYNCD_MUTATION_SYNCD_OPERATION=s,l.PendingMutationsTableSchemaProtoSpec=u}),98);
__d("MAWArmadilloPersonalSenderKeyStatusTableSchema.pb",["WAProtoConst"],(function(t,n,r,o,a,i,l){var e,s={};s.name="PersonalSenderKeyStatusTableSchemaProto",s.internalSpec={groupJid:[1,(e=o("WAProtoConst")).TYPES.STRING],senderKeyId:[2,e.TYPES.INT32],rotateSenderKey:[4,e.TYPES.BOOL],senderKeyTs:[5,e.TYPES.INT64],hasSenderKey:[6,e.FLAGS.REPEATED|e.TYPES.STRING]},l.PersonalSenderKeyStatusTableSchemaProtoSpec=s}),98);
__d("MAWArmadilloPollTableSchema.pb",["WAProtoConst"],(function(t,n,r,o,a,i,l){var e,s={OPEN:0,FROZEN:1},u={},c={},d={},m={};u.name="PollOptionProto",u.internalSpec={optionText:[1,(e=o("WAProtoConst")).TYPES.STRING],voteAuthors:[2,e.FLAGS.REPEATED|e.TYPES.STRING]},c.name="PollOptionsProto",c.internalSpec={pollOptionHash:[1,e.TYPES.STRING],pollOption:[2,e.TYPES.MESSAGE,u]},d.name="LatestSenderTimestampsMsProto",d.internalSpec={author:[1,e.TYPES.STRING],latestSenderTimestampMs:[2,e.TYPES.INT64]},m.name="PollTableSchemaProto",m.internalSpec={chatJid:[1,e.TYPES.STRING],encKey:[2,e.TYPES.BYTES],pollAuthor:[3,e.TYPES.STRING],pollStanzaId:[4,e.TYPES.STRING],pollOptions:[5,e.FLAGS.REPEATED|e.TYPES.MESSAGE,c],pollParticipantCount:[6,e.TYPES.UINT32],pollState:[7,e.TYPES.ENUM,s],selectableOptionsCount:[8,e.TYPES.UINT32],title:[9,e.TYPES.STRING],latestSenderTimestampsMs:[10,e.FLAGS.REPEATED|e.TYPES.MESSAGE,d]},l.POLL_STATE=s,l.PollOptionProtoSpec=u,l.PollOptionsProtoSpec=c,l.LatestSenderTimestampsMsProtoSpec=d,l.PollTableSchemaProtoSpec=m}),98);
__d("MAWArmadilloReactionsTableSchema.pb",["WAProtoConst"],(function(t,n,r,o,a,i,l){var e,s={};s.name="ReactionsTableSchemaProto",s.internalSpec={ack:[1,(e=o("WAProtoConst")).TYPES.INT32],author:[2,e.TYPES.STRING],externalId:[3,e.TYPES.STRING],reactionId:[4,e.TYPES.STRING],reactToExternalId:[5,e.TYPES.STRING],reactToAuthor:[6,e.TYPES.STRING],reactToMsgId:[7,e.TYPES.STRING],threadJid:[8,e.TYPES.STRING],reaction:[9,e.TYPES.STRING],groupingKey:[10,e.TYPES.STRING],ts:[11,e.TYPES.INT64],rowId:[12,e.TYPES.INT32],senderTimestampMs:[13,e.TYPES.INT64]},l.ReactionsTableSchemaProtoSpec=s}),98);
__d("MAWArmadilloReceiptTablesSchema.pb",["WAProtoConst"],(function(t,n,r,o,a,i,l){var e,s={},u={},c={},d={},m={},p={},_={};s.name="DbUserStatusTsProto",s.internalSpec={deliveredTs:[1,(e=o("WAProtoConst")).TYPES.INT64],readTs:[2,e.TYPES.INT64]},u.name="StatusTsPerUserProto",u.internalSpec={userJid:[1,e.TYPES.STRING],dbUserStatusTs:[2,e.TYPES.MESSAGE,s]},c.name="IdentitiesPerDeviceProto",c.internalSpec={deviceJid:[1,e.TYPES.STRING],serializedPubKey:[2,e.TYPES.BYTES],baseKey:[3,e.TYPES.BYTES]},d.name="RetryCountPerDeviceProto",d.internalSpec={deviceJid:[1,e.TYPES.STRING],count:[2,e.TYPES.INT32]},m.name="ReceiptsTableSchemaProto",m.internalSpec={msgId:[1,e.TYPES.STRING],statusTsPerUser:[2,e.FLAGS.REPEATED|e.TYPES.MESSAGE,u],permittedIdentitiesPerDevice:[3,e.FLAGS.REPEATED|e.TYPES.MESSAGE,c],recipientDevices:[4,e.FLAGS.REPEATED|e.TYPES.STRING],retryCountsPerDevice:[5,e.FLAGS.REPEATED|e.TYPES.MESSAGE,d],waMsgId:[6,e.TYPES.STRING]},p.name="Receipts",p.internalSpec={device:[1,e.TYPES.STRING],ts:[2,e.TYPES.INT64]},_.name="PendingReceiptsTableSchemaProto",_.internalSpec={pendingReceiptId:[1,e.TYPES.STRING],thread:[2,e.TYPES.STRING],externalId:[3,e.TYPES.STRING],author:[4,e.TYPES.STRING],deliveryReceipts:[5,e.FLAGS.REPEATED|e.TYPES.MESSAGE,p],readReceipts:[6,e.FLAGS.REPEATED|e.TYPES.MESSAGE,p]},l.DbUserStatusTsProtoSpec=s,l.StatusTsPerUserProtoSpec=u,l.IdentitiesPerDeviceProtoSpec=c,l.RetryCountPerDeviceProtoSpec=d,l.ReceiptsTableSchemaProtoSpec=m,l.ReceiptsSpec=p,l.PendingReceiptsTableSchemaProtoSpec=_}),98);
__d("MAWArmadilloReceiverFetchInfoTableSchema.pb",["WAProtoConst"],(function(t,n,r,o,a,i,l){var e,s={};s.name="ReceiverFetchInfoTableSchemaProto",s.internalSpec={mimetype:[1,(e=o("WAProtoConst")).TYPES.STRING],previewHeight:[2,e.TYPES.UINT32],previewWidth:[3,e.TYPES.UINT32],receiverFetchId:[4,e.TYPES.STRING],type:[5,e.TYPES.STRING],previewUrl:[6,e.TYPES.STRING],previewUrlExpirationTimestampMs:[7,e.TYPES.UINT64],accessibilitySummaryText:[8,e.TYPES.STRING]},l.ReceiverFetchInfoTableSchemaProtoSpec=s}),98);
__d("MAWArmadilloSyncActionsTableSchema.pb",["WAProtoConst"],(function(t,n,r,o,a,i,l){var e,s={};s.name="SyncActionsTableSchemaProto",s.internalSpec={index:[1,(e=o("WAProtoConst")).TYPES.STRING],binarySyncData:[2,e.TYPES.BYTES],actionState:[3,e.TYPES.STRING],version:[4,e.TYPES.INT32],keyId:[5,e.TYPES.BYTES],modelId:[6,e.TYPES.STRING],modelType:[7,e.TYPES.STRING],indexMac:[8,e.TYPES.BYTES],valueMac:[9,e.TYPES.BYTES],collection:[10,e.TYPES.STRING],timestamp:[11,e.TYPES.INT64],action:[12,e.TYPES.STRING]},l.SyncActionsTableSchemaProtoSpec=s}),98);
__d("MAWArmadilloSyncKeysTableSchema.pb",["WAProtoConst"],(function(t,n,r,o,a,i,l){var e,s={},u={};s.name="SyncKeyFingerprint",s.internalSpec={currentIndex:[1,(e=o("WAProtoConst")).TYPES.INT32],deviceIndexes:[2,e.FLAGS.REPEATED|e.TYPES.INT32],rawId:[3,e.TYPES.INT64]},u.name="SyncKeysTableSchemaProto",u.internalSpec={id:[1,e.TYPES.BYTES],keyId:[2,e.TYPES.BYTES],keyData:[3,e.TYPES.BYTES],keyEpoch:[4,e.TYPES.INT64],timestamp:[5,e.TYPES.INT64],fingerprint:[6,e.TYPES.MESSAGE,s]},l.SyncKeyFingerprintSpec=s,l.SyncKeysTableSchemaProtoSpec=u}),98);
__d("MAWArmadilloTasksTableSchema.pb",["WAProtoConst"],(function(t,n,r,o,a,i,l){var e={};e.name="TasksTableSchemaProto",e.internalSpec={taskName:[1,o("WAProtoConst").TYPES.STRING],scheduledTime:[2,o("WAProtoConst").TYPES.INT64]},l.TasksTableSchemaProtoSpec=e}),98);
__d("MAWArmadilloThreadsTableSchema.pb",["WAProtoConst"],(function(t,n,r,o,a,i,l){var e,s={};s.name="ThreadsTableSchemaProto",s.internalSpec={jid:[1,(e=o("WAProtoConst")).TYPES.STRING],threadOrder:[2,e.TYPES.STRING],folder:[4,e.TYPES.INT32],newestMsg:[5,e.TYPES.STRING],oldestMsg:[6,e.TYPES.STRING],lastReadMsg:[7,e.TYPES.STRING],lastReadMsgReceiptSent:[8,e.TYPES.STRING],lastReadMsgTs:[9,e.TYPES.INT64],newestMsgTs:[10,e.TYPES.INT64],muteExpireTimeMs:[11,e.TYPES.INT64],muteCallsExpireTimeMs:[12,e.TYPES.INT64],archived:[13,e.TYPES.BOOL],cannotReplyReason:[14,e.TYPES.STRING],chatId:[15,e.TYPES.INT32],optimisticThreadKey:[16,e.TYPES.STRING],isMigratedLocally:[17,e.TYPES.BOOL],snippetMsg:[18,e.TYPES.STRING],deduplicationKey:[19,e.TYPES.STRING],authoritativeThreadKey:[20,e.TYPES.STRING],snippetMsgTs:[21,e.TYPES.INT64],didInsertDualThreadCutoverAdminMsg:[22,e.TYPES.BOOL],unbumpFromTs:[23,e.TYPES.INT64],unbumpToTs:[24,e.TYPES.INT64]},l.ThreadsTableSchemaProtoSpec=s}),98);
__d("MAWArmadilloUnrenderedMessagesTableSchema.pb",["MAWArmadilloContactsTableSchema.pb","MAWArmadilloMessagesTableSchema.pb","WAProtoConst"],(function(t,n,r,o,a,i,l){var e,s={};s.name="UnrenderedMessagesTableSchemaProto",s.internalSpec={type:[1,(e=o("WAProtoConst")).TYPES.STRING],ts:[2,e.TYPES.INT64],externalId:[3,e.TYPES.STRING],msgId:[4,e.TYPES.STRING],author:[5,e.TYPES.STRING],ack:[6,e.TYPES.INT32],resendCount:[7,e.TYPES.INT32],ephemeralSetting:[8,e.TYPES.MESSAGE,o("MAWArmadilloContactsTableSchema.pb").EphemeralSettingProtoSpec],messageDeleteForMeTs:[9,e.TYPES.INT64],rowId:[10,e.TYPES.INT32],thread:[11,e.TYPES.INT32],mediaId:[12,e.TYPES.INT32],msgContent:[13,e.TYPES.STRING],threadJid:[14,e.TYPES.STRING],reportingMeta:[15,e.TYPES.MESSAGE,o("MAWArmadilloMessagesTableSchema.pb").ReportingMetaProtoSpec],invitedParticipantUserJid:[16,e.TYPES.STRING],groupName:[17,e.TYPES.STRING],quote:[18,e.TYPES.MESSAGE,o("MAWArmadilloMessagesTableSchema.pb").DbQuotedMsgProtoSpec],xmaMessageType:[19,e.TYPES.INT32],sortOrderMs:[20,e.TYPES.INT64]},l.UnrenderedMessagesTableSchemaProtoSpec=s}),98);
__d("MAWArmadilloXMATableSchema.pb",["WAProtoConst"],(function(t,n,r,o,a,i,l){var e,s={},u={};s.name="XMATableSchemaProto",s.internalSpec={associatedMessageId:[1,(e=o("WAProtoConst")).TYPES.STRING],author:[2,e.TYPES.STRING],ctas:[3,e.FLAGS.REPEATED|e.TYPES.MESSAGE,u],defaultCTA:[4,e.TYPES.MESSAGE,u],defaultPreviewMediaId:[5,e.TYPES.INT32],externalId:[6,e.TYPES.STRING],faviconMediaId:[7,e.TYPES.INT32],headerMediaId:[8,e.TYPES.INT32],headerTitle:[9,e.TYPES.STRING],isTombstoned:[10,e.TYPES.BOOL],maxSubtitleNumOfLines:[11,e.TYPES.INT32],maxTitleNumOfLines:[12,e.TYPES.INT32],msgId:[13,e.TYPES.STRING],overlayDescription:[14,e.TYPES.STRING],overlayIconGlyph:[15,e.TYPES.INT32],overlayTitle:[16,e.TYPES.STRING],previewMediaIds:[17,e.FLAGS.REPEATED|e.TYPES.INT32],subtitleText:[18,e.TYPES.STRING],targetExpiringAtSec:[19,e.TYPES.INT64],targetId:[20,e.TYPES.STRING],targetType:[21,e.TYPES.INT32],targetUsername:[22,e.TYPES.STRING],threadJid:[23,e.TYPES.STRING],titleText:[24,e.TYPES.STRING],xmaId:[25,e.TYPES.INT32],xmaLayoutType:[26,e.TYPES.INT32],defaultPreviewMediaPlaintextHash:[27,e.TYPES.STRING],faviconPlaintextHash:[28,e.TYPES.STRING],headerMediaPlaintextHash:[29,e.TYPES.STRING]},u.name="CTAProto",u.internalSpec={buttonType:[1,e.TYPES.INT32],title:[2,e.TYPES.STRING],actionUrl:[3,e.TYPES.STRING],nativeUrl:[4,e.TYPES.STRING],ctaType:[5,e.TYPES.STRING]},l.XMATableSchemaProtoSpec=s,l.CTAProtoSpec=u}),98);
__d("MAWXMACTAUtil",[],(function(t,n,r,o,a,i){"use strict";function e(e){var t=e.actionUrl,n=e.buttonType,r=e.ctaType,o=e.nativeUrl,a=e.title;return{actionUrl:t,buttonType:n,ctaType:r,nativeUrl:o,title:a}}function l(e){var t=e.actionUrl,n=e.buttonType,r=e.ctaType,o=e.nativeUrl,a=e.title;return{actionUrl:t,buttonType:n,ctaType:r,nativeUrl:o,title:a}}i.toMAWCTAEncode=e,i.fromMAWCTAEncode=l}),66);
__d("WAServerSync.pb",["$InternalEnum","WAProtoConst"],(function(t,n,r,o,a,i,l){var e,s=n("$InternalEnum")({SET:0,REMOVE:1}),u={},c={},d={},m={},p={},_={},f={},g={},h={},y={},C={};u.name="SyncdVersion",u.internalSpec={version:[1,(e=o("WAProtoConst")).TYPES.UINT64]},c.name="ExitCode",c.internalSpec={code:[1,e.TYPES.UINT64],text:[2,e.TYPES.STRING]},d.name="SyncdIndex",d.internalSpec={blob:[1,e.TYPES.BYTES]},m.name="SyncdValue",m.internalSpec={blob:[1,e.TYPES.BYTES]},p.name="KeyId",p.internalSpec={id:[1,e.TYPES.BYTES]},_.name="SyncdRecord",_.internalSpec={index:[1,e.TYPES.MESSAGE,d],value:[2,e.TYPES.MESSAGE,m],keyId:[3,e.TYPES.MESSAGE,p]},f.name="ExternalBlobReference",f.internalSpec={mediaKey:[1,e.TYPES.BYTES],directPath:[2,e.TYPES.STRING],handle:[3,e.TYPES.STRING],fileSizeBytes:[4,e.TYPES.UINT64],fileSha256:[5,e.TYPES.BYTES],fileEncSha256:[6,e.TYPES.BYTES]},g.name="SyncdSnapshot",g.internalSpec={version:[1,e.TYPES.MESSAGE,u],records:[2,e.FLAGS.REPEATED|e.TYPES.MESSAGE,_],mac:[3,e.TYPES.BYTES],keyId:[4,e.TYPES.MESSAGE,p]},h.name="SyncdMutations",h.internalSpec={mutations:[1,e.FLAGS.REPEATED|e.TYPES.MESSAGE,y]},y.name="SyncdMutation",y.internalSpec={operation:[1,e.TYPES.ENUM,s],record:[2,e.TYPES.MESSAGE,_]},C.name="SyncdPatch",C.internalSpec={version:[1,e.TYPES.MESSAGE,u],mutations:[2,e.FLAGS.REPEATED|e.TYPES.MESSAGE,y],externalMutations:[3,e.TYPES.MESSAGE,f],snapshotMac:[4,e.TYPES.BYTES],patchMac:[5,e.TYPES.BYTES],keyId:[6,e.TYPES.MESSAGE,p],exitCode:[7,e.TYPES.MESSAGE,c],deviceIndex:[8,e.TYPES.UINT32],clientDebugData:[9,e.TYPES.BYTES]},l.SyncdMutation$SyncdOperation=s,l.SyncdVersionSpec=u,l.ExitCodeSpec=c,l.SyncdIndexSpec=d,l.SyncdValueSpec=m,l.KeyIdSpec=p,l.SyncdRecordSpec=_,l.ExternalBlobReferenceSpec=f,l.SyncdSnapshotSpec=g,l.SyncdMutationsSpec=h,l.SyncdMutationSpec=y,l.SyncdPatchSpec=C}),98);
__d("MAWDbObjDecode",["FBLogger","MAWArmadilloAppDataTableSchema.pb","MAWArmadilloAppMetaTableSchema.pb","MAWArmadilloCollectionVersionsTableSchema.pb","MAWArmadilloDeletedMessagesTableSchema.pb","MAWArmadilloDeviceChangeAlertsTableSchema.pb","MAWArmadilloDyiBatchTableSchema.pb","MAWArmadilloEBMsgRangesTableSchema.pb","MAWArmadilloEditMsgHistoryTableSchema.pb","MAWArmadilloGroupInfoTableSchema.pb","MAWArmadilloGroupInvitesTableSchema.pb","MAWArmadilloMediaTablesSchema.pb","MAWArmadilloMessagesTableSchema.pb","MAWArmadilloMissingKeysTableSchema.pb","MAWArmadilloParticipantsTableSchema.pb","MAWArmadilloPendingMutationsTableSchema.pb","MAWArmadilloPersonalSenderKeyStatusTableSchema.pb","MAWArmadilloPollTableSchema.pb","MAWArmadilloReactionsTableSchema.pb","MAWArmadilloReceiptTablesSchema.pb","MAWArmadilloReceiverFetchInfoTableSchema.pb","MAWArmadilloSyncActionsTableSchema.pb","MAWArmadilloSyncKeysTableSchema.pb","MAWArmadilloTasksTableSchema.pb","MAWArmadilloThreadsTableSchema.pb","MAWArmadilloUnrenderedMessagesTableSchema.pb","MAWArmadilloXMATableSchema.pb","MAWMsgType","MAWODSProxy","MAWXMACTAUtil","WAOdsEnums","WAServerSync.pb","decodeProtobuf"],(function(t,n,r,o,a,i,l){var e={appData:function(t){return I(t)},appMeta:function(t){return T(t)},chunk:function(t){return D(t)},collectionVersions:function(t){return O(t)},deletedMessages:function(t){return _(t)},deviceChangeAlerts:function(t){return u(t)},dualSendMedia:function(t){throw r("FBLogger")("messenger_web").mustfixThrow("unexpected table for decryption")},dyiBatch:function(t){return N(t)},ebMessageRestoreTasks:function(t){throw r("FBLogger")("messenger_web").mustfixThrow("unexpected table for decryption")},ebMsgRanges:function(t){return M(t)},ebRestoreQueue:function(t){throw r("FBLogger")("messenger_web").mustfixThrow("unexpected table for decryption")},ebUploadQueue:function(t){throw r("FBLogger")("messenger_web").mustfixThrow("unexpected table for decryption")},editMsgHistory:function(t){return q(t)},encryptionMetaV3:function(t){throw r("FBLogger")("messenger_web").mustfixThrow("unexpected table for decryption")},ephemeralSettings:function(t){throw r("FBLogger")("messenger_web").mustfixThrow("unexpected table for decryption")},existingUsers:function(t){throw r("FBLogger")("messenger_web").mustfixThrow("unexpected table for decryption")},ftsBackloggedMessages:function(t){throw r("FBLogger")("messenger_web").mustfixThrow("unexpected table for decryption")},ftsEncryptionMeta:function(t){throw r("FBLogger")("messenger_web").mustfixThrow("unexpected table for decryption")},ftsIndexV3:function(t){throw r("FBLogger")("messenger_web").mustfixThrow("unexpected table for decryption")},ftsPurgeBacklog:function(t){throw r("FBLogger")("messenger_web").mustfixThrow("unexpected table for decryption")},ftsPurgeThreadBacklog:function(t){throw r("FBLogger")("messenger_web").mustfixThrow("unexpected table for decryption")},groupInfo:function(t){return h(t)},groupInvites:function(t){return L(t)},historySyncQRCodeData:function(t){throw r("FBLogger")("messenger_web").mustfixThrow("unexpected table for decryption")},historySyncQRCodeSecretKey:function(t){throw r("FBLogger")("messenger_web").mustfixThrow("unexpected table for decryption")},igMessageAuxiliaryInfo:function(t){throw r("FBLogger")("messenger_web").mustfixThrow("unexpected table for decryption")},isDualSend:function(t){throw r("FBLogger")("messenger_web").mustfixThrow("unexpected table for decryption")},media:function(t){return $(t)},mediaBackup:function(t){return x(t)},mediaKeys:function(t){throw r("FBLogger")("messenger_web").mustfixThrow("unexpected table for decryption")},messages:function(t){return p(t)},missingKeys:function(t){return A(t)},participants:function(t){return R(t)},pendingMessageStanzaQueue:function(t){throw r("FBLogger")("messenger_web").mustfixThrow("unexpected table for decryption")},pendingMutations:function(t){return F(t)},pendingReceipts:function(t){return v(t)},pendingStanzas:function(t){throw r("FBLogger")("messenger_web").mustfixThrow("unexpected table for decryption")},personalSenderKeyStatuses:function(t){return k(t)},poll:function(t){return V(t)},reactions:function(t){return P(t)},receipts:function(t){return b(t)},receiverFetchInfo:function(t){return U(t)},sentBytesCache:function(t){throw r("FBLogger")("messenger_web").mustfixThrow("unexpected table for decryption")},staleQueue:function(t){throw r("FBLogger")("messenger_web").mustfixThrow("unexpected table for decryption")},syncActions:function(t){return w(t)},syncKeys:function(t){return B(t)},tasks:function(t){return E(t)},threads:function(t){return S(t)},unrenderedMessages:function(t){return f(t)},xma:function(t){return W(t)}};function s(t,n){var o=null;if(Object.prototype.hasOwnProperty.call(e,n))o=e[n](t);else throw r("FBLogger")("messenger_web").mustfixThrow("not a valid table name");return o}function u(e){var t=o("decodeProtobuf").decodeProtobuf(o("MAWArmadilloDeviceChangeAlertsTableSchema.pb").DeviceChangeAlertsTableSchemaProtoSpec,e);return{action:t.action,deviceJid:t.deviceJid,identity:t.identity,isArchived:t.isArchived,latitude:t.latitude,location:t.location,loggedOut:t.loggedOut,longitude:t.longitude,model:t.model,platform:t.platform,ts:t.ts}}function c(e){var t=e.quote,n;if(t!=null){if(t.content==null)throw r("FBLogger")("messenger_web").mustfixThrow("QuotedMsgContent missing upon decoding");var o=t.content,a=o.author,i=o.expirationTs,l=o.externalId,s=o.mediaId,u=o.msgContent,c=o.msgId,d=o.plaintextHash,m=o.sourceId,p=o.specialTextSize,_=o.ts,f=o.type,g=o.xmaMessageType;n={content:babelHelpers.extends({},t.content,{author:a,expirationTs:i,externalId:l,mediaId:s,msgContent:u,msgId:c,plaintextHash:d,sourceId:m,specialTextSize:p,ts:_,type:f,xmaMessageType:g}),remoteJid:t.remoteJid}}return n}function d(e){return e==null?e:new Uint8Array(e)}function m(e){return e==null||e.length===0?new Set:new Set(e)}function p(e){var t=o("decodeProtobuf").decodeProtobuf(o("MAWArmadilloMessagesTableSchema.pb").MessagesTableSchemaProtoSpec,e),n=t.msgContent;if(t.type===o("MAWMsgType").MSG_TYPE.FUTUREPROOF){if(n==null)throw r("FBLogger")("messenger_web").mustfixThrow("MsgContent missing upon decoding futureproof message");n.subtype=n.subtype}var a=c(t),i=g(t.reportingMeta);return babelHelpers.extends({},t,{msgContent:n,quote:a,reportingMeta:i})}function _(e){var t=o("decodeProtobuf").decodeProtobuf(o("MAWArmadilloDeletedMessagesTableSchema.pb").DeletedMessagesTableSchemaProtoSpec,e);return babelHelpers.extends({},t)}function f(e){var t=o("decodeProtobuf").decodeProtobuf(o("MAWArmadilloUnrenderedMessagesTableSchema.pb").UnrenderedMessagesTableSchemaProtoSpec,e),n=c(t),r=g(t.reportingMeta);return babelHelpers.extends({},t,{quote:n,reportingMeta:r})}function g(e){if(e!=null)return{frankingKey:e.frankingKey!=null?new Uint8Array(e.frankingKey):e.frankingKey,frankingTag:e.frankingTag!=null?new Uint8Array(e.frankingTag):e.frankingTag,frankingVersion:e.frankingVersion,reportingContent:e.reportingContent,reportingTag:e.reportingTag!=null?new Uint8Array(e.reportingTag):e.reportingTag}}function h(e){var t=o("decodeProtobuf").decodeProtobuf(o("MAWArmadilloGroupInfoTableSchema.pb").GroupInfoSchemaProtoSpec,e);return{creationTs:t.creationTs,creator:t.creator,inviter:t.inviter,memberAddMode:t.memberAddMode,msgExpiration:t.msgExpiration,name:t.name,nameOwner:t.nameOwner,nameTs:t.nameTs,participantVersion:t.participantVersion}}function y(e){return e.length===0?null:new Map(e.map(function(e){var t=e.deviceJid;if(t==null||e.serializedPubKey==null)throw r("FBLogger")("messenger_web").mustfixThrow("Expected deviceJid or serializedPubKey are missing ");var n=new Uint8Array(e.serializedPubKey),o=d(e.baseKey),a={baseKey:o,pubKey:n};return[t,a]}))}function C(e){return e==null?null:new Map(e.map(function(e){var t;if(e.deviceJid==null)throw r("FBLogger")("messenger_web").mustfixThrow("Expected deviceJID is missing ");return[e.deviceJid,(t=e.count)!=null?t:0]}))}function b(e){var t=o("decodeProtobuf").decodeProtobuf(o("MAWArmadilloReceiptTablesSchema.pb").ReceiptsTableSchemaProtoSpec,e),n=t.recipientDevices,r=m(n);return{permittedIdentitiesPerDevice:y(t.permittedIdentitiesPerDevice),recipientDevices:r,retryCountsPerDevice:C(t.retryCountsPerDevice)}}function v(e){return o("decodeProtobuf").decodeProtobuf(o("MAWArmadilloReceiptTablesSchema.pb").PendingReceiptsTableSchemaProtoSpec,e)}function S(e){var t=o("decodeProtobuf").decodeProtobuf(o("MAWArmadilloThreadsTableSchema.pb").ThreadsTableSchemaProtoSpec,e);return{archived:t.archived,cannotReplyReason:t.cannotReplyReason,didInsertDualThreadCutoverAdminMsg:t.didInsertDualThreadCutoverAdminMsg,folder:t.folder,isMigratedLocally:t.isMigratedLocally,lastReadMsg:t.lastReadMsg,lastReadMsgReceiptSent:t.lastReadMsgReceiptSent,muteCallsExpireTimeMs:t.muteCallsExpireTimeMs,muteExpireTimeMs:t.muteExpireTimeMs,newestMsg:t.newestMsg,newestMsgTs:t.newestMsgTs,oldestMsg:t.oldestMsg,optimisticThreadKey:t.optimisticThreadKey,snippetMsg:t.snippetMsg,snippetMsgTs:t.snippetMsgTs}}function R(e){return o("decodeProtobuf").decodeProtobuf(o("MAWArmadilloParticipantsTableSchema.pb").ParticipantsTableSchemaProtoSpec,e)}function L(e){return o("decodeProtobuf").decodeProtobuf(o("MAWArmadilloGroupInvitesTableSchema.pb").GroupInvitesTableSchemaProtoSpec,e)}function E(e){return o("decodeProtobuf").decodeProtobuf(o("MAWArmadilloTasksTableSchema.pb").TasksTableSchemaProtoSpec,e)}function k(e){var t=o("decodeProtobuf").decodeProtobuf(o("MAWArmadilloPersonalSenderKeyStatusTableSchema.pb").PersonalSenderKeyStatusTableSchemaProtoSpec,e),n=t.hasSenderKey,r=m(n);return{hasSenderKey:r,rotateSenderKey:t.rotateSenderKey,senderKeyId:t.senderKeyId,senderKeyTs:t.senderKeyTs}}function I(e){var t=o("decodeProtobuf").decodeProtobuf(o("MAWArmadilloAppDataTableSchema.pb").AppDataTableSchemaProtoSpec,e);return{ack:t.ack,contents:t.contents,permittedIdentitiesPerDevice:y(t.permittedIdentitiesPerDevice),recipientDevices:new Set(t.recipientDevices),sendPartial:t.sendPartial,ts:t.ts}}function T(e){return o("decodeProtobuf").decodeProtobuf(o("MAWArmadilloAppMetaTableSchema.pb").AppMetaTableSchemaProtoSpec,e)}function D(e){return o("decodeProtobuf").decodeProtobuf(o("MAWArmadilloMediaTablesSchema.pb").ChunkTableSchemaProtoSpec,e)}function x(e){return o("decodeProtobuf").decodeProtobuf(o("MAWArmadilloMediaTablesSchema.pb").MediaBackupSchemaProtoSpec,e)}function $(e){var t=o("decodeProtobuf").decodeProtobuf(o("MAWArmadilloMediaTablesSchema.pb").MediaTableSchemaProtoSpec,e),n,a=t.mediaEntries;return a==null?n=new Map:n=new Map(a.map(function(e){if(e.msgId==null||e.mediaEntryData==null)throw r("FBLogger")("messenger_web").mustfixThrow("Expected msgId or mediaEntryData are missing ");return[e.msgId,new Uint8Array(e.mediaEntryData)]})),{accessibilitySummaryText:t.accessibilitySummaryText,isVideoGif:t.isVideoGif,mediaEntries:n,mediaType:t.mediaType,plaintextHash:t.plaintextHash,size:t.size,ts:t.ts,validatedAudioInfo:t.validatedAudioInfo,validatedDocumentFileInfo:t.validatedDocumentFileInfo,validatedImageInfo:t.validatedImageInfo,validatedResult:t.validatedResult,validatedVideoInfo:t.validatedVideoInfo}}function P(e){var t=o("decodeProtobuf").decodeProtobuf(o("MAWArmadilloReactionsTableSchema.pb").ReactionsTableSchemaProtoSpec,e);return t.ts!=null&&o("MAWODSProxy").odsBumpEntityKey({entity:o("WAOdsEnums").Entity.MAW_MIGRATE_REACTION_TS_AS_INDEX,key:"reaction_ts_encrypted"}),babelHelpers.extends({ack:t.ack,author:t.author,groupingKey:t.groupingKey,reaction:t.reaction,reactToAuthor:t.reactToAuthor,senderTimestampMs:t.senderTimestampMs},t.ts!=null?{ts:t.ts}:{})}function N(e){var t=o("decodeProtobuf").decodeProtobuf(o("MAWArmadilloDyiBatchTableSchema.pb").DyiBatchTableSchemaProtoSpec,e);return{isThread:t.isThread,numMessages:t.numMessages,numMessagesRestored:t.numMessagesRestored,numThreadsRestored:t.numThreadsRestored,oldestTs:t.oldestTs,qplFlowDescriptor:t.qplFlowDescriptor,qplInstanceKeyE2E:t.qplInstanceKeyE2E,qplInstanceKeyForThread:t.qplInstanceKeyForThread,threadId:t.threadId}}function M(e){var t=o("decodeProtobuf").decodeProtobuf(o("MAWArmadilloEBMsgRangesTableSchema.pb").EBMsgRangesTableSchemaProtoSpec,e);return{creationTime:t.creationTime,maxMsgExternalId:t.maxMsgExternalId,maxMsgSortOrderMs:t.maxMsgSortOrderMs,minMsgExternalId:t.minMsgExternalId,minMsgSortOrderMs:t.minMsgSortOrderMs}}function w(e){var t=o("decodeProtobuf").decodeProtobuf(o("MAWArmadilloSyncActionsTableSchema.pb").SyncActionsTableSchemaProtoSpec,e);return{binarySyncData:t.binarySyncData,keyId:t.keyId,timestamp:t.timestamp,valueMac:t.valueMac,version:t.version}}function A(e){var t=o("decodeProtobuf").decodeProtobuf(o("MAWArmadilloMissingKeysTableSchema.pb").MissingKeysTableSchemaProtoSpec,e),n;return t.deviceResponses==null?n=new Map:n=new Map(t.deviceResponses.map(function(e){if(e.deviceId==null)throw r("FBLogger")("messenger_web").mustfixThrow("Expected deviceId is missing");return[e.deviceId,e.deviceResponse]})),{deviceResponses:n,keyId:t.keyId,timestamp:t.timestamp}}function F(e){var t=o("decodeProtobuf").decodeProtobuf(o("MAWArmadilloPendingMutationsTableSchema.pb").PendingMutationsTableSchemaProtoSpec,e),n;switch(t.operation){case o("MAWArmadilloPendingMutationsTableSchema.pb").SYNCD_MUTATION_SYNCD_OPERATION.SET:n=o("WAServerSync.pb").SyncdMutation$SyncdOperation.SET;break;case o("MAWArmadilloPendingMutationsTableSchema.pb").SYNCD_MUTATION_SYNCD_OPERATION.REMOVE:n=o("WAServerSync.pb").SyncdMutation$SyncdOperation.REMOVE;break;default:throw r("FBLogger")("messenger_web").mustfixThrow("operation missing when decoding PendingMutation")}return{binarySyncAction:t.binarySyncAction,operation:n,timestamp:t.timestamp,version:t.version}}function O(e){var t=o("decodeProtobuf").decodeProtobuf(o("MAWArmadilloCollectionVersionsTableSchema.pb").CollectionVersionsTableSchemaProtoSpec,e);return{finiteFailureStartTime:t.finiteFailureStartTime,isCollectionInMacMismatchFatal:t.isCollectionInMacMismatchFatal,isCollectionLthashInconsistent:t.isCollectionLthashInconsistent,ltHash:t.ltHash,state:t.state,version:t.version}}function B(e){var t=o("decodeProtobuf").decodeProtobuf(o("MAWArmadilloSyncKeysTableSchema.pb").SyncKeysTableSchemaProtoSpec,e);return{fingerprint:t.fingerprint,keyData:t.keyData,timestamp:t.timestamp}}function W(e){var t=o("decodeProtobuf").decodeProtobuf(o("MAWArmadilloXMATableSchema.pb").XMATableSchemaProtoSpec,e);return{author:t.author,ctas:t.ctas.map(function(e){return o("MAWXMACTAUtil").fromMAWCTAEncode(e)}),defaultCTA:t.defaultCTA==null?t.defaultCTA:o("MAWXMACTAUtil").fromMAWCTAEncode(t.defaultCTA),defaultPreviewMediaPlaintextHash:t.defaultPreviewMediaPlaintextHash,faviconPlaintextHash:t.faviconPlaintextHash,headerMediaPlaintextHash:t.headerMediaPlaintextHash,headerTitle:t.headerTitle,isTombstoned:t.isTombstoned,maxSubtitleNumOfLines:t.maxSubtitleNumOfLines,maxTitleNumOfLines:t.maxTitleNumOfLines,msgId:t.msgId,overlayDescription:t.overlayDescription,overlayIconGlyph:t.overlayIconGlyph,overlayTitle:t.overlayTitle,previewMediaIds:t.previewMediaIds,subtitleText:t.subtitleText,targetId:t.targetId,targetType:t.targetType,targetUsername:t.targetUsername,threadJid:t.threadJid,titleText:t.titleText,xmaLayoutType:t.xmaLayoutType}}function q(e){var t=o("decodeProtobuf").decodeProtobuf(o("MAWArmadilloEditMsgHistoryTableSchema.pb").EditMsgHistoryTableSchemaProtoSpec,e);return{author:t.author,editExternalId:t.editExternalId,editTs:t.editTs,msgContent:t.msgContent,sendStatus:t.sendStatus,specialTextSize:t.specialTextSize}}function U(e){var t=o("decodeProtobuf").decodeProtobuf(o("MAWArmadilloReceiverFetchInfoTableSchema.pb").ReceiverFetchInfoTableSchemaProtoSpec,e);return{accessibilitySummaryText:t.accessibilitySummaryText,mimetype:t.mimetype,previewHeight:t.previewHeight,previewUrl:t.previewUrl,previewUrlExpirationTimestampMs:t.previewUrlExpirationTimestampMs,previewWidth:t.previewWidth,type:t.type}}function V(e){var t=o("decodeProtobuf").decodeProtobuf(o("MAWArmadilloPollTableSchema.pb").PollTableSchemaProtoSpec,e),n=new Map(t.pollOptions.map(function(e){var t=e.pollOptionHash;if(t==null||e.pollOption==null)throw r("FBLogger")("messenger_web").mustfixThrow("Expected pollOptionHash or pollOption is missing");return[t,{optionText:e.pollOption.optionText,voteAuthors:new Set(e.pollOption.voteAuthors)}]}).filter(Boolean)),a=new Map(t.latestSenderTimestampsMs.map(function(e){if(e.author==null||e.latestSenderTimestampMs==null)throw r("FBLogger")("messenger_web").mustfixThrow("Expected author or latestSenderTimestampMs are missing");return[e.author,e.latestSenderTimestampMs]}));return{encKey:t.encKey,latestSenderTimestampsMs:a,pollAuthor:t.pollAuthor,pollOptions:n,pollParticipantCount:t.pollParticipantCount,pollState:t.pollState,selectableOptionsCount:t.selectableOptionsCount,title:t.title}}l.decodeDbObj=s}),98);
__d("WASyncdKeyTypes",[],(function(t,n,r,o,a,i){"use strict";function e(e){return e}function l(e){return e}function s(e){return e}function u(e){return e}i.toSyncKeyId=e,i.fromSyncKeyId=l,i.toSyncKeyData=s,i.fromSyncKeyData=u}),66);
__d("MAWDbObjEncode",["FBLogger","MAWArmadilloAppDataTableSchema.pb","MAWArmadilloAppMetaTableSchema.pb","MAWArmadilloDeletedMessagesTableSchema.pb","MAWArmadilloDeviceChangeAlertsTableSchema.pb","MAWArmadilloDyiBatchTableSchema.pb","MAWArmadilloEBMsgRangesTableSchema.pb","MAWArmadilloEditMsgHistoryTableSchema.pb","MAWArmadilloGroupInfoTableSchema.pb","MAWArmadilloGroupInvitesTableSchema.pb","MAWArmadilloMediaTablesSchema.pb","MAWArmadilloMessagesTableSchema.pb","MAWArmadilloParticipantsTableSchema.pb","MAWArmadilloPersonalSenderKeyStatusTableSchema.pb","MAWArmadilloPollTableSchema.pb","MAWArmadilloReactionsTableSchema.pb","MAWArmadilloReceiptTablesSchema.pb","MAWArmadilloReceiverFetchInfoTableSchema.pb","MAWArmadilloTasksTableSchema.pb","MAWArmadilloThreadsTableSchema.pb","MAWArmadilloUnrenderedMessagesTableSchema.pb","MAWArmadilloXMATableSchema.pb","MAWMsgType","MAWXMACTAUtil","WASyncdKeyTypes","encodeProtobuf"],(function(t,n,r,o,a,i,l){"use strict";var e=["ack","altIndex","collapsibleId","externalId","messageDeleteTs","messageExpirationTs","msgId","pollStanzaId","protocolMsgId","quoteExpirationTs","quoteExternalId","revokedExternalId","rowId","serverTs","sortOrderMs","threadJid","unsendMsgContentDeleteTs"],s=["author","chat","externalId","rowId"],u={appData:k,appMeta:I,chunk:T,deletedMessages:_,deviceChangeAlerts:c,dualSendMedia:d,dyiBatch:P,ebMessageRestoreTasks:d,ebMsgRanges:N,ebRestoreQueue:d,ebUploadQueue:d,editMsgHistory:w,encryptionMetaV3:d,ephemeralSettings:d,existingUsers:d,ftsBackloggedMessages:d,ftsEncryptionMeta:d,ftsIndexV3:d,ftsPurgeBacklog:d,ftsPurgeThreadBacklog:d,groupInfo:g,groupInvites:R,historySyncQRCodeData:d,historySyncQRCodeSecretKey:d,igMessageAuxiliaryInfo:d,isDualSend:d,media:x,mediaBackup:D,mediaKeys:d,messages:p,participants:S,pendingMessageStanzaQueue:d,pendingReceipts:b,pendingStanzas:d,personalSenderKeyStatuses:E,poll:F,reactions:$,receipts:C,receiverFetchInfo:A,sentBytesCache:d,staleQueue:d,tasks:L,threads:v,unrenderedMessages:f,xma:M};function c(e){var t={action:e.action,deviceJid:e.deviceJid,identity:e.identity,isArchived:e.isArchived,latitude:e.latitude,location:e.location,loggedOut:e.loggedOut,longitude:e.longitude,model:e.model,platform:e.platform,ts:e.ts};return{encodedFields:t,proto:o("encodeProtobuf").encodeProtobuf(o("MAWArmadilloDeviceChangeAlertsTableSchema.pb").DeviceChangeAlertsTableSchemaProtoSpec,t).readByteArrayView()}}function d(e){throw r("FBLogger")("messenger_web").mustfixThrow("unexpected table for encryption")}function m(e,t){var n=null;if(Object.prototype.hasOwnProperty.call(u,t))n=u[t](e);else throw r("FBLogger")("messenger_web").mustfixThrow("not a valid table name");return n}function p(t){var n=t.ack,r=t.altIndex,a=t.collapsibleId,i=t.externalId,l=t.messageDeleteTs,s=t.messageExpirationTs,u=t.msgId,c=t.pollStanzaId,d=t.protocolMsgId,m=t.quoteExpirationTs,p=t.quoteExternalId,_=t.revokedExternalId,f=t.rowId,g=t.serverTs,h=t.sortOrderMs,y=t.threadJid,C=t.unsendMsgContentDeleteTs,b=babelHelpers.objectWithoutPropertiesLoose(t,e),v=b,S;if(v.quote==null)S=v.quote;else{var R,L={author:v.quote.content.author,expirationTs:v.quote.content.expirationTs,externalId:(R=v.quote)==null?void 0:R.content.externalId,mediaId:v.quote.content.mediaId,msgContent:v.quote.content.msgContent,msgId:v.quote.content.msgId,plaintextHash:v.quote.content.plaintextHash,sourceId:v.quote.content.sourceId,specialTextSize:v.quote.content.specialTextSize,ts:v.quote.content.ts,type:v.quote.content.type,xmaMessageType:v.quote.content.xmaMessageType},E={content:L,remoteJid:v.quote.remoteJid};S=E}var k=v.msgContent;v.type===o("MAWMsgType").MSG_TYPE.FUTUREPROOF&&(k={protobuf:v.msgContent.protobuf,subtype:v.msgContent.subtype});var I=v.ravenEphemeralType,T=v.ravenEphemeralMediaState,D=I!=null?I:null,x=T!=null?T:null,$={applicationErrorCode:v.applicationErrorCode,author:v.author,editCount:v.editCount,ephemeralCounterStarted:v.ephemeralCounterStarted,ephemeralMsgDisappeared:v.ephemeralMsgDisappeared,ephemeralSetting:v.ephemeralSetting,forwardingScore:v.forwardingScore,groupId:v.groupId,groupIndex:v.groupIndex,groupSize:v.groupSize,hdType:v.hdType,isCollapsed:v.isCollapsed,isExpiredXmaMsg:v.isExpiredXmaMsg,isForwarded:v.isForwarded,mediaId:v.mediaId,msgContent:k,originalTs:v.originalTs,quote:S,ravenEphemeralMediaState:x,ravenEphemeralType:D,receiverFetchId:v.receiverFetchId,reportingMeta:v.reportingMeta,resendCount:v.resendCount,source:v.source,specialTextSize:v.specialTextSize,ts:v.ts,type:v.type,xmaMessageType:v.xmaMessageType};return{encodedFields:$,proto:o("encodeProtobuf").encodeProtobuf(o("MAWArmadilloMessagesTableSchema.pb").MessagesTableSchemaProtoSpec,$).readByteArrayView()}}function _(e){var t=e.author,n=e.chat,r=e.externalId,a=e.rowId,i=babelHelpers.objectWithoutPropertiesLoose(e,s),l={reason:String(i.reason)};return{encodedFields:l,proto:o("encodeProtobuf").encodeProtobuf(o("MAWArmadilloDeletedMessagesTableSchema.pb").DeletedMessagesTableSchemaProtoSpec,l).readByteArrayView()}}function f(e){var t;if(e.quote==null)t=e.quote;else{var n,r={author:e.quote.content.author,expirationTs:e.quote.content.expirationTs,externalId:(n=e.quote)==null?void 0:n.content.externalId,mediaId:e.quote.content.mediaId,msgContent:e.quote.content.msgContent,msgId:e.quote.content.msgId,plaintextHash:e.quote.content.plaintextHash,sourceId:e.quote.content.sourceId,ts:e.quote.content.ts,type:e.quote.content.type,xmaMessageType:e.quote.content.xmaMessageType},a={content:r,remoteJid:e.quote.remoteJid};t=a}var i={ack:e.ack,author:e.author,ephemeralSetting:e.ephemeralSetting,groupName:e.groupName,invitedParticipantUserJid:e.invitedParticipantUserJid,mediaId:e.mediaId,msgContent:e.msgContent,quote:t,reportingMeta:e.reportingMeta,resendCount:e.resendCount,ts:e.ts,type:e.type,xmaMessageType:e.xmaMessageType};return{encodedFields:i,proto:o("encodeProtobuf").encodeProtobuf(o("MAWArmadilloUnrenderedMessagesTableSchema.pb").UnrenderedMessagesTableSchemaProtoSpec,i).readByteArrayView()}}function g(e){var t={creationTs:e.creationTs,creator:e.creator,inviter:e.inviter,memberAddMode:e.memberAddMode,msgExpiration:e.msgExpiration,name:e.name,nameOwner:e.nameOwner,nameTs:e.nameTs,participantVersion:e.participantVersion};return{encodedFields:t,proto:o("encodeProtobuf").encodeProtobuf(o("MAWArmadilloGroupInfoTableSchema.pb").GroupInfoSchemaProtoSpec,t).readByteArrayView()}}function h(e){return e==null?e:Array.from(e,function(e){var t=e[0],n=e[1];return{baseKey:n.baseKey,deviceJid:t,serializedPubKey:n.pubKey}})}function y(e){return e==null?null:Array.from(e,function(e){var t=e[0],n=e[1];return{count:n,deviceJid:t}})}function C(e){var t=Array.from(e.recipientDevices),n={permittedIdentitiesPerDevice:h(e.permittedIdentitiesPerDevice),recipientDevices:t,retryCountsPerDevice:y(e.retryCountsPerDevice)};return{encodedFields:n,proto:o("encodeProtobuf").encodeProtobuf(o("MAWArmadilloReceiptTablesSchema.pb").ReceiptsTableSchemaProtoSpec,n).readByteArrayView()}}function b(e){var t={author:e.author,deliveryReceipts:e.deliveryReceipts,externalId:e.externalId,readReceipts:e.readReceipts,thread:e.thread};return{encodedFields:t,proto:o("encodeProtobuf").encodeProtobuf(o("MAWArmadilloReceiptTablesSchema.pb").PendingReceiptsTableSchemaProtoSpec,t).readByteArrayView()}}function v(e){var t={archived:e.archived,cannotReplyReason:e.cannotReplyReason,didInsertDualThreadCutoverAdminMsg:e.didInsertDualThreadCutoverAdminMsg,folder:e.folder,isMigratedLocally:e.isMigratedLocally,lastReadMsg:e.lastReadMsg,lastReadMsgReceiptSent:e.lastReadMsgReceiptSent,newestMsgTs:e.newestMsgTs,oldestMsg:e.oldestMsg,optimisticThreadKey:e.optimisticThreadKey,snippetMsg:e.snippetMsg,snippetMsgTs:e.snippetMsgTs};return{encodedFields:t,proto:o("encodeProtobuf").encodeProtobuf(o("MAWArmadilloThreadsTableSchema.pb").ThreadsTableSchemaProtoSpec,t).readByteArrayView()}}function S(e){var t={addressable:e.addressable,deliveredWatermarkTs:e.deliveredWatermarkTs,lastReadActionTs:e.lastReadActionTs,lastReadWatermarkTs:e.lastReadWatermarkTs,type:e.type};return{encodedFields:t,proto:o("encodeProtobuf").encodeProtobuf(o("MAWArmadilloParticipantsTableSchema.pb").ParticipantsTableSchemaProtoSpec,t).readByteArrayView()}}function R(e){var t={caption:e.caption,inviteCode:e.inviteCode,inviteExpirationTs:e.inviteExpirationTs};return{encodedFields:t,proto:o("encodeProtobuf").encodeProtobuf(o("MAWArmadilloGroupInvitesTableSchema.pb").GroupInvitesTableSchemaProtoSpec,t).readByteArrayView()}}function L(e){var t={scheduledTime:e.scheduledTime};return{encodedFields:t,proto:o("encodeProtobuf").encodeProtobuf(o("MAWArmadilloTasksTableSchema.pb").TasksTableSchemaProtoSpec,t).readByteArrayView()}}function E(e){var t=Array.from(e.hasSenderKey),n={hasSenderKey:t,rotateSenderKey:e.rotateSenderKey,senderKeyId:e.senderKeyId,senderKeyTs:e.senderKeyTs};return{encodedFields:n,proto:o("encodeProtobuf").encodeProtobuf(o("MAWArmadilloPersonalSenderKeyStatusTableSchema.pb").PersonalSenderKeyStatusTableSchemaProtoSpec,n).readByteArrayView()}}function k(e){var t;switch(e.contents.type){case"meta_sync":{var n=[];for(var a of e.contents.actions)a.chatAction?n.push({chatAction:a.chatAction}):a.messageAction&&n.push({messageAction:a.messageAction});t={actions:n,type:"meta_sync"};break}case"backups_secrets":{t={encryptedBackupsSecrets:e.contents.encryptedBackupsSecrets,type:"backups_secrets"};break}case"sync_key_share":{var i;t={syncKeyShare:{keys:e.contents.syncKeyShare.keys,orphanKeys:(i=e.contents.syncKeyShare)==null||(i=i.orphanKeys)==null?void 0:i.map(o("WASyncdKeyTypes").fromSyncKeyId)},type:"sync_key_share"};break}case"sync_key_request":{t={syncKeyRequest:{keyIds:e.contents.syncKeyRequest.keyIds.map(o("WASyncdKeyTypes").fromSyncKeyId)},type:"sync_key_request"};break}default:throw e.contents.type,r("FBLogger")("messenger_web").mustfixThrow("Unknown appdata type: "+e.contents.type)}var l={ack:e.ack,contents:t,permittedIdentitiesPerDevice:h(e.permittedIdentitiesPerDevice),recipientDevices:Array.from(e.recipientDevices),sendPartial:e.sendPartial,ts:e.ts};return{encodedFields:l,proto:o("encodeProtobuf").encodeProtobuf(o("MAWArmadilloAppDataTableSchema.pb").AppDataTableSchemaProtoSpec,l).readByteArrayView()}}function I(e){var t={value:e.value};return{encodedFields:t,proto:o("encodeProtobuf").encodeProtobuf(o("MAWArmadilloAppMetaTableSchema.pb").AppMetaTableSchemaProtoSpec,t).readByteArrayView()}}function T(e){var t={blobData:e.blobData,mimetype:e.mimetype,plaintextHash:e.plaintextHash};return{encodedFields:t,proto:o("encodeProtobuf").encodeProtobuf(o("MAWArmadilloMediaTablesSchema.pb").ChunkTableSchemaProtoSpec,t).readByteArrayView()}}function D(e){var t={fbid:e.fbid};return{encodedFields:t,proto:o("encodeProtobuf").encodeProtobuf(o("MAWArmadilloMediaTablesSchema.pb").MediaBackupSchemaProtoSpec,t).readByteArrayView()}}function x(e){var t=Array.from(e.mediaEntries,function(e){var t=e[0],n=e[1];return{mediaEntryData:n,msgId:t}}),n={accessibilitySummaryText:e.accessibilitySummaryText,isVideoGif:e.isVideoGif,mediaEntries:t,mediaType:e.mediaType,plaintextHash:e.plaintextHash,size:e.size,ts:e.ts,validatedAudioInfo:e.validatedAudioInfo,validatedDocumentFileInfo:e.validatedDocumentFileInfo,validatedImageInfo:e.validatedImageInfo,validatedResult:e.validatedResult,validatedVideoInfo:e.validatedVideoInfo};return{encodedFields:n,proto:o("encodeProtobuf").encodeProtobuf(o("MAWArmadilloMediaTablesSchema.pb").MediaTableSchemaProtoSpec,n).readByteArrayView()}}function $(e){var t={ack:e.ack,author:e.author,groupingKey:e.groupingKey,reaction:e.reaction,reactToAuthor:e.reactToAuthor,senderTimestampMs:e.senderTimestampMs};return{encodedFields:t,proto:o("encodeProtobuf").encodeProtobuf(o("MAWArmadilloReactionsTableSchema.pb").ReactionsTableSchemaProtoSpec,t).readByteArrayView()}}function P(e){var t={isThread:e.isThread,numMessages:e.numMessages,numMessagesRestored:e.numMessagesRestored,numThreadsRestored:e.numThreadsRestored,oldestTs:e.oldestTs,qplFlowDescriptor:e.qplFlowDescriptor,qplInstanceKeyE2E:e.qplInstanceKeyE2E,qplInstanceKeyForThread:e.qplInstanceKeyForThread,threadId:e.threadId};return{encodedFields:t,proto:o("encodeProtobuf").encodeProtobuf(o("MAWArmadilloDyiBatchTableSchema.pb").DyiBatchTableSchemaProtoSpec,t).readByteArrayView()}}function N(e){var t={creationTime:e.creationTime,maxMsgExternalId:e.maxMsgExternalId,maxMsgSortOrderMs:e.maxMsgSortOrderMs,minMsgExternalId:e.minMsgExternalId,minMsgSortOrderMs:e.minMsgSortOrderMs};return{encodedFields:t,proto:o("encodeProtobuf").encodeProtobuf(o("MAWArmadilloEBMsgRangesTableSchema.pb").EBMsgRangesTableSchemaProtoSpec,t).readByteArrayView()}}function M(e){var t=e.ctas==null?[]:e.ctas.map(function(e){return o("MAWXMACTAUtil").toMAWCTAEncode(e)}),n={author:e.author,ctas:t,defaultCTA:e.defaultCTA==null?e.defaultCTA:o("MAWXMACTAUtil").toMAWCTAEncode(e.defaultCTA),defaultPreviewMediaPlaintextHash:e.defaultPreviewMediaPlaintextHash,faviconPlaintextHash:e.faviconPlaintextHash,headerMediaPlaintextHash:e.headerMediaPlaintextHash,headerTitle:e.headerTitle,isTombstoned:e.isTombstoned,maxSubtitleNumOfLines:e.maxSubtitleNumOfLines,maxTitleNumOfLines:e.maxTitleNumOfLines,msgId:e.msgId,overlayDescription:e.overlayDescription,overlayIconGlyph:e.overlayIconGlyph,overlayTitle:e.overlayTitle,previewMediaIds:e.previewMediaIds,subtitleText:e.subtitleText,targetId:e.targetId,targetType:e.targetType,targetUsername:e.targetUsername,threadJid:e.threadJid,titleText:e.titleText,xmaLayoutType:e.xmaLayoutType};return{encodedFields:n,proto:o("encodeProtobuf").encodeProtobuf(o("MAWArmadilloXMATableSchema.pb").XMATableSchemaProtoSpec,n).readByteArrayView()}}function w(e){var t={author:e.author,editExternalId:e.editExternalId,editTs:e.editTs,msgContent:e.msgContent,sendStatus:e.sendStatus,specialTextSize:e.specialTextSize};return{encodedFields:t,proto:o("encodeProtobuf").encodeProtobuf(o("MAWArmadilloEditMsgHistoryTableSchema.pb").EditMsgHistoryTableSchemaProtoSpec,t).readByteArrayView()}}function A(e){var t={accessibilitySummaryText:e.accessibilitySummaryText,mimetype:e.mimetype,previewHeight:e.previewHeight,previewUrl:e.previewUrl,previewUrlExpirationTimestampMs:e.previewUrlExpirationTimestampMs,previewWidth:e.previewWidth,type:e.type};return{encodedFields:t,proto:o("encodeProtobuf").encodeProtobuf(o("MAWArmadilloReceiverFetchInfoTableSchema.pb").ReceiverFetchInfoTableSchemaProtoSpec,t).readByteArrayView()}}function F(e){var t=Array.from(e.pollOptions,function(e){var t=e[0],n=e[1];return{pollOption:{optionText:n.optionText,voteAuthors:Array.from(n.voteAuthors)},pollOptionHash:t}}),n=Array.from(e.latestSenderTimestampsMs,function(e){var t=e[0],n=e[1];return{author:t,latestSenderTimestampMs:n}}),r={encKey:e.encKey,latestSenderTimestampsMs:n,pollAuthor:e.pollAuthor,pollOptions:t,pollParticipantCount:e.pollParticipantCount,pollState:e.pollState,selectableOptionsCount:e.selectableOptionsCount,title:e.title};return{encodedFields:r,proto:o("encodeProtobuf").encodeProtobuf(o("MAWArmadilloPollTableSchema.pb").PollTableSchemaProtoSpec,r).readByteArrayView()}}l.encodeDbObj=m,l.encodeDbPollForEncryption=F}),98);
__d("MAWMpsMigrationRunningState",[],(function(t,n,r,o,a,i){"use strict";var e=!1;function l(){return e}function s(t){e=t}i.isMawMpsMigrationRunning=l,i.setIsMawMpsMigrationRunning=s}),66);
__d("MAWDbObjEncryption",["ExecutionEnvironment","FBLogger","MAWBridge","MAWCryptoConsts","MAWDbEncryptObjContent","MAWDbObjDecode","MAWDbObjEncode","MAWDexieTable","MAWIndexedDb","MAWKeychainCrypto","MAWKeychainNaClCrypto","MAWKeychainUtil","MAWMpsMigrationRunningState","MAWQplProxy","MAWUnrecoverableDbErrors","MWEARKeychainV3","MWEARKeychainV3Errors","ODS","WABase64","WATimeUtils","getErrorSafe","gkx","isEncryptionAtRestEnabled","pageID","qpl"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u="_encryptedContent",c=new Set(["threads","messages","participants"]);function d(e,t,n){if(!(r("isEncryptionAtRestEnabled")()||r("gkx")("23910")===!0)||!o("MAWIndexedDb").TABLES_TO_ENCRYPT.includes(t))return e;var a=o("MAWQplProxy").startQplUserFlow(r("qpl")._(25300256,"115"),{bool:{isWorker:(s||(s=r("ExecutionEnvironment"))).isInWorker,useMawEar:o("MWEARKeychainV3").isKeychainSettled("maw_ear")},string:{pageID:r("pageID"),tableName:t}});try{var i=babelHelpers.extends({},e),l=n(o("MWEARKeychainV3").isKeychainSettled("maw_ear")?"maw_ear":"global_ear"),d=l.keys,m=d[0],p=l.version,_=l.randomisedVersion;o("MWEARKeychainV3").isKeychainSettled("maw_ear")===!1&&r("FBLogger")("messenger_web").mustfix("[EAR] Encrypting %s data with global ear. Transactor: %s",t,o("MAWDexieTable").getDexiePSDItem("transactorName")),a.addAnnotations({int:{keyVersion:p,randomisedVersion:_}});var f=o("MAWKeychainUtil").makeAAD(p,o("MAWCryptoConsts").CIPHER_ID),g=o("MAWDbObjEncode").encodeDbObj(e,t),h=g.encodedFields,y=g.proto;Object.keys(h).forEach(function(t){Object.prototype.hasOwnProperty.call(e,t)&&delete i[t]});var C=o("MAWDbEncryptObjContent").encryptContent(m,y,f);return i[u]=C,c.has(t)&&(i.updatedAt_S456130=Date.now(),i.randomisedVersion_S456130=_,i.encryptedWith_S456130=o("MWEARKeychainV3").isKeychainSettled("maw_ear")?"maw_ear":"global_ear",i.keyVersion_S456130=p),a==null||a.endSuccess(),i}catch(e){var b=r("getErrorSafe")(e);throw a==null||a.endFail("ear_encrypt_fail"),r("FBLogger")("messenger_web").catching(b).mustfixThrow("[%s] %s - Encrypted dexie was unable to encrypt an entity for table %s",b.name,b.message,t)}}function m(t,n,a){if(!o("MAWIndexedDb").TABLES_TO_ENCRYPT.includes(n)||!Object.prototype.hasOwnProperty.call(t,u))return t;var i=(s||(s=r("ExecutionEnvironment"))).isInMainThread?null:o("MAWQplProxy").startQplUserFlow(r("qpl")._(25313004,"118"));i==null||i.addAnnotations({bool:{isWorker:(s||(s=r("ExecutionEnvironment"))).isInWorker,useMawEar:o("MWEARKeychainV3").isKeychainSettled("maw_ear")},string:{pageID:r("pageID"),tableName:n}});var l;try{var d=t[u],m=babelHelpers.extends({},t);(e||(e=o("ODS"))).bumpEntityKey(3185,"maw_db_ear_decryption","encrypted_content_type."+n+"."+(d instanceof ArrayBuffer?"ArrayBuffer":"string"));var f=d instanceof ArrayBuffer?d:o("WABase64").decodeB64(d),g=o("MAWKeychainCrypto").getKeyVersionFromCipherDataString(f),h=g.aadLengthInBytes,y=g.keyVersion,C=a(o("MWEARKeychainV3").isKeychainSettled("maw_ear")?"maw_ear":"global_ear",y);l=C;var b=C.dbEntry,v=C.keys,S=C.randomisedVersion;i==null||i.addAnnotations({int:{contentVersion:t==null?void 0:t.keyVersion_S456130,keyVersion:y,randomisedVersion:S},string:{encryptedWith:t==null?void 0:t.encryptedWith_S456130,randomisedVersionEncryption:t==null?void 0:t.randomisedVersion_S456130}});var R={},L,E;for(var k of v)try{L=o("MAWKeychainNaClCrypto").decryptArrayBuffer(k,f,y,b.formatVersion,h);break}catch(e){E=e}if(L==null)throw r("getErrorSafe")(E);var I=o("MAWDbObjDecode").decodeDbObj(L,n);Object.keys(I).forEach(function(e){R[e]=I[e]}),delete m[u];var T=babelHelpers.extends({},m,R);return i==null||i.endSuccess(),T}catch(e){var D,x,$;if(c.has(n)){var P;i==null||i.addAnnotations({int:{updatedAt:(P=t==null?void 0:t.updatedAt_S456130)!=null?P:-1}})}if((e instanceof o("MAWKeychainNaClCrypto").EARDecryptionError||e instanceof o("MWEARKeychainV3Errors").EARKeychainNotFoundError)&&o("MAWMpsMigrationRunningState").isMawMpsMigrationRunning()){i==null||i.addAnnotations({bool:{earDecryptionErrorSuppressed:!0}}),r("FBLogger")("messenger_web").mustfix("[EAR] Ignoring EAR decryption error during MAW->MPS migration. Table: %s.",n);return}(s||(s=r("ExecutionEnvironment"))).isInWorker&&(e instanceof o("MAWKeychainNaClCrypto").EARDecryptionError||e instanceof o("MWEARKeychainV3Errors").EARKeychainNotFoundError)&&(r("FBLogger")("messenger_web").mustfix("[EAR] Encountered EAR Error - submitting unrecoverableDbError. Table: %s.",n),i==null||i.addAnnotations({bool:{unrecoverableDbError:!0}}),o("MAWBridge").getBridge().fireAndForget("event","unrecoverableDbError",{error:new(o("MAWUnrecoverableDbErrors")).EarRuntimeError}));var N=r("getErrorSafe")(e);throw i==null||i.markError("ear_decrypt_exception",null,N),i==null||i.endFail("ear_decrypt_fail"),r("FBLogger")("messenger_web").catching(N).mustfixThrow("[%s] %s - (v2) Encrypted dexie was unable to decrypt an entity for table %s. UpdatedAt: %s. KeyStatus: %s. Signature matches: %s. Key source: %s. Using MAW EAR: %s. Worker: %s. Encrypted With: %s. PageID: %s. Source: %s",N.name,N.message,n,p(t==null?void 0:t.updatedAt_S456130),_(t,l),(t==null?void 0:t.randomisedVersion_S456130)!=null&&((D=l)==null?void 0:D.randomisedVersion)!=null?t.randomisedVersion_S456130===l.randomisedVersion:null,(x=($=l)==null?void 0:$.dbEntry.source)!=null?x:"-1",o("MWEARKeychainV3").isKeychainSettled("maw_ear"),(s||(s=r("ExecutionEnvironment"))).isInWorker,t==null?void 0:t.encryptedWith_S456130,r("pageID"),o("MAWDexieTable").getDexiePSDItem("transactorName"))}}function p(e){if(e==null)return"unknown";var t=Date.now()-e,n=Math.floor(t/(1e3*60*60*24));return n<1?"0-1 days":n<7?"1-7 days":n<14?"7-14 days":n<30?"14-30 days":"30+ days"}function _(e,t){if((e==null?void 0:e.updatedAt_S456130)==null||t==null)return null;var n=o("WATimeUtils").castToUnixTime(e.updatedAt_S456130/1e3),r=t.dbEntry.expiration-o("MAWCryptoConsts").ENC_KEY_TTL;return n===r?"same":n>r?"key_older":"key_newer"}l.ENCRYPTED_COLUMN_NAME=u,l.encryptDbObj=d,l.decryptDbObj=m}),98);
__d("WorkerUtils",[],(function(t,n,r,o,a,i){"use strict";function e(){try{return"WorkerGlobalScope"in t&&t instanceof t.WorkerGlobalScope}catch(e){return!1}}function l(){try{return"SharedWorkerGlobalScope"in t&&t instanceof t.SharedWorkerGlobalScope}catch(e){return!1}}i.isWorkerContext=e,i.isSharedWorkerContext=l}),66);
__d("MAWEBCombinedSwitch",["MAWEBEnabledStateManager","MAWEBLSInWorkerSwitch","MAWEBSwitch","MAWODSProxy","WAOdsEnums"],(function(t,n,r,o,a,i,l){"use strict";var e=(function(e){function t(t,n){var r;return r=e.call(this)||this,r.$MAWCombinedStateManager$p_1=t,r.$MAWCombinedStateManager$p_2=n,r.$MAWCombinedStateManager$p_3=null,r.$MAWCombinedStateManager$p_4=!1,r.$MAWCombinedStateManager$p_1.onSet(function(){r.$MAWCombinedStateManager$p_5()}),r.$MAWCombinedStateManager$p_2.onSet(function(){r.$MAWCombinedStateManager$p_5()}),r.$MAWCombinedStateManager$p_5(),r}babelHelpers.inheritsLoose(t,e);var n=t.prototype;return n.isEnabled=function(){var t=e.prototype.isEnabled.call(this);return this.$MAWCombinedStateManager$p_6(),t},n.$MAWCombinedStateManager$p_6=function(){var e=this.$MAWCombinedStateManager$p_1.isEnabled(),t=this.$MAWCombinedStateManager$p_2.isEnabled(),n=e!==t,r=e?"enabled":"disabled",a=t?"enabled":"disabled",i=n?"mismatch":"match";if(n&&!this.$MAWCombinedStateManager$p_4)this.$MAWCombinedStateManager$p_3=Date.now(),this.$MAWCombinedStateManager$p_4=!0;else if(this.$MAWCombinedStateManager$p_4&&this.$MAWCombinedStateManager$p_3!=null){var l=this.$MAWCombinedStateManager$p_3,s=Date.now()-l;this.$MAWCombinedStateManager$p_4=n,this.$MAWCombinedStateManager$p_3=n?Date.now():null;var u=this.$MAWCombinedStateManager$p_7(s);o("MAWODSProxy").odsBumpEntityKey({entity:o("WAOdsEnums").Entity.EB_SWITCH_STATE,key:"eb_switch.sync.duration_bucket."+u});var c=n?"failed":"success";o("MAWODSProxy").odsBumpEntityKey({entity:o("WAOdsEnums").Entity.EB_SWITCH_STATE,key:"eb_switch.sync.result."+c})}o("MAWODSProxy").odsBumpEntityKey({entity:o("WAOdsEnums").Entity.EB_SWITCH_STATE,key:"eb_switch."+i+"."+r+"."+a})},n.$MAWCombinedStateManager$p_7=function(t){return t<100?"under_100ms":t<500?"100_to_500ms":t<1e3?"500ms_to_1s":t<5e3?"1s_to_5s":t<1e4?"5s_to_10s":"over_10s"},n.$MAWCombinedStateManager$p_5=function(){this.set(this.$MAWCombinedStateManager$p_1.isEnabled()&&this.$MAWCombinedStateManager$p_2.isEnabled()),this.$MAWCombinedStateManager$p_6()},t})(o("MAWEBEnabledStateManager").MAWEBEnabledStateManager),s=new e(r("MAWEBSwitch"),r("MAWEBLSInWorkerSwitch"));l.MAWCombinedStateManager=e,l.MAWEBCombinedSwitch=s}),98);
__d("LFUCache",["Cache","ExecutionEnvironment"],(function(t,n,r,o,a,i,l){"use strict";var e,s=15,u=1,c=6e4,d=(function(t){function n(n,o){var a;return a=t.call(this)||this,a.$LFUCache2=n&&n>0?n:s,a.$LFUCache3=o&&o>0?o:u,((e||(e=r("ExecutionEnvironment"))).canUseDOM||(e||(e=r("ExecutionEnvironment"))).isInWorker)&&a.$LFUCache4(),a}babelHelpers.inheritsLoose(n,t);var o=n.prototype;return o.$LFUCache4=function(){clearTimeout(this.$LFUCache1),this.$LFUCache1=setTimeout(this.purge.bind(this),this.$LFUCache2*c)},o.destroy=function(){clearTimeout(this.$LFUCache1)},o.get=function(n,r){return this.has(n)&&this.$LFUCache5(n),t.prototype.get.call(this,n,r)},o.set=function(n,r,o,a){var e=this.has(n),i=t.prototype.set.call(this,n,r,o,a);return i&&(e?this.$LFUCache5(n):this.$LFUCache6(n,this.$LFUCache3)),i},o.purge=function(){var e=this,t=Array.from(this.__keys());t.forEach(function(t){e.$LFUCache7(t)<e.$LFUCache3?e.delete(t):e.$LFUCache6(t,0)}),this.$LFUCache4()},o.$LFUCache5=function(t){var e=this.$LFUCache7(t)+1;return this.$LFUCache6(t,e),e},o.$LFUCache7=function(t){var e=this.__getRaw(t);return e&&e.$LFUCache8?e.$LFUCache8:0},o.$LFUCache6=function(t,n){var e=this.__getRaw(t);return e||(e=this.__getNewRawObject()),e.$LFUCache8=n,this.__setRaw(t,e),!0},n})(r("Cache"));l.default=d}),98);
__d("memoizeWithArgsLFUCache",["LFUCache"],(function(t,n,r,o,a,i,l){function e(e,t,n,o){var a;function i(){return a||(a=new(r("LFUCache"))(n)),a}function l(e){if(e===void 0)a=null;else{var t;(t=a)==null||t.delete(e)}}o&&o(l);var s=function(){var n=i(),r=t.apply(void 0,arguments);n.has(r)||n.set(r,e.apply(void 0,arguments));var o=n.get(r);return o};return s}l.default=e}),98);
__d("MAWMpsXMAValidationPreprocessor",["ACTSanitizerApiLazyLoader","ACTSanitizerApiTypes","FBLogger","MAWParseXMAFBConfig","MAWParseXMAProtocol","MAWProtobufDeserializers","MpsPreprocessor","Promise","WAResultOrError","asyncToGeneratorRuntime","err","getErrorSafe","getMediaTypeFromConsumerMessage"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(e){if(e.payload!=null){var t=new(o("MAWProtobufDeserializers")).DeserializedMessageApplication(e.payload),n=t.subProtocol();if((n==null?void 0:n.kind)==="consumerApplication")return n.proto}}function u(){var e=null;return(function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){try{if(e==null){var n=yield o("ACTSanitizerApiLazyLoader").loadACTSanitizerApi();e=n.isXMAValid}var a=e,i=a(t);if(i!==o("ACTSanitizerApiTypes").ACTSanitizerValidationResult.Valid)throw r("FBLogger")("mps").mustfixThrow("XMA validation failed - extendedContentMessage does not have valid XMA content");var l=t.associatedMessage,u=t.sentWithMessageId,c=t.targetType,d=t.xmaDataclass;if(c==null||!o("MAWParseXMAFBConfig").isFBSupportedTargetType({fbTargetType:c,xmaDataclass:d}))return r("FBLogger")("mps").warn("XMA Validation - found futureproof message"),o("WAResultOrError").makeResult();if(l!=null&&u==null)throw r("FBLogger")("mps").mustfixThrow("XMA validation failed - XMA associatedMessage cannot be received without sentWithMessageId field");if(l!=null){var m=s(l);if(o("getMediaTypeFromConsumerMessage").getMediaTypeFromConsumerMessage(m)!=null&&!o("MAWParseXMAProtocol").SUPPORTED_XMA_ASSOC_MEDIA_TARGET_TYPES.has(c))throw r("FBLogger")("mps").mustfixThrow("XMA validation failed - XMA associated msg has unsupported media type")}return o("WAResultOrError").makeResult()}catch(e){var p=r("getErrorSafe")(e);return r("FBLogger")("mps").catching(r("getErrorSafe")(p)).mustfix("XMA Validation failed for message"),o("WAResultOrError").DEPRECATED_makeError("runtime-error",p)}});return function(e){return t.apply(this,arguments)}})()}var c=o("MpsPreprocessor").preprocessor((function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var a=t.ctx,i=t.payloadList,l=new Map,s=new Array(i.length),c=u(),d=i.map(function(e,t){var n,a=(n=o("MAWProtobufDeserializers").DeserializedBackupMessage.create(e.message.payload).encryptedTransportMessage())==null||(n=n.armadillo())==null||(n=n.payload)==null||(n=n.content)==null?void 0:n.extendedContentMessage;if(a==null){s[t]=e;return}return c(a).then(function(n){if(n.success)s[t]=e;else{var o;l.set(e.message.messageId,(o=n.payload)!=null?o:r("err")("XMA validation failed for message - runtime error"))}})}).filter(Boolean);return d.length>0&&(yield(e||(e=n("Promise"))).all(d)),{ctx:a,errors:l,payloadList:s.filter(Boolean)}});return function(e){return t.apply(this,arguments)}})(),"xma_validator");l.xmaValidator=u,l.MAWMpsXMAValidationPreprocessor=c}),98);
__d("XFBLSRestoreOperationType.facebook",["$InternalEnum"],(function(t,n,r,o,a,i){var e=n("$InternalEnum").Mirrored(["DELTA_GENERIC_MESSAGE_SYNC","INITIAL_RESTORE","MESSAGE_QUERY_RESTORE","POINT_QUERY_RESTORE","RANGE_QUERY_RESTORE","SNAPSHOT_RESTORE","SURROUNDING_RESTORE","THREAD_POINT_QUERY_RESTORE","UNKNOWN"]),l=e;i.default=l}),66);
__d("handleRestoreMessagesGraphQLResponse_XFBEncryptedBackupMessages.graphql",[],(function(t,n,r,o,a,i){"use strict";var e=(function(){var e={alias:null,args:null,kind:"ScalarField",name:"encryption_version",storageKey:null},t={alias:null,args:null,kind:"ScalarField",name:"epoch_anon_id",storageKey:null},n={alias:null,args:null,kind:"ScalarField",name:"epoch_id",storageKey:null},r={alias:null,args:null,kind:"ScalarField",name:"encrypted_protobuf_stanza",storageKey:null},o={alias:null,args:null,kind:"ScalarField",name:"protobuf_timestamp_ms",storageKey:null},a={alias:null,args:null,kind:"ScalarField",name:"sk_ciphertext",storageKey:null},i={alias:null,args:null,kind:"ScalarField",name:"supplemental_key",storageKey:null},l={alias:null,args:null,kind:"ScalarField",name:"supplemental_otid",storageKey:null},s={alias:null,args:null,kind:"ScalarField",name:"actor_token",storageKey:null},u={alias:null,args:null,kind:"ScalarField",name:"encrypted_protobuf",storageKey:null},c={alias:null,args:null,kind:"ScalarField",name:"mek_fbid",storageKey:null},d={alias:null,args:null,kind:"ScalarField",name:"mek_id",storageKey:null},m={alias:null,args:null,kind:"ScalarField",name:"protobuf_timestamp",storageKey:null},p={alias:null,args:null,kind:"ScalarField",name:"transport_sender_signing_pk",storageKey:null},_={alias:null,args:null,kind:"ScalarField",name:"transport_sender_message_signature",storageKey:null},f={alias:null,args:null,kind:"ScalarField",name:"franking_tag",storageKey:null},g={alias:null,args:null,kind:"ScalarField",name:"reporting_tag",storageKey:null},h={alias:null,args:null,kind:"ScalarField",name:"message_encryption_version",storageKey:null},y={alias:null,args:null,kind:"ScalarField",name:"message_metadata_version",storageKey:null},C=[t,n];return{argumentDefinitions:[{defaultValue:!1,kind:"LocalArgument",name:"minos_gk_enabled"}],kind:"Fragment",metadata:null,name:"handleRestoreMessagesGraphQLResponse_XFBEncryptedBackupMessages",selections:[{alias:null,args:null,concreteType:"XFBEncryptedBackupMessage",kind:"LinkedField",name:"encrypted_messages",plural:!0,selections:[{alias:null,args:null,concreteType:"XFBEchoDocument",kind:"LinkedField",name:"echo_document",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"echo_document_string",storageKey:null},e,t,n,{alias:null,args:null,kind:"ScalarField",name:"epoch_fingerprint",storageKey:null}],storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"otid",storageKey:null},{alias:null,args:null,concreteType:"XFBProtobufStanzas",kind:"LinkedField",name:"protobuf_stanzas",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"message_tags",storageKey:null},{alias:null,args:null,concreteType:"XFBProtobufStanza",kind:"LinkedField",name:"top_level_protobuf",plural:!1,selections:[r,e,t,n,o,a],storageKey:null},{alias:null,args:null,concreteType:"XFBProtobufStanza",kind:"LinkedField",name:"supplemental_protobufs",plural:!0,selections:[r,e,t,n,o,a,i,l],storageKey:null},{alias:null,args:null,concreteType:"XFBUnencryptedProtobufStanza",kind:"LinkedField",name:"top_level_protobuf_unencrypted",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"unencrypted_protobuf",storageKey:null},o],storageKey:null},{condition:"minos_gk_enabled",kind:"Condition",passingValue:!0,selections:[{alias:null,args:null,concreteType:"XFBMinosProtobufStanza",kind:"LinkedField",name:"top_level_protobuf_v2",plural:!1,selections:[s,u,c,d,m,p,_,f,g,h,y],storageKey:null},{alias:null,args:null,concreteType:"XFBMinosProtobufStanza",kind:"LinkedField",name:"supplemental_protobufs_v2",plural:!0,selections:[s,u,m,c,d,i,l,p,_,f,g,h,y],storageKey:null}]}],storageKey:null}],storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"backup_id",storageKey:null},{alias:null,args:null,concreteType:"XFBMessageRangeInfo",kind:"LinkedField",name:"message_range_info",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"has_more_before",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"has_more_after",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"next_message_timestamp_ms_before",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"next_message_timestamp_ms_after",storageKey:null}],storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"should_delete_mailbox",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"exception_string",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"thread_not_found",storageKey:null},{alias:null,args:null,concreteType:"XFBEpochDerivationSet",kind:"LinkedField",name:"epoch_derivation_set",plural:!1,selections:[{alias:null,args:null,concreteType:"XFBEncryptedBackupsEpochEdge",kind:"LinkedField",name:"epoch_edges",plural:!0,selections:[{alias:null,args:null,kind:"ScalarField",name:"backward_edge",storageKey:null},{alias:null,args:null,concreteType:"XFBEpochForwardEdge",kind:"LinkedField",name:"forward_edge",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"auth_public_key",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"encrypted_entropy",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"entropy_fingerprint",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"epoch_storage_public_key",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"psk_fingerprint",storageKey:null}],storageKey:null},{alias:null,args:null,concreteType:"XFBEpochIds",kind:"LinkedField",name:"from_epoch",plural:!1,selections:C,storageKey:null},{alias:null,args:null,concreteType:"XFBEpochIds",kind:"LinkedField",name:"to_epoch",plural:!1,selections:C,storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"from_epoch_fingerprint",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"to_epoch_fingerprint",storageKey:null}],storageKey:null}],storageKey:null},{condition:"minos_gk_enabled",kind:"Condition",passingValue:!0,selections:[{alias:null,args:null,concreteType:"XFBMinosDecryptionKeyMap",kind:"LinkedField",name:"minos_decryption_keys",plural:!0,selections:[{alias:null,args:null,kind:"ScalarField",name:"id",storageKey:null},{alias:null,args:null,concreteType:"XFBMinosDecryptionKeys",kind:"LinkedField",name:"keys",plural:!1,selections:[{alias:null,args:null,concreteType:"XFBMinosMekInfo",kind:"LinkedField",name:"mek_info",plural:!1,selections:[d,{alias:null,args:null,kind:"ScalarField",name:"roster_hash",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"encrypted_mek",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"mek_creation_timestamp",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"mek_encryption_version",storageKey:null}],storageKey:null},{alias:null,args:null,concreteType:"XFBMinosRecipientInfo",kind:"LinkedField",name:"recipient_info",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"epoch_fbid",storageKey:null},t,{alias:null,args:null,kind:"ScalarField",name:"epoch_head",storageKey:null}],storageKey:null},{alias:null,args:null,concreteType:"XFBMekCreatorInfo",kind:"LinkedField",name:"mek_creator_info",plural:!1,selections:[{alias:null,args:null,concreteType:"XFBMinosEncryptionKeys",kind:"LinkedField",name:"minos_keys",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"sender_auth_pk",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"sender_epoch_head",storageKey:null}],storageKey:null},{alias:null,args:null,concreteType:"XFBMinosTransportKeys",kind:"LinkedField",name:"transport_keys",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"ephm_hpke_pk",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"ephm_signature",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"mek_creator_transport_signing_pk",storageKey:null}],storageKey:null}],storageKey:null}],storageKey:null}],storageKey:null}]}],type:"XFBEncryptedBackupMessages",abstractKey:null}})();a.exports=e}),null);
__d("handleRestoreMessagesGraphQLResponse",["EBMinosInterfaceTypes","I64","MEBEncryptionVersion","QPLUserFlow","WALogger","handleRestoreMessagesGraphQLResponse_XFBEncryptedBackupMessages.graphql"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d;function m(e){if(e==null)return r("MEBEncryptionVersion").UNKNOWN;switch(e){case"ENCRYPTION_KDF_WITH_NULL_SALT":return r("MEBEncryptionVersion").ENCRYPTION_KDF_WITH_NULL_SALT;case"ENCRYPTION_KDF_WITH_VERSION":return r("MEBEncryptionVersion").ENCRYPTION_KDF_WITH_VERSION;case"ENCRYPTION_KDF_WITH_NULL_SALT_DF_CANARY":return r("MEBEncryptionVersion").ENCRYPTION_KDF_WITH_NULL_SALT_DF_CANARY;case"TEST_VERSION":return r("MEBEncryptionVersion").TEST_VERSION;default:return r("MEBEncryptionVersion").UNKNOWN}}function p(e,t,n,a){var i,l=((i=e==null?void 0:e.map(function(e){var n,r,a,i,l,c,p,f,g;if(e==null)return o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] message is null in the GraphQL range restore response"]))),null;var h=e.otid;if(h==null)return o("WALogger").ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] otid is null for a message in the GraphQL range restore response"]))),null;var y=(n=e.echo_document)==null?void 0:n.echo_document_string,C=(r=e.echo_document)==null?void 0:r.epoch_anon_id,b=(a=e.echo_document)==null?void 0:a.epoch_fingerprint,v=e.protobuf_stanzas,S=v==null||(i=v.top_level_protobuf)==null?void 0:i.encrypted_protobuf_stanza,R=v==null||(l=v.top_level_protobuf)==null?void 0:l.epoch_anon_id,L=v==null||(c=v.top_level_protobuf)==null?void 0:c.epoch_id,E=v==null||(p=v.top_level_protobuf)==null?void 0:p.protobuf_timestamp_ms,k=v==null?void 0:v.supplemental_protobufs,I=v==null?void 0:v.message_tags,T=(f=e.protobuf_stanzas)==null?void 0:f.top_level_protobuf_v2,D=(g=e.protobuf_stanzas)==null?void 0:g.top_level_protobuf_unencrypted;if(D!=null&&D.unencrypted_protobuf!=null&&D.protobuf_timestamp_ms!=null){var x=D.unencrypted_protobuf,$=D.protobuf_timestamp_ms;return{message:{isUnencrypted:!0,messageTags:o("EBMinosInterfaceTypes").convertArrayToMpsMessageTags(I),otid:h,supplementalProtobufs:[],topLevelProtobuf:{backup_id:t,encryptedProtobufContent:x,encryption_version:void 0,epoch_anon_id:new ArrayBuffer(0),epoch_id:void 0,otid:h,protobufTimestampMs:$,value:void 0}},type:"protobuf"}}if(S==null||R==null||L==null||E==null){var P,N;if(y==null||C==null||y.length===0)return T==null&&_(S,R,L,E),null;var M=m((P=e.echo_document)==null?void 0:P.encryption_version);return{message:{backup_id:t,encryption_version:M,epoch_anon_id:new TextEncoder().encode(C).buffer,epoch_fingerprint:b!=null?new TextEncoder().encode(b).buffer:void 0,epoch_id:((N=e.echo_document)==null?void 0:N.epoch_id)!=null?(d||(d=o("I64"))).of_string(e.echo_document.epoch_id):void 0,otid:h,value:y},type:"echo"}}if(v!=null){var w,A=m(v==null||(w=v.top_level_protobuf)==null?void 0:w.encryption_version),F={messageTags:o("EBMinosInterfaceTypes").convertArrayToMpsMessageTags(I),otid:h,supplementalProtobufs:[],topLevelProtobuf:{backup_id:t,encryptedProtobufContent:S,encryption_version:A,epoch_anon_id:new TextEncoder().encode(R).buffer,epoch_id:(d||(d=o("I64"))).of_string(L),otid:h,protobufTimestampMs:E,value:void 0}};return k==null||k.forEach(function(e){var n=e==null?void 0:e.supplemental_key,r=e==null?void 0:e.encrypted_protobuf_stanza,a=e.epoch_anon_id,i=e==null?void 0:e.epoch_id,l=e==null?void 0:e.protobuf_timestamp_ms;if(!(r==null||a==null||i==null||l==null||n==null)){var s=m(e==null?void 0:e.encryption_version);F.supplementalProtobufs.push({backup_id:t,encryptedProtobufContent:r,encryption_version:s,epoch_anon_id:new TextEncoder().encode(a).buffer,epoch_id:(d||(d=o("I64"))).of_string(i),protobufTimestampMs:l,skCipherText:e==null?void 0:e.sk_ciphertext,supplementalKey:n,value:void 0})}}),{message:F,type:"protobuf"}}return null}))!=null?i:[]).filter(Boolean),c=l.filter(function(e){return e.type==="echo"}).map(function(e){return e.message}),p=l.filter(function(e){return e.type==="protobuf"}).map(function(e){return e.message});return a!=null&&n!=null&&r("QPLUserFlow").addPoint(n,"processing_encrypted_messages_complete",{instanceKey:a}),{encryptedNonLSEchoMessages:c,encryptedNonLSProtobufs:p}}function _(e,t,n,r){o("WALogger").ERROR(c||(c=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] message with no echo document and no protobuf data, more details: encrypted_protobuf_content: ",", protobuf_epoch_anon_id: ",", protobuf_epoch_id: ",", protobuf_timestamp_ms: ",""])),e==null?"null/empty":"not empty",t==null?"null/empty":"not empty",n==null?"null/empty":"not empty",r==null?"null/empty":"not empty")}e!==void 0||(e=n("handleRestoreMessagesGraphQLResponse_XFBEncryptedBackupMessages.graphql")),l.processMessageArray=p}),98);
__d("EBMessagePointQuery",["Base64Utils","EBAPIConvertNativeToLS","EBAPIDecryptionModule","EBAPIQPLPoints","EBAPISharedTypes","EBAPIWorkerCheck","EBDedupeEncryptedLabyrinthMessages","EBDedupeLabyrinthMessages","EBDeriveAndStoreEpochs","EBGetClientState","EBLS","EBMessagePointQuery.graphql","EBMinosCheckWasmFeatureSupport","EBMinosDecryptAndValidateMessages","EBMinosInterfaceTypes","EBgenerateMPSMessageQuery","FBLogger","I64","LSVec","MAWCurrentUser","MAWEncryptedBackupUtils","MAWHandleEBRestoreWithHIM","MAWJobDefinitions","MAWMpsXMAValidationPreprocessor","MpsTypes","Promise","QPLFlow","WAJids","WAResultOrError","WorkerRelay","WorkerRelayNetwork","asyncToGeneratorRuntime","getErrorSafe","gkx","handleRestoreMessagesGraphQLResponse","qpl"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c=e!==void 0?e:e=n("EBMessagePointQuery.graphql");function d(e){return m.apply(this,arguments)}function m(){return m=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=e.chatJid,a=e.messageIds,i=e.source,l=yield o("EBMinosCheckWasmFeatureSupport").checkWasmFeatureSupportAndGK(),d=o("QPLFlow").startQPLFlow(r("qpl")._(521474469,"2612"),{annotations:{bool:{is_wasm_serializer_on:r("gkx")("18428"),minos_rollout_enabled:l,occam_only_mailbox_users:r("gkx")("16674")},string:{source:i!=null?i:"unknown"}}});try{var m,_,f,g,h;if(!o("EBAPIWorkerCheck").runningInWorker())return d.endFail(o("EBAPIQPLPoints").EBAPIQPLCommonErrorPoints.UNSUPPORTED_CONTEXT),o("WAResultOrError").makeError("unsupported-context");var y=(yield o("EBLS").init()).db;d.addPoint(o("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.LSDB_SINGLETON_RETRIEVED);var C=yield o("EBGetClientState").getClientState(y);if(d.addPoint(o("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.CLIENT_STATE_RETRIEVED,{string:{device_id:(m=C==null?void 0:C.deviceId)!=null?m:(u||(u=o("I64"))).to_string((u||(u=o("I64"))).zero)}}),C==null)return d.endFail(o("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.NO_CLIENT_STATE,{string:{error_description:o("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.NO_CLIENT_STATE}}),o("WAResultOrError").makeError("no-client-state");var b=o("WAJids").threadIdForChatJid(t),v=C.backupId,S=C.deviceId,R=C.locally_available_epochs,L=C.mailboxRootKey,E=C.ocmfClientStateBlob;if(v==null||S==null||L==null||E==null)return d.endFail(o("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.INVALID_CLIENT_STATE,{string:{error_description:o("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.INVALID_CLIENT_STATE}}),o("WAResultOrError").makeError("invalid-client-state");var k=""+((_=o("MAWCurrentUser").getAppID())!=null?_:0),I={restore_context:{act_thread_id:b,site:"www",tam_thread_subtype:0},success:{device_context:{device_id:S,locally_available_epochs:R,raw_tokens:{mailbox_root_key:o("Base64Utils").fromArrayBuffer(L),ocmf_client_state_blob:o("Base64Utils").fromArrayBuffer(E)}},mps_message_query:o("EBgenerateMPSMessageQuery").generateMPSMessageQueryForGraphQLQuery(b,[].concat(a))}},T={app_id:k,minos_gk_enabled:l,restore_payload_string:JSON.stringify(I),restore_type:"MESSAGE_QUERY_RESTORE"};d.addPoint(o("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.CREATE_WORKER_NETWORK_EXECUTE_START),yield o("WorkerRelayNetwork").createWorkerNetworkExecute(),d.addPoint(o("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.CREATE_WORKER_NETWORK_EXECUTE_END),d.addPoint(o("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.GRAPHQL_QUERY_START);var D=yield o("WorkerRelay").createWorkerQuery(c,T);d.addPoint(o("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.GRAPHQL_QUERY_END);var x=D==null||(f=D.viewer)==null||(f=f.encrypted_backup)==null||(f=f.mailbox)==null?void 0:f.messages_point_restore;if(x==null)return d.endFail(o("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.INVALID_GRAPHQL_RESPONSE,{string:{error_description:o("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.INVALID_GRAPHQL_RESPONSE}}),o("WAResultOrError").makeError("invalid-graphql-response");var $=x;if(($==null?void 0:$.encrypted_messages)==null)return d.endFail(o("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.INVALID_GRAPHQL_RESPONSE,{string:{error_description:o("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.INVALID_GRAPHQL_RESPONSE}}),o("WAResultOrError").makeError("invalid-graphql-response");var P=$.backup_id,N=$.encrypted_messages,M=$.epoch_derivation_set,w=$.exception_string,A=$.minos_decryption_keys,F=p(N,d);if(d.addAnnotations({int:{encrypted_messages_with_content_count:F}}),w!=null)return d.endFail(o("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.SERVER_SIDE_EXCEPTION,{string:{error_description:o("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.SERVER_SIDE_EXCEPTION,exception:w}}),o("WAResultOrError").makeError("server-side-exception");P==null&&d.addPoint(o("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.BACKUP_ID_NULL),d.addPoint(o("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.DERIVE_AND_STORE_EPOCHS_START);var O=M;d.addAnnotations({bool:{hasEpochs:O!=null&&O.epoch_edges.length>0}}),yield o("EBDeriveAndStoreEpochs").deriveAndStoreEpochsNonLS(y,O),d.addPoint(o("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.DERIVE_AND_STORE_EPOCHS_END),d.addPoint("decryption_start");var B=N,W=l?o("EBMinosInterfaceTypes").processMinosMessages(B):[],q=l?yield o("EBMinosDecryptAndValidateMessages").minosDecryptAndValidateMessages({encryptedMinosMessages:W,entryPoint:"point_query",minosDecryptionKeys:A,qplFlow:d,source:i!=null?i:"unknown",threadId:o("MpsTypes").toThreadId(t),validator:r("gkx")("5782")?o("MAWMpsXMAValidationPreprocessor").xmaValidator():function(){return(s||(s=n("Promise"))).resolve(o("WAResultOrError").makeResult())}}):o("WAResultOrError").makeResult({decryptionResult:new Map,errorMessages:[]}),U=q.success===!0&&q.value.decryptionResult.size>0?q.value.decryptionResult:null,V=q.success===!0?q.value.errorMessages:[(g=q.error)!=null?g:"unknown-error"];d.addAnnotations({bool:{minos_decrypt_success:V.length===0},int:{minos_decrypted_messages_count:(h=U==null?void 0:U.size)!=null?h:0},string_array:{minos_decrypt_errors:V}});var H=U!=null&&l?o("EBDedupeEncryptedLabyrinthMessages").dedupeEncryptedLabyrinthMessages(B,U,d):B;d.addAnnotations({int:{deduped_encrypted_messages:p(H)}});var G=o("handleRestoreMessagesGraphQLResponse").processMessageArray(H,P!=null?o("EBMinosInterfaceTypes").unsafeCastToBackupFbid(P):v),z=G.encryptedNonLSEchoMessages,j=G.encryptedNonLSProtobufs;d.addPoint("native_decryption_start");var K=yield o("EBAPIDecryptionModule").decryptUsingNativeJS(y,b,j,z,i,"point_query");if(!K.success){var Q,X=K.error,Y=X.message,J=o("EBAPISharedTypes").EBAPIRestoreErrorValues.find(function(e){return e===Y});return d.endFail("decrypt_labyrinth10_messages_failure",{string:{error_description:X.message,errorStackTrace:(Q=X.stack)!=null?Q:""}}),J!=null?o("WAResultOrError").makeError(J):o("WAResultOrError").makeError("native-decryption-error")}d.addAnnotations({bool:{labyrinth_10_toplevel_decrypt_success:K.value.decryptedEchoMessages.length===z.length&&K.value.decryptedProtobufs.length===j.length}}),d.addPoint("native_decryption_end");var Z=K.value.decryptedEchoMessages,ee=K.value.decryptedProtobufs,te=l?o("EBDedupeLabyrinthMessages").dedupeLabyrinthMessages(ee,U):ee,ne=Z.length+te.length;d.addAnnotations({bool:{decrypted_count_equals_encrypted_count:F===ne},int:{decrypted_echo_count:Z.length,decrypted_messages_count:te.length+Z.length,decrypted_protobuf_count:te.length}}),d.addPoint("convert_native_to_decrypted_type_start");var re=o("EBAPIConvertNativeToLS").convertNativeDecryptionResponseToDecryptedMessageType(Z,te);d.addPoint("convert_native_to_decrypted_type_end");var oe=r("LSVec").toArray(re.echo),ae=re.protobuf,ie=oe.map(function(e){return o("MAWJobDefinitions").toEncodedEchoMessage(e)}),le=o("MAWHandleEBRestoreWithHIM").convertEchoMessagesToEBProtobufs(ie,t).concat(o("MAWEncryptedBackupUtils").convertLSTypesToJSTypesForRestoreJob(ae)),se=new Map(le.map(function(e){return[e.otid,e]})),ue=Array.from(se.values()),ce=a.reduce(function(e,t){return e+(se.get(t)==null?1:0)},0);return d.addAnnotations({int:{decrypted_message_result_count:ue.length,missing_message_count:ce}}),d.addPoint("decryption_end"),d.endSuccess(),o("WAResultOrError").makeResult(ue)}catch(e){var de,me=r("getErrorSafe")(e);return d.endFail(o("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.RUNTIME_ERROR,{string:{error_description:me.message,errorStackTrace:(de=me.stack)!=null?de:""}}),r("FBLogger")("wmi_eb").catching(me).mustfix("Runtime error performing messagePointQuery: %s",me.message),o("WAResultOrError").makeError("runtime-error")}}),m.apply(this,arguments)}function p(e,t){var n=0,r=!1,o=!1,a=!1,i=!1;for(var l of e){var s,u=l.protobuf_stanzas,c=(u==null?void 0:u.top_level_protobuf)!=null,d=(u==null?void 0:u.top_level_protobuf_unencrypted)!=null,m=(u==null?void 0:u.top_level_protobuf_v2)!=null,p=((s=l.echo_document)==null?void 0:s.echo_document_string)!=null;r=r||c,o=o||m,a=a||p,i=i||d,(c||d||m||p)&&(n+=1)}return t!=null&&t.addAnnotations({bool:{has_echo_document:a,has_lab1_messages:r,has_lab11_messages:o,has_unencrypted_protobuf:i}}),n}l.messagePointQuery=d}),98);
__d("EBProbe",["FBLogger","MAWODSProxy","Promise","WAOdsEnums","WAShiftTimer","WATimeUtils","asyncToGeneratorRuntime","err"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u=(function(){function t(e,t,n){this.$5=!1,this.$1=e,this.$2=t,this.$3=n}var a=t.prototype;return a.sample=function(t){var e=this.$1.sample(t);return e&&o("MAWODSProxy").odsBumpEntityKey({entity:o("WAOdsEnums").Entity.EB_MESSAGE_PROBE,key:"sampled"}),e},a.start=function(){var e=this;this.$4==null&&(this.$4=new(o("WAShiftTimer")).ShiftTimer(function(){e.$6()}),this.$4.onOrBefore(this.$3.validationIntervalMs,void 0))},a.stop=function(){this.$4!=null&&(this.$4.cancel(),this.$4=null)},a.hasStarted=function(){return this.$4!=null},a.$6=(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(){yield this.$7(),this.$4!=null&&this.$4.onOrBefore(this.$3.validationIntervalMs,void 0)});function t(){return e.apply(this,arguments)}return t})(),a.$7=(function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(){if(!this.$5){this.$5=!0;try{var t=o("WATimeUtils").castToMillisTime(Date.now()-this.$3.sampleAgeThresholdMs),n=this.$2.fetchOlderThan({consume:!0,cutOffTimestamp:t});if(n.length>0)try{o("MAWODSProxy").odsBumpEntityKey({amount:n.length,entity:o("WAOdsEnums").Entity.EB_MESSAGE_PROBE,key:"validated"}),yield this.validateSamples(n)}catch(t){var a=t instanceof Error?t:r("err")(String(t));r("FBLogger")("wmi_eb").catching(a).MUSTFIX(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Exception in validateSamples()"])))}}finally{this.$5=!1}}});function a(){return t.apply(this,arguments)}return a})(),a.addMarkerToItem=function(t,n,r){return!1},a.updateSample=function(t,n){var e=this.getSamplingDB();if(e==null)return!1;var r=e.getItemByPrimaryKey(t);return r==null?!1:(n(r),!0)},a.getConfig=function(){return this.$3},a.getSamplingDB=function(){return this.$2},a.validateSamples=function(t){return(s||(s=n("Promise"))).reject(r("err")("validateSamples() must be implemented by concrete probe classes"))},t})();l.EBProbe=u}),98);
__d("EBSampler",["Random"],(function(t,n,r,o,a,i,l){"use strict";var e=(function(){function e(e,t,n,r){this.$1=e,this.$2=t,this.$3=n,this.$4=r}var t=e.prototype;return t.sample=function(t){var e,n=this.$3(t),r=((e=this.$2.get(n))!=null?e:0)*this.$1,a=o("Random").random(),i=a<r;return i&&this.$4.append(t),i},t.setSamplingMultipler=function(t,n){this.$2.set(t,n)},t.setSamplingRate=function(t){this.$1=t},e})();l.EBSampler=e}),98);
__d("EBMinosDisableLabyrinth10Uploads",["gkx"],(function(t,n,r,o,a,i,l){"use strict";function e(){return r("gkx")("16675")}l.disableLabyrinth10Uploads=e}),98);
__d("MWEBODSUtils",["CurrentMessengerUser","MWEBODSCategory","ODS"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(t,n,a){var i=o("CurrentMessengerUser").getAppID(),l=i!=null?i.toString():"unknown",s=t+"."+l;(e||(e=o("ODS"))).bumpEntityKey(r("MWEBODSCategory"),s,n,a!=null?a:1),e.bumpEntityKey(r("MWEBODSCategory"),t,n,a!=null?a:1)}l.markODSForEB=s}),98);
__d("EncryptedBackupsUploadQueue",["EBMinosDisableLabyrinth10Uploads","EncryptedBackupsUploadEntity","MWEBODSEntityName.enum","MWEBODSUtils","PersistedQueueApi","Promise","QPLUserFlow","WAPersistedQueue","WATagsLogger","qpl"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c=o("WATagsLogger").TAGS(["EbUploadQueue"]),d=null;function m(){return d==null?p():d}function p(){d!=null&&c.ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["EB Upload Queue is already initialized"])));var t=o("WAPersistedQueue").initPersistedQueue("ebUploadQueue",o("PersistedQueueApi").persistedQueueApi());return d=t,t}function _(e){if(e.length===0||o("EBMinosDisableLabyrinth10Uploads").disableLabyrinth10Uploads())return(u||(u=n("Promise"))).resolve();o("MWEBODSUtils").markODSForEB(r("MWEBODSEntityName.enum").MAW_EB_UPLOAD_COUNTER,"upload.api.put",e.length);var t=m();return t.addAndCommit(e.map(o("EncryptedBackupsUploadEntity").asEBUploadEntity)).then(function(){e.forEach(function(e){(e==null?void 0:e.instanceKey)!=null&&r("QPLUserFlow").endSuccess(r("qpl")._(521477113,"2698"),{instanceKey:e.instanceKey})})}).catch(function(e){return c.ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Failed to write to ebUploadQueue ",""])),e),(u||(u=n("Promise"))).reject(e)})}l.logger=c,l.ebUploadQueue=m,l.initEbUploadQueue=p,l.putMsgsToEbUpload=_}),98);
__d("InMemorySamplingDB",[],(function(t,n,r,o,a,i){"use strict";var e=(function(){function e(e,t){this.$1=[],this.$4=new Map,this.$2=e,this.$3=t}var t=e.prototype;return t.append=function(t){var e=this.$3(t);this.$1.push([this.$2(t),t]),this.$4.set(e,t)},t.fetchOlderThan=function(t){var e=t.consume,n=e===void 0?!1:e,r=t.cutOffTimestamp,o=t.limit,a=o===void 0?50:o,i=[];if(a<=0)return i;var l=0,s=[];for(var u of this.$1){var c=u[0],d=u[1];if(c<=r&&(i.push(d),n===!0&&(l++,s.push(d))),i.length>=a)break}if(n===!0&&l>0){this.$1.splice(0,l);for(var m of s){var p=this.$3(m);this.$4.delete(p)}}return i},t.getItemByPrimaryKey=function(t){var e;return(e=this.$4.get(t))!=null?e:null},t.size=function(){return this.$1.length},t.pruneOlderThan=function(t){var e=[];this.$1=this.$1.filter(function(n){var r=n[0],o=n[1];return r<=t?(e.push(o),!1):!0});for(var n of e){var r=this.$3(n);this.$4.delete(r)}},t.purgeAll=function(){this.$1=[],this.$4.clear()},e})();i.InMemorySamplingDB=e}),66);
__d("EBMessageProbe",["EBDeps","EBGetClientState","EBMessagePointQuery","EBMessageProbeSamplingPreprocessor","EBProbe","EBSampler","EncryptedBackupsUploadQueue","EncryptedBackupsUploadQueueV3Scheduler","FBLogger","I64","InMemorySamplingDB","MAWEBLSInWorkerSwitch","MAWODSProxy","MpsTypes","Promise","QPLFlow","WAOdsEnums","WAResultOrError","WATimeUtils","WebMps","asyncToGeneratorRuntime","getErrorSafe","justknobx","qpl"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c;function d(e,t){var n={};for(var r of e){var o=t(r);n[o]==null&&(n[o]=[]),n[o].push(r)}return n}var m={qplEvent:r("qpl")._(521475573,"3232"),sampleAgeThresholdMs:(c=r("justknobx"))._("3485"),validationIntervalMs:c._("3949")},p=c._("3573")/1e4,_=new Map([["text",c._("3952")],["image",c._("3957")],["video",c._("3969")],["audio",c._("3970")],["document",c._("3973")],["sticker",c._("3977")],["gif",c._("3981")],["xma",c._("1505")],["revoked",c._("66")],["deleteForMe",c._("399")]]);function f(e,t,n,r,a,i){var l=n.has(t.messageId),s=o("EBMessageProbeSamplingPreprocessor").isDeleteMessageType(t.messageType),u=a?r.has(t.messageId):void 0,c=s?!l:l;c?e.endSuccess({bool:{messageFound:l,mpsLocalMessageFound:u}}):e.endFail("message_probe_not_successful",{bool:{messageFound:l,mpsLocalMessageFound:u},string:{encryption_version:i,error:"message_probe_not_successful"}})}var g=function(t){return t.timestampMs},h=function(t){return t.messageType},y=function(){return new(o("InMemorySamplingDB")).InMemorySamplingDB(g,function(e){return e.messageId})},C=function(t){return new(o("EBSampler")).EBSampler(p,_,h,t)},b=(function(t){function a(e,n,r){return r===void 0&&(r=m),t.call(this,e,n,r)||this}babelHelpers.inheritsLoose(a,t),a.getInstance=function(){if(!a.$EBMessageProbe$p_1){var e=y(),t=C(e);a.$EBMessageProbe$p_1=new a(t,e,m)}return a.$EBMessageProbe$p_1},a.reset=function(){a.$EBMessageProbe$p_1=null};var i=a.prototype;return i.addMarkerToItem=function(t,n,r){return this.addMarker(t,n,r)},i.addMarker=function(t,n,r){var e=this.getSamplingDB();if(e==null)return!1;var a=e.getItemByPrimaryKey(t);if(a==null)return!1;var i={event:n,metadata:r,timestampMs:o("WATimeUtils").castToMillisTime(Date.now())};return a.markers.push(i),!0},i.getMarkersForMessage=function(t){var e=this.getSamplingDB();if(e==null)return null;var n=e.getItemByPrimaryKey(t);return n==null?null:[].concat(n.markers)},i.getMessageSample=function(t){var e=this.getSamplingDB();return e==null?null:e.getItemByPrimaryKey(t)},i.$EBMessageProbe$p_2=function(t){return t.length===0?"":t.map(function(e){return e.event}).join(",")},i.$EBMessageProbe$p_3=function(t){var e={bool:{},int:{},string:{}};for(var n of t){var r=n.metadata;if(r!=null)for(var o of Object.entries(r)){var a=o[0],i=o[1];typeof i=="string"?e.string!=null&&(e.string[a]=i):typeof i=="number"?e.int!=null&&(e.int[a]=i):typeof i=="boolean"&&e.bool!=null&&(e.bool[a]=i)}}return e},i.$EBMessageProbe$p_4=function(t){if(t===0)return"0";if(t>=1e3)return"1000+";var e=Math.floor(t/50)*50,n=e+50;return e+"-"+n},i.$EBMessageProbe$p_5=function(t){if(t<0)return"never";var e=t/(1e3*60);return e<1?"<1min":e>=1&&e<5?"1-5min":e>=5&&e<10?"5-10min":e>=10&&e<20?"10-20min":e>=20&&e<60?"20-60min":">60min"},i.validateSamples=(function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){if(t.length!==0){var a=o("EncryptedBackupsUploadQueue").ebUploadQueue(),i=-1,l="unknown";try{i=yield a.count(),l=this.$EBMessageProbe$p_4(i),o("MAWODSProxy").odsBumpEntityKey({entity:o("WAOdsEnums").Entity.EB_UPLOAD,key:"upload_queue_count_bucket_"+l})}catch(e){r("FBLogger")("wmi").catching(r("getErrorSafe")(e)).warn("Failed to get upload queue count for probe annotation")}var c=o("EncryptedBackupsUploadQueueV3Scheduler").getLastSuccessfulAckTimestampMs(),m=c!=null?Date.now()-c:-1,p=this.$EBMessageProbe$p_5(m),_=new Set,g=[];for(var h of t){var y,C,b=h.chatJid+"_"+h.messageId;if(!_.has(b)){_.add(b);var v=Date.now()-h.timestampMs,S=v/(1e3*60),R=function(t){return t<5?"<5min":t>=5&&t<10?"5-10min":">10min"},L=void 0,E=void 0;if(h.queueId!=null){var k,I=yield a.get(h.queueId);if(L=I!=null,(I==null||(k=I.msgId)==null?void 0:k.externalId)!=null){var T;E=o("MpsTypes").toMessageId(I==null||(T=I.msgId)==null?void 0:T.externalId)===h.messageId}}var D=o("QPLFlow").startQPLFlow(this.getConfig().qplEvent,{annotations:babelHelpers.extends({},this.$EBMessageProbe$p_3(h.markers),{bool:{eb_state:r("MAWEBLSInWorkerSwitch").isEnabled(),ebUploadTaskScheduled:o("EncryptedBackupsUploadQueueV3Scheduler").isUploadTaskScheduled(),isProtobufOnlyUpload:!0,queueItemExists:L,queueItemMessageIdMatches:E},int:{markerCount:h.markers.length,queueCount:i,queueId:(y=h.queueId)!=null?y:-1,sampleSize:t.length,sampleTimestampMs:h.timestampMs,validationIntervalMs:v,validationTimestampMs:Date.now()},string:{bucketizedQueueCount:l,bucketizedTimeSinceLastAck:p,chatJid:h.chatJid,insertionSource:(C=h.insertionSource)!=null?C:"unknown",markerEvents:this.$EBMessageProbe$p_2(h.markers),messageId:h.messageId,messageType:h.messageType,validationIntervalBucket:R(S),version:"v1"}})});g.push({qplFlow:D,sample:h})}}try{var x=r("justknobx")._("4947"),$=d(g,function(e){return e.sample.chatJid}),P=Object.entries($).map((function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=e[0],n=e[1],r=n.map(function(e){return e.sample.messageId}),a=n[0].sample.chatJid,i={chatJid:a,messageIds:r,source:"message_probe"};n.forEach(function(e){var t=e.qplFlow;t!=null&&t.addPoint("point_query_start")});var l=yield o("EBMessagePointQuery").messagePointQuery(i),s=x?yield o("WebMps").mps().batchLoadMessage({config:{shouldFetchSupplementals:!1,shouldFetchTags:!1,strategy:"local-only"},debug:{purpose:"eb-message-probe"},messageIds:r,threadId:o("MpsTypes").toThreadId(a)}):o("WAResultOrError").makeResult([]);return n.forEach(function(e){var t=e.qplFlow;t!=null&&t.addPoint("point_query_end")}),{chatJid:a,mpsLocalResult:s,result:l,samplesWithQplFlow:n}});return function(t){return e.apply(this,arguments)}})()),N=yield o("EBDeps").getDeps().getLSDB(),M=yield o("EBGetClientState").getClientState(N),w=M==null?void 0:M.encryptionVersion,A=w!=null?(u||(u=o("I64"))).to_string(w):"unknown",F=yield(s||(s=n("Promise"))).all(P);for(var O of F){var B,W=O.mpsLocalResult,q=O.result,U=O.samplesWithQplFlow,V=new Set((B=W.value)==null?void 0:B.map(function(e){var t,n;return(t=e==null||(n=e.toplevelProtobuf)==null?void 0:n.messageId)!=null?t:null}));if(q.success){var H=new Set(q.value.map(function(e){return o("MpsTypes").toMessageId(e.otid)}));for(var G of U)f(G.qplFlow,G.sample,H,V,x,A)}else for(var z of U){var j=z.qplFlow;if(j!=null){var K;j.endFail("query_failed",{bool:{messageFound:!1,mpsLocalMessageFound:x?V.has(z.sample.messageId):void 0},string:{encryption_version:A,error:(K=q.error)!=null?K:"unknown-query-failure"}})}}}}catch(t){var Q=r("getErrorSafe")(t);r("FBLogger")("wmi").catching(Q).MUSTFIX(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Failed to validate samples"])));for(var X of g){var Y;X.qplFlow.endFail("validation_exception",{bool:{messageFound:!1},string:{error:(Y=Q.message)!=null?Y:"unknown-validation-exception"}})}}}});function a(e){return t.apply(this,arguments)}return a})(),a})(o("EBProbe").EBProbe),v=b.getInstance,S=b.reset;l.EBMessageProbe=b,l.getEBMessageProbeInstance=v,l.resetEBMessageProbeInstance=S}),98);
__d("EBUploadMessagesFromWorkerMutationDeferred",["requireDeferred"],(function(t,n,r,o,a,i,l){"use strict";var e=r("requireDeferred")("EBUploadMessagesFromWorkerMutation").__setRef("EBUploadMessagesFromWorkerMutationDeferred");function s(t,n){return e.load().then(function(e){return e.uploadMessagesFromWorker(t,n)})}l.uploadMessagesFromWorker=s}),98);
__d("EncryptedBackupsCreateAttachmentContext",["EBLogger","EncryptedBackupsUploadEntity","MAWProtobufDeserializers","WAMediaTransport.pb","WAMediaUtils","decodeProtobuf"],(function(t,n,r,o,a,i,l){"use strict";var e=o("EBLogger").EBLogger().tags(["labyrinth_web","CreateAttachmentContext"]);function s(t){var n=new Map;try{var r=o("MAWProtobufDeserializers").DeserializedBackupMessage.create(t),a=r.encryptedTransportMessage();if(a==null)return e.warn("transport message subprotocol is undefined"),[];var i=d(a);if(i!=null)if(i.type!==o("EncryptedBackupsUploadEntity").AttachmentContextMediaType.XMA)c(i,n);else{var l=i.payload;u(l.favicon,n),u(l.headerImage,n),l.previews!=null&&l.previews.forEach(function(e){u(e,n)});var s=l.associatedMessage;if(s!=null&&s.payload!=null){var m=new(o("MAWProtobufDeserializers")).DeserializedMessageApplication(s.payload),p=d(m);p!=null&&c(p,n)}}}catch(t){e.warn("Unable to create attachment context for message")}return Array.from(n.entries()).map(function(e){var t=e[0],n=e[1];return{mediaObjectId:t,mediaType:n}})}function u(e,t){var n;if(e!=null){var r=o("decodeProtobuf").decodeProtobuf(o("WAMediaTransport.pb").ImageTransportSpec,e.payload),a=(n=r.integral)==null||(n=n.transport)==null||(n=n.ancillary)==null?void 0:n.objectId;a!=null&&t.set(o("WAMediaUtils").stringToDeliveryObjectId(a),o("EncryptedBackupsUploadEntity").AttachmentContextMediaType.XMA)}}function c(t,n){var r,a,i,l=t.type,s=t.payload,u=s.integral;if((u==null||(r=u.transport)==null||(r=r.ancillary)==null?void 0:r.objectId)==null){e.warn("object id for attachment is null");return}var c=o("WAMediaUtils").stringToDeliveryObjectId(u==null||(a=u.transport)==null||(a=a.ancillary)==null?void 0:a.objectId);n.set(c,l);var d=u==null||(i=u.transport)==null||(i=i.ancillary)==null||(i=i.thumbnail)==null||(i=i.downloadableThumbnail)==null?void 0:i.objectId;if(d!=null&&d!==c){var m=o("WAMediaUtils").stringToDeliveryObjectId(d);n.set(m,o("EncryptedBackupsUploadEntity").AttachmentContextMediaType.MESSENGER_PREVIEW)}}function d(e){var t=e.consumerMessage(),n=e.armadillo();if(t!=null){var r,a,i,l,s,u=t.payload;if((u==null||(r=u.content)==null?void 0:r.imageMessage)!=null){var c;return{payload:o("decodeProtobuf").decodeProtobuf(o("WAMediaTransport.pb").ImageTransportSpec,u==null||(c=u.content)==null||(c=c.imageMessage.image)==null?void 0:c.payload),type:o("EncryptedBackupsUploadEntity").AttachmentContextMediaType.IMAGE}}if((u==null||(a=u.content)==null?void 0:a.videoMessage)!=null){var d,m,p,_=o("decodeProtobuf").decodeProtobuf(o("WAMediaTransport.pb").VideoTransportSpec,u==null||(d=u.content)==null||(d=d.videoMessage.video)==null?void 0:d.payload);return{payload:_,type:(_==null||(m=_.ancillary)==null?void 0:m.gifPlayback)!==!0||(_==null||(p=_.ancillary)==null?void 0:p.gifAttribution)!=null?o("EncryptedBackupsUploadEntity").AttachmentContextMediaType.GIF:o("EncryptedBackupsUploadEntity").AttachmentContextMediaType.VIDEO}}if((u==null||(i=u.content)==null?void 0:i.stickerMessage)!=null){var f;return{payload:o("decodeProtobuf").decodeProtobuf(o("WAMediaTransport.pb").StickerTransportSpec,u==null||(f=u.content)==null||(f=f.stickerMessage.sticker)==null?void 0:f.payload),type:o("EncryptedBackupsUploadEntity").AttachmentContextMediaType.STICKER}}if((u==null||(l=u.content)==null?void 0:l.audioMessage)!=null){var g;return{payload:o("decodeProtobuf").decodeProtobuf(o("WAMediaTransport.pb").AudioTransportSpec,u==null||(g=u.content)==null||(g=g.audioMessage.audio)==null?void 0:g.payload),type:o("EncryptedBackupsUploadEntity").AttachmentContextMediaType.PTT}}if((u==null||(s=u.content)==null?void 0:s.documentMessage)!=null){var h;return{payload:o("decodeProtobuf").decodeProtobuf(o("WAMediaTransport.pb").DocumentTransportSpec,u==null||(h=u.content)==null||(h=h.documentMessage.document)==null?void 0:h.payload),type:o("EncryptedBackupsUploadEntity").AttachmentContextMediaType.DOCUMENT}}}if(n!=null){var y,C=n.payload;if((C==null||(y=C.content)==null?void 0:y.extendedContentMessage)!=null){var b;return{payload:C==null||(b=C.content)==null?void 0:b.extendedContentMessage,type:o("EncryptedBackupsUploadEntity").AttachmentContextMediaType.XMA}}}}l.createAttachmentContext=s}),98);
__d("EncryptedBackupsMediaRestoreProbeQpl",["MAWQplProxy","WAGetAgeBucketForMediaKeyTimestamp","WAGetPlatformFromStanzaId","justknobx","qpl"],(function(t,n,r,o,a,i,l){"use strict";function e(e){var t=e.isRetroactiveUpload,n=e.mediaType,a=e.msgType,i=e.objectId,l=e.probeDelayMs,s=e.restoreMethod,u=e.sampleRate,c=e.stanzaId,d=e.timestamp,m=e.triggerSource,p=e.version,_=e.xmaType;return o("MAWQplProxy").startQplUserFlow(r("qpl")._(521473213,"27"),{bool:{isRetroactiveUpload:t,isUnifiedAttachmentUpload:!0},int:{probeDelayMs:l,sampleRate:u},string:{e2eePlatform:o("WAGetPlatformFromStanzaId").getPlatformFromStanzaId(c),mediaKeyAge:o("WAGetAgeBucketForMediaKeyTimestamp").getAgeBucketForMediaKeyTimestamp(d),mediaType:n,msgType:a,objectId:i,restoreMethod:s,triggerSource:m,version:p,xmaType:_==null?"<null>":_}},{providedTimeoutInMs:r("justknobx")._("3047")})}l.startMediaRestoreProbeQPLFlow=e}),98);
__d("MAWCastToMsgType",["MAWMsgType"],(function(t,n,r,o,a,i,l){"use strict";function e(e){switch(e){case"image":return o("MAWMsgType").MSG_TYPE.IMAGE;case"video":return o("MAWMsgType").MSG_TYPE.VIDEO;case"gif":return o("MAWMsgType").MSG_TYPE.GIF;case"sticker":return o("MAWMsgType").MSG_TYPE.STICKER;case"file":return o("MAWMsgType").MSG_TYPE.DOCUMENT_FILE;case"audio":return o("MAWMsgType").MSG_TYPE.PTT;case"xma":return o("MAWMsgType").MSG_TYPE.XMA}}l.castMsgrServerMediaTypeToMsgType=e}),98);
__d("MAWCastToServerMediaType",[],(function(t,n,r,o,a,i){"use strict";function e(e){switch(e){case"document":case"image":case"xma-image":case"video":case"ptt":case"gif":case"sticker":return e;default:return null}}function l(e){switch(e){case"image":case"video":case"gif":case"sticker":case"preview":return e;case"audio":return"ptt";case"xma":return"xma-image";case"file":return"document"}}i.castToServerMediaType=e,i.castMsgrServerMediaTypeToServerMediaType=l}),66);
__d("EncryptedBackupsMediaRestoreProbeV2",["$InternalEnum","EncryptedBackupsMediaRestoreProbeQpl","MAWCastToMsgType","MAWCastToServerMediaType","Promise","Random","WAMediaUtils","WAPromiseDelays","WAResultOrError","WATagsLogger","WATimeUtils","asyncToGeneratorRuntime","cr:10071","gkx","justknobx"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_,f=n("$InternalEnum")({DEFAULT_PREVIEW:"defaultPreview",FAVICON:"favicon",HEADER:"header",PREVIEWS:"previews"}),g=r("justknobx")._("2045"),h=o("WATagsLogger").TAGS(["MediaRestoreProbeV2"]);function y(e){switch(e){case"video":return 13;case"sticker":return 10;case"audio":return 8;case"gif":return 40;case"file":return 40;case"xma":return 2;case"image":case"preview":return 1}}function C(){return r("gkx")("2067")?100:r("justknobx")._("2722")}function b(e){return v.apply(this,arguments)}function v(){return v=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var a=t.backupMessage,i=t.chatJid,l=t.sortOrderMs,f=t.stanzaId,b=t.triggerSource;if(n("cr:10071")==null)return o("WAResultOrError").makeResult("not-in-gk");var v=S(a);if(v.success===!1)return v;var R=h.TAGS([f]),L=v.value;if(L==="no-attachment-with-msg")return R.LOG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["skip restore probe because no attachment found"]))),o("WAResultOrError").makeResult(L);var E=L.map(function(e){return e.serverMediaType}).filter(function(e){return e!=="preview"}).find(Boolean);if(E==null)return R.LOG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["skip restore probe because no attachment found"]))),o("WAResultOrError").makeResult("no-attachment-with-msg");var k=C(),I=y(E),T=o("Random").coinflip(100/(k*I));if(!T)return(_||(_=n("Promise"))).resolve(o("WAResultOrError").makeResult("not-sampled"));R.LOG(u||(u=babelHelpers.taggedTemplateLiteralLoose(["Sampling before delay from source: "," "])),b),yield o("WAPromiseDelays").delayMs(r("gkx")("2067")?5e3:g);var D=yield(_||(_=n("Promise"))).all(L.map(function(e){var t=o("EncryptedBackupsMediaRestoreProbeQpl").startMediaRestoreProbeQPLFlow({isRetroactiveUpload:!1,mediaType:o("MAWCastToServerMediaType").castMsgrServerMediaTypeToServerMediaType(e.serverMediaType),msgType:o("MAWCastToMsgType").castMsgrServerMediaTypeToMsgType(E),objectId:e.objectId,probeDelayMs:g,restoreMethod:"gql",sampleRate:k,stanzaId:f,timestamp:e.timestamp,triggerSource:b,version:"protobuf",xmaType:e.xmaType});return R.LOG(c||(c=babelHelpers.taggedTemplateLiteralLoose(["start probing. triggerSource: ",", serverMediaType: ",", xmaType: ",", objectId: "," "])),b,e.serverMediaType,e.xmaType,e.objectId),n("cr:10071").eblsResignCdnUrlWithGraphQL({chatJid:i,deliveryObjectId:e.objectId,externalId:f,mediaDownloadFlow:{addAnnotations:function(n){t.addAnnotations(babelHelpers.extends({},n))},addPoint:function(n,r){t.addPoint(n,babelHelpers.extends({},r))}},mediaKey:e.mediaKey,mediaType:e.serverMediaType,sortOrderMs:l}).then(function(n){return n.success?(R.LOG(d||(d=babelHelpers.taggedTemplateLiteralLoose(["Probe success"]))),{error:null,qpl:t,v2Payload:e}):(R.LOG(m||(m=babelHelpers.taggedTemplateLiteralLoose(["Probe failed: "," "])),n.error),{error:n.error,qpl:t,v2Payload:e})}).catch(function(n){return R.LOG(p||(p=babelHelpers.taggedTemplateLiteralLoose(["Probe failed: "," "])),n.toString()),{error:"runtime-error",qpl:t,v2Payload:e}})}));for(var x of D)x.error!=null?x.qpl.endFail(x.error,{string:{failReason:x.error}}):x.qpl.endSuccess();return o("WAResultOrError").makeResult("restore-media-success")}),v.apply(this,arguments)}function S(e){var t,n=e.encryptedTransportMessage();if(n==null)return o("WAResultOrError").makeError("missing-transport");var r=n.consumerMessage();if(r!=null){var a=r.imageMessage();if(a!=null)return E(a,"image");var i=r.videoMessage();if(i!=null){var l,s,u=((l=i.payload.ancillary)==null?void 0:l.gifPlayback)===!0||((s=i.payload.ancillary)==null?void 0:s.gifAttribution)!=null;return E(i,u?"gif":"video")}var c=r.audioMessage();if(c!=null){var d=L(c,"audio");return d.success===!1?d:o("WAResultOrError").makeResult([d.value])}var m=r.stickerMessage();if(m!=null){var p=L(m,"sticker");return p.success===!1?p:o("WAResultOrError").makeResult([p.value])}var _=r.documentMessage();if(_!=null){var g=L(_,"file");return g.success===!1?g:o("WAResultOrError").makeResult([g.value])}}var h=(t=n.armadillo())==null?void 0:t.extendedContentMessage();if(h!=null){var y=h.previews();return o("WAResultOrError").makeResult([R({transport:h.favicon(),xmaType:f.FAVICON}),R({transport:h.headerImage(),xmaType:f.FAVICON}),y.length>0?R({transport:y[0],xmaType:f.DEFAULT_PREVIEW}):null].concat(y.map(function(e){return R({transport:e,xmaType:f.PREVIEWS})})).filter(Boolean))}return o("WAResultOrError").makeResult("no-attachment-with-msg")}function R(e){var t,n,r,a=e.transport,i=e.xmaType,l=a==null||(t=a.integral)==null||(t=t.transport)==null||(t=t.ancillary)==null?void 0:t.objectId;if(l==null)return null;var s=a==null||(n=a.integral)==null||(n=n.transport)==null||(n=n.integral)==null?void 0:n.mediaKeyTimestamp,u=a==null||(r=a.integral)==null||(r=r.transport)==null||(r=r.integral)==null?void 0:r.mediaKey;return u==null?null:{mediaKey:o("WAMediaUtils").castToMediaKey(u),objectId:o("WAMediaUtils").stringToDeliveryObjectId(l),serverMediaType:"xma",timestamp:s!=null?o("WATimeUtils").castLongIntToUnixTime(s):null,xmaType:i}}function L(e,t){var n,r,a,i=e==null||(n=e.payload.integral)==null||(n=n.transport)==null||(n=n.ancillary)==null?void 0:n.objectId,l=e==null||(r=e.payload.integral)==null||(r=r.transport)==null||(r=r.integral)==null?void 0:r.mediaKeyTimestamp,s=e==null||(a=e.payload.integral)==null||(a=a.transport)==null||(a=a.integral)==null?void 0:a.mediaKey;return s==null?o("WAResultOrError").makeError("missing-media-key"):i!=null?o("WAResultOrError").makeResult({mediaKey:o("WAMediaUtils").castToMediaKey(s),objectId:o("WAMediaUtils").stringToDeliveryObjectId(i),serverMediaType:t,timestamp:l!=null?o("WATimeUtils").castLongIntToUnixTime(l):null}):o("WAResultOrError").makeError("missing-object-id")}function E(e,t){var n,r,a,i=L(e,t);if(i.success===!1)return i;var l=e==null||(n=e.payload.integral)==null||(n=n.transport)==null||(n=n.ancillary)==null||(n=n.thumbnail)==null||(n=n.downloadableThumbnail)==null?void 0:n.objectId,s=e==null||(r=e.payload.integral)==null||(r=r.transport)==null||(r=r.integral)==null?void 0:r.mediaKeyTimestamp,u=e==null||(a=e.payload.integral)==null||(a=a.transport)==null||(a=a.integral)==null?void 0:a.mediaKey;return u==null?o("WAResultOrError").makeError("missing-media-key"):l!=null?o("WAResultOrError").makeResult([i.value,{mediaKey:o("WAMediaUtils").castToMediaKey(u),objectId:o("WAMediaUtils").stringToDeliveryObjectId(l),serverMediaType:"preview",timestamp:s!=null?o("WATimeUtils").castLongIntToUnixTime(s):null}]):o("WAResultOrError").makeResult([i.value])}l.ProbeXmaType=f,l.sampleProbeMediaRestoreV2=b}),98);
__d("MAWMPSCreateBackupDirective",["EBLogger","MpsMessageToBridgeWrapper","MpsTypes","WAStanzaUtils"],(function(t,n,r,o,a,i,l){"use strict";var e=o("EBLogger").EBLogger().tags(["mps"]);function s(t){switch(t){case o("MpsTypes").ActionType.UpsertTopLevel:return 1;case o("MpsTypes").ActionType.UpsertSupplemental:return 2;case o("MpsTypes").ActionType.DeleteTopLevel:return 3;case o("MpsTypes").ActionType.DeleteTopLevelWithPlaceholder:return 4;case o("MpsTypes").ActionType.DeleteSupplemental:case o("MpsTypes").ActionType.Preprocess:case o("MpsTypes").ActionType.Noop:case o("MpsTypes").ActionType.DeleteThread:case o("MpsTypes").ActionType.Unknown:return e.warn("Action type %d not supported on EB upload",t),0}}function u(t,n){var r=s(t.actionType);if(r===0){e.warn("Unknown EB upload action type - cannot upload message");return}var o={actionType:r,originalMsgProtocolId:n};return t.supplementalKey!=null&&(o=babelHelpers.extends({},o,{supplementalKey:t.supplementalKey})),o}function c(e,t){var n=o("MpsMessageToBridgeWrapper").MpsMessageToBridgeWrapper.fromTopLevel(t);return{author:n.getAuthor(),chat:n.getChatJid(),externalId:o("WAStanzaUtils").toStanzaId(e.targetMessageId)}}l.createBackupDirectiveFromMPSMessage=u,l.getTargetProtocolMsgIdForMessage=c}),98);
__d("EncryptedBackupsUploadQueueV3",["EncryptedBackupsMediaRestoreProbeV2","FBLogger","MAWEBSwitch","MAWMPSCreateBackupDirective","MAWProtobufDeserializers","MpsTypes","WAJids","WAStanzaUtils","WATimeUtils","WormPersistedQueue","WormPersistedQueueSchema"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(e,t,n){return o("WormPersistedQueueSchema").toWormPersistedQueueId(e+"."+t+"."+n.toString())}function u(e){var t=e.directive,n=e.insertionSource,a=e.message,i=o("WATimeUtils").millisTime(),l=o("MAWMPSCreateBackupDirective").getTargetProtocolMsgIdForMessage(t,a),u=o("MAWMPSCreateBackupDirective").createBackupDirectiveFromMPSMessage(t,l);if(u==null)throw r("FBLogger")("wmi").mustfixThrow("invalid-protobuf-no-backup-directive");var c=n===o("MpsTypes").InsertionSource.Send?"upload-sent-message":n===o("MpsTypes").InsertionSource.Receive?"upload-received-message":(function(){throw Error("Match: No case succesfully matched. Make exhaustive or add a wildcard case using '_'. Argument: "+n)})();return babelHelpers.extends({},a,{addedAtMs:i,attemptCount:0,backupDirective:u,debugInfo:{isRetroactive:!r("MAWEBSwitch").isEnabled(),triggerSource:c},queueId:s(a.messageId,a.threadId,i)})}var c=function(){return r("FBLogger")("wmi").tags(["eb_upload","upload_queue_v3"])},d=null;function m(){return d==null&&(d=new(o("WormPersistedQueue")).WormPersistedQueue("ebUploadQueueV3")),d}function p(t){var n;if(t.backupDirective.actionType===1){var r=o("MAWProtobufDeserializers").DeserializedBackupMessage.create(t.payload);o("EncryptedBackupsMediaRestoreProbeV2").sampleProbeMediaRestoreV2({backupMessage:r,chatJid:o("WAJids").unsafeCoerceToChatJid(t.threadId),sortOrderMs:t.timestampMs,stanzaId:o("WAStanzaUtils").toStanzaId(t.messageId),triggerSource:(n=t.debugInfo.triggerSource)!=null?n:"unknown"}).catch(function(t){c().MUSTFIX(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Unexpected runtime error in probeMediaRestoreV2: ",""])),t)})}}l.uploadEntityFromIncomingPayload=u,l.getUploadQueue=m,l.queryMediaRestoreProbe=p}),98);
__d("WAGetHashFromProtocolMsgId",[],(function(t,n,r,o,a,i){"use strict";function e(e){return e.externalId+"_"+e.author+"_"+e.chat}i.getHashFromProtocolMsgId=e}),66);
__d("MAWEBUploadTrackingUtils",["MAWAckLevel","MAWEBSwitch","MAWExternalId","MAWMsgType","MWEBODSEntityKey.enum","MWEBODSEntityName.enum","MWEBODSUtils","ODS","QPLUserFlow","QuickPerformanceLogger","WACommsConnectionState","WAExceededStorageQuota","WAGetHashFromProtocolMsgId","WAGlobals","WAHashStringToNumber","gkx","justknobx","qpl"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u={ERROR_FETCHING_DB_MESSAGE:"error_fetching_db_message",FAILED_TO_ACK_MESSAGE:"failed_to_ack_message",FAILED_TO_CONSTRUCT_ECHO_MESSAGE:"failed_to_construct_echo_message",MESSAGE_UPLOAD_TIMEOUT:"message_upload_timeout",RUNTIME_ERROR:"runtime_error"};function c(e,t,n,a,i,l,u,c,d,m){var _;if(l===void 0&&(l=!1),u===void 0&&(u=!1),d===void 0&&(d="unknown"),m===void 0&&(m=0),!!r("MAWEBSwitch").isEnabled()){r("QPLUserFlow").start(r("qpl")._(521481602,"829"),{annotations:{bool:{eb_switch:r("MAWEBSwitch").isEnabled(),eb_upload_queue:!0,fromUploadQueue:l,is_retroactive_upload:u,is_unified_attachment_upload:!0,is_wasm_serializer_on:r("gkx")("18428"),middleware_init:!1},int:{attachmentsSize:(_=c==null?void 0:c.attachmentInfos.length)!=null?_:0,instanceKey:i,retryCount:m},string:{comms_status:o("WACommsConnectionState").WACommsConnectionState.isConnected()===!0?"connected":"disconnected",externalId:e,msgType:n,payloadType:d,threadId:t,triggerType:a,userJid:o("WAGlobals").getMyUserJid()},string_array:{attachment_trace_ids:c==null?void 0:c.attachmentInfos.map(function(e){var t;return(t=e.attachmentTraceId)!=null?t:"null"}),media_types:c==null?void 0:c.attachmentInfos.map(function(e){return e.mediaType})}},instanceKey:i,timeoutInMs:r("justknobx")._("1405")}),p(i,"upload_tracking_started"),(s||(s=o("ODS"))).bumpEntityKey(7319,r("MWEBODSEntityName.enum").MAW_EB_UPLOAD_TRACKING,r("MWEBODSEntityKey.enum").START),o("MWEBODSUtils").markODSForEB(r("MWEBODSEntityName.enum").MAW_EB_UPLOAD_COUNTER,"upload."+(n!=null?n:"unknown"));var f=o("MAWMsgType").isMAWSupportedMediaType(n!=null?n:"Text")?"media":"non-media";o("MWEBODSUtils").markODSForEB(r("MWEBODSEntityName.enum").MAW_EB_UPLOAD_COUNTER,"upload."+f)}}function d(e){return e==null?{string:{comms_status_on_failure:o("WACommsConnectionState").WACommsConnectionState.isConnected()===!0?"connected":"disconnected"}}:babelHelpers.extends({},e,{string:babelHelpers.extends({},e.string,{comms_status_on_failure:o("WACommsConnectionState").WACommsConnectionState.isConnected()===!0?"connected":"disconnected"})})}function m(e,t,n,r){switch(e){case"success":h(t,n,r);break;case"fail":g(t,n,r);break;case"point":p(t,n,r);break}}function p(e,t,n){n&&r("QPLUserFlow").addAnnotations(r("qpl")._(521481602,"829"),n,{instanceKey:e}),r("QPLUserFlow").addPoint(r("qpl")._(521481602,"829"),t,{instanceKey:e})}function _(e,t){r("QPLUserFlow").addAnnotations(r("qpl")._(521481602,"829"),t,{instanceKey:e})}function f(e,t){var n;r("QPLUserFlow").addAnnotations(r("qpl")._(521481602,"829"),d(t),{instanceKey:e}),r("QPLUserFlow").endCancel(r("qpl")._(521481602,"829"),{annotations:{bool:{exceededStorageQuota:o("WAExceededStorageQuota").getExceededStorageQuota(),isRelaxedDurability:!0},string:{threadID:t==null||(n=t.string)==null?void 0:n.jid}},instanceKey:e}),(s||(s=o("ODS"))).bumpEntityKey(7319,r("MWEBODSEntityName.enum").MAW_EB_UPLOAD_TRACKING,r("MWEBODSEntityKey.enum").CANCEL)}function g(e,t,n){var a;r("QPLUserFlow").addAnnotations(r("qpl")._(521481602,"829"),d(n),{instanceKey:e}),r("QPLUserFlow").endFailure(r("qpl")._(521481602,"829"),t,{annotations:{bool:{exceededStorageQuota:o("WAExceededStorageQuota").getExceededStorageQuota(),isRelaxedDurability:!0},string:{threadID:n==null||(a=n.string)==null?void 0:a.jid}},instanceKey:e}),(s||(s=o("ODS"))).bumpEntityKey(7319,r("MWEBODSEntityName.enum").MAW_EB_UPLOAD_TRACKING,r("MWEBODSEntityKey.enum").FAIL)}function h(e,t,n){p(e,t),y(e,n)}function y(e,t){t&&r("QPLUserFlow").addAnnotations(r("qpl")._(521481602,"829"),t,{instanceKey:e}),r("QPLUserFlow").endSuccess(r("qpl")._(521481602,"829"),{annotations:{bool:{exceededStorageQuota:o("WAExceededStorageQuota").getExceededStorageQuota(),isRelaxedDurability:!0}},instanceKey:e}),(s||(s=o("ODS"))).bumpEntityKey(7319,r("MWEBODSEntityName.enum").MAW_EB_UPLOAD_TRACKING,r("MWEBODSEntityKey.enum").SUCCESS)}function C(e,t,n){var a;p(e,t),n&&r("QPLUserFlow").addAnnotations(r("qpl")._(521481602,"829"),n,{instanceKey:e}),r("QPLUserFlow").endTimeout(r("qpl")._(521481602,"829"),{annotations:{bool:{exceededStorageQuota:o("WAExceededStorageQuota").getExceededStorageQuota(),isRelaxedDurability:!0},string:{threadID:n==null||(a=n.string)==null?void 0:a.jid}},instanceKey:e}),(s||(s=o("ODS"))).bumpEntityKey(7319,r("MWEBODSEntityName.enum").MAW_EB_UPLOAD_TRACKING,r("MWEBODSEntityKey.enum").TIMEOUT)}function b(t,n,o){var a=r("qpl")._(521481602,"829");p(t,n),o&&(e||(e=r("QuickPerformanceLogger"))).markerAnnotate(a,o,{instanceKey:t}),(e||(e=r("QuickPerformanceLogger"))).markerEnd(a,52,t,e.currentTimestamp())}function v(){return o("WAHashStringToNumber").hashStringToNumber(o("MAWExternalId").generateExternalId())}function S(e,t){return t===void 0&&(t=0),o("WAHashStringToNumber").hashStringToNumber(o("WAGetHashFromProtocolMsgId").getHashFromProtocolMsgId(e)+"_"+o("WAGlobals").getMyDeviceJid()+"_"+t)}function R(e){return r("MAWEBSwitch").isEnabled()&&o("MAWMsgType").isEBSupportedMsgType(e.type)&&e.ack>=o("MAWAckLevel").ACK.sent&&e.serverTs!=null&&!(e.ephemeralSetting!=null&&e.ephemeralSetting.ephemeralExpirationInSec>0)}function L(e){return{addAnnotations:function(n){_(e,n)},addPoint:function(n,r){p(e,n,r)},endCancel:function(n,r){f(e,r)},endFail:function(n,r){g(e,n,r)},endSuccess:function(n){y(e,n)},getQPLAttrs:function(){return{instanceKey:e}},isActive:function(){return!0},start:function(){}}}function E(e,t){return e.get(t)}function k(e,t,n,r,o){var a=E(t,n);if(a!=null)switch(e){case"success":h(a,r,o);break;case"fail":g(a,r,o);break;case"point":p(a,r,o);break}}l.EBUploadTrackingWorkerFailurePoints=u,l.startUploadTracking=c,l.handleBridgeEbUploadTrackingQPL=m,l.addPointWorkerOnly=p,l.addAnnotationsWorkerOnly=_,l.endCancelWorkerOnly=f,l.endFailWorkerOnly=g,l.endSuccessWorkerOnly=h,l.endTimeoutWorkerOnly=C,l.endRetryWorkerOnly=b,l.genInstanceKeyOnly=v,l.genInstanceKeyForUploadQueue=S,l.isUploadSupported=R,l.makeEBWorkerQplFlowFromInstanceKey=L,l.getUploadTrackingInstanceKey=E,l.addUploadTrackingByType=k}),98);
__d("EncryptedBackupsUploadQueueV3Scheduler",["EBGenerateMessageTags","EBMessageProbe","EBUploadMessagesFromWorkerMutationDeferred","EncryptedBackupsCreateAttachmentContext","EncryptedBackupsUploadEntity","EncryptedBackupsUploadQueueV3","FBLogger","I64","MAWBridgeUpload","MAWEBLSInWorkerSwitch","MAWEBUploadTrackingUtils","MAWProtobufValidator","MWEBODSUtils","QPLFlow","WACommsConnectionState","WAGlobals","WAHashStringToNumber","WAJids","WAStanzaUtils","WATimeUtils","WAWaitForUserUnblocked","WorkerScheduler","asyncToGeneratorRuntime","getErrorSafe","justknobx","performanceAbsoluteNow","qpl","uuidv4"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_,f,g=function(){return r("FBLogger")("wmi").tags(["eb_upload","upload_queue_v3_scheduler"])},h=null;function y(){return h!==null}var C;function b(){return C}var v={concurrency:1,maxTaskLimit:1,maxThrottleMs:r("justknobx")._("1453"),timeoutMs:r("justknobx")._("1460")};function S(){r("MAWEBLSInWorkerSwitch").onSet(function(e){e===!0&&R()}),o("WACommsConnectionState").WACommsConnectionState.onSet(function(e){e===!0&&R()}),o("EncryptedBackupsUploadQueueV3").getUploadQueue().subscribe(function(e){e.type==="new_entities"&&R()}),R()}function R(){return L.apply(this,arguments)}function L(){return L=n("asyncToGeneratorRuntime").asyncToGenerator(function*(){if(h!=null){g().DEBUG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["EB Upload is already running"])));return}yield o("WAWaitForUserUnblocked").waitForUserUnblocked();var t=o("QPLFlow").startQPLFlow(r("qpl")._(521475028,"909"));if(!r("MAWEBLSInWorkerSwitch").isEnabled()){g().DEBUG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["EB is not enabled"]))),t.addPoint("eb_disabled"),t.endSuccess();return}if(!o("WACommsConnectionState").WACommsConnectionState.isConnected()){g().DEBUG(u||(u=babelHelpers.taggedTemplateLiteralLoose(["WAComms connection is not established"]))),t.addPoint("wa_comms_not_connected"),t.endSuccess();return}h=o("WorkerScheduler").makeScheduler("EncryptedBackupsUploadQueueV3",v).task({fn:function(){return E(t)},name:"eb_upload_queue_v3",priority:o("WorkerScheduler").BACKGROUND_PRIORITY});try{var n=yield h.run();h=null,n&&R()}catch(e){h=null;var a=r("getErrorSafe")(e);g().FATAL(c||(c=babelHelpers.taggedTemplateLiteralLoose(["Runtime error during EB upload run: ",""])),a.message),t.endFail("runtime_error"),R()}}),L.apply(this,arguments)}function E(e){return k.apply(this,arguments)}function k(){return k=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=[],n=0,a=0,i=yield o("EncryptedBackupsUploadQueueV3").getUploadQueue().readFromIndex("[attemptCount+addedAtMs]",{filter:function(i){return Date.now()-i.timestampMs>o("WATimeUtils").DAY_MILLISECONDS*30?(t.push(i.queueId),n++,!1):o("MAWProtobufValidator").isProtobufValid(i.payload)?i.attemptCount<r("justknobx")._("1596"):(t.push(i.queueId),a++,!1)},limit:r("justknobx")._("1676"),order:"asc"});if(e.addPoint("retrieved_entries",{int:{entriesCount:i.length}}),t.length>0&&(yield o("EncryptedBackupsUploadQueueV3").getUploadQueue().delete(t),e.addPoint("deleted_invalid_entries",{int:{expiredEntryCount:n,invalidProtobufEntryCount:a}})),i.length===0)return e.endSuccess(),t.length>0;g().DEBUG(d||(d=babelHelpers.taggedTemplateLiteralLoose(["upload queue uploading "," messages"])),i.length);var l=[],s=[];for(var u of i){var c;o("EBMessageProbe").EBMessageProbe.getInstance().addMarkerToItem(u.messageId,"message_picked_from_queue",{is_retroactive:u.debugInfo.isRetroactive||!1,trigger_source:"upload-message-from-mps"});var _=o("WAHashStringToNumber").hashStringToNumber(r("uuidv4")()),h=$(u,_);l.push(h),s.push(_),o("MAWEBUploadTrackingUtils").startUploadTracking(o("WAStanzaUtils").toStanzaId(u.messageId),o("WAJids").threadIdForChatJid(o("WAJids").unsafeCoerceToChatJid(u.threadId)),void 0,(c=u.debugInfo.triggerSource)!=null?c:"unknown",_,!0,u.debugInfo.isRetroactive||!1,h.attachmentBackupContext,"protobuf_only",u.attemptCount);var y=/^\d*$/.test(h.messageId);if(o("MAWEBUploadTrackingUtils").addAnnotationsWorkerOnly(_,{bool:{message_id_valid:y}}),!y){var b;g().MUSTFIX(m||(m=babelHelpers.taggedTemplateLiteralLoose(["Invalid message OTID: ",""])),h.messageId),o("MWEBODSUtils").markODSForEB("upload",((b=u.debugInfo.triggerSource)!=null?b:"unknown")+".invalid_otid")}}e.addPoint("generated_bridge_upload_messages"),s.forEach(function(e){return o("MAWEBUploadTrackingUtils").addPointWorkerOnly(e,"fire_protobuf_only_upload_bridge_event")});try{var v=yield o("EBUploadMessagesFromWorkerMutationDeferred").uploadMessagesFromWorker(l,"EncryptedBackupsUploadQueueV3");if(e.addPoint("received_upload_response"),v.success){for(var S of i)o("EBMessageProbe").EBMessageProbe.getInstance().addMarkerToItem(S.messageId,"message_uploaded_via_graphql",{action_type:S.backupDirective.actionType,upload_type:"protobuf_only"}),o("EncryptedBackupsUploadQueueV3").queryMediaRestoreProbe(S);yield I(i,s),C=(f||(f=r("performanceAbsoluteNow")))(),e.endSuccess()}else if(yield T(i,s,v.error,!0),e.endFail(v.error),v.error==="user_device_not_enrolled")return!1}catch(t){var R=r("getErrorSafe")(t);g().MUSTFIX(p||(p=babelHelpers.taggedTemplateLiteralLoose(["Runtime error when doing GraphQL upload, ",""])),R.message),yield T(i,s,R.message,!0),e.endFail("graphql_runtime_error")}return!0}),k.apply(this,arguments)}function I(e,t){return t.forEach(function(e){return o("MAWEBUploadTrackingUtils").endSuccessWorkerOnly(e,"upload_queue_ack_worker_success")}),o("EncryptedBackupsUploadQueueV3").getUploadQueue().ack(e.map(function(e){return e.queueId}))}function T(e,t,n,r){return D.apply(this,arguments)}function D(){return D=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t,n,r){if(t.forEach(function(e){return o("MAWEBUploadTrackingUtils").endFailWorkerOnly(e,"upload_queue_ack_worker_"+(r?"retriable":"non_retriable")+"_error",{string:{error_description:o("MAWEBUploadTrackingUtils").EBUploadTrackingWorkerFailurePoints.FAILED_TO_ACK_MESSAGE,reason:n}})}),r){yield o("EncryptedBackupsUploadQueueV3").getUploadQueue().put(e.map(function(e){return babelHelpers.extends({},e,{attemptCount:e.attemptCount+1})}));return}yield o("EncryptedBackupsUploadQueueV3").getUploadQueue().ack(e.map(function(e){return e.queueId}))}),D.apply(this,arguments)}var x=o("WAJids").createJidUtils({platform:"msgr"});function $(e,t){var n=e.backupDirective.actionType===3?e.backupDirective.originalMsgProtocolId.externalId:o("WAStanzaUtils").toStanzaId(e.messageId),r=x.toUserJid(e.senderId),a=o("WAJids").unsafeCoerceToChatJid(e.threadId),i=r===o("WAGlobals").getMyUserJid()?o("WAJids").AUTHOR_ME:r,l={author:i,chat:a,externalId:n},s=o("EncryptedBackupsCreateAttachmentContext").createAttachmentContext(o("EncryptedBackupsUploadEntity").toEbBackupMessageBytes(e.payload)),u=o("MAWBridgeUpload").createBridgeUploadAttachmentBackupContext(void 0,"msgr",s),c=s.map(function(e){return o("EBGenerateMessageTags").generateEBMessageTags(e.mediaType)}).filter(Boolean);return{actionType:e.backupDirective.actionType===3?2:1,attachmentBackupContext:u,authTs:void 0,echoDocument:void 0,echoEncodingLatencyNs:void 0,errorCode:void 0,errorMessage:void 0,messageId:e.backupDirective.originalMsgProtocolId.externalId,messageType:void 0,protoMsg:{backupActionType:e.backupDirective.actionType,msgId:l,originalMsgProtocolId:e.backupDirective.originalMsgProtocolId,protobuf:o("EncryptedBackupsUploadEntity").toEbBackupMessageBytes(e.payload),senderId:(_||(_=o("I64"))).of_string(o("WAJids").userIdFromJid(r)),serverTs:o("WATimeUtils").castMilliSecondsToUnixTime(e.timestampMs),sortOrderMs:o("WATimeUtils").castToMillisTime(e.timestampMs),supplementalKey:e.backupDirective.supplementalKey,tags:c},sortOrderMs:e.timestampMs,threadId:o("WAJids").threadIdForChatJid(a),traceId:t.toString(),uploadTrackingInstanceKey:t}}l.isUploadTaskScheduled=y,l.getLastSuccessfulAckTimestampMs=b,l.subscribeToUploadQueueUpdates=S}),98);
__d("EBMessageProbeSamplingPreprocessor",["EBMessageProbe","FBLogger","MAWEBLSInWorkerSwitch","MAWProtobufDeserializers","MpsPreprocessor","MpsTypes","WAJids","WATimeUtils","getErrorSafe","gkx"],(function(t,n,r,o,a,i,l){"use strict";function e(e){return e==="deleteForMe"||e==="revoked"}function s(e){var t,n=e.insertionSource,r=e.message,a=o("MAWProtobufDeserializers").DeserializedBackupMessage.create(r.payload),i=(t=a.proto.metadata)==null?void 0:t.timestampMs,l=i!=null?Number(i):r.timestampMs,s=u(a),c=o("WAJids").unsafeCoerceToChatJid(r.threadId);return{chatJid:c,insertionSource:String(n),markers:[],messageId:r.messageId,messageType:s!=null?s:"unknown",timestampMs:o("WATimeUtils").castToMillisTime(l)}}function u(e){var t=e.payload();return(function(e){if((typeof e=="object"&&e!==null||typeof e=="function")&&e.kind==="transportEvent"||(typeof e=="object"&&e!==null||typeof e=="function")&&e.kind==="adminMessage"||(typeof e=="object"&&e!==null||typeof e=="function")&&e.kind==="locallyTransformedMessage")return"unsupported";if((typeof e=="object"&&e!==null||typeof e=="function")&&e.kind==="messageApplication"){var t=e;return(function(e){if((typeof e=="object"&&e!==null||typeof e=="function")&&e.kind==="consumerApplication"){var t=e;return d(t)}if((typeof e=="object"&&e!==null||typeof e=="function")&&e.kind==="armadillo"){var n=e;return c(n)}if(e===void 0)return"unsupported";throw Error("Match: No case succesfully matched. Make exhaustive or add a wildcard case using '_'. Argument: "+e)})(t.subProtocol())}throw Error("Match: No case succesfully matched. Make exhaustive or add a wildcard case using '_'. Argument: "+e)})(t)}function c(e){var t,n=(t=e.payload)==null?void 0:t.content;return(n==null?void 0:n.extendedContentMessage)!=null?"xma":"unsupported"}function d(e){var t,n,r,o=(t=e.payload)==null?void 0:t.content,a=(n=e.payload)==null?void 0:n.applicationData;if((a==null?void 0:a.revoke)!=null)return"revoked";if((o==null?void 0:o.messageText)!=null)return"text";if((o==null?void 0:o.reactionMessage)!=null)return"reaction";if((o==null?void 0:o.editMessage)!=null)return"edit";if(((r=e.attachmentMessage())==null||(r=r.payload)==null||(r=r.ancillary)==null?void 0:r.gifPlayback)===!0)return"gif";var i=e.attachmentMessage();return i!=null?i.kind==="imageTransport"?"image":i.kind==="audioTransport"?"audio":i.kind==="videoTransport"?"video":i.kind==="documentTransport"?"document":i.kind==="stickerTransport"?"sticker":(function(){throw Error("Match: No case succesfully matched. Make exhaustive or add a wildcard case using '_'. Argument: "+i.kind)})():"unsupported"}function m(t){return e(t)?r("gkx")("7963"):!0}function p(e){try{var t=s(e);if(!m(t.messageType))return null;var n=o("EBMessageProbe").getEBMessageProbeInstance();return n.sample(t),n.hasStarted()||n.start(),null}catch(e){return r("getErrorSafe")(e)}}function _(e){return e===o("MpsTypes").ActionType.UpsertTopLevel||e===o("MpsTypes").ActionType.DeleteTopLevel||e===o("MpsTypes").ActionType.DeleteTopLevelWithPlaceholder||e===o("MpsTypes").ActionType.DeleteSupplemental}var f=o("MpsPreprocessor").preprocessor(function(e){var t=e.ctx,n=e.payloadList;return r("MAWEBLSInWorkerSwitch").isEnabled()?n.forEach(function(e){if(_(e.directive.actionType)&&!e.directive.isLocalOnly){var t=p(e);t!=null&&r("FBLogger")("wmi_eb").warn("Failed to sample message for probe: %s",t.message)}}):t.messageToQpl.all().addPoint("eb_message_probe_sampling_skipped"),{ctx:t,errors:new Map,payloadList:n}},"eb_message_probe_sampling");l.isDeleteMessageType=e,l.EBMessageProbeSamplingPreprocessor=f}),98);
__d("EBSenderUploadQueue",["EBMinosLogger","PersistedQueueApi","Promise","WAPersistedQueue","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c=function(t){return t},d=null;function m(){return d==null?p():d}function p(){d!=null&&o("EBMinosLogger").minosLogger.ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["EB Upload Queue is already initialized"])));var t=o("WAPersistedQueue").initPersistedQueue("ebSenderUploadQueueV3",o("PersistedQueueApi").persistedQueueApi());return d=t,t}function _(e){return f.apply(this,arguments)}function f(){return f=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){if(e.length===0)return(u||(u=n("Promise"))).resolve();try{var t=m();yield t.addAndCommit(e)}catch(e){return o("EBMinosLogger").minosLogger.ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Failed to write to ebSenderUploadQueue ",""])),e),(u||(u=n("Promise"))).reject(e)}}),f.apply(this,arguments)}l.toSendersQueueId=c,l.ebSenderUploadQueue=m,l.enqueueMessages=_}),98);
__d("EBWorkerEBDBApi",["EBDB","EBDBConsistencyApi","EBLS","LSAuthorityLevel","LSEncryptedBackupsBackupTenancy","WALogger","WAResolvable","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e,s=new(o("WAResolvable")).Resolvable;function u(){return c.apply(this,arguments)}function c(){return c=n("asyncToGeneratorRuntime").asyncToGenerator(function*(){var t=yield o("EBLS").genLSClient();try{yield o("EBDBConsistencyApi").startListeningDeviceRegistrations(t.db,o("EBDB").EBDBEnvironment.Worker)}catch(t){o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Error on EBDB init in Worker: ",""])),t)}finally{s.resolve(t.db)}}),c.apply(this,arguments)}function d(e){return m.apply(this,arguments)}function m(){return m=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){yield o("EBDBConsistencyApi").trackOverprompting(o("EBDB").EBDBEnvironment.Worker,e)}),m.apply(this,arguments)}function p(e){return _.apply(this,arguments)}function _(){return _=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=yield s.promise;yield o("EBDBConsistencyApi").addNewDevice(t,o("EBDB").EBDBEnvironment.Worker,e)}),_.apply(this,arguments)}function f(e){return g.apply(this,arguments)}function g(){return g=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=yield s.promise;return o("EBDBConsistencyApi").trackConsistency(t,o("EBDB").EBDBEnvironment.Worker,e),o("EBDBConsistencyApi").getDeviceId()}),g.apply(this,arguments)}function h(){return y.apply(this,arguments)}function y(){return y=n("asyncToGeneratorRuntime").asyncToGenerator(function*(){var e=yield o("EBDB").getEBDB(),t=yield e.store("secure_encrypted_backups_client_state").readAll();return t[0]}),y.apply(this,arguments)}function C(){return b.apply(this,arguments)}function b(){return b=n("asyncToGeneratorRuntime").asyncToGenerator(function*(){var e=yield o("EBDB").getEBDB(),t=yield e.store("secure_encrypted_backups_client_state").readAll();if((t==null?void 0:t.length)===0)return!1;var n=t[0],a=n.authorityLevel,i=n.backupTenancy;if(a==null)return!1;var l=i!=null?i:r("LSEncryptedBackupsBackupTenancy").PRODUCTION;return Number(l)===r("LSEncryptedBackupsBackupTenancy").PRODUCTION&&Number(a)===r("LSAuthorityLevel").AUTHORITATIVE}),b.apply(this,arguments)}l.startListeningEBDeviceRegistrations=u,l.trackOverprompting=d,l.addNewDevice=p,l.trackConsistency=f,l.getSecureEBClientState=h,l.isEBEnabledEBDB=C}),98);
__d("EncryptedBackupTaskFailureFalcoEvent",["FalcoLoggerInternal","getFalcoLogPolicy_DO_NOT_USE"],(function(t,n,r,o,a,i,l){"use strict";var e=r("getFalcoLogPolicy_DO_NOT_USE")("5725"),s=o("FalcoLoggerInternal").create("encrypted_backup_task_failure",e),u=s;l.default=u}),98);
__d("EncryptedBackupTaskIssuedFalcoEvent",["FalcoLoggerInternal","getFalcoLogPolicy_DO_NOT_USE"],(function(t,n,r,o,a,i,l){"use strict";var e=r("getFalcoLogPolicy_DO_NOT_USE")("5726"),s=o("FalcoLoggerInternal").create("encrypted_backup_task_issued",e),u=s;l.default=u}),98);
__d("LSWriteSupplementalMessage",["LSLogMebClientEvent.nop"],(function(t,n,r,o,a,i){function e(){var e=arguments,t=e[e.length-1],r=[],o=[];return t.sequence([function(a){return t.sequence([function(n){return r[0]=t.i64.of_float(Date.now()),(function(e){t.logger(e).info(e)})("[EncryptedBackups][writeSupplementalMessage] Beginning execution."),r[1]=t.i64.of_float(Date.now()),t.filter(t.db.table(302).fetch(),function(t){return t.threadId===e[1]&&t.toplevelOfflineThreadingId===e[2]&&t.supplementalKey===e[3]}).next().then(function(e,t){var n=e.done,o=e.value;return n?r[2]=void 0:(t=o.item,r[2]=t.messageTimestampMs)})},function(n){return t.i64.neq(r[2],void 0)?t.sequence([function(n){var o;return t.i64.gt(r[2],e[5])?t.resolve((o=[!1,t.i64.cast([0,851])],r[12]=o[0],r[13]=o[1],o)):t.sequence([function(n){return t.forEach(t.filter(t.db.table(302).fetch(),function(t){return t.threadId===e[1]&&t.toplevelOfflineThreadingId===e[2]&&t.supplementalKey===e[3]}),function(e){return e.delete()})},function(n){return t.db.table(302).add({pk:void 0,messagePayload:e[0],threadId:e[1],toplevelOfflineThreadingId:e[2],supplementalKey:e[3],offlineThreadingId:e[4],messageTimestampMs:e[5]})},function(e){var t;return t=[!0,void 0],r[12]=t[0],r[13]=t[1],t}])},function(e){var t;return t=[r[12],r[13]],r[4]=t[0],r[5]=t[1],t}]):t.sequence([function(n){return t.forEach(t.filter(t.db.table(302).fetch(),function(t){return t.threadId===e[1]&&t.toplevelOfflineThreadingId===e[2]&&t.supplementalKey===e[3]}),function(e){return e.delete()})},function(n){return t.db.table(302).add({pk:void 0,messagePayload:e[0],threadId:e[1],toplevelOfflineThreadingId:e[2],supplementalKey:e[3],offlineThreadingId:e[4],messageTimestampMs:e[5]})},function(e){var t;return t=[!0,void 0],r[4]=t[0],r[5]=t[1],t}])},function(e){return r[6]=t.i64.of_float(Date.now()),r[7]=t.i64.random(),r[9]="Finishing execution. Execution time: ",r[10]=t.i64.to_string(t.i64.sub(r[6],r[0])),r[11]=" ms",r[8]="",(function(e){t.logger(e).info(e)})(["[EncryptedBackups][writeSupplementalMessage] ",r[8],r[9],r[8],r[10],r[8],r[11]].join("")),t.i64.eq(t.i64.mod_(r[7],t.i64.cast([0,1e3])),t.i64.cast([0,0]))?(r[12]=",",r[13]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"writeSupplementalMessage",[r[9],r[12],r[10],r[12],r[11]].join(""),r[13],t.i64.cast([0,4]))):t.resolve()},function(e){var t;return t=[r[4],r[5]],o[0]=t[0],o[1]=t[1],t}])},function(e){return t.resolve(o)}])}e.__sproc_name__="LSMPSWriteSupplementalMessageStoredProcedure",e.__tables__=["local_message_persistence_store_supplemental"],a.exports=e}),null);
__d("LSWriteSupplementalMessageStoredProcedure",["LSSynchronousPromise","LSWriteSupplementalMessage","Promise","cr:8709"],(function(t,n,r,o,a,i,l){var e;function s(t,a){var i=t.storedProcedure(r("LSWriteSupplementalMessage"),a.messagePayload,a.threadId,a.toplevelOfflineThreadingId,a.supplementalKey,a.offlineThreadingId,a.messageTimestampMs);return(e||(e=n("Promise"))).resolve(o("LSSynchronousPromise").maybeExtractValueIfSynchronousPromise(i))}l.default=s}),98);
__d("LSWriteTopLevelMessage",["LSLogMebClientEvent.nop"],(function(t,n,r,o,a,i){function e(){var e=arguments,t=e[e.length-1],r=[],o=[];return t.sequence([function(a){return t.sequence([function(n){return r[0]=t.i64.of_float(Date.now()),(function(e){t.logger(e).info(e)})("[EncryptedBackups][writeTopLevelMessage] Beginning execution."),r[1]=t.i64.of_float(Date.now()),t.filter(t.db.table(301).fetch(),function(t){return t.threadId===e[1]&&t.offlineThreadingId===e[2]}).next().then(function(e,t){var n=e.done,o=e.value;return n?r[2]=void 0:(t=o.item,r[2]=t.messageTimestampMs)})},function(n){return t.i64.neq(r[2],void 0)?t.sequence([function(n){var o;return t.i64.gt(r[2],e[3])?t.resolve((o=[!1,t.i64.cast([0,851])],r[12]=o[0],r[13]=o[1],o)):t.sequence([function(n){return t.filter(t.db.table(303).fetch(),function(t){return t.threadId===e[1]&&t.offlineThreadingId===e[2]}).next().then(function(e,t){var n=e.done,o=e.value;return n?r[14]=!1:(t=o.item,r[14]=!0)})},function(n){return r[14]?t.sequence([function(n){return t.forEach(t.filter(t.db.table(303).fetch(),function(t){return t.threadId===e[1]&&t.offlineThreadingId===e[2]}),function(t){var n=t.update,r=t.item;return n({deletedMessagePayload:e[0],isLocalOnlyMessage:e[4],messageTimestampMs:e[3]})})},function(n){return t.forEach(t.filter(t.db.table(301).fetch(),function(n){return n.threadId===e[1]&&n.offlineThreadingId===e[2]&&t.i64.eq(n.messageTimestampMs,t.i64.cast([-1,4294967295]))}),function(t){var n=t.update,r=t.item;return n({messageTimestampMs:e[3]})})},function(e){var n;return n=[!1,t.i64.cast([0,852])],r[16]=n[0],r[17]=n[1],n}]):t.sequence([function(n){return t.forEach(t.filter(t.db.table(301).fetch(),function(t){return t.threadId===e[1]&&t.offlineThreadingId===e[2]}),function(e){return e.delete()})},function(n){return t.db.table(301).add({pk:void 0,messagePayload:e[0],threadId:e[1],offlineThreadingId:e[2],messageTimestampMs:e[3],isLocalOnlyMessage:e[4],extraData:e[5]})},function(e){var t;return t=[!0,void 0],r[16]=t[0],r[17]=t[1],t}])},function(e){var t;return t=[r[16],r[17]],r[12]=t[0],r[13]=t[1],t}])},function(e){var t;return t=[r[12],r[13]],r[4]=t[0],r[5]=t[1],t}]):t.sequence([function(n){return t.filter(t.db.table(303).fetch(),function(t){return t.threadId===e[1]&&t.offlineThreadingId===e[2]}).next().then(function(e,t){var n=e.done,o=e.value;return n?r[12]=!1:(t=o.item,r[12]=!0)})},function(n){return r[12]?t.sequence([function(n){return t.forEach(t.filter(t.db.table(303).fetch(),function(t){return t.threadId===e[1]&&t.offlineThreadingId===e[2]}),function(t){var n=t.update,r=t.item;return n({deletedMessagePayload:e[0],isLocalOnlyMessage:e[4],messageTimestampMs:e[3]})})},function(n){return t.forEach(t.filter(t.db.table(301).fetch(),function(n){return n.threadId===e[1]&&n.offlineThreadingId===e[2]&&t.i64.eq(n.messageTimestampMs,t.i64.cast([-1,4294967295]))}),function(t){var n=t.update,r=t.item;return n({messageTimestampMs:e[3]})})},function(e){var n;return n=[!1,t.i64.cast([0,852])],r[14]=n[0],r[15]=n[1],n}]):t.sequence([function(n){return t.forEach(t.filter(t.db.table(301).fetch(),function(t){return t.threadId===e[1]&&t.offlineThreadingId===e[2]}),function(e){return e.delete()})},function(n){return t.db.table(301).add({pk:void 0,messagePayload:e[0],threadId:e[1],offlineThreadingId:e[2],messageTimestampMs:e[3],isLocalOnlyMessage:e[4],extraData:e[5]})},function(e){var t;return t=[!0,void 0],r[14]=t[0],r[15]=t[1],t}])},function(e){var t;return t=[r[14],r[15]],r[4]=t[0],r[5]=t[1],t}])},function(e){return r[6]=t.i64.of_float(Date.now()),r[7]=t.i64.random(),r[9]="Finishing execution. Execution time: ",r[10]=t.i64.to_string(t.i64.sub(r[6],r[0])),r[11]=" ms",r[8]="",(function(e){t.logger(e).info(e)})(["[EncryptedBackups][writeTopLevelMessage] ",r[8],r[9],r[8],r[10],r[8],r[11]].join("")),t.i64.eq(t.i64.mod_(r[7],t.i64.cast([0,1e3])),t.i64.cast([0,0]))?(r[12]=",",r[13]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"writeTopLevelMessage",[r[9],r[12],r[10],r[12],r[11]].join(""),r[13],t.i64.cast([0,4]))):t.resolve()},function(e){var t;return t=[r[4],r[5]],o[0]=t[0],o[1]=t[1],t}])},function(e){return t.resolve(o)}])}e.__sproc_name__="LSMPSWriteTopLevelMessageStoredProcedure",e.__tables__=["local_message_persistence_store","local_message_persistence_store_deleted_messages"],a.exports=e}),null);
__d("LSWriteTopLevelMessageStoredProcedure",["LSSynchronousPromise","LSWriteTopLevelMessage","Promise","cr:8709"],(function(t,n,r,o,a,i,l){var e;function s(t,a){var i=t.storedProcedure(r("LSWriteTopLevelMessage"),a.messagePayload,a.threadId,a.offlineThreadingId,a.messageTimestampMs,a.isLocalOnlyMessage,a.extraData);return(e||(e=n("Promise"))).resolve(o("LSSynchronousPromise").maybeExtractValueIfSynchronousPromise(i))}l.default=s}),98);
__d("MessageBackupTagsDelimiter",[],(function(t,n,r,o,a,i){"use strict";var e=":";i.INSTAMADILLO_TAG_DELIMITER=e}),66);
__d("EncryptedBackupsWriteToMPSTables",["EncryptedBackupsUploadEntity","FBLogger","I64","IGDWEBUploadMessageUtils","LSFactory","LSWriteSupplementalMessageStoredProcedure","LSWriteTopLevelMessageStoredProcedure","MessageBackupTagsDelimiter","WAErrorMessage","WAResultOrError","asyncToGeneratorRuntime","getSafeQplErrorMessage","promiseDone","requireDeferred"],(function(t,n,r,o,a,i,l){"use strict";var e,s=r("requireDeferred")("ReverbWriteFailureFalcoEvent").__setRef("EncryptedBackupsWriteToMPSTables"),u=r("requireDeferred")("ReverbWriteSuccessFalcoEvent").__setRef("EncryptedBackupsWriteToMPSTables");function c(e,t,n,o,a,i){o?r("promiseDone")(u.load(),function(r){return r.log(function(){return{backup_action:n,backup_protocol:a,labyrinth_version:0,message_id:e,thread_id:t}})}):r("promiseDone")(s.load(),function(r){return r.log(function(){return{backup_action:n,backup_protocol:a,failure_reason:i,labyrinth_version:0,message_id:e,thread_id:t}})})}function d(e,t,n,r,o){return m.apply(this,arguments)}function m(){return m=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t,n,a,i,l){var s=n.backupActionType,u=n.instamadilloItemId,d=n.msgId,m=n.originalMsgProtocolId,p=n.protobuf,_=n.serverTs,f=n.sortOrderMs,g=n.supplementalKey;l==null||l.addPoint("mps_tables_write_start");var h=d.externalId,y=m==null?void 0:m.externalId,C=u!=null?u:f;if(C==null)return l==null||l.addPoint("mps_tables_write_missing_protobuf_ts"),o("WAResultOrError").makeError({errorCode:null,errorMsg:"protobufTimestampMs is null when writing to MPS tables"});var b=(e||(e=o("I64"))).of_float(C),v=!1,S=i?"dual_upload":"open_eb_ttlc",R=null;switch(s){case 1:{l==null||l.addPoint("mps_top_level_write_start");try{var L=yield r("LSWriteTopLevelMessageStoredProcedure")(r("LSFactory")(t),{isLocalOnlyMessage:!1,messagePayload:o("EncryptedBackupsUploadEntity").getEbBackupMessageBytesBuffer(p),messageTimestampMs:b,offlineThreadingId:h,threadId:a}),E=L[0],k=L[1];R=k,E&&(v=!0),c(h,a,"upsert_top_level",E,S),l==null||l.addPoint("mps_top_level_write",{bool:{mps_top_level_write_succesful:E}})}catch(e){c(h,a,"upsert_top_level",!1,S,o("WAErrorMessage").maybeGetMessageFromError(e)),l==null||l.addPoint("mps_top_level_write_error",{string:{mps_top_level_write_error:o("getSafeQplErrorMessage").getSafeQPLErrorMessage(e)}})}break}case 2:{if(l==null||l.addPoint("mps_supplemental_write_start"),y==null||g==null)c(h,a,"upsert_supplemental",!1,S),r("FBLogger")("wmi_eb").warn("Missing toplevelOfflineThreadingId or supplementalKey when writing to MPS tables");else try{var I=yield r("LSWriteSupplementalMessageStoredProcedure")(r("LSFactory")(t),{messagePayload:o("EncryptedBackupsUploadEntity").getEbBackupMessageBytesBuffer(p),messageTimestampMs:b,offlineThreadingId:h,supplementalKey:g,threadId:a,toplevelOfflineThreadingId:y}),T=I[0],D=I[1];R=D,T&&(v=!0),c(h,a,"upsert_supplemental",T,S),l==null||l.addPoint("mps_supplemental_write",{bool:{mps_supplemental_write_successful:T}})}catch(e){c(h,a,"upsert_supplemental",!1,S,o("WAErrorMessage").maybeGetMessageFromError(e)),l==null||l.addPoint("mps_supplemental_write_error",{string:{mps_supplemental_write_error:o("getSafeQplErrorMessage").getSafeQPLErrorMessage(e)}})}break}case 4:{if(l==null||l.addPoint("mps_delete_top_level_with_placeholder_write_start"),y==null)break;try{var x=yield r("LSWriteTopLevelMessageStoredProcedure")(r("LSFactory")(t),{isLocalOnlyMessage:!1,messagePayload:o("EncryptedBackupsUploadEntity").getEbBackupMessageBytesBuffer(p),messageTimestampMs:(e||(e=o("I64"))).of_float(o("IGDWEBUploadMessageUtils").generateProtobufServerTs(y,_)),offlineThreadingId:h,threadId:a}),$=x[0],P=x[1];R=P,$&&(v=!0),c(y,a,"delete_top_level",$,S),l==null||l.addPoint("mps_delete_top_level_with_placeholder_write",{bool:{mps_delete_top_level_with_placeholder_write_successful:$}})}catch(e){c(y,a,"delete_top_level_with_placeholder",!1,S,o("WAErrorMessage").maybeGetMessageFromError(e)),l==null||l.addPoint("mps_delete_top_level_with_placeholder_write_error",{string:{mps_delete_top_level_with_placeholder_write_error:o("getSafeQplErrorMessage").getSafeQPLErrorMessage(e)}})}break}case 3:v=!0,y!=null&&c(y,a,"delete_top_level",!1,S);break;default:l==null||l.addPoint("mps_write_unsupported_backup_action_type"),r("FBLogger")("wmi_eb").warn("Unsupported backupActionType when writing to MPS tables")}return v?(l==null||l.addPoint("mps_write_successful"),o("WAResultOrError").makeResult(v)):(l==null||l.addPoint("mps_write_unsuccessful"),o("WAResultOrError").makeError({errorCode:R,errorMsg:"Unsuccessful writing to MPS tables"}))}),m.apply(this,arguments)}function p(e,t,n){return _.apply(this,arguments)}function _(){return _=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t,n,r){var a=n.msgId,i=n.sortOrderMs,l=n.tags;l!=null&&l.length!==0&&i!=null&&(yield t.local_message_persistence_store_tag_index.put({localMessagePersistenceStoreKey:(e||(e=o("I64"))).of_string(a.externalId),messageTimestampMs:e.of_float(i),offlineThreadingId:a.externalId,tag:l.join(o("MessageBackupTagsDelimiter").INSTAMADILLO_TAG_DELIMITER),threadId:r}))}),_.apply(this,arguments)}l.writeToMPSTables=d,l.writeTagsToMPSTables=p}),98);
__d("LSEBPayloadSerializerError",[],(function(t,n,r,o,a,i){var e=Object.freeze({INVALID_BACKUP_OPERATION:-7,INVALID_CONTENT_TYPE:-6,INVALID_PAYLOAD_FORMAT:-5,CQL_DB_ERROR:-4,REQUIRED_COLUMN_NOT_PRESENT_ON_CLIENT:-3,DEPRECATED_SPROC:-2,UNKNOWN_ERROR:-1,NOT_AN_ERROR:0,BACKUP_NOT_FOUND:1,REQUIRED_TABLE_NOT_FOUND:2,NATIVE_OP_NOT_FOUND:3,BACKUP_UPLOAD_KILLSWITCHED:4,TASK_ID_NOT_FOUND:5,NOT_IMPLEMENTED:6,NOT_SUPPORTED_ON_WEB:7,DUPLICATE_TASK:8,CLIENT_STATE_NOT_LOADED:9,RECOVERY_CODE_NOT_FOUND:10,EPOCH_KEYS_NOT_FOUND:11,DEVICE_PAYLOAD_NOT_CREATED:12,NULL_DEVICE_PAYLOAD:13,EPOCH_PAYLOAD_NOT_CREATED:14,NULL_EPOCH_PAYLOAD:15,VIRTUAL_DEVICE_PAYLOAD_NOT_CREATED:16,NULL_VIRTUAL_DEVICE_PAYLOAD:17,DEVICE_METADATA_NOT_FOUND:18,NO_MATCHING_DEVICE_PUBLIC_KEY:19,NULL_MAILBOX_ROOT_KEY:20,NULL_ENCRYPTION_VERSION:21,NULL_OCMF_KEY:22,NULL_EPOCH_KEYS:23,NULL_DEVICE_ID:24,OPE_KEY_DERIVATION_FAILED:25,MESSAGE_KEY_DERIVATION_FAILED:26,NULL_MAILBOX_ROOT_KEY_V2:27,ECHO_DOCUMENT_ENCODING_FAILED:30,ECHO_PAYLOAD_CREATION_DISABLED:31,ECHO_DOCUMENT_ENCODING_SKIPPED:32,MESSAGE_PAYLOAD_ENCRYPTION_FAILED:40,SERVER_THREAD_ID_NOT_FOUND_FOR_JID:52,UNKNOWN_PROTOBUF_TYPE:60,SUPPLEMENTARY_DATA_KEY_UNEXPECTED:61,PROTOBUF_ENCRYPTION_FAILED:62,PROTOBUF_NOT_FOUND_IN_TOPLEVEL_TABLE:63,PROTOBUF_NOT_FOUND_IN_SUPPLEMENTAL_TABLE:64,SUPPLEMENTAL_KEY_NOT_SET_IN_CONTEXT_TABLE:65,SUPPLEMENTAL_ENCRYPTION_FAILED:66,PROTOBUF_CONTEXT_ROW_NOT_FOUND:67,PROTOBUF_FORMATTING_FAILED:68,SUPPLEMENTAL_FORMATTING_FAILED:69,PROTOBUF_ALREADY_DELETED:70,PROTOBUF_NOT_FOUND_IN_DELETED_MESSAGES_TABLE:71,DELETION_PROTOBUF_IS_NULL:72,PROTOBUF_PAYLOAD_IN_CONTEXT_ROW_IS_NOT_FOUND:73,PROTOBUF_ENCRYPTION_FAILED_RETRYABLE:74,VALUE_SECRET_REF_INVALID:75,MINOS_ENCRYPTION_RESULT_NULL:76,SUPPLEMENTAL_OTID_NOT_SET_IN_CONTEXT_TABLE:77,SNAPSHOT_NOT_FOUND_FAILURE:78,THREAD_PK_NOT_FOUND_FOR_JID:100,MESSAGE_DECRYPTION_FAILED:101,EPOCH_KEY_FETCH_FAILED:102,TOO_MANY_OPEN_EPOCHS:103,MESSAGE_RANGE_PREPARE_FAILURE:104,ECHO_DOCUMENT_RESTORE_FAILED:105,MISMATCH_POINT_QUERY_MESSAGE_AND_RANGE_LENGTH:106,INITIAL_THREADS_FETCH_FOR_RESTORE_FAILED:107,MISSING_SUPPLEMENTAL_KEY_CIPHERTEXT:108,SUPPLEMENTAL_KEY_DECRYPTION_FAILURE:109,DEVICE_ID_MISMATCH:110,RESTORE_TO_TAM_INFO:111,MISSING_SERVER_THREAD_KEY:112,EB_ADD_DEVICE_FOUND_NO_LOCAL_THREADS:113,EB_MORE_THREADS_IN_MAPPING_TABLE:114,RESTORE_INTEGRITY_CHECK_FAILED:115,RESTORE_TOP_LEVEL_PROTOBUF_NULL:116,DECRYPT_MINOS_PROTOBUF_FAILURE:117,MESSAGE_PK_NOT_FOUND_IN_CLIENT_MESSAGES:200,OTID_NOT_FOUND_IN_ACT_MESSAGES:201,THREAD_ID_NOT_FOUND_IN_ACT_THREADS:202,THREAD_PK_NOT_FOUND_IN_CLIENT_THREADS:203,FAILED_TO_GET_THREAD_SORT_KEY:204,MEDIA_INFO_INVALID:205,REVERB_DB_NOT_ENABLED_FOR_INSTAMADILLO:206,SKIPPED_EB_DISABLED:300,SKIPPED_THREAD_NOT_ELIGIBLE:301,SKIPPED_MESSAGE_NOT_ELIGIBLE:302,NO_EPOCHS_FOUND:400,LATEST_EPOCH_QUERY_BY_ID_FAILED:401,FOUND_EPOCH_WITH_NULL_ROOT_KEY:402,FOUND_EPOCH_WITH_NULL_ANON_ID:403,NO_RECOVERY_CODE:501,NO_ERROR:601,ERROR_GENERAL:602,UNKNOWN:603,ONBOARDING_MATERIAL_DERIVATION_FAILURE:604,NULL_DEVICE_HMAC:605,MISSING_LATEST_EPOCH_AT_ONBOARDING:606,EPOCH_REPAIR_UNREACHABLE_EPOCH:607,NO_THREADS_TO_COMPARE:701,START_SORT_KEY_FAILURE:702,END_SORT_KEY_FAILURE:703,LOOPING_UPLOAD_PAYLOAD_NOT_FOUND:704,NULL_ECHO_IDENTIFIERS:705,ECHO_TIMESTAMP_CONVERSION_FAILED:706,ECHO_PROTOBUF_THREAD_ID_MISMATCH:707,ECHO_PROTOBUF_TIMESTAMP_MISMATCH:708,ECHO_PROTOBUF_OTID_MISMATCH:709,NULL_ECHO_DOCUMENT:710,INVALID_PROTOBUF_BACKUP_ACTION:711,EMPTY_ENCODED_ECHO_DOCUMENT:712,LOOPING_UPLOAD_TASK_QUEUE_FULL:713,ECHO_DOCUMENT_ENCODING_UNKNOWN_ENCODING_ERROR:750,ECHO_DOCUMENT_ENCODING_MESSAGE_PK_NOT_FOUND_ERROR:751,ECHO_DOCUMENT_ENCODING_DISK_WRITE_CHECK_FAILED:752,ECHO_DOCUMENT_ENCODING_THREAD_TRANSPORT_ID_FETCH_FAILED:753,ECHO_DOCUMENT_ENCODING_FILE_WRITE_FAILED:754,ECHO_DOCUMENT_ENCODING_DISK_WRITE_DISABLED:755,ECHO_DOCUMENT_ENCODING_SHOULD_NOT_PERSIST:756,MISSING_SUPPLEMENTAL_DATA:757,ECHO_DOCUMENT_ENCODING_MESSAGE_FIELDS_REPLY_PROXY_ERROR:758,ECHO_DOCUMENT_ENCODING_MESSAGE_FIELDS_EDIT_MESSAGE_QUERY_ERROR:759,ECHO_DOCUMENT_ENCODING_MESSAGE_FIELDS_EDIT_MESSAGE_ERROR:760,ECHO_DOCUMENT_ENCODING_MESSAGE_FIELDS_RECEIPTS_ERROR:761,ECHO_DOCUMENT_ENCODING_MESSAGE_FIELDS_REACTIONS_ERROR:762,ECHO_DOCUMENT_ENCODING_MESSAGE_FIELDS_VISUAL_MESSAGE_ACTIONS_ERROR:763,ECHO_DOCUMENT_ENCODING_MESSAGE_FIELDS_POLLS_ERROR:764,READ_CLIENT_STATE_FROM_MAIN_DB_ERROR:801,NOT_SUPPORTED_ON_MAIN_DB:802,SKIP_MPS_WRITE_DUE_TO_HIGHER_TIMESTAMP_AVAILABILITY:851,MESSAGE_ALREADY_DELETED:852});i.default=e}),66);
__d("MAWTraceUtils",["LSDataTraceTag","LSRequestId","MAWMsgType"],(function(t,n,r,o,a,i,l){"use strict";var e="backup_upload",s="media_backup",u="vesta_registration",c="vesta_login";function d(){return r("LSRequestId").generate()}function m(e){return e}function p(e){switch(e){case o("MAWMsgType").MSG_TYPE.TEXT:return o("LSDataTraceTag").messageTypeText;case o("MAWMsgType").MSG_TYPE.FUTUREPROOF:return o("LSDataTraceTag").messageTypeFutureproof;case o("MAWMsgType").MSG_TYPE.CIPHERTEXT:return o("LSDataTraceTag").messageTypeCiphertext;case o("MAWMsgType").MSG_TYPE.UNAVAILABLE:return o("LSDataTraceTag").messageTypeUnavailable;case o("MAWMsgType").MSG_TYPE.IMAGE:return o("LSDataTraceTag").messageTypeImage;case o("MAWMsgType").MSG_TYPE.VIDEO:return o("LSDataTraceTag").messageTypeVideo;case o("MAWMsgType").MSG_TYPE.PTT:return o("LSDataTraceTag").messageTypePtt;case o("MAWMsgType").MSG_TYPE.ADMIN:return o("LSDataTraceTag").messageTypeAdmin;case o("MAWMsgType").MSG_TYPE.REVOKED:return o("LSDataTraceTag").messageTypeRevoked;case o("MAWMsgType").MSG_TYPE.GIF:return o("LSDataTraceTag").messageTypeGif;case o("MAWMsgType").MSG_TYPE.STICKER:return o("LSDataTraceTag").messageTypeSticker;case o("MAWMsgType").MSG_TYPE.EXPIRED_EPHEMERAL:return o("LSDataTraceTag").messageTypeExpiredEphemeral;case o("MAWMsgType").MSG_TYPE.EPHEMERAL_SETTING_ADMIN:return o("LSDataTraceTag").messageTypeEphemeralSettingAdmin;case o("MAWMsgType").MSG_TYPE.EPHEMERAL_SYNC_RESPONSE:return o("LSDataTraceTag").messageTypeEphemeralSyncResponse;case o("MAWMsgType").MSG_TYPE.EPHEMERAL_SCREENSHOT_ACTION:return o("LSDataTraceTag").messageTypeEphemeralScreenshotAction;case o("MAWMsgType").MSG_TYPE.DELETE_FOR_ME:return o("LSDataTraceTag").messageTypeDeleteForMe;case o("MAWMsgType").MSG_TYPE.EPHEMERAL_SETTING_CHANGE_FROM_CURRENT_DEVICE:return o("LSDataTraceTag").messageTypeEphemeralSettingChangeFromCurrentDevice;case o("MAWMsgType").MSG_TYPE.ICDC_ALERT:return o("LSDataTraceTag").messageTypeAlertICDC;case o("MAWMsgType").MSG_TYPE.GROUP_INVITE:return o("LSDataTraceTag").messageTypeGroupInvite;case o("MAWMsgType").MSG_TYPE.XMA:return o("LSDataTraceTag").messageTypeXMA;case o("MAWMsgType").MSG_TYPE.REACTION:return o("LSDataTraceTag").messageTypeReaction;case o("MAWMsgType").MSG_TYPE.SK_DISTRIBUTION:return o("LSDataTraceTag").messageTypeSenderKeyDistribution;default:return o("LSDataTraceTag").messageTypeNone}}l.CONTEXT_BACKUP_UPLOAD=e,l.CONTEXT_MEDIA_BACKUP=s,l.CONTEXT_VESTA_REGISTRATION=u,l.CONTEXT_VESTA_LOGIN=c,l.createTraceId=d,l.stringToTraceId=m,l.getTagForMsgType=p}),98);
__d("WACryptoCurve25519Dependencies",["Promise","WACryptoPrimitives","WASignalKeys","WASignalOther"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(){return(e||(e=n("Promise"))).resolve().then(function(){return o("WASignalKeys").makeKeyPair()})}function u(t,r){return(e||(e=n("Promise"))).resolve().then(function(){return o("WACryptoPrimitives").scalarMult(o("WASignalOther").ensureSize(r,32),o("WASignalOther").ensureSize(t,32)).buffer})}var c={generateIdentityKeyPair:s,calculateAgreement:u};l.calculateAgreement=u,l.CURVE25519_SIGNAL_DEPENDENCIES=c}),98);
__d("WASmaxInPreKeysIQErrorItemNotFoundMixin",["WAResultOrError","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e){var t=o("WASmaxParseUtils").assertTag(e,"error");if(!t.success)return t;var n=o("WASmaxParseUtils").literal(o("WASmaxParseUtils").attrString,e,"text","item-not-found");if(!n.success)return n;var r=o("WASmaxParseUtils").literal(o("WASmaxParseUtils").attrInt,e,"code",404);return r.success?o("WAResultOrError").makeResult({text:n.value,code:r.value}):r}l.parseIQErrorItemNotFoundMixin=e}),98);
__d("WASmaxInPreKeysRequestErrorsFetchDigest",["WAResultOrError","WASmaxInPreKeysIQErrorFallbackClientMixin","WASmaxInPreKeysIQErrorItemNotFoundMixin","WASmaxInPreKeysIQErrorNotAcceptableMixin","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e){var t=o("WASmaxInPreKeysIQErrorNotAcceptableMixin").parseIQErrorNotAcceptableMixin(e);if(t.success)return o("WAResultOrError").makeResult({name:"IQErrorNotAcceptable",value:t.value});var n=o("WASmaxInPreKeysIQErrorItemNotFoundMixin").parseIQErrorItemNotFoundMixin(e);if(n.success)return o("WAResultOrError").makeResult({name:"IQErrorItemNotFound",value:n.value});var r=o("WASmaxInPreKeysIQErrorFallbackClientMixin").parseIQErrorFallbackClientMixin(e);return r.success?o("WAResultOrError").makeResult({name:"IQErrorFallbackClient",value:r.value}):o("WASmaxParseUtils").errorMixinDisjunction(e,["IQErrorNotAcceptable","IQErrorItemNotFound","IQErrorFallbackClient"],[t,n,r])}l.parseRequestErrorsFetchDigest=e}),98);
__d("WASmaxInPreKeysFetchDigestResponseRequestError",["WAResultOrError","WASmaxInPreKeysIQErrorResponseMixin","WASmaxInPreKeysRequestErrorsFetchDigest","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e,t){var n=o("WASmaxParseUtils").assertTag(e,"iq");if(!n.success)return n;var r=o("WASmaxParseUtils").flattenedChildWithTag(e,"error");if(!r.success)return r;var a=o("WASmaxInPreKeysIQErrorResponseMixin").parseIQErrorResponseMixin(e,t);if(!a.success)return a;var i=o("WASmaxInPreKeysRequestErrorsFetchDigest").parseRequestErrorsFetchDigest(r.value);return i.success?o("WAResultOrError").makeResult(babelHelpers.extends({},a.value,{errorRequestErrorsFetchDigest:i.value})):i}l.parseFetchDigestResponseRequestError=e}),98);
__d("WASmaxInPreKeysFetchDigestResponseServerError",["WAResultOrError","WASmaxInPreKeysIQErrorResponseMixin","WASmaxInPreKeysServerErrors","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e,t){var n=o("WASmaxParseUtils").assertTag(e,"iq");if(!n.success)return n;var r=o("WASmaxParseUtils").flattenedChildWithTag(e,"error");if(!r.success)return r;var a=o("WASmaxInPreKeysIQErrorResponseMixin").parseIQErrorResponseMixin(e,t);if(!a.success)return a;var i=o("WASmaxInPreKeysServerErrors").parseServerErrors(r.value);return i.success?o("WAResultOrError").makeResult(babelHelpers.extends({},a.value,{errorServerErrors:i.value})):i}l.parseFetchDigestResponseServerError=e}),98);
__d("WASmaxInPreKeysKeysHashMixin",["WAResultOrError","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e){var t=o("WASmaxParseUtils").flattenedChildWithTag(e,"hash");if(!t.success)return t;var n=o("WASmaxParseUtils").contentBytesRange(t.value,20,20);return n.success?o("WAResultOrError").makeResult({hashElementValue:n.value}):n}l.parseKeysHashMixin=e}),98);
__d("WASmaxInPreKeysPreKeyIDListMixin",["WAResultOrError","WASmaxInPreKeysKeyIDMixin","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e){var t=o("WASmaxParseUtils").assertTag(e,"id");if(!t.success)return t;var n=o("WASmaxInPreKeysKeyIDMixin").parseKeyIDMixin(e);return n.success,n}function s(t){var n=o("WASmaxParseUtils").flattenedChildWithTag(t,"list");if(!n.success)return n;var r=o("WASmaxParseUtils").mapChildrenWithTag(n.value,"id",0,2e4,e);return r.success?o("WAResultOrError").makeResult({listId:r.value}):r}l.parsePreKeyIDListListId=e,l.parsePreKeyIDListMixin=s}),98);
__d("WASmaxInPreKeysIdentityDigestBundleMixin",["WAResultOrError","WASmaxInPreKeysIdentityKeyMixin","WASmaxInPreKeysKeyTypeMixin","WASmaxInPreKeysKeysHashMixin","WASmaxInPreKeysPreKeyIDListMixin","WASmaxInPreKeysRegistrationIDMixin","WASmaxInPreKeysSignedPreKeyMixin"],(function(t,n,r,o,a,i,l){function e(e){var t=o("WASmaxInPreKeysRegistrationIDMixin").parseRegistrationIDMixin(e);if(!t.success)return t;var n=o("WASmaxInPreKeysIdentityKeyMixin").parseIdentityKeyMixin(e);if(!n.success)return n;var r=o("WASmaxInPreKeysPreKeyIDListMixin").parsePreKeyIDListMixin(e);if(!r.success)return r;var a=o("WASmaxInPreKeysSignedPreKeyMixin").parseSignedPreKeyMixin(e);if(!a.success)return a;var i=o("WASmaxInPreKeysKeyTypeMixin").parseKeyTypeMixin(e),l=o("WASmaxInPreKeysKeysHashMixin").parseKeysHashMixin(e);return l.success?o("WAResultOrError").makeResult(babelHelpers.extends({},t.value,n.value,r.value,a.value,{keyTypeMixin:i.success?i.value:null},l.value)):l}l.parseIdentityDigestBundleMixin=e}),98);
__d("WASmaxInPreKeysFetchDigestResponseSuccess",["WAResultOrError","WASmaxInPreKeysIQResultResponseMixin","WASmaxInPreKeysIdentityDigestBundleMixin","WASmaxParseReference","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e,t){var n=o("WASmaxParseUtils").assertTag(e,"iq");if(!n.success)return n;var r=o("WASmaxParseUtils").flattenedChildWithTag(e,"digest");if(!r.success)return r;var a=o("WASmaxParseReference").optionalAttrStringFromReference(t,["digest","identity_type"]);if(!a.success)return a;var i=o("WASmaxParseUtils").optionalLiteral(o("WASmaxParseUtils").attrString,r.value,"identity_type",a.value);if(!i.success)return i;var l=o("WASmaxInPreKeysIdentityDigestBundleMixin").parseIdentityDigestBundleMixin(r.value);if(!l.success)return l;var s=o("WASmaxInPreKeysIQResultResponseMixin").parseIQResultResponseMixin(e,t);return s.success?o("WAResultOrError").makeResult(babelHelpers.extends({hasDigestIdentityType:i.value!=null,digestIdentityDigestBundleMixin:l.value},s.value)):s}l.parseFetchDigestResponseSuccess=e}),98);
__d("WASmaxOutPreKeysFetchDigestRequest",["WASmaxJsx","WASmaxOutPreKeysClientRequestMixin"],(function(t,n,r,o,a,i,l){function e(){var e=o("WASmaxOutPreKeysClientRequestMixin").mergeClientRequestMixin(o("WASmaxJsx").smax("iq",{type:"get"},o("WASmaxJsx").smax("digest",null)));return e}l.makeFetchDigestRequest=e}),98);
__d("WASmaxPreKeysFetchDigestRPC",["WAComms","WASmaxInPreKeysFetchDigestResponseRequestError","WASmaxInPreKeysFetchDigestResponseServerError","WASmaxInPreKeysFetchDigestResponseSuccess","WASmaxOutPreKeysFetchDigestRequest","WASmaxParsingFailure","WASmaxRpcUtils","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){function e(e){return s.apply(this,arguments)}function s(){return s=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=o("WASmaxOutPreKeysFetchDigestRequest").makeFetchDigestRequest(),n=yield o("WAComms").sendSmaxStanza(t,e),r=o("WASmaxInPreKeysFetchDigestResponseSuccess").parseFetchDigestResponseSuccess(n,t);if(r.success)return{name:"FetchDigestResponseSuccess",value:r.value};var a=o("WASmaxInPreKeysFetchDigestResponseRequestError").parseFetchDigestResponseRequestError(n,t);if(a.success)return{name:"FetchDigestResponseRequestError",value:a.value};var i=o("WASmaxInPreKeysFetchDigestResponseServerError").parseFetchDigestResponseServerError(n,t);if(i.success)return{name:"FetchDigestResponseServerError",value:i.value};throw new(o("WASmaxParsingFailure")).SmaxParsingFailure(o("WASmaxRpcUtils").errorMessageRpcParsing("FetchDigest",{Success:r,RequestError:a,ServerError:i}))}),s.apply(this,arguments)}l.sendFetchDigestRPC=e}),98);
__d("WARequestPreKeyDigestProtocol",["WABinary","WAConvertRegistrationIdMixin","WAConvertSignedPreKeyMixin","WACryptoDependencies","WACryptoUtils","WAParsableXmlNode","WAResultOrError","WASignalKeys","WASmaxPreKeysFetchDigestRPC","WATagsLogger","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u=o("WATagsLogger").TAGS(["requestPreKeyDigestProtocol"]);function c(t){return o("WASmaxPreKeysFetchDigestRPC").sendFetchDigestRPC({withoutRetry:!1}).then(function(n){switch(n.name){case"FetchDigestResponseServerError":{var r=n.value.errorServerErrors.name;return u.ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["",": ",""])),n.name,r),o("WAResultOrError").makeError({type:"server-error",payload:r})}case"FetchDigestResponseRequestError":{var a=n.value.errorRequestErrorsFetchDigest.name;return u.ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["",": ",""])),n.name,a),o("WAResultOrError").makeError({type:"request-error",payload:a})}default:{n.name;var i=d(n.value.digestIdentityDigestBundleMixin);return m(i,t).then(function(e){return e==="ok"?o("WAResultOrError").makeResult():o("WAResultOrError").makeError({type:"compare-error",payload:e})})}}})}function d(e){var t=o("WAConvertRegistrationIdMixin").registrationIdMixin(e),n=o("WAConvertSignedPreKeyMixin").convertSignedPreKeyMixin(e),r=e.listId.map(function(e){return o("WASignalKeys").castToPreKeyId(o("WAParsableXmlNode").convertBytesToUint(e.elementValue,3))}),a=e.hashElementValue;return{regId:t,skeyId:n.id,preKeyIds:r,hash:a}}function m(e,t){return p.apply(this,arguments)}function p(){return p=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t){if(e.regId!==t.regInfo.regId)return"RegIdMismatch";if(e.skeyId!==t.signedPreKey.id)return"SignedPreKeyIdMismatch";var n=new Map;t.preKeys.forEach(function(e){return n.set(e.id,e)});var r=e.preKeyIds.some(function(e){return!n.has(e)});if(r)return"UnknownPreKey";var a=e.preKeyIds.map(function(e){return n.get(e)}).filter(Boolean),i=yield _(t,a);return o("WACryptoUtils").uint8ArraysEqual(i,e.hash)?"ok":"HashMismatch"}),p.apply(this,arguments)}function _(e,t){var n=new(o("WABinary")).Binary;return n.writeByteArray(e.regInfo.staticKeyPair.publicKey),n.writeByteArray(e.signedPreKey.keyPair.publicKey),n.writeByteArray(e.signedPreKey.signature),t.forEach(function(e){n.writeByteArray(e.keyPair.publicKey)}),o("WACryptoDependencies").getCrypto().subtle.digest("SHA-1",n.readByteArrayView()).then(function(e){return new Uint8Array(e)})}l.requestPreKeyDigestProtocol=c}),98);
__d("WARequestPreKeyDigest",["WABridge","WAGenerateAndUploadPreKeys","WAGetKeysForUpload","WAGlobals","WALogger","WAOdsEnums","WARequestPreKeyDigestProtocol","asyncToGeneratorRuntime","err"],(function(t,n,r,o,a,i,l){"use strict";var e,s;function u(e){return c.apply(this,arguments)}function c(){return c=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var n=yield t(function(e){var t=e.cryptoManager;return o("WAGetKeysForUpload").getKeysForUpload(t)}),a=yield o("WARequestPreKeyDigestProtocol").requestPreKeyDigestProtocol(n.value);if(a.success===!1){if(o("WABridge").getBridge().fireAndForget("event","odsBumpEntityKey",{entity:o("WAOdsEnums").Entity.PREKEY_DIGEST,key:"fail"}),a.error.type==="compare-error"){o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["PreKey digest comparison failed: ",""])),a.error.payload),o("WAGenerateAndUploadPreKeys").generateAndUploadPreKeys({reason:"prekey digest comparison failed"}).catch(function(e){o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Error while generating and uploading prekeys: ",""])),e)});return}throw r("err")("Error while requesting key digest: "+a.error.type+" "+a.error.payload)}a.success,o("WABridge").getBridge().fireAndForget("event","odsBumpEntityKey",{entity:o("WAOdsEnums").Entity.PREKEY_DIGEST,key:"success"})}),c.apply(this,arguments)}function d(){return u(function(e){return o("WAGlobals").getWaOneQueue().enqueue(e,{operationType:"request_prekey_digest",flush:!1})})}l.requestPreKeyDigestFn=u,l.requestPreKeyDigest=d}),98);
__d("WASmaxInPreKeysRotateSignedResponseRequestError",["WAResultOrError","WASmaxInPreKeysIQErrorResponseMixin","WASmaxInPreKeysRequestErrors","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e,t){var n=o("WASmaxParseUtils").assertTag(e,"iq");if(!n.success)return n;var r=o("WASmaxParseUtils").flattenedChildWithTag(e,"error");if(!r.success)return r;var a=o("WASmaxInPreKeysIQErrorResponseMixin").parseIQErrorResponseMixin(e,t);if(!a.success)return a;var i=o("WASmaxInPreKeysRequestErrors").parseRequestErrors(r.value);return i.success?o("WAResultOrError").makeResult(babelHelpers.extends({},a.value,{errorRequestErrors:i.value})):i}l.parseRotateSignedResponseRequestError=e}),98);
__d("WASmaxInPreKeysRotateSignedResponseServerError",["WAResultOrError","WASmaxInPreKeysIQErrorResponseMixin","WASmaxInPreKeysServerErrors","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e,t){var n=o("WASmaxParseUtils").assertTag(e,"iq");if(!n.success)return n;var r=o("WASmaxParseUtils").flattenedChildWithTag(e,"error");if(!r.success)return r;var a=o("WASmaxInPreKeysIQErrorResponseMixin").parseIQErrorResponseMixin(e,t);if(!a.success)return a;var i=o("WASmaxInPreKeysServerErrors").parseServerErrors(r.value);return i.success?o("WAResultOrError").makeResult(babelHelpers.extends({},a.value,{errorServerErrors:i.value})):i}l.parseRotateSignedResponseServerError=e}),98);
__d("WASmaxInPreKeysRotateSignedResponseSuccess",["WASmaxInPreKeysIQResultResponseMixin","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e,t){var n=o("WASmaxParseUtils").assertTag(e,"iq");if(!n.success)return n;var r=o("WASmaxInPreKeysIQResultResponseMixin").parseIQResultResponseMixin(e,t);return r.success,r}l.parseRotateSignedResponseSuccess=e}),98);
__d("WASmaxInPreKeysRotateSignedResponseValidationError",["WAResultOrError","WASmaxInPreKeysIQErrorResponseMixin","WASmaxInPreKeysIdentityKeyMixin","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e,t){var n=o("WASmaxParseUtils").assertTag(e,"iq");if(!n.success)return n;var r=o("WASmaxParseUtils").flattenedChildWithTag(e,"error");if(!r.success)return r;var a=o("WASmaxParseUtils").attrString(r.value,"text");if(!a.success)return a;var i=o("WASmaxParseUtils").attrIntRange(r.value,"code",400,499);if(!i.success)return i;var l=o("WASmaxInPreKeysIdentityKeyMixin").parseIdentityKeyMixin(r.value);if(!l.success)return l;var s=o("WASmaxInPreKeysIQErrorResponseMixin").parseIQErrorResponseMixin(e,t);return s.success?o("WAResultOrError").makeResult(babelHelpers.extends({errorText:a.value,errorCode:i.value,errorIdentityKeyMixin:l.value},s.value)):s}l.parseRotateSignedResponseValidationError=e}),98);
__d("WASmaxOutPreKeysRotateSignedRequest",["WASmaxJsx","WASmaxOutPreKeysClientRequestMixin","WASmaxOutPreKeysSignedPreKeyMixin"],(function(t,n,r,o,a,i,l){function e(e){var t=e.signedPreKeyMixinArgs,n=o("WASmaxOutPreKeysClientRequestMixin").mergeClientRequestMixin(o("WASmaxJsx").smax("iq",{type:"set"},o("WASmaxOutPreKeysSignedPreKeyMixin").mergeSignedPreKeyMixin(o("WASmaxJsx").smax("rotate",null),t)));return n}l.makeRotateSignedRequest=e}),98);
__d("WASmaxPreKeysRotateSignedRPC",["WAComms","WASmaxInPreKeysRotateSignedResponseRequestError","WASmaxInPreKeysRotateSignedResponseServerError","WASmaxInPreKeysRotateSignedResponseSuccess","WASmaxInPreKeysRotateSignedResponseValidationError","WASmaxOutPreKeysRotateSignedRequest","WASmaxParsingFailure","WASmaxRpcUtils","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){function e(e,t){return s.apply(this,arguments)}function s(){return s=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t){var n=o("WASmaxOutPreKeysRotateSignedRequest").makeRotateSignedRequest(e),r=yield o("WAComms").sendSmaxStanza(n,t),a=o("WASmaxInPreKeysRotateSignedResponseSuccess").parseRotateSignedResponseSuccess(r,n);if(a.success)return{name:"RotateSignedResponseSuccess",value:a.value};var i=o("WASmaxInPreKeysRotateSignedResponseValidationError").parseRotateSignedResponseValidationError(r,n);if(i.success)return{name:"RotateSignedResponseValidationError",value:i.value};var l=o("WASmaxInPreKeysRotateSignedResponseRequestError").parseRotateSignedResponseRequestError(r,n);if(l.success)return{name:"RotateSignedResponseRequestError",value:l.value};var s=o("WASmaxInPreKeysRotateSignedResponseServerError").parseRotateSignedResponseServerError(r,n);if(s.success)return{name:"RotateSignedResponseServerError",value:s.value};throw new(o("WASmaxParsingFailure")).SmaxParsingFailure(o("WASmaxRpcUtils").errorMessageRpcParsing("RotateSigned",{Success:a,ValidationError:i,RequestError:l,ServerError:s}))}),s.apply(this,arguments)}l.sendRotateSignedRPC=e}),98);
__d("WARotateSignedPreKeyProtocol",["WACryptoManager","WAErrorMessage","WAGlobals","WAHandleFailureUtils","WAMakeSignedPreKeyMixin","WAResultOrError","WASmaxPreKeysRotateSignedRPC","WATagsLogger","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p=o("WATagsLogger").TAGS(["rotateSignedPreKeyProtocol"]);function _(){return f.apply(this,arguments)}function f(){return f=n("asyncToGeneratorRuntime").asyncToGenerator(function*(){p.LOG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["start generating skey..."])));try{var t=yield o("WAGlobals").getWaOneQueue().enqueue(function(e){var t=e.cryptoManager;return o("WACryptoManager").generateSignedPreKey(t)},{operationType:"generate_signed_prekey",flush:!0,afterInit:!0});p.LOG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["generated skey. Start rotating skey..."])));var n=yield o("WASmaxPreKeysRotateSignedRPC").sendRotateSignedRPC({signedPreKeyMixinArgs:o("WAMakeSignedPreKeyMixin").makeSignedPreKeyMixin(t)});switch(n.name){case"RotateSignedResponseValidationError":{var r=n.value,a=r.errorCode,i=r.errorIdentityKeyMixin,l=r.errorText;return p.ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["ValidationError: "," ",""])),a,l),o("WAResultOrError").makeError({type:"validation-error",identity:i.elementValue})}case"RotateSignedResponseRequestError":{var _=n.value.errorRequestErrors.value.code,f=n.value.errorRequestErrors.name;return p.ERROR(c||(c=babelHelpers.taggedTemplateLiteralLoose(["RequestError: "," ",""])),_,f),o("WAResultOrError").makeError({type:"request-error"})}case"RotateSignedResponseServerError":{var g=n.value.errorServerErrors.value.code,h=n.value.errorServerErrors.name;return p.ERROR(d||(d=babelHelpers.taggedTemplateLiteralLoose(["ServerError: "," ",""])),g,h),o("WAResultOrError").makeError({type:"server-error"})}default:return n.name,p.LOG(m||(m=babelHelpers.taggedTemplateLiteralLoose(["successfully rotated new skey"]))),o("WAResultOrError").makeResult()}}catch(e){var y=o("WAErrorMessage").maybeGetMessageFromError(e);if(y.includes("No lastSignedPrekeyId and registration"))return yield o("WAHandleFailureUtils").reregisterPhone(),o("WAResultOrError").makeError({type:"no-prekey-reregistered"});throw e}}),f.apply(this,arguments)}l.rotateSignedPreKeyProtocol=_}),98);
__d("WARotateSignedPreKey",["Promise","WAGenerateAndUploadPreKeys","WALoggerTag","WARotateSignedPreKeyProtocol","WATagsLogger","asyncToGeneratorRuntime","err"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d=o("WATagsLogger").TAGS([r("WALoggerTag").SignedPrekeyRotation,r("WALoggerTag").SignedPrekey]);function m(){return p.apply(this,arguments)}function p(){return p=n("asyncToGeneratorRuntime").asyncToGenerator(function*(){var t=yield o("WARotateSignedPreKeyProtocol").rotateSignedPreKeyProtocol();if(!(t.success||t.error.type==="no-prekey-reregistered")){if(t.error.type==="validation-error")return d.ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Signed prekey failed server validation. need to upload all keys."]))),o("WAGenerateAndUploadPreKeys").generateAndUploadPreKeys({reason:"signed prekey failed server validation"}).catch(function(e){d.ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Error while generating and uploading prekeys: ",""])),e)}),(c||(c=n("Promise"))).resolve();throw d.ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["rotateSignedPreKey failed."]))),r("err")("rotateSignedPreKey RPC failed: "+t.error.type)}}),p.apply(this,arguments)}l.rotateSignedPreKey=m}),98);